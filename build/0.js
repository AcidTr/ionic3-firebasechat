webpackJsonp([0],{406:function(t,e,n){"use strict";function r(t){return s._40(0,[s._31(0,R.e,[s.C]),(t()(),s._17(1,0,null,null,10,"div",[["class","text"]],null,null,null,null,null)),s._16(2,278528,null,0,R.i,[s.A,s.B,s.p,s.O],{klass:[0,"klass"],ngClass:[1,"ngClass"]},null),s._32(3,{"sender-background":0}),(t()(),s._38(-1,null,["\n  "])),(t()(),s._17(5,0,null,null,1,"p",[],null,null,null,null,null)),(t()(),s._38(6,null,[" ",""])),(t()(),s._38(-1,null,["\n  "])),(t()(),s._17(8,0,null,null,2,"p",[["class","timestamp"]],null,null,null,null,null)),(t()(),s._38(9,null,[" ",""])),s._33(10,2),(t()(),s._38(-1,null,["\n"])),(t()(),s._38(-1,null,["\n"]))],function(t,e){t(e,2,0,"text",t(e,3,0,e.component.isFromSender))},function(t,e){var n=e.component;t(e,6,0,n.message.text);t(e,9,0,s._39(e,9,0,t(e,10,0,s._29(e,0),n.message.timestamp,"dd/MM/y H:mm")))})}function i(t){return s._40(0,[(t()(),s._17(0,0,null,null,2,"message-box",[],[[4,"justify-content",null],[4,"text-align",null]],null,null,r,P)),s._16(1,49152,null,0,O.a,[],{message:[0,"message"],isFromSender:[1,"isFromSender"]},null),(t()(),s._38(-1,null,["\n\n    "]))],function(t,e){t(e,1,0,e.context.$implicit,e.context.$implicit.userId===e.component.sender.uid)},function(t,e){t(e,0,0,s._29(e,1).isFromSender?"flex-end":"flex-start",s._29(e,1).isFromSender?"right":"left")})}function o(t){return s._40(0,[s._36(402653184,1,{content:0}),(t()(),s._38(-1,null,["\n"])),(t()(),s._17(2,0,null,null,5,"ion-header",[],null,null,null,null,null)),s._16(3,16384,null,0,M.a,[L.a,s.p,s.N,[2,x.a]],null,null),(t()(),s._38(-1,null,["\n\n  "])),(t()(),s._17(5,0,null,null,1,"custom-logged-header",[],null,null,null,U.b,U.a)),s._16(6,114688,null,0,B.a,[F.a,f.a,q.a,V.a],{title:[0,"title"],user:[1,"user"]},null),(t()(),s._38(-1,null,["\n\n"])),(t()(),s._38(-1,null,["\n\n\n"])),(t()(),s._17(9,0,null,null,6,"ion-content",[["padding",""]],[[2,"statusbar-padding",null],[2,"has-refresher",null]],null,null,K.b,K.a)),s._16(10,4374528,[[1,4]],0,j.a,[L.a,W.a,Q.a,s.p,s.N,q.a,G.a,s.G,[2,x.a],[2,z.a]],null,null),(t()(),s._38(-1,1,["\n\n\n    "])),(t()(),s._12(16777216,null,1,2,null,i)),s._16(13,802816,null,0,R.j,[s._0,s.V,s.A],{ngForOf:[0,"ngForOf"]},null),s._31(131072,R.b,[s.i]),(t()(),s._38(-1,1,["\n\n\n"])),(t()(),s._38(-1,null,["\n\n\n"])),(t()(),s._17(17,0,null,null,27,"ion-footer",[],null,null,null,null,null)),s._16(18,16384,null,0,H.a,[L.a,s.p,s.N,[2,x.a]],null,null),(t()(),s._38(-1,null,["\n  "])),(t()(),s._17(20,0,null,null,23,"ion-toolbar",[["class","toolbar"]],[[2,"statusbar-padding",null]],null,null,X.b,X.a)),s._16(21,49152,null,0,Y.a,[L.a,s.p,s.N],null,null),(t()(),s._38(-1,3,["\n    "])),(t()(),s._17(23,0,null,3,19,"ion-item",[["class","item item-block"],["no-lines",""]],null,null,null,J.b,J.a)),s._16(24,1097728,null,3,Z.a,[$.a,L.a,s.p,s.N,[2,tt.a]],null,null),s._36(335544320,2,{contentLabel:0}),s._36(603979776,3,{_buttons:1}),s._36(603979776,4,{_icons:1}),s._16(28,16384,null,0,et.a,[],null,null),(t()(),s._38(-1,2,["\n      "])),(t()(),s._17(30,0,null,3,4,"ion-input",[["placeholder","Message..."],["type","text"]],[[2,"ng-untouched",null],[2,"ng-touched",null],[2,"ng-pristine",null],[2,"ng-dirty",null],[2,"ng-valid",null],[2,"ng-invalid",null],[2,"ng-pending",null]],[[null,"ngModelChange"],[null,"keyup.enter"]],function(t,e,n){var r=!0,i=t.component;if("ngModelChange"===e){r=!1!==(i.newMessage=n)&&r}if("keyup.enter"===e){i.sendMessage(i.newMessage);r=!1!==(i.newMessage="")&&r}return r},nt.b,nt.a)),s._16(31,671744,null,0,rt.n,[[8,null],[8,null],[8,null],[8,null]],{model:[0,"model"]},{update:"ngModelChange"}),s._34(2048,null,rt.j,null,[rt.n]),s._16(33,16384,null,0,rt.k,[rt.j],null,null),s._16(34,5423104,null,0,it.a,[L.a,W.a,$.a,q.a,s.p,s.N,[2,j.a],[2,Z.a],[2,rt.j],Q.a],{type:[0,"type"],placeholder:[1,"placeholder"]},null),(t()(),s._38(-1,2,["\n      "])),(t()(),s._17(36,0,null,4,5,"button",[["ion-button",""],["item-right",""]],null,[[null,"click"]],function(t,e,n){var r=!0,i=t.component;if("click"===e){i.sendMessage(i.newMessage);r=!1!==(i.newMessage="")&&r}return r},ot.b,ot.a)),s._16(37,1097728,[[3,4]],0,st.a,[[8,""],L.a,s.p,s.N],null,null),(t()(),s._38(-1,0,["\n        "])),(t()(),s._17(39,0,null,0,1,"ion-icon",[["name","send"],["role","img"]],[[2,"hide",null]],null,null,null,null)),s._16(40,147456,null,0,at.a,[L.a,s.p,s.N],{name:[0,"name"]},null),(t()(),s._38(-1,0,["\n      "])),(t()(),s._38(-1,2,["\n    "])),(t()(),s._38(-1,3,["\n  "])),(t()(),s._38(-1,null,["\n\n"])),(t()(),s._38(-1,null,["\n"]))],function(t,e){var n=e.component;t(e,6,0,n.pageTitle,n.recipient);t(e,13,0,s._39(e,13,0,s._29(e,14).transform(n.viewMessages)));t(e,31,0,n.newMessage);t(e,34,0,"text","Message...");t(e,40,0,"send")},function(t,e){t(e,9,0,s._29(e,10).statusbarPadding,s._29(e,10)._hasRefresher);t(e,20,0,s._29(e,21)._sbPadding);t(e,30,0,s._29(e,33).ngClassUntouched,s._29(e,33).ngClassTouched,s._29(e,33).ngClassPristine,s._29(e,33).ngClassDirty,s._29(e,33).ngClassValid,s._29(e,33).ngClassInvalid,s._29(e,33).ngClassPending);t(e,39,0,s._29(e,40)._hidden)})}Object.defineProperty(e,"__esModule",{value:!0});var s=n(0),a=n(413),u=n(71),c=n(206),h=n(211),l=n(323),f=n(53),d=n(99),p=(n(318),n(416)),m=n.n(p),y=this&&this.__decorate||function(t,e,n,r){var i,o=arguments.length,s=o<3?e:null===r?r=Object.getOwnPropertyDescriptor(e,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(t,e,n,r);else for(var a=t.length-1;a>=0;a--)(i=t[a])&&(s=(o<3?i(s):o>3?i(e,n,s):i(e,n))||s);return o>3&&s&&Object.defineProperty(e,n,s),s},g=this&&this.__metadata||function(t,e){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(t,e)},v=function(){function t(t,e,n,r,i,o){this.authService=t,this.chatService=e,this.messageService=n,this.navCtrl=r,this.navParams=i,this.userService=o}return t.prototype.ionViewCanEnter=function(){return this.authService.authenticated},t.prototype.ionViewDidLoad=function(){var t=this;this.recipient=this.navParams.get("recipientUser"),this.pageTitle=this.recipient.name,this.userService.currentUser.valueChanges().first().subscribe(function(e){t.sender=e,t.chat1=t.chatService.getDeepChat(t.sender.uid,t.recipient.uid),t.chat2=t.chatService.getDeepChat(t.recipient.uid,t.sender.uid),t.recipient.photo&&t.chat1.valueChanges().subscribe(function(e){t.chatService.updatePhoto(t.chat1,e.photo,t.recipient.photo)});var n=function(){t.viewMessages=t.messages.valueChanges(),t.viewMessages.subscribe(function(e){t.scrollToBottom()})};t.messages=t.messageService.getMessages(t.sender.uid,t.recipient.uid),t.messages.valueChanges().first().subscribe(function(e){0===e.length?(t.messages=t.messageService.getMessages(t.recipient.uid,t.sender.uid),n()):n()})})},t.prototype.sendMessage=function(t){var e=this;if(t){var n=m.a.database.ServerValue.TIMESTAMP;this.messageService.create(new l.a(this.sender.uid,t,n),this.messages).then(function(){e.chat1.update({lastMessage:t,timestamp:n}),e.chat2.update({lastMessage:t,timestamp:n})})}},t.prototype.scrollToBottom=function(t){var e=this;setTimeout(function(){e.content._scroll&&e.content.scrollToBottom(t||300)},50)},y([Object(s.Y)(u.c),g("design:type",u.c)],t.prototype,"content",void 0),t=y([Object(s.k)({selector:"page-chat",templateUrl:"chat.html"}),g("design:paramtypes",[f.a,c.a,h.a,u.j,u.k,d.a])],t)}(),b=n(202),_=this&&this.__decorate||function(t,e,n,r){var i,o=arguments.length,s=o<3?e:null===r?r=Object.getOwnPropertyDescriptor(e,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(t,e,n,r);else for(var a=t.length-1;a>=0;a--)(i=t[a])&&(s=(o<3?i(s):o>3?i(e,n,s):i(e,n))||s);return o>3&&s&&Object.defineProperty(e,n,s),s},w=function(){function t(){}return t=_([Object(s.D)({declarations:[v],imports:[u.g.forChild(v),b.a,a.a]})],t)}(),E=n(306),T=n(307),S=n(308),I=n(309),C=n(310),D=n(311),N=n(312),A=n(313),k=n(314),R=n(17),O=n(321),P=s._15({encapsulation:2,styles:[],data:{}}),M=(s._13("message-box",O.a,function(t){return s._40(0,[(t()(),s._17(0,0,null,null,1,"message-box",[],[[4,"justify-content",null],[4,"text-align",null]],null,null,r,P)),s._16(1,49152,null,0,O.a,[],null,null)],null,function(t,e){t(e,0,0,s._29(e,1).isFromSender?"flex-end":"flex-start",s._29(e,1).isFromSender?"right":"left")})},{message:"message",isFromSender:"isFromSender"},{},[]),n(203)),L=n(2),x=n(6),U=n(414),B=n(305),F=n(72),q=n(12),V=n(36),K=n(315),j=n(35),W=n(4),Q=n(13),G=n(38),z=n(29),H=n(213),X=n(422),Y=n(97),J=n(201),Z=n(22),$=n(18),tt=n(61),et=n(98),nt=n(412),rt=n(27),it=n(200),ot=n(69),st=n(34),at=n(60),ut=n(14),ct=s._15({encapsulation:2,styles:[],data:{}}),ht=s._13("page-chat",v,function(t){return s._40(0,[(t()(),s._17(0,0,null,null,1,"page-chat",[],null,null,null,o,ct)),s._16(1,49152,null,0,v,[f.a,c.a,h.a,z.a,ut.a,d.a],null,null)],null,null)},{},{},[]),lt=n(204),ft=n(62);n.d(e,"ChatPageModuleNgFactory",function(){return dt});var dt=s._14(w,[],function(t){return s._25([s._26(512,s.l,s._10,[[8,[E.a,T.a,S.a,I.a,C.a,D.a,N.a,A.a,k.a,ht]],[3,s.l],s.E]),s._26(4608,R.m,R.l,[s.C,[2,R.v]]),s._26(4608,rt.t,rt.t,[]),s._26(4608,rt.d,rt.d,[]),s._26(512,R.c,R.c,[]),s._26(512,rt.r,rt.r,[]),s._26(512,rt.g,rt.g,[]),s._26(512,rt.o,rt.o,[]),s._26(512,lt.a,lt.a,[]),s._26(512,lt.b,lt.b,[]),s._26(512,b.a,b.a,[]),s._26(512,a.a,a.a,[]),s._26(512,w,w,[]),s._26(256,ft.a,v,[])])})},410:function(t,e,n){"use strict";function r(t){return i._40(0,[(t()(),i._17(0,0,null,null,1,"div",[["class","toolbar-background"]],null,null,null,null,null)),i._16(1,278528,null,0,o.i,[i.A,i.B,i.p,i.O],{klass:[0,"klass"],ngClass:[1,"ngClass"]},null),(t()(),i._17(2,0,null,null,8,"button",[["class","back-button"],["ion-button","bar-button"]],[[8,"hidden",0]],[[null,"click"]],function(t,e,n){var r=!0;if("click"===e){r=!1!==t.component.backButtonClick(n)&&r}return r},s.b,s.a)),i._16(3,278528,null,0,o.i,[i.A,i.B,i.p,i.O],{klass:[0,"klass"],ngClass:[1,"ngClass"]},null),i._16(4,1097728,null,0,a.a,[[8,"bar-button"],u.a,i.p,i.N],null,null),(t()(),i._17(5,0,null,0,2,"ion-icon",[["class","back-button-icon"],["role","img"]],[[2,"hide",null]],null,null,null,null)),i._16(6,278528,null,0,o.i,[i.A,i.B,i.p,i.O],{klass:[0,"klass"],ngClass:[1,"ngClass"]},null),i._16(7,147456,null,0,c.a,[u.a,i.p,i.N],{name:[0,"name"]},null),(t()(),i._17(8,0,null,0,2,"span",[["class","back-button-text"]],null,null,null,null,null)),i._16(9,278528,null,0,o.i,[i.A,i.B,i.p,i.O],{klass:[0,"klass"],ngClass:[1,"ngClass"]},null),(t()(),i._38(10,null,["",""])),i._28(null,0),i._28(null,1),i._28(null,2),(t()(),i._17(14,0,null,null,2,"div",[["class","toolbar-content"]],null,null,null,null,null)),i._16(15,278528,null,0,o.i,[i.A,i.B,i.p,i.O],{klass:[0,"klass"],ngClass:[1,"ngClass"]},null),i._28(null,3)],function(t,e){var n=e.component;t(e,1,0,"toolbar-background","toolbar-background-"+n._mode);t(e,3,0,"back-button","back-button-"+n._mode);t(e,6,0,"back-button-icon","back-button-icon-"+n._mode);t(e,7,0,n._bbIcon);t(e,9,0,"back-button-text","back-button-text-"+n._mode);t(e,15,0,"toolbar-content","toolbar-content-"+n._mode)},function(t,e){var n=e.component;t(e,2,0,n._hideBb);t(e,5,0,i._29(e,7)._hidden);t(e,10,0,n._backText)})}n.d(e,"a",function(){return p}),e.b=r;var i=n(0),o=n(17),s=n(69),a=n(34),u=n(2),c=n(60),h=n(70),l=n(12),f=n(6),d=n(29),p=i._15({encapsulation:2,styles:[],data:{}});i._13("ion-navbar",h.a,function(t){return i._40(0,[(t()(),i._17(0,0,null,null,1,"ion-navbar",[["class","toolbar"]],[[8,"hidden",0],[2,"statusbar-padding",null]],null,null,r,p)),i._16(1,49152,null,0,h.a,[l.a,[2,f.a],[2,d.a],u.a,i.p,i.N],null,null)],null,function(t,e){t(e,0,0,i._29(e,1)._hidden,i._29(e,1)._sbPadding)})},{color:"color",mode:"mode",hideBackButton:"hideBackButton"},{},["[menuToggle],ion-buttons[left]","ion-buttons[start]","ion-buttons[end],ion-buttons[right]","*"])},411:function(t,e,n){"use strict";function r(t){return i._40(2,[(t()(),i._17(0,0,null,null,2,"div",[["class","toolbar-title"]],null,null,null,null,null)),i._16(1,278528,null,0,o.i,[i.A,i.B,i.p,i.O],{klass:[0,"klass"],ngClass:[1,"ngClass"]},null),i._28(null,0)],function(t,e){t(e,1,0,"toolbar-title","toolbar-title-"+e.component._mode)},null)}n.d(e,"a",function(){return h}),e.b=r;var i=n(0),o=n(17),s=n(199),a=n(2),u=n(97),c=n(70),h=i._15({encapsulation:2,styles:[],data:{}});i._13("ion-title",s.a,function(t){return i._40(0,[(t()(),i._17(0,0,null,null,1,"ion-title",[],null,null,null,r,h)),i._16(1,49152,null,0,s.a,[a.a,i.p,i.N,[2,u.a],[2,c.a]],null,null)],null,null)},{color:"color",mode:"mode"},{},["*"])},412:function(t,e,n){"use strict";function r(t){return u._40(0,[(t()(),u._17(0,0,[[1,0],["textInput",1]],null,1,"input",[["class","text-input"],["dir","auto"]],[[8,"type",0],[1,"aria-labelledby",0],[1,"min",0],[1,"max",0],[1,"step",0],[1,"autocomplete",0],[1,"autocorrect",0],[8,"placeholder",0],[8,"disabled",0],[8,"readOnly",0]],[[null,"input"],[null,"blur"],[null,"focus"],[null,"keydown"]],function(t,e,n){var r=!0,i=t.component;if("input"===e){r=!1!==i.onInput(n)&&r}if("blur"===e){r=!1!==i.onBlur(n)&&r}if("focus"===e){r=!1!==i.onFocus(n)&&r}if("keydown"===e){r=!1!==i.onKeydown(n)&&r}return r},null,null)),u._16(1,278528,null,0,c.i,[u.A,u.B,u.p,u.O],{klass:[0,"klass"],ngClass:[1,"ngClass"]},null)],function(t,e){t(e,1,0,"text-input","text-input-"+e.component._mode)},function(t,e){var n=e.component;t(e,0,0,n._type,n._labelId,n.min,n.max,n.step,n.autocomplete,n.autocorrect,n.placeholder,n._disabled,n._readonly)})}function i(t){return u._40(0,[(t()(),u._17(0,0,[[1,0],["textInput",1]],null,1,"textarea",[["class","text-input"]],[[1,"aria-labelledby",0],[1,"autocomplete",0],[1,"autocorrect",0],[8,"placeholder",0],[8,"disabled",0],[8,"readOnly",0]],[[null,"input"],[null,"blur"],[null,"focus"],[null,"keydown"]],function(t,e,n){var r=!0,i=t.component;if("input"===e){r=!1!==i.onInput(n)&&r}if("blur"===e){r=!1!==i.onBlur(n)&&r}if("focus"===e){r=!1!==i.onFocus(n)&&r}if("keydown"===e){r=!1!==i.onKeydown(n)&&r}return r},null,null)),u._16(1,278528,null,0,c.i,[u.A,u.B,u.p,u.O],{klass:[0,"klass"],ngClass:[1,"ngClass"]},null)],function(t,e){t(e,1,0,"text-input","text-input-"+e.component._mode)},function(t,e){var n=e.component;t(e,0,0,n._labelId,n.autocomplete,n.autocorrect,n.placeholder,n._disabled,n._readonly)})}function o(t){return u._40(0,[(t()(),u._17(0,0,null,null,1,"button",[["class","text-input-clear-icon"],["clear",""],["ion-button",""],["tabindex","-1"],["type","button"]],null,[[null,"click"],[null,"mousedown"]],function(t,e,n){var r=!0,i=t.component;if("click"===e){r=!1!==i.clearTextInput(n)&&r}if("mousedown"===e){r=!1!==i.clearTextInput(n)&&r}return r},h.b,h.a)),u._16(1,1097728,null,0,l.a,[[8,""],f.a,u.p,u.N],{clear:[0,"clear"]},null)],function(t,e){t(e,1,0,"")},null)}function s(t){return u._40(0,[(t()(),u._17(0,0,null,null,0,"div",[["class","input-cover"]],null,[[null,"touchstart"],[null,"touchend"],[null,"mousedown"],[null,"mouseup"]],function(t,e,n){var r=!0,i=t.component;if("touchstart"===e){r=!1!==i._pointerStart(n)&&r}if("touchend"===e){r=!1!==i._pointerEnd(n)&&r}if("mousedown"===e){r=!1!==i._pointerStart(n)&&r}if("mouseup"===e){r=!1!==i._pointerEnd(n)&&r}return r},null,null))],null,null)}function a(t){return u._40(2,[u._36(671088640,1,{_native:0}),(t()(),u._12(16777216,null,null,1,null,r)),u._16(2,16384,null,0,c.k,[u._0,u.V],{ngIf:[0,"ngIf"]},null),(t()(),u._12(16777216,null,null,1,null,i)),u._16(4,16384,null,0,c.k,[u._0,u.V],{ngIf:[0,"ngIf"]},null),(t()(),u._12(16777216,null,null,1,null,o)),u._16(6,16384,null,0,c.k,[u._0,u.V],{ngIf:[0,"ngIf"]},null),(t()(),u._12(16777216,null,null,1,null,s)),u._16(8,16384,null,0,c.k,[u._0,u.V],{ngIf:[0,"ngIf"]},null)],function(t,e){var n=e.component;t(e,2,0,!n._isTextarea);t(e,4,0,n._isTextarea);t(e,6,0,n._clearInput);t(e,8,0,n._useAssist)},null)}n.d(e,"a",function(){return w}),e.b=a;var u=n(0),c=n(17),h=n(69),l=n(34),f=n(2),d=n(200),p=n(4),m=n(18),y=n(12),g=n(35),v=n(22),b=n(27),_=n(13),w=u._15({encapsulation:2,styles:[],data:{}});u._13("ion-input,ion-textarea",d.a,function(t){return u._40(0,[(t()(),u._17(0,0,null,null,1,"ion-input",[],null,null,null,a,w)),u._16(1,5423104,null,0,d.a,[f.a,p.a,m.a,y.a,u.p,u.N,[2,g.a],[2,v.a],[2,b.j],_.a],null,null)],null,null)},{value:"value",color:"color",mode:"mode",disabled:"disabled",clearInput:"clearInput",type:"type",readonly:"readonly",clearOnEdit:"clearOnEdit",autocomplete:"autocomplete",autocorrect:"autocorrect",placeholder:"placeholder",min:"min",max:"max",step:"step"},{ionFocus:"ionFocus",ionChange:"ionChange",ionBlur:"ionBlur",input:"input",blur:"blur",focus:"focus"},[])},413:function(t,e,n){"use strict";n.d(e,"a",function(){return a});var r=n(71),i=n(0),o=n(415),s=this&&this.__decorate||function(t,e,n,r){var i,o=arguments.length,s=o<3?e:null===r?r=Object.getOwnPropertyDescriptor(e,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(t,e,n,r);else for(var a=t.length-1;a>=0;a--)(i=t[a])&&(s=(o<3?i(s):o>3?i(e,n,s):i(e,n))||s);return o>3&&s&&Object.defineProperty(e,n,s),s},a=function(){function t(){}return t=s([Object(i.D)({declarations:[o.a],imports:[r.f],exports:[o.a]})],t)}()},414:function(t,e,n){"use strict";function r(t){return s._40(0,[(t()(),s._17(0,0,null,null,12,"ion-item",[["class","item item-block"],["color","transparent"],["detail-none",""],["no-lines",""]],null,null,null,a.b,a.a)),s._16(1,1097728,null,3,u.a,[c.a,h.a,s.p,s.N,[2,l.a]],{color:[0,"color"]},null),s._36(335544320,2,{contentLabel:0}),s._36(603979776,3,{_buttons:1}),s._36(603979776,4,{_icons:1}),s._16(5,16384,null,0,f.a,[],null,null),(t()(),s._38(-1,2,["\n\n      "])),(t()(),s._17(7,0,null,0,4,"ion-avatar",[["item-start",""]],null,null,null,null,null)),s._16(8,16384,null,0,d.a,[],null,null),(t()(),s._38(-1,null,["\n        "])),(t()(),s._17(10,0,null,null,0,"img",[],[[8,"src",4]],null,null,null,null)),(t()(),s._38(-1,null,["\n      "])),(t()(),s._38(12,2,["\n      ","\n    "]))],function(t,e){t(e,1,0,"transparent")},function(t,e){var n=e.component;t(e,10,0,n.user.photo||"assets/imgs/no-photo.jpg");t(e,12,0,n.title)})}function i(t){return s._40(0,[(t()(),s._38(0,null,["\n      ","\n    "]))],null,function(t,e){t(e,0,0,e.component.title)})}function o(t){return s._40(0,[(t()(),s._17(0,0,null,null,33,"ion-navbar",[["class","toolbar"]],[[8,"hidden",0],[2,"statusbar-padding",null]],null,null,p.b,p.a)),s._16(1,49152,null,0,m.a,[y.a,[2,g.a],[2,v.a],h.a,s.p,s.N],null,null),(t()(),s._38(-1,3,["\n\n  "])),(t()(),s._17(3,0,null,0,8,"button",[["ion-button",""],["menuToggle","user-menu"]],[[8,"hidden",0]],[[null,"click"]],function(t,e,n){var r=!0;if("click"===e){r=!1!==s._29(t,5).toggle()&&r}return r},b.b,b.a)),s._16(4,1097728,[[1,4]],0,_.a,[[8,""],h.a,s.p,s.N],null,null),s._16(5,1064960,null,0,w.a,[E.a,[2,g.a],[2,_.a],[2,m.a]],{menuToggle:[0,"menuToggle"]},null),s._16(6,16384,null,1,T.a,[h.a,s.p,s.N,[2,S.a],[2,m.a]],null,null),s._36(603979776,1,{_buttons:1}),(t()(),s._38(-1,0,["\n    "])),(t()(),s._17(9,0,null,0,1,"ion-icon",[["name","menu"],["role","img"]],[[2,"hide",null]],null,null,null,null)),s._16(10,147456,null,0,I.a,[h.a,s.p,s.N],{name:[0,"name"]},null),(t()(),s._38(-1,0,["\n  "])),(t()(),s._38(-1,3,["\n\n  "])),(t()(),s._17(13,0,null,3,7,"ion-title",[],null,null,null,C.b,C.a)),s._16(14,49152,null,0,D.a,[h.a,s.p,s.N,[2,S.a],[2,m.a]],null,null),(t()(),s._38(-1,0,["\n\n    "])),(t()(),s._12(16777216,null,0,1,null,r)),s._16(17,16384,null,0,N.k,[s._0,s.V],{ngIf:[0,"ngIf"],ngIfElse:[1,"ngIfElse"]},null),(t()(),s._38(-1,0,["\n\n\n    "])),(t()(),s._12(0,[["titleTemplate",2]],0,0,null,i)),(t()(),s._38(-1,0,["\n  "])),(t()(),s._38(-1,3,["\n\n  "])),(t()(),s._17(22,0,null,2,10,"ion-buttons",[["end",""]],null,null,null,null,null)),s._16(23,16384,null,1,T.a,[h.a,s.p,s.N,[2,S.a],[2,m.a]],null,null),s._36(603979776,5,{_buttons:1}),(t()(),s._38(-1,null,["\n    "])),(t()(),s._17(26,0,null,null,5,"button",[["icon-only",""],["ion-button",""]],null,[[null,"click"]],function(t,e,n){var r=!0;if("click"===e){r=!1!==t.component.onLogout()&&r}return r},b.b,b.a)),s._16(27,1097728,[[5,4]],0,_.a,[[8,""],h.a,s.p,s.N],null,null),(t()(),s._38(-1,0,["\n      "])),(t()(),s._17(29,0,null,0,1,"ion-icon",[["name","exit"],["role","img"]],[[2,"hide",null]],null,null,null,null)),s._16(30,147456,null,0,I.a,[h.a,s.p,s.N],{name:[0,"name"]},null),(t()(),s._38(-1,0,["\n    "])),(t()(),s._38(-1,null,["\n  "])),(t()(),s._38(-1,3,["\n\n\n"])),(t()(),s._38(-1,null,["\n"]))],function(t,e){var n=e.component;t(e,5,0,"user-menu");t(e,10,0,"menu");t(e,17,0,n.user,s._29(e,19));t(e,30,0,"exit")},function(t,e){t(e,0,0,s._29(e,1)._hidden,s._29(e,1)._sbPadding);t(e,3,0,s._29(e,5).isHidden);t(e,9,0,s._29(e,10)._hidden);t(e,29,0,s._29(e,30)._hidden)})}n.d(e,"a",function(){return O}),e.b=o;var s=n(0),a=n(201),u=n(22),c=n(18),h=n(2),l=n(61),f=n(98),d=n(133),p=n(410),m=n(70),y=n(12),g=n(6),v=n(29),b=n(69),_=n(34),w=n(207),E=n(36),T=n(208),S=n(97),I=n(60),C=n(411),D=n(199),N=n(17),A=n(305),k=n(72),R=n(53),O=s._15({encapsulation:2,styles:[],data:{}});s._13("custom-logged-header",A.a,function(t){return s._40(0,[(t()(),s._17(0,0,null,null,1,"custom-logged-header",[],null,null,null,o,O)),s._16(1,114688,null,0,A.a,[k.a,R.a,y.a,E.a],null,null)],function(t,e){t(e,1,0)},null)},{title:"title",user:"user"},{},[])},415:function(t,e,n){"use strict";n.d(e,"a",function(){return o});var r=n(0),i=this&&this.__decorate||function(t,e,n,r){var i,o=arguments.length,s=o<3?e:null===r?r=Object.getOwnPropertyDescriptor(e,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(t,e,n,r);else for(var a=t.length-1;a>=0;a--)(i=t[a])&&(s=(o<3?i(s):o>3?i(e,n,s):i(e,n))||s);return o>3&&s&&Object.defineProperty(e,n,s),s},o=function(){function t(){}return t.prototype.transform=function(t,e){if(e)return t.charAt(0).toUpperCase()+t.substr(1);var n="";return t.split(" ").forEach(function(t,e,r){n+=t.charAt(0).toUpperCase()+t.substr(1).toLowerCase()+" "}),n},t=i([Object(r.L)({name:"capitalize"}),Object(r.w)()],t)}()},416:function(t,e,n){"use strict";n(316);var r=function(t){return t&&"object"==typeof t&&"default"in t?t.default:t}(n(132));n(317),n(319),n(417),n(419),n(420),n(421),console.warn("\nIt looks like you're using the development build of the Firebase JS SDK.\nWhen deploying Firebase apps to production, it is advisable to only import\nthe individual SDK components you intend to use.\n\nFor the module builds, these are available in the following manner\n(replace <PACKAGE> with the name of a component - i.e. auth, database, etc):\n\nCommonJS Modules:\nconst firebase = require('firebase/app');\nrequire('firebase/<PACKAGE>');\n\nES Modules:\nimport firebase from 'firebase/app';\nimport 'firebase/<PACKAGE>';\n\nTypescript:\nimport * as firebase from 'firebase/app';\nimport 'firebase/<PACKAGE>';\n"),t.exports=r},417:function(t,e,n){"use strict";(function(t){function r(){return zt.logLevel===Kt.LogLevel.DEBUG?qt.DEBUG:zt.logLevel===Kt.LogLevel.SILENT?qt.SILENT:qt.ERROR}function i(t){switch(t){case qt.DEBUG:zt.logLevel=Kt.LogLevel.DEBUG;break;case qt.ERROR:zt.logLevel=Kt.LogLevel.ERROR;break;case qt.SILENT:zt.logLevel=Kt.LogLevel.SILENT;break;default:zt.error("Firestore ("+Gt+"): Invalid value passed to `setLogLevel`")}}function o(t,e){for(var n=[],r=2;r<arguments.length;r++)n[r-2]=arguments[r];if(zt.logLevel<=Kt.LogLevel.DEBUG){var i=n.map(a);zt.debug.apply(zt,["Firestore ("+Gt+") ["+t+"]: "+e].concat(i))}}function s(t){for(var e=[],n=1;n<arguments.length;n++)e[n-1]=arguments[n];if(zt.logLevel<=Kt.LogLevel.ERROR){var r=e.map(a);zt.error.apply(zt,["Firestore ("+Gt+"): "+t].concat(r))}}function a(t){if("string"==typeof t)return t;var e=Ht.getPlatform();try{return e.formatJSON(t)}catch(e){return t}}function u(t){var e="FIRESTORE ("+Gt+") INTERNAL ASSERTION FAILED: "+t;throw s(e),new Error(e)}function c(t,e){t||u(e)}function h(){return Ht.getPlatform().emptyByteString}function l(t,e){function n(){var t="This constructor is private.";throw e&&(t+=" ",t+=e),new Yt(Xt.INVALID_ARGUMENT,t)}n.prototype=t.prototype;for(var r in t)t.hasOwnProperty(r)&&(n[r]=t[r]);return n}function f(t,e){return Object.prototype.hasOwnProperty.call(t,e)}function d(t,e){return void 0!==t?t:e}function p(t,e){for(var n in t)if(Object.prototype.hasOwnProperty.call(t,n)){var r=Number(n);isNaN(r)||e(r,t[n])}}function m(t,e){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&e(n,t[n])}function y(t){c(null!=t&&"object"==typeof t,"isEmpty() expects object parameter.");for(var e in t)if(Object.prototype.hasOwnProperty.call(t,e))return!1;return!0}function g(t,e,n){if(e.length!==n)throw new Yt(Xt.INVALID_ARGUMENT,"Function "+t+"() requires "+P(n,"argument")+", but was called with "+P(e.length,"argument")+".")}function v(t,e,n){if(e.length<n)throw new Yt(Xt.INVALID_ARGUMENT,"Function "+t+"() requires at least "+P(n,"argument")+", but was called with "+P(e.length,"argument")+".")}function b(t,e,n,r){if(e.length<n||e.length>r)throw new Yt(Xt.INVALID_ARGUMENT,"Function "+t+"() requires between "+n+" and "+r+" arguments, but was called with "+P(e.length,"argument")+".")}function _(t,e,n,r){C(t,e,O(n)+" argument",r)}function w(t,e,n,r){void 0!==r&&_(t,e,n,r)}function E(t,e,n,r){C(t,e,n+" option",r)}function T(t,e,n,r){void 0!==r&&E(t,e,n,r)}function S(t,e,n,r,i){void 0!==r&&function(t,e,n,r,i){if(!(r instanceof Array))throw new Yt(Xt.INVALID_ARGUMENT,"Function "+t+"() requires its "+e+" option to be an array, but it was: "+N(r));for(var o=0;o<r.length;++o)if(!i(r[o]))throw new Yt(Xt.INVALID_ARGUMENT,"Function "+t+"() requires all "+e+" elements to be "+n+", but the value at index "+o+" was: "+N(r[o]))}(t,e,n,r,i)}function I(t,e,n,r,i){void 0!==r&&function(t,e,n,r,i){for(var o=[],s=0,a=i;s<a.length;s++){var u=a[s];if(u===r)return;o.push(N(u))}var c=N(r);throw new Yt(Xt.INVALID_ARGUMENT,"Invalid value "+c+" provided to function "+t+'() for option "'+n+'". Acceptable values: '+o.join(", "))}(t,0,n,r,i)}function C(t,e,n,r){if(!("object"===e?D(r):"non-empty string"===e?"string"==typeof r&&""!==r:typeof r===e)){var i=N(r);throw new Yt(Xt.INVALID_ARGUMENT,"Function "+t+"() requires its "+n+" to be of type "+e+", but it was: "+i)}}function D(t){return"object"==typeof t&&null!==t&&(Object.getPrototypeOf(t)===Object.prototype||null===Object.getPrototypeOf(t))}function N(t){if(void 0===t)return"undefined";if(null===t)return"null";if("string"==typeof t)return t.length>20&&(t=t.substring(0,20)+"..."),JSON.stringify(t);if("number"==typeof t||"boolean"==typeof t)return""+t;if("object"==typeof t){if(t instanceof Array)return"an array";var e=function(t){if(t.constructor){var e=/function\s+([^\s(]+)\s*\(/,n=e.exec(t.constructor.toString());if(n&&n.length>1)return n[1]}return null}(t);return e?"a custom "+e+" object":"an object"}return"function"==typeof t?"a function":u("Unknown wrong type: "+typeof t)}function A(t,e,n){if(void 0===n)throw new Yt(Xt.INVALID_ARGUMENT,"Function "+t+"() requires a valid "+O(e)+" argument, but it was undefined.")}function k(t,e,n){m(e,function(e,r){if(n.indexOf(e)<0)throw new Yt(Xt.INVALID_ARGUMENT,"Unknown option '"+e+"' passed to function "+t+"(). Available options: "+n.join(", "))})}function R(t,e,n,r){var i=N(r);return new Yt(Xt.INVALID_ARGUMENT,"Function "+t+"() requires its "+O(n)+" argument to be a "+e+", but it was: "+i)}function O(t){switch(t){case 1:return"first";case 2:return"second";case 3:return"third";default:return t+"th"}}function P(t,e){return t+" "+e+(1===t?"":"s")}function M(t,e){return t<e?-1:t>e?1:0}function L(t,e){if(t.length!==e.length)return!1;for(var n=0;n<t.length;n++)if(!t[n].isEqual(e[n]))return!1;return!0}function x(){if("undefined"==typeof Uint8Array)throw new Yt(Xt.UNIMPLEMENTED,"Uint8Arrays are not available in this environment.")}function U(){if(!Ht.getPlatform().base64Available)throw new Yt(Xt.UNIMPLEMENTED,"Blobs are unavailable in Firestore in this environment.")}function B(t,e){return t===e?0!==t||1/t==1/e:t!=t&&e!=e}function F(t){return null===t||void 0===t}function q(t){return Fe(t)&&t<=Be&&t>=Ue}function V(t){return t instanceof Le?t.internalValue.slice():[]}function K(t){switch(t){case Xt.OK:return u("Treated status OK as error");case Xt.CANCELLED:case Xt.UNKNOWN:case Xt.DEADLINE_EXCEEDED:case Xt.RESOURCE_EXHAUSTED:case Xt.INTERNAL:case Xt.UNAVAILABLE:case Xt.UNAUTHENTICATED:return!1;case Xt.INVALID_ARGUMENT:case Xt.NOT_FOUND:case Xt.ALREADY_EXISTS:case Xt.PERMISSION_DENIED:case Xt.FAILED_PRECONDITION:case Xt.ABORTED:case Xt.OUT_OF_RANGE:case Xt.UNIMPLEMENTED:case Xt.DATA_LOSS:return!0;default:return u("Unknown status code: "+t)}}function j(t){if(void 0===t)return s("GRPC error has no .code"),Xt.UNKNOWN;switch(t){case sn.OK:return Xt.OK;case sn.CANCELLED:return Xt.CANCELLED;case sn.UNKNOWN:return Xt.UNKNOWN;case sn.DEADLINE_EXCEEDED:return Xt.DEADLINE_EXCEEDED;case sn.RESOURCE_EXHAUSTED:return Xt.RESOURCE_EXHAUSTED;case sn.INTERNAL:return Xt.INTERNAL;case sn.UNAVAILABLE:return Xt.UNAVAILABLE;case sn.UNAUTHENTICATED:return Xt.UNAUTHENTICATED;case sn.INVALID_ARGUMENT:return Xt.INVALID_ARGUMENT;case sn.NOT_FOUND:return Xt.NOT_FOUND;case sn.ALREADY_EXISTS:return Xt.ALREADY_EXISTS;case sn.PERMISSION_DENIED:return Xt.PERMISSION_DENIED;case sn.FAILED_PRECONDITION:return Xt.FAILED_PRECONDITION;case sn.ABORTED:return Xt.ABORTED;case sn.OUT_OF_RANGE:return Xt.OUT_OF_RANGE;case sn.UNIMPLEMENTED:return Xt.UNIMPLEMENTED;case sn.DATA_LOSS:return Xt.DATA_LOSS;default:return u("Unknown status code: "+t)}}function W(){return vn}function Q(){return W()}function G(){return bn}function z(){return _n}function H(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];for(var n=wn,r=0,i=t;r<i.length;r++){n=n.add(i[r])}return n}function X(){return En}function Y(){return new pe(ce.comparator)}function J(){return new pe(ce.comparator)}function Z(t,e){c(!F(t),e+" is missing")}function $(t){return"number"==typeof t?t:"string"==typeof t?Number(t):u("can't parse "+t)}function tt(t,e,n){return e===n||!e&&n in t}function et(t){for(var e="",n=0;n<t.length;n++)e.length>0&&(e=nt(e)),e=function(t,e){for(var n=e,r=t.length,i=0;i<r;i++){var o=t.charAt(i);switch(o){case"\0":n+=Jn+$n;break;case Jn:n+=Jn+tr;break;default:n+=o}}return n}(t.get(n),e);return nt(e)}function nt(t){return t+Jn+Zn}function rt(t){var e=t.length;if(c(e>=2,"Invalid path "+t),2===e)return c(t.charAt(0)===Jn&&t.charAt(1)===Zn,"Non-empty path "+t+" had length 2"),se.EMPTY_PATH;for(var n=e-2,r=[],i="",o=0;o<e;){var s=t.indexOf(Jn,o);(s<0||s>n)&&u('Invalid encoded resource path: "'+t+'"');switch(t.charAt(s+1)){case Zn:var a=t.substring(o,s),h=void 0;0===i.length?h=a:(h=i+=a,i=""),r.push(h);break;case $n:i+=t.substring(o,s),i+="\0";break;case tr:i+=t.substring(o,s+1);break;default:u('Invalid encoded resource path: "'+t+'"')}o=s+2}return new se(r)}function it(t){return new ar(function(e,n){t.onsuccess=function(t){e(t.target.result)},t.onerror=function(t){n(t.target.error)}})}function ot(t){return Hr.getStore(t,kr.store)}function st(t){return cr.getStore(t,Or.store).get(Or.key).next(function(t){return c(null!==t,"Missing metadata row."),t})}function at(t){return st(t).next(function(t){return t.highestListenSequenceNumber})}function ut(t){return Hr.getStore(t,Rr.store)}function ct(t){return Hr.getStore(t,Ar.store)}function ht(t){return Hr.getStore(t,Nr.store)}function lt(t){return Hr.getStore(t,Pr.store)}function ft(t){return t.path.toArray()}function dt(t){var e;if(t.document)e=t.document;else if(t.unknownDocument)e=t.unknownDocument;else{if(!t.noDocument)throw u("Unknown remote document type");e=t.noDocument}return JSON.stringify(e).length}function pt(t){t.createObjectStore(Rr.store,{keyPath:Rr.keyPath}).createIndex(Rr.documentTargetsIndex,Rr.documentTargetsKeyPath,{unique:!0});t.createObjectStore(kr.store,{keyPath:kr.keyPath}).createIndex(kr.queryTargetsIndexName,kr.queryTargetsKeyPath,{unique:!0}),t.createObjectStore(Or.store)}function mt(t,e,n){var r=Ir.prefixForPath(e,n.path),i=r[1],o=IDBKeyRange.lowerBound(r),s=!1;return bt(t).iterate({range:o,keysOnly:!0},function(t,n,r){t[0]===e&&t[1]===i&&(s=!0),r.done()}).next(function(){return s})}function yt(t,e,n){var r=t.store(Sr.store),i=t.store(Ir.store),o=[],s=IDBKeyRange.only(n.batchId),a=0,u=r.iterate({range:s},function(t,e,n){return a++,n.delete()});o.push(u.next(function(){c(1===a,"Dangling document-mutation reference found: Missing batch "+n.batchId)}));for(var h=[],l=0,f=n.mutations;l<f.length;l++){var d=f[l],p=Ir.key(e,d.key.path,n.batchId);o.push(i.delete(p)),h.push(d.key)}return ar.waitFor(o).next(function(){return h})}function gt(e){return e instanceof Uint8Array?(c("YES"===t.env.USE_MOCK_PERSISTENCE,"Persisting non-string stream tokens is only supported with mock persistence."),e.toString()):e}function vt(t){return Hr.getStore(t,Sr.store)}function bt(t){return Hr.getStore(t,Ir.store)}function _t(t){return Hr.getStore(t,Tr.store)}function wt(t,e){var n=t[1],r=e[1],i=M(t[0],e[0]);return 0===i?M(n,r):i}function Et(t){return jt.__awaiter(this,void 0,void 0,function(){return jt.__generator(this,function(e){if(!function(t){return t.code===Xt.FAILED_PRECONDITION&&t.message===Wr}(t))throw t;return o(jr,"Unexpectedly lost primary lease"),[2]})})}function Tt(t){return t.store(Er.store)}function St(t){return t.store(Mr.store)}function It(t,e){return ut(t).put(function(t,e){return new Rr(0,et(t.path),e)}(e,t.currentSequenceNumber))}function Ct(t){return function(t,e){if("object"!=typeof t||null===t)return!1;for(var n=t,r=0,i=e;r<i.length;r++){var o=i[r];if(o in n&&"function"==typeof n[o])return!0}return!1}(t,["next","error","complete"])}function Dt(t){switch(t){case bi.Set:case bi.MergeSet:case bi.Update:return!0;case bi.Argument:return!1;default:throw u("Unexpected case for UserDataSource: "+t)}}function Nt(t){return!("object"!=typeof t||null===t||t instanceof Array||t instanceof Date||t instanceof ee||t instanceof te||t instanceof Zt||t instanceof yo||t instanceof oo)}function At(t,e,n){if(!Nt(n)||!D(n)){var r=N(n);throw e.createError("an object"===r?t+" a custom object":t+" "+r)}}function kt(t,e){if(e instanceof Zi)return e._internalPath;if("string"==typeof e)return Rt(t,e);throw new Yt(Xt.INVALID_ARGUMENT,"Function "+t+"() called with invalid data. Field path arguments must be of type string or FieldPath.")}function Rt(t,e){try{return function(t){if(t.search($i)>=0)throw new Yt(Xt.INVALID_ARGUMENT,"Invalid field path ("+t+"). Paths must not contain '~', '*', '/', '[', or ']'");try{return new(Zi.bind.apply(Zi,[void 0].concat(t.split("."))))}catch(e){throw new Yt(Xt.INVALID_ARGUMENT,"Invalid field path ("+t+"). Paths must not be empty, begin with '.', end with '.', or contain '..'")}}(e)._internalPath}catch(e){var n=Ot(e);throw new Yt(Xt.INVALID_ARGUMENT,"Function "+t+"() called with invalid data. "+n)}}function Ot(t){return t instanceof Error?t.message:t.toString()}function Pt(t,e){if(void 0===e)return{merge:!1};if(k(t,e,["merge","mergeFields"]),T(t,"boolean","merge",e.merge),S(t,"mergeFields","a string or a FieldPath",e.mergeFields,function(t){return"string"==typeof t||t instanceof Zi}),void 0!==e.mergeFields&&void 0!==e.merge)throw new Yt(Xt.INVALID_ARGUMENT,"Invalid options passed to function "+t+'(): You cannot specify both "merge" and "mergeFields".');return e}function Mt(t,e){return void 0===e?{}:(k(t,e,["serverTimestamps"]),I(t,0,"serverTimestamps",e.serverTimestamps,["estimate","previous","none"]),e)}function Lt(t,e){w(t,"object",1,e),e&&(k(t,e,["source"]),I(t,0,"source",e.source,["default","server","cache"]))}function xt(t,e,n){if(e instanceof Do){if(e.firestore!==n)throw new Yt(Xt.INVALID_ARGUMENT,"Provided document reference is from a different Firestore instance.");return e}throw R(t,"DocumentReference",1,e)}function Ut(t,e,n){if(n.oldDocs.isEmpty()){var r,i=0;return n.docChanges.map(function(e){var o=new ko(t,e.doc.key,e.doc,n.fromCache,n.mutatedKeys.has(e.doc.key));return c(e.type===gn.Added,"Invalid event type for first snapshot"),c(!r||n.query.docComparator(r,e.doc)<0,"Got added events in wrong order"),r=e.doc,{type:"added",doc:o,oldIndex:-1,newIndex:i++}})}var o=n.oldDocs;return n.docChanges.filter(function(t){return e||t.type!==gn.Metadata}).map(function(e){var r=new ko(t,e.doc.key,e.doc,n.fromCache,n.mutatedKeys.has(e.doc.key)),i=-1,s=-1;return e.type!==gn.Added&&(c((i=o.indexOf(e.doc.key))>=0,"Index for document not found"),o=o.delete(e.doc.key)),e.type!==gn.Removed&&(s=(o=o.add(e.doc)).indexOf(e.doc.key)),{type:function(t){switch(t){case gn.Added:return"added";case gn.Modified:case gn.Metadata:return"modified";case gn.Removed:return"removed";default:return u("Unknown change type: "+t)}}(e.type),doc:r,oldIndex:i,newIndex:s}})}function Bt(t){t.INTERNAL.registerService("firestore",function(t){return new So(t)},function(t){c(t&&"object"==typeof t,"shallowCopy() expects object parameter.");var e={};for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n]);return e}(jo))}function Ft(t){Bt(t)}Object.defineProperty(e,"__esModule",{value:!0});var qt,Vt=function(t){return t&&"object"==typeof t&&"default"in t?t.default:t}(n(132)),Kt=n(320),jt=n(1),Wt=n(418),Qt=n(205),Gt=Vt.SDK_VERSION,zt=new Kt.Logger("@firebase/firestore");!function(t){t[t.DEBUG=0]="DEBUG",t[t.ERROR=1]="ERROR",t[t.SILENT=2]="SILENT"}(qt||(qt={}));var Ht=function(){function t(){}return t.setPlatform=function(e){t.platform&&u("Platform already defined"),t.platform=e},t.getPlatform=function(){return t.platform||u("Platform not set"),t.platform},t}(),Xt={OK:"ok",CANCELLED:"cancelled",UNKNOWN:"unknown",INVALID_ARGUMENT:"invalid-argument",DEADLINE_EXCEEDED:"deadline-exceeded",NOT_FOUND:"not-found",ALREADY_EXISTS:"already-exists",PERMISSION_DENIED:"permission-denied",UNAUTHENTICATED:"unauthenticated",RESOURCE_EXHAUSTED:"resource-exhausted",FAILED_PRECONDITION:"failed-precondition",ABORTED:"aborted",OUT_OF_RANGE:"out-of-range",UNIMPLEMENTED:"unimplemented",INTERNAL:"internal",UNAVAILABLE:"unavailable",DATA_LOSS:"data-loss"},Yt=function(t){function e(e,n){var r=t.call(this,n)||this;return r.code=e,r.message=n,r.name="FirebaseError",r.toString=function(){return r.name+": [code="+r.code+"]: "+r.message},r}return jt.__extends(e,t),e}(Error),Jt=function(){function t(){}return t.newId=function(){for(var t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",e="",n=0;n<20;n++)e+=t.charAt(Math.floor(Math.random()*t.length));return c(20===e.length,"Invalid auto ID: "+e),e},t}(),Zt=function(){function t(t){U(),this._binaryString=t}return t.fromBase64String=function(e){g("Blob.fromBase64String",arguments,1),_("Blob.fromBase64String","string",1,e),U();try{return new t(Ht.getPlatform().atob(e))}catch(t){throw new Yt(Xt.INVALID_ARGUMENT,"Failed to construct Blob from Base64 string: "+t)}},t.fromUint8Array=function(e){if(g("Blob.fromUint8Array",arguments,1),x(),!(e instanceof Uint8Array))throw R("Blob.fromUint8Array","Uint8Array",1,e);return new t(Array.prototype.map.call(e,function(t){return String.fromCharCode(t)}).join(""))},t.prototype.toBase64=function(){return g("Blob.toBase64",arguments,0),U(),Ht.getPlatform().btoa(this._binaryString)},t.prototype.toUint8Array=function(){g("Blob.toUint8Array",arguments,0),x();for(var t=new Uint8Array(this._binaryString.length),e=0;e<this._binaryString.length;e++)t[e]=this._binaryString.charCodeAt(e);return t},t.prototype.toString=function(){return"Blob(base64: "+this.toBase64()+")"},t.prototype.isEqual=function(t){return this._binaryString===t._binaryString},t.prototype._compareTo=function(t){return M(this._binaryString,t._binaryString)},t}(),$t=l(Zt,"Use Blob.fromUint8Array() or Blob.fromBase64String() instead."),te=function(){function t(t,e){if(g("GeoPoint",arguments,2),_("GeoPoint","number",1,t),_("GeoPoint","number",2,e),!isFinite(t)||t<-90||t>90)throw new Yt(Xt.INVALID_ARGUMENT,"Latitude must be a number between -90 and 90, but was: "+t);if(!isFinite(e)||e<-180||e>180)throw new Yt(Xt.INVALID_ARGUMENT,"Longitude must be a number between -180 and 180, but was: "+e);this._lat=t,this._long=e}return Object.defineProperty(t.prototype,"latitude",{get:function(){return this._lat},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"longitude",{get:function(){return this._long},enumerable:!0,configurable:!0}),t.prototype.isEqual=function(t){return this._lat===t._lat&&this._long===t._long},t.prototype._compareTo=function(t){return M(this._lat,t._lat)||M(this._long,t._long)},t}(),ee=function(){function t(t,e){if(this.seconds=t,this.nanoseconds=e,e<0)throw new Yt(Xt.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+e);if(e>=1e9)throw new Yt(Xt.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+e);if(t<-62135596800)throw new Yt(Xt.INVALID_ARGUMENT,"Timestamp seconds out of range: "+t);if(t>=253402300800)throw new Yt(Xt.INVALID_ARGUMENT,"Timestamp seconds out of range: "+t)}return t.now=function(){return t.fromMillis(Date.now())},t.fromDate=function(e){return t.fromMillis(e.getTime())},t.fromMillis=function(e){var n=Math.floor(e/1e3);return new t(n,1e6*(e-1e3*n))},t.prototype.toDate=function(){return new Date(this.toMillis())},t.prototype.toMillis=function(){return 1e3*this.seconds+this.nanoseconds/1e6},t.prototype._compareTo=function(t){return this.seconds===t.seconds?M(this.nanoseconds,t.nanoseconds):M(this.seconds,t.seconds)},t.prototype.isEqual=function(t){return t.seconds===this.seconds&&t.nanoseconds===this.nanoseconds},t.prototype.toString=function(){return"Timestamp(seconds="+this.seconds+", nanoseconds="+this.nanoseconds+")"},t}(),ne=function(){return function(t,e,n,r){this.databaseId=t,this.persistenceKey=e,this.host=n,this.ssl=r}}(),re="(default)",ie=function(){function t(t,e){this.projectId=t,this.database=e||re}return Object.defineProperty(t.prototype,"isDefaultDatabase",{get:function(){return this.database===re},enumerable:!0,configurable:!0}),t.prototype.isEqual=function(e){return e instanceof t&&e.projectId===this.projectId&&e.database===this.database},t.prototype.compareTo=function(t){return M(this.projectId,t.projectId)||M(this.database,t.database)},t}(),oe=function(){function t(t,e,n){this.init(t,e,n)}return t.prototype.init=function(t,e,n){void 0===e?e=0:e>t.length&&u("offset "+e+" out of range "+t.length),void 0===n?n=t.length-e:n>t.length-e&&u("length "+n+" out of range "+(t.length-e)),this.segments=t,this.offset=e,this.len=n},t.prototype.construct=function(t,e,n){var r=Object.create(Object.getPrototypeOf(this));return r.init(t,e,n),r},Object.defineProperty(t.prototype,"length",{get:function(){return this.len},enumerable:!0,configurable:!0}),t.prototype.isEqual=function(e){return 0===t.comparator(this,e)},t.prototype.child=function(e){var n=this.segments.slice(this.offset,this.limit());return e instanceof t?e.forEach(function(t){n.push(t)}):"string"==typeof e?n.push(e):u("Unknown parameter type for Path.child(): "+e),this.construct(n)},t.prototype.limit=function(){return this.offset+this.length},t.prototype.popFirst=function(t){return t=void 0===t?1:t,c(this.length>=t,"Can't call popFirst() with less segments"),this.construct(this.segments,this.offset+t,this.length-t)},t.prototype.popLast=function(){return c(!this.isEmpty(),"Can't call popLast() on empty path"),this.construct(this.segments,this.offset,this.length-1)},t.prototype.firstSegment=function(){return c(!this.isEmpty(),"Can't call firstSegment() on empty path"),this.segments[this.offset]},t.prototype.lastSegment=function(){return c(!this.isEmpty(),"Can't call lastSegment() on empty path"),this.segments[this.limit()-1]},t.prototype.get=function(t){return c(t<this.length,"Index out of range"),this.segments[this.offset+t]},t.prototype.isEmpty=function(){return 0===this.length},t.prototype.isPrefixOf=function(t){if(t.length<this.length)return!1;for(var e=0;e<this.length;e++)if(this.get(e)!==t.get(e))return!1;return!0},t.prototype.isImmediateParentOf=function(t){if(this.length+1!==t.length)return!1;for(var e=0;e<this.length;e++)if(this.get(e)!==t.get(e))return!1;return!0},t.prototype.forEach=function(t){for(var e=this.offset,n=this.limit();e<n;e++)t(this.segments[e])},t.prototype.toArray=function(){return this.segments.slice(this.offset,this.limit())},t.comparator=function(t,e){for(var n=Math.min(t.length,e.length),r=0;r<n;r++){var i=t.get(r),o=e.get(r);if(i<o)return-1;if(i>o)return 1}return t.length<e.length?-1:t.length>e.length?1:0},t}(),se=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return jt.__extends(e,t),e.prototype.canonicalString=function(){return this.toArray().join("/")},e.prototype.toString=function(){return this.canonicalString()},e.fromString=function(t){if(t.indexOf("//")>=0)throw new Yt(Xt.INVALID_ARGUMENT,"Invalid path ("+t+"). Paths must not contain // in them.");return new e(t.split("/").filter(function(t){return t.length>0}))},e.EMPTY_PATH=new e([]),e}(oe),ae=/^[_a-zA-Z][_a-zA-Z0-9]*$/,ue=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return jt.__extends(e,t),e.isValidIdentifier=function(t){return ae.test(t)},e.prototype.canonicalString=function(){return this.toArray().map(function(t){return t=t.replace("\\","\\\\").replace("`","\\`"),e.isValidIdentifier(t)||(t="`"+t+"`"),t}).join(".")},e.prototype.toString=function(){return this.canonicalString()},e.prototype.isKeyField=function(){return 1===this.length&&"__name__"===this.get(0)},e.keyField=function(){return new e(["__name__"])},e.fromServerFormat=function(t){for(var n=[],r="",i=0,o=function(){if(0===r.length)throw new Yt(Xt.INVALID_ARGUMENT,"Invalid field path ("+t+"). Paths must not be empty, begin with '.', end with '.', or contain '..'");n.push(r),r=""},s=!1;i<t.length;){var a=t[i];if("\\"===a){if(i+1===t.length)throw new Yt(Xt.INVALID_ARGUMENT,"Path has trailing escape character: "+t);var u=t[i+1];if("\\"!==u&&"."!==u&&"`"!==u)throw new Yt(Xt.INVALID_ARGUMENT,"Path has invalid escape sequence: "+t);r+=u,i+=2}else"`"===a?(s=!s,i++):"."!==a||s?(r+=a,i++):(o(),i++)}if(o(),s)throw new Yt(Xt.INVALID_ARGUMENT,"Unterminated ` in path: "+t);return new e(n)},e.EMPTY_PATH=new e([]),e}(oe),ce=function(){function t(e){this.path=e,c(t.isDocumentKey(e),"Invalid DocumentKey with an odd number of segments: "+e.toArray().join("/"))}return t.prototype.isEqual=function(t){return null!==t&&0===se.comparator(this.path,t.path)},t.prototype.toString=function(){return this.path.toString()},t.comparator=function(t,e){return se.comparator(t.path,e.path)},t.isDocumentKey=function(t){return t.length%2==0},t.fromSegments=function(e){return new t(new se(e.slice()))},t.fromPathString=function(e){return new t(se.fromString(e))},t.EMPTY=new t(new se([])),t}(),he=function(){function t(t,e){this.key=t,this.version=e}return t.compareByKey=function(t,e){return ce.comparator(t.key,e.key)},t}(),le=function(t){function e(e,n,r,i,o){var s=t.call(this,e,n)||this;return s.data=r,s.proto=o,s.hasLocalMutations=!!i.hasLocalMutations,s.hasCommittedMutations=!!i.hasCommittedMutations,s}return jt.__extends(e,t),e.prototype.field=function(t){return this.data.field(t)},e.prototype.fieldValue=function(t){var e=this.field(t);return e?e.value():void 0},e.prototype.value=function(){return this.data.value()},e.prototype.isEqual=function(t){return t instanceof e&&this.key.isEqual(t.key)&&this.version.isEqual(t.version)&&this.data.isEqual(t.data)&&this.hasLocalMutations===t.hasLocalMutations&&this.hasCommittedMutations===t.hasCommittedMutations},e.prototype.toString=function(){return"Document("+this.key+", "+this.version+", "+this.data.toString()+", {hasLocalMutations: "+this.hasLocalMutations+"}), {hasCommittedMutations: "+this.hasCommittedMutations+"})"},Object.defineProperty(e.prototype,"hasPendingWrites",{get:function(){return this.hasLocalMutations||this.hasCommittedMutations},enumerable:!0,configurable:!0}),e.compareByField=function(t,e,n){var r=e.field(t),i=n.field(t);return void 0!==r&&void 0!==i?r.compareTo(i):u("Trying to compare documents on fields that don't exist")},e}(he),fe=function(t){function e(e,n,r){var i=t.call(this,e,n)||this;return i.hasCommittedMutations=!(!r||!r.hasCommittedMutations),i}return jt.__extends(e,t),e.prototype.toString=function(){return"NoDocument("+this.key+", "+this.version+")"},Object.defineProperty(e.prototype,"hasPendingWrites",{get:function(){return this.hasCommittedMutations},enumerable:!0,configurable:!0}),e.prototype.isEqual=function(t){return t instanceof e&&t.hasCommittedMutations===this.hasCommittedMutations&&t.version.isEqual(this.version)&&t.key.isEqual(this.key)},e}(he),de=function(t){function e(e,n){return t.call(this,e,n)||this}return jt.__extends(e,t),e.prototype.toString=function(){return"UnknownDocument("+this.key+", "+this.version+")"},Object.defineProperty(e.prototype,"hasPendingWrites",{get:function(){return!0},enumerable:!0,configurable:!0}),e.prototype.isEqual=function(t){return t instanceof e&&t.version.isEqual(this.version)&&t.key.isEqual(this.key)},e}(he),pe=function(){function t(t,e){this.comparator=t,this.root=e||ye.EMPTY}return t.prototype.insert=function(e,n){return new t(this.comparator,this.root.insert(e,n,this.comparator).copy(null,null,ye.BLACK,null,null))},t.prototype.remove=function(e){return new t(this.comparator,this.root.remove(e,this.comparator).copy(null,null,ye.BLACK,null,null))},t.prototype.get=function(t){for(var e=this.root;!e.isEmpty();){var n=this.comparator(t,e.key);if(0===n)return e.value;n<0?e=e.left:n>0&&(e=e.right)}return null},t.prototype.indexOf=function(t){for(var e=0,n=this.root;!n.isEmpty();){var r=this.comparator(t,n.key);if(0===r)return e+n.left.size;r<0?n=n.left:(e+=n.left.size+1,n=n.right)}return-1},t.prototype.isEmpty=function(){return this.root.isEmpty()},Object.defineProperty(t.prototype,"size",{get:function(){return this.root.size},enumerable:!0,configurable:!0}),t.prototype.minKey=function(){return this.root.minKey()},t.prototype.maxKey=function(){return this.root.maxKey()},t.prototype.inorderTraversal=function(t){return this.root.inorderTraversal(t)},t.prototype.forEach=function(t){this.inorderTraversal(function(e,n){return t(e,n),!1})},t.prototype.reverseTraversal=function(t){return this.root.reverseTraversal(t)},t.prototype.getIterator=function(){return new me(this.root,null,this.comparator,!1)},t.prototype.getIteratorFrom=function(t){return new me(this.root,t,this.comparator,!1)},t.prototype.getReverseIterator=function(){return new me(this.root,null,this.comparator,!0)},t.prototype.getReverseIteratorFrom=function(t){return new me(this.root,t,this.comparator,!0)},t}(),me=function(){function t(t,e,n,r){this.isReverse=r,this.nodeStack=[];for(var i=1;!t.isEmpty();)if(i=e?n(t.key,e):1,r&&(i*=-1),i<0)t=this.isReverse?t.left:t.right;else{if(0===i){this.nodeStack.push(t);break}this.nodeStack.push(t),t=this.isReverse?t.right:t.left}}return t.prototype.getNext=function(){c(this.nodeStack.length>0,"getNext() called on iterator when hasNext() is false.");var t=this.nodeStack.pop(),e={key:t.key,value:t.value};if(this.isReverse)for(t=t.left;!t.isEmpty();)this.nodeStack.push(t),t=t.right;else for(t=t.right;!t.isEmpty();)this.nodeStack.push(t),t=t.left;return e},t.prototype.hasNext=function(){return this.nodeStack.length>0},t.prototype.peek=function(){if(0===this.nodeStack.length)return null;var t=this.nodeStack[this.nodeStack.length-1];return{key:t.key,value:t.value}},t}(),ye=function(){function t(e,n,r,i,o){this.key=e,this.value=n,this.color=null!=r?r:t.RED,this.left=null!=i?i:t.EMPTY,this.right=null!=o?o:t.EMPTY,this.size=this.left.size+1+this.right.size}return t.prototype.copy=function(e,n,r,i,o){return new t(null!=e?e:this.key,null!=n?n:this.value,null!=r?r:this.color,null!=i?i:this.left,null!=o?o:this.right)},t.prototype.isEmpty=function(){return!1},t.prototype.inorderTraversal=function(t){return this.left.inorderTraversal(t)||t(this.key,this.value)||this.right.inorderTraversal(t)},t.prototype.reverseTraversal=function(t){return this.right.reverseTraversal(t)||t(this.key,this.value)||this.left.reverseTraversal(t)},t.prototype.min=function(){return this.left.isEmpty()?this:this.left.min()},t.prototype.minKey=function(){return this.min().key},t.prototype.maxKey=function(){return this.right.isEmpty()?this.key:this.right.maxKey()},t.prototype.insert=function(t,e,n){var r=this,i=n(t,r.key);return(r=i<0?r.copy(null,null,null,r.left.insert(t,e,n),null):0===i?r.copy(null,e,null,null,null):r.copy(null,null,null,null,r.right.insert(t,e,n))).fixUp()},t.prototype.removeMin=function(){if(this.left.isEmpty())return t.EMPTY;var e=this;return e.left.isRed()||e.left.left.isRed()||(e=e.moveRedLeft()),(e=e.copy(null,null,null,e.left.removeMin(),null)).fixUp()},t.prototype.remove=function(e,n){var r,i=this;if(n(e,i.key)<0)i.left.isEmpty()||i.left.isRed()||i.left.left.isRed()||(i=i.moveRedLeft()),i=i.copy(null,null,null,i.left.remove(e,n),null);else{if(i.left.isRed()&&(i=i.rotateRight()),i.right.isEmpty()||i.right.isRed()||i.right.left.isRed()||(i=i.moveRedRight()),0===n(e,i.key)){if(i.right.isEmpty())return t.EMPTY;r=i.right.min(),i=i.copy(r.key,r.value,null,null,i.right.removeMin())}i=i.copy(null,null,null,null,i.right.remove(e,n))}return i.fixUp()},t.prototype.isRed=function(){return this.color},t.prototype.fixUp=function(){var t=this;return t.right.isRed()&&!t.left.isRed()&&(t=t.rotateLeft()),t.left.isRed()&&t.left.left.isRed()&&(t=t.rotateRight()),t.left.isRed()&&t.right.isRed()&&(t=t.colorFlip()),t},t.prototype.moveRedLeft=function(){var t=this.colorFlip();return t.right.left.isRed()&&(t=(t=(t=t.copy(null,null,null,null,t.right.rotateRight())).rotateLeft()).colorFlip()),t},t.prototype.moveRedRight=function(){var t=this.colorFlip();return t.left.left.isRed()&&(t=(t=t.rotateRight()).colorFlip()),t},t.prototype.rotateLeft=function(){var e=this.copy(null,null,t.RED,null,this.right.left);return this.right.copy(null,null,this.color,e,null)},t.prototype.rotateRight=function(){var e=this.copy(null,null,t.RED,this.left.right,null);return this.left.copy(null,null,this.color,null,e)},t.prototype.colorFlip=function(){var t=this.left.copy(null,null,!this.left.color,null,null),e=this.right.copy(null,null,!this.right.color,null,null);return this.copy(null,null,!this.color,t,e)},t.prototype.checkMaxDepth=function(){var t=this.check();return Math.pow(2,t)<=this.size+1},t.prototype.check=function(){if(this.isRed()&&this.left.isRed())throw u("Red node has red child("+this.key+","+this.value+")");if(this.right.isRed())throw u("Right child of ("+this.key+","+this.value+") is red");var t=this.left.check();if(t!==this.right.check())throw u("Black depths differ");return t+(this.isRed()?0:1)},t.EMPTY=null,t.RED=!0,t.BLACK=!1,t}(),ge=function(){function t(){this.size=0}return t.prototype.copy=function(t,e,n,r,i){return this},t.prototype.insert=function(t,e,n){return new ye(t,e)},t.prototype.remove=function(t,e){return this},t.prototype.isEmpty=function(){return!0},t.prototype.inorderTraversal=function(t){return!1},t.prototype.reverseTraversal=function(t){return!1},t.prototype.minKey=function(){return null},t.prototype.maxKey=function(){return null},t.prototype.isRed=function(){return!1},t.prototype.checkMaxDepth=function(){return!0},t.prototype.check=function(){return 0},t}();ye.EMPTY=new ge;var ve;!function(t){t[t.NullValue=0]="NullValue",t[t.BooleanValue=1]="BooleanValue",t[t.NumberValue=2]="NumberValue",t[t.TimestampValue=3]="TimestampValue",t[t.StringValue=4]="StringValue",t[t.BlobValue=5]="BlobValue",t[t.RefValue=6]="RefValue",t[t.GeoPointValue=7]="GeoPointValue",t[t.ArrayValue=8]="ArrayValue",t[t.ObjectValue=9]="ObjectValue"}(ve||(ve={}));var be;!function(t){t[t.Default=0]="Default",t[t.Estimate=1]="Estimate",t[t.Previous=2]="Previous"}(be||(be={}));var _e,we=function(){function t(t,e){this.serverTimestampBehavior=t,this.timestampsInSnapshots=e}return t.fromSnapshotOptions=function(e,n){switch(e.serverTimestamps){case"estimate":return new t(be.Estimate,n);case"previous":return new t(be.Previous,n);case"none":case void 0:return new t(be.Default,n);default:return u("fromSnapshotOptions() called with invalid options.")}},t}(),Ee=function(){function t(){}return t.prototype.toString=function(){var t=this.value();return null===t?"null":t.toString()},t.prototype.defaultCompareTo=function(t){c(this.typeOrder!==t.typeOrder,"Default compareTo should not be used for values of same type.");return M(this.typeOrder,t.typeOrder)},t}(),Te=function(t){function e(){var e=t.call(this)||this;return e.typeOrder=ve.NullValue,e.internalValue=null,e}return jt.__extends(e,t),e.prototype.value=function(t){return null},e.prototype.isEqual=function(t){return t instanceof e},e.prototype.compareTo=function(t){return t instanceof e?0:this.defaultCompareTo(t)},e.INSTANCE=new e,e}(Ee),Se=function(t){function e(e){var n=t.call(this)||this;return n.internalValue=e,n.typeOrder=ve.BooleanValue,n}return jt.__extends(e,t),e.prototype.value=function(t){return this.internalValue},e.prototype.isEqual=function(t){return t instanceof e&&this.internalValue===t.internalValue},e.prototype.compareTo=function(t){return t instanceof e?M(this,t):this.defaultCompareTo(t)},e.of=function(t){return t?e.TRUE:e.FALSE},e.TRUE=new e(!0),e.FALSE=new e(!1),e}(Ee),Ie=function(t){function e(e){var n=t.call(this)||this;return n.internalValue=e,n.typeOrder=ve.NumberValue,n}return jt.__extends(e,t),e.prototype.value=function(t){return this.internalValue},e.prototype.compareTo=function(t){return t instanceof e?function(t,e){return t<e?-1:t>e?1:t===e?0:isNaN(t)?isNaN(e)?0:-1:1}(this.internalValue,t.internalValue):this.defaultCompareTo(t)},e}(Ee),Ce=function(t){function e(e){return t.call(this,e)||this}return jt.__extends(e,t),e.prototype.isEqual=function(t){return t instanceof e&&B(this.internalValue,t.internalValue)},e}(Ie),De=function(t){function e(e){var n=t.call(this,e)||this;return n.internalValue=e,n}return jt.__extends(e,t),e.prototype.isEqual=function(t){return t instanceof e&&B(this.internalValue,t.internalValue)},e.NAN=new e(NaN),e.POSITIVE_INFINITY=new e(1/0),e.NEGATIVE_INFINITY=new e(-1/0),e}(Ie),Ne=function(t){function e(e){var n=t.call(this)||this;return n.internalValue=e,n.typeOrder=ve.StringValue,n}return jt.__extends(e,t),e.prototype.value=function(t){return this.internalValue},e.prototype.isEqual=function(t){return t instanceof e&&this.internalValue===t.internalValue},e.prototype.compareTo=function(t){return t instanceof e?M(this.internalValue,t.internalValue):this.defaultCompareTo(t)},e}(Ee),Ae=function(t){function e(e){var n=t.call(this)||this;return n.internalValue=e,n.typeOrder=ve.TimestampValue,n}return jt.__extends(e,t),e.prototype.value=function(t){return t&&t.timestampsInSnapshots?this.internalValue:this.internalValue.toDate()},e.prototype.isEqual=function(t){return t instanceof e&&this.internalValue.isEqual(t.internalValue)},e.prototype.compareTo=function(t){return t instanceof e?this.internalValue._compareTo(t.internalValue):t instanceof ke?-1:this.defaultCompareTo(t)},e}(Ee),ke=function(t){function e(e,n){var r=t.call(this)||this;return r.localWriteTime=e,r.previousValue=n,r.typeOrder=ve.TimestampValue,r}return jt.__extends(e,t),e.prototype.value=function(t){return t&&t.serverTimestampBehavior===be.Estimate?new Ae(this.localWriteTime).value(t):t&&t.serverTimestampBehavior===be.Previous&&this.previousValue?this.previousValue.value(t):null},e.prototype.isEqual=function(t){return t instanceof e&&this.localWriteTime.isEqual(t.localWriteTime)},e.prototype.compareTo=function(t){return t instanceof e?this.localWriteTime._compareTo(t.localWriteTime):t instanceof Ae?1:this.defaultCompareTo(t)},e.prototype.toString=function(){return"<ServerTimestamp localTime="+this.localWriteTime.toString()+">"},e}(Ee),Re=function(t){function e(e){var n=t.call(this)||this;return n.internalValue=e,n.typeOrder=ve.BlobValue,n}return jt.__extends(e,t),e.prototype.value=function(t){return this.internalValue},e.prototype.isEqual=function(t){return t instanceof e&&this.internalValue.isEqual(t.internalValue)},e.prototype.compareTo=function(t){return t instanceof e?this.internalValue._compareTo(t.internalValue):this.defaultCompareTo(t)},e}(Ee),Oe=function(t){function e(e,n){var r=t.call(this)||this;return r.databaseId=e,r.key=n,r.typeOrder=ve.RefValue,r}return jt.__extends(e,t),e.prototype.value=function(t){return this.key},e.prototype.isEqual=function(t){return t instanceof e&&(this.key.isEqual(t.key)&&this.databaseId.isEqual(t.databaseId))},e.prototype.compareTo=function(t){if(t instanceof e){var n=this.databaseId.compareTo(t.databaseId);return 0!==n?n:ce.comparator(this.key,t.key)}return this.defaultCompareTo(t)},e}(Ee),Pe=function(t){function e(e){var n=t.call(this)||this;return n.internalValue=e,n.typeOrder=ve.GeoPointValue,n}return jt.__extends(e,t),e.prototype.value=function(t){return this.internalValue},e.prototype.isEqual=function(t){return t instanceof e&&this.internalValue.isEqual(t.internalValue)},e.prototype.compareTo=function(t){return t instanceof e?this.internalValue._compareTo(t.internalValue):this.defaultCompareTo(t)},e}(Ee),Me=function(t){function e(e){var n=t.call(this)||this;return n.internalValue=e,n.typeOrder=ve.ObjectValue,n}return jt.__extends(e,t),e.prototype.value=function(t){var e={};return this.internalValue.inorderTraversal(function(n,r){e[n]=r.value(t)}),e},e.prototype.forEach=function(t){this.internalValue.inorderTraversal(t)},e.prototype.isEqual=function(t){if(t instanceof e){for(var n=this.internalValue.getIterator(),r=t.internalValue.getIterator();n.hasNext()&&r.hasNext();){var i=n.getNext(),o=r.getNext();if(i.key!==o.key||!i.value.isEqual(o.value))return!1}return!n.hasNext()&&!r.hasNext()}return!1},e.prototype.compareTo=function(t){if(t instanceof e){for(var n=this.internalValue.getIterator(),r=t.internalValue.getIterator();n.hasNext()&&r.hasNext();){var i=n.getNext(),o=r.getNext(),s=M(i.key,o.key)||i.value.compareTo(o.value);if(s)return s}return M(n.hasNext(),r.hasNext())}return this.defaultCompareTo(t)},e.prototype.set=function(t,n){if(c(!t.isEmpty(),"Cannot set field for empty path on ObjectValue"),1===t.length)return this.setChild(t.firstSegment(),n);var r=this.child(t.firstSegment());r instanceof e||(r=e.EMPTY);var i=r.set(t.popFirst(),n);return this.setChild(t.firstSegment(),i)},e.prototype.delete=function(t){if(c(!t.isEmpty(),"Cannot delete field for empty path on ObjectValue"),1===t.length)return new e(this.internalValue.remove(t.firstSegment()));var n=this.child(t.firstSegment());if(n instanceof e){var r=n.delete(t.popFirst());return new e(this.internalValue.insert(t.firstSegment(),r))}return this},e.prototype.contains=function(t){return void 0!==this.field(t)},e.prototype.field=function(t){c(!t.isEmpty(),"Can't get field of empty path");var n=this;return t.forEach(function(t){n=n instanceof e?n.internalValue.get(t)||void 0:void 0}),n},e.prototype.toString=function(){return JSON.stringify(this.value())},e.prototype.child=function(t){return this.internalValue.get(t)||void 0},e.prototype.setChild=function(t,n){return new e(this.internalValue.insert(t,n))},e.EMPTY=new e(new pe(M)),e}(Ee),Le=function(t){function e(e){var n=t.call(this)||this;return n.internalValue=e,n.typeOrder=ve.ArrayValue,n}return jt.__extends(e,t),e.prototype.value=function(t){return this.internalValue.map(function(e){return e.value(t)})},e.prototype.forEach=function(t){this.internalValue.forEach(t)},e.prototype.isEqual=function(t){if(t instanceof e){if(this.internalValue.length!==t.internalValue.length)return!1;for(var n=0;n<this.internalValue.length;n++)if(!this.internalValue[n].isEqual(t.internalValue[n]))return!1;return!0}return!1},e.prototype.compareTo=function(t){if(t instanceof e){for(var n=Math.min(this.internalValue.length,t.internalValue.length),r=0;r<n;r++){var i=this.internalValue[r].compareTo(t.internalValue[r]);if(i)return i}return M(this.internalValue.length,t.internalValue.length)}return this.defaultCompareTo(t)},e.prototype.toString=function(){return JSON.stringify(this.value())},e}(Ee),xe=Number,Ue=xe.MIN_SAFE_INTEGER||-(Math.pow(2,53)-1),Be=xe.MAX_SAFE_INTEGER||Math.pow(2,53)-1,Fe=xe.isInteger||function(t){return"number"==typeof t&&isFinite(t)&&Math.floor(t)===t},qe=function(){function t(t,e,n,r,i,o){void 0===e&&(e=[]),void 0===n&&(n=[]),void 0===r&&(r=null),void 0===i&&(i=null),void 0===o&&(o=null),this.path=t,this.explicitOrderBy=e,this.filters=n,this.limit=r,this.startAt=i,this.endAt=o,this.memoizedCanonicalId=null,this.memoizedOrderBy=null,this.startAt&&this.assertValidBound(this.startAt),this.endAt&&this.assertValidBound(this.endAt)}return t.atPath=function(e){return new t(e)},Object.defineProperty(t.prototype,"orderBy",{get:function(){if(null===this.memoizedOrderBy){var t=this.getInequalityFilterField(),e=this.getFirstOrderByField();if(null!==t&&null===e)this.memoizedOrderBy=t.isKeyField()?[Xe]:[new He(t),Xe];else{c(null===t||null!==e&&t.isEqual(e),"First orderBy should match inequality field."),this.memoizedOrderBy=[];for(var n=!1,r=0,i=this.explicitOrderBy;r<i.length;r++){var o=i[r];this.memoizedOrderBy.push(o),o.field.isKeyField()&&(n=!0)}if(!n){this.memoizedOrderBy.push((this.explicitOrderBy.length>0?this.explicitOrderBy[this.explicitOrderBy.length-1].dir:Ge.ASCENDING)===Ge.ASCENDING?Xe:Ye)}}}return this.memoizedOrderBy},enumerable:!0,configurable:!0}),t.prototype.addFilter=function(e){c(null==this.getInequalityFilterField()||!(e instanceof je)||!e.isInequality()||e.field.isEqual(this.getInequalityFilterField()),"Query must only have one inequality field."),c(!ce.isDocumentKey(this.path),"No filtering allowed for document query");var n=this.filters.concat([e]);return new t(this.path,this.explicitOrderBy.slice(),n,this.limit,this.startAt,this.endAt)},t.prototype.addOrderBy=function(e){c(!ce.isDocumentKey(this.path),"No ordering allowed for document query"),c(!this.startAt&&!this.endAt,"Bounds must be set after orderBy");var n=this.explicitOrderBy.concat([e]);return new t(this.path,n,this.filters.slice(),this.limit,this.startAt,this.endAt)},t.prototype.withLimit=function(e){return new t(this.path,this.explicitOrderBy.slice(),this.filters.slice(),e,this.startAt,this.endAt)},t.prototype.withStartAt=function(e){return new t(this.path,this.explicitOrderBy.slice(),this.filters.slice(),this.limit,e,this.endAt)},t.prototype.withEndAt=function(e){return new t(this.path,this.explicitOrderBy.slice(),this.filters.slice(),this.limit,this.startAt,e)},t.prototype.canonicalId=function(){if(null===this.memoizedCanonicalId){var t=this.path.canonicalString();t+="|f:";for(var e=0,n=this.filters;e<n.length;e++){t+=n[e].canonicalId(),t+=","}t+="|ob:";for(var r=0,i=this.orderBy;r<i.length;r++){t+=i[r].canonicalId(),t+=","}F(this.limit)||(t+="|l:",t+=this.limit),this.startAt&&(t+="|lb:",t+=this.startAt.canonicalId()),this.endAt&&(t+="|ub:",t+=this.endAt.canonicalId()),this.memoizedCanonicalId=t}return this.memoizedCanonicalId},t.prototype.toString=function(){var t="Query("+this.path.canonicalString();return this.filters.length>0&&(t+=", filters: ["+this.filters.join(", ")+"]"),F(this.limit)||(t+=", limit: "+this.limit),this.explicitOrderBy.length>0&&(t+=", orderBy: ["+this.explicitOrderBy.join(", ")+"]"),this.startAt&&(t+=", startAt: "+this.startAt.canonicalId()),this.endAt&&(t+=", endAt: "+this.endAt.canonicalId()),t+")"},t.prototype.isEqual=function(t){if(this.limit!==t.limit)return!1;if(this.orderBy.length!==t.orderBy.length)return!1;for(var e=0;e<this.orderBy.length;e++)if(!this.orderBy[e].isEqual(t.orderBy[e]))return!1;if(this.filters.length!==t.filters.length)return!1;for(e=0;e<this.filters.length;e++)if(!this.filters[e].isEqual(t.filters[e]))return!1;return!!this.path.isEqual(t.path)&&(!(null!==this.startAt?!this.startAt.isEqual(t.startAt):null!==t.startAt)&&(null!==this.endAt?this.endAt.isEqual(t.endAt):null===t.endAt))},t.prototype.docComparator=function(t,e){for(var n=!1,r=0,i=this.orderBy;r<i.length;r++){var o=i[r],s=o.compare(t,e);if(0!==s)return s;n=n||o.field.isKeyField()}return c(n,"orderBy used that doesn't compare on key field"),0},t.prototype.matches=function(t){return this.matchesAncestor(t)&&this.matchesOrderBy(t)&&this.matchesFilters(t)&&this.matchesBounds(t)},t.prototype.hasLimit=function(){return!F(this.limit)},t.prototype.getFirstOrderByField=function(){return this.explicitOrderBy.length>0?this.explicitOrderBy[0].field:null},t.prototype.getInequalityFilterField=function(){for(var t=0,e=this.filters;t<e.length;t++){var n=e[t];if(n instanceof je&&n.isInequality())return n.field}return null},t.prototype.hasArrayContainsFilter=function(){return void 0!==this.filters.find(function(t){return t instanceof je&&t.op===Ke.ARRAY_CONTAINS})},t.prototype.isDocumentQuery=function(){return ce.isDocumentKey(this.path)&&0===this.filters.length},t.prototype.matchesAncestor=function(t){var e=t.key.path;return ce.isDocumentKey(this.path)?this.path.isEqual(e):this.path.isPrefixOf(e)&&this.path.length===e.length-1},t.prototype.matchesOrderBy=function(t){for(var e=0,n=this.explicitOrderBy;e<n.length;e++){var r=n[e];if(!r.field.isKeyField()&&void 0===t.field(r.field))return!1}return!0},t.prototype.matchesFilters=function(t){for(var e=0,n=this.filters;e<n.length;e++){if(!n[e].matches(t))return!1}return!0},t.prototype.matchesBounds=function(t){return!(this.startAt&&!this.startAt.sortsBeforeDocument(this.orderBy,t))&&(!this.endAt||!this.endAt.sortsBeforeDocument(this.orderBy,t))},t.prototype.assertValidBound=function(t){c(t.position.length<=this.orderBy.length,"Bound is longer than orderBy")},t}(),Ve=function(){function t(){}return t.create=function(t,e,n){if(n.isEqual(Te.INSTANCE)){if(e!==Ke.EQUAL)throw new Yt(Xt.INVALID_ARGUMENT,"Invalid query. You can only perform equals comparisons on null.");return new We(t)}if(n.isEqual(De.NAN)){if(e!==Ke.EQUAL)throw new Yt(Xt.INVALID_ARGUMENT,"Invalid query. You can only perform equals comparisons on NaN.");return new Qe(t)}return new je(t,e,n)},t}(),Ke=function(){function t(t){this.name=t}return t.fromString=function(e){switch(e){case"<":return t.LESS_THAN;case"<=":return t.LESS_THAN_OR_EQUAL;case"==":return t.EQUAL;case">=":return t.GREATER_THAN_OR_EQUAL;case">":return t.GREATER_THAN;case"array-contains":return t.ARRAY_CONTAINS;default:return u("Unknown relation: "+e)}},t.prototype.toString=function(){return this.name},t.prototype.isEqual=function(t){return this.name===t.name},t.LESS_THAN=new t("<"),t.LESS_THAN_OR_EQUAL=new t("<="),t.EQUAL=new t("=="),t.GREATER_THAN=new t(">"),t.GREATER_THAN_OR_EQUAL=new t(">="),t.ARRAY_CONTAINS=new t("array-contains"),t}(),je=function(t){function e(e,n,r){var i=t.call(this)||this;return i.field=e,i.op=n,i.value=r,i}return jt.__extends(e,t),e.prototype.matches=function(t){if(this.field.isKeyField()){c(this.value instanceof Oe,"Comparing on key, but filter value not a RefValue"),c(this.op!==Ke.ARRAY_CONTAINS,"array-contains queries don't make sense on document keys.");var e=ce.comparator(t.key,this.value.key);return this.matchesComparison(e)}var n=t.field(this.field);return void 0!==n&&this.matchesValue(n)},e.prototype.matchesValue=function(t){var e=this;return this.op===Ke.ARRAY_CONTAINS?t instanceof Le&&void 0!==t.internalValue.find(function(t){return t.isEqual(e.value)}):this.value.typeOrder===t.typeOrder&&this.matchesComparison(t.compareTo(this.value))},e.prototype.matchesComparison=function(t){switch(this.op){case Ke.LESS_THAN:return t<0;case Ke.LESS_THAN_OR_EQUAL:return t<=0;case Ke.EQUAL:return 0===t;case Ke.GREATER_THAN:return t>0;case Ke.GREATER_THAN_OR_EQUAL:return t>=0;default:return u("Unknown relation op"+this.op)}},e.prototype.isInequality=function(){return this.op!==Ke.EQUAL&&this.op!==Ke.ARRAY_CONTAINS},e.prototype.canonicalId=function(){return this.field.canonicalString()+this.op.toString()+this.value.toString()},e.prototype.isEqual=function(t){return t instanceof e&&(this.op.isEqual(t.op)&&this.field.isEqual(t.field)&&this.value.isEqual(t.value))},e.prototype.toString=function(){return this.field.canonicalString()+" "+this.op+" "+this.value.value()},e}(Ve),We=function(t){function e(e){var n=t.call(this)||this;return n.field=e,n}return jt.__extends(e,t),e.prototype.matches=function(t){var e=t.field(this.field);return void 0!==e&&null===e.value()},e.prototype.canonicalId=function(){return this.field.canonicalString()+" IS null"},e.prototype.toString=function(){return this.field.canonicalString()+" IS null"},e.prototype.isEqual=function(t){return t instanceof e&&this.field.isEqual(t.field)},e}(Ve),Qe=function(t){function e(e){var n=t.call(this)||this;return n.field=e,n}return jt.__extends(e,t),e.prototype.matches=function(t){var e=t.field(this.field),n=e&&e.value();return"number"==typeof n&&isNaN(n)},e.prototype.canonicalId=function(){return this.field.canonicalString()+" IS NaN"},e.prototype.toString=function(){return this.field.canonicalString()+" IS NaN"},e.prototype.isEqual=function(t){return t instanceof e&&this.field.isEqual(t.field)},e}(Ve),Ge=function(){function t(t){this.name=t}return t.prototype.toString=function(){return this.name},t.ASCENDING=new t("asc"),t.DESCENDING=new t("desc"),t}(),ze=function(){function t(t,e){this.position=t,this.before=e}return t.prototype.canonicalId=function(){for(var t=this.before?"b:":"a:",e=0,n=this.position;e<n.length;e++){t+=n[e].toString()}return t},t.prototype.sortsBeforeDocument=function(t,e){c(this.position.length<=t.length,"Bound has more components than query's orderBy");for(var n=0,r=0;r<this.position.length;r++){var i=t[r],o=this.position[r];if(i.field.isKeyField())c(o instanceof Oe,"Bound has a non-key value where the key path is being used."),n=ce.comparator(o.key,e.key);else{var s=e.field(i.field);c(void 0!==s,"Field should exist since document matched the orderBy already."),n=o.compareTo(s)}if(i.dir===Ge.DESCENDING&&(n*=-1),0!==n)break}return this.before?n<=0:n<0},t.prototype.isEqual=function(t){if(null===t)return!1;if(this.before!==t.before||this.position.length!==t.position.length)return!1;for(var e=0;e<this.position.length;e++){return this.position[e].isEqual(t.position[e])}return!0},t}(),He=function(){function t(t,e){this.field=t,void 0===e&&(e=Ge.ASCENDING),this.dir=e,this.isKeyOrderBy=t.isKeyField()}return t.prototype.compare=function(t,e){var n=this.isKeyOrderBy?le.compareByKey(t,e):le.compareByField(this.field,t,e);switch(this.dir){case Ge.ASCENDING:return n;case Ge.DESCENDING:return-1*n;default:return u("Unknown direction: "+this.dir)}},t.prototype.canonicalId=function(){return this.field.canonicalString()+this.dir.toString()},t.prototype.toString=function(){return this.field.canonicalString()+" ("+this.dir+")"},t.prototype.isEqual=function(t){return this.dir===t.dir&&this.field.isEqual(t.field)},t}(),Xe=new He(ue.keyField(),Ge.ASCENDING),Ye=new He(ue.keyField(),Ge.DESCENDING),Je=function(){function t(t){this.timestamp=t}return t.fromMicroseconds=function(e){var n=Math.floor(e/1e6);return new t(new ee(n,e%1e6*1e3))},t.fromTimestamp=function(e){return new t(e)},t.forDeletedDoc=function(){return t.MIN},t.prototype.compareTo=function(t){return this.timestamp._compareTo(t.timestamp)},t.prototype.isEqual=function(t){return this.timestamp.isEqual(t.timestamp)},t.prototype.toMicroseconds=function(){return 1e6*this.timestamp.seconds+this.timestamp.nanoseconds/1e3},t.prototype.toString=function(){return"SnapshotVersion("+this.timestamp.toString()+")"},t.prototype.toTimestamp=function(){return this.timestamp},t.MIN=new t(new ee(0,0)),t}();!function(t){t[t.Listen=0]="Listen",t[t.ExistenceFilterMismatch=1]="ExistenceFilterMismatch",t[t.LimboResolution=2]="LimboResolution"}(_e||(_e={}));var Ze,$e=function(){function t(t,e,n,r,i,o){void 0===i&&(i=Je.MIN),void 0===o&&(o=h()),this.query=t,this.targetId=e,this.purpose=n,this.sequenceNumber=r,this.snapshotVersion=i,this.resumeToken=o}return t.prototype.copy=function(e){return new t(this.query,this.targetId,this.purpose,void 0===e.sequenceNumber?this.sequenceNumber:e.sequenceNumber,void 0===e.snapshotVersion?this.snapshotVersion:e.snapshotVersion,void 0===e.resumeToken?this.resumeToken:e.resumeToken)},t.prototype.isEqual=function(t){return this.targetId===t.targetId&&this.purpose===t.purpose&&this.sequenceNumber===t.sequenceNumber&&this.snapshotVersion.isEqual(t.snapshotVersion)&&this.resumeToken===t.resumeToken&&this.query.isEqual(t.query)},t}(),tn=function(){function t(t){this.comparator=t,this.data=new pe(this.comparator)}return t.fromMapKeys=function(e){var n=new t(e.comparator);return e.forEach(function(t){n=n.add(t)}),n},t.prototype.has=function(t){return null!==this.data.get(t)},t.prototype.first=function(){return this.data.minKey()},t.prototype.last=function(){return this.data.maxKey()},Object.defineProperty(t.prototype,"size",{get:function(){return this.data.size},enumerable:!0,configurable:!0}),t.prototype.indexOf=function(t){return this.data.indexOf(t)},t.prototype.forEach=function(t){this.data.inorderTraversal(function(e,n){return t(e),!1})},t.prototype.forEachInRange=function(t,e){for(var n=this.data.getIteratorFrom(t[0]);n.hasNext();){var r=n.getNext();if(this.comparator(r.key,t[1])>=0)return;e(r.key)}},t.prototype.forEachWhile=function(t,e){var n;for(n=void 0!==e?this.data.getIteratorFrom(e):this.data.getIterator();n.hasNext();){if(!t(n.getNext().key))return}},t.prototype.firstAfterOrEqual=function(t){var e=this.data.getIteratorFrom(t);return e.hasNext()?e.getNext().key:null},t.prototype.getIterator=function(){return new en(this.data.getIterator())},t.prototype.getIteratorFrom=function(t){return new en(this.data.getIteratorFrom(t))},t.prototype.add=function(t){return this.copy(this.data.remove(t).insert(t,!0))},t.prototype.delete=function(t){return this.has(t)?this.copy(this.data.remove(t)):this},t.prototype.isEmpty=function(){return this.data.isEmpty()},t.prototype.unionWith=function(t){var e=this;return t.forEach(function(t){e=e.add(t)}),e},t.prototype.isEqual=function(e){if(!(e instanceof t))return!1;if(this.size!==e.size)return!1;for(var n=this.data.getIterator(),r=e.data.getIterator();n.hasNext();){var i=n.getNext().key,o=r.getNext().key;if(0!==this.comparator(i,o))return!1}return!0},t.prototype.toArray=function(){var t=[];return this.forEach(function(e){t.push(e)}),t},t.prototype.toString=function(){var t=[];return this.forEach(function(e){return t.push(e)}),"SortedSet("+t.toString()+")"},t.prototype.copy=function(e){var n=new t(this.comparator);return n.data=e,n},t}(),en=function(){function t(t){this.iter=t}return t.prototype.getNext=function(){return this.iter.getNext().key},t.prototype.hasNext=function(){return this.iter.hasNext()},t}(),nn=function(){function t(t){this.fields=t}return t.fromSet=function(e){return new t(e)},t.fromArray=function(e){var n=new tn(ue.comparator);return e.forEach(function(t){return n=n.add(t)}),new t(n)},t.prototype.covers=function(t){var e=!1;return this.fields.forEach(function(n){n.isPrefixOf(t)&&(e=!0)}),e},t.prototype.isEqual=function(t){return this.fields.isEqual(t.fields)},t}(),rn=function(){function t(t,e){this.field=t,this.transform=e}return t.prototype.isEqual=function(t){return this.field.isEqual(t.field)&&this.transform.isEqual(t.transform)},t}(),on=function(){return function(t,e){this.version=t,this.transformResults=e}}();!function(t){t[t.Set=0]="Set",t[t.Patch=1]="Patch",t[t.Transform=2]="Transform",t[t.Delete=3]="Delete"}(Ze||(Ze={}));var sn,an=function(){function t(t,e){this.updateTime=t,this.exists=e,c(void 0===t||void 0===e,'Precondition can specify "exists" or "updateTime" but not both')}return t.exists=function(e){return new t(void 0,e)},t.updateTime=function(e){return new t(e)},Object.defineProperty(t.prototype,"isNone",{get:function(){return void 0===this.updateTime&&void 0===this.exists},enumerable:!0,configurable:!0}),t.prototype.isValidFor=function(t){return void 0!==this.updateTime?t instanceof le&&t.version.isEqual(this.updateTime):void 0!==this.exists?this.exists===t instanceof le:(c(this.isNone,"Precondition should be empty"),!0)},t.prototype.isEqual=function(t){return function(t,e){return null!==t&&void 0!==t?!(!e||!t.isEqual(e)):t===e}(this.updateTime,t.updateTime)&&this.exists===t.exists},t.NONE=new t,t}(),un=function(){function t(){}return t.prototype.verifyKeyMatches=function(t){null!=t&&c(t.key.isEqual(this.key),"Can only apply a mutation to a document with the same key")},t.getPostMutationVersion=function(t){return t instanceof le?t.version:Je.MIN},t}(),cn=function(t){function e(e,n,r){var i=t.call(this)||this;return i.key=e,i.value=n,i.precondition=r,i.type=Ze.Set,i}return jt.__extends(e,t),e.prototype.applyToRemoteDocument=function(t,e){this.verifyKeyMatches(t),c(null==e.transformResults,"Transform results received by SetMutation.");return new le(this.key,e.version,this.value,{hasCommittedMutations:!0})},e.prototype.applyToLocalView=function(t,e,n){if(this.verifyKeyMatches(t),!this.precondition.isValidFor(t))return t;var r=un.getPostMutationVersion(t);return new le(this.key,r,this.value,{hasLocalMutations:!0})},e.prototype.isEqual=function(t){return t instanceof e&&this.key.isEqual(t.key)&&this.value.isEqual(t.value)&&this.precondition.isEqual(t.precondition)},e}(un),hn=function(t){function e(e,n,r,i){var o=t.call(this)||this;return o.key=e,o.data=n,o.fieldMask=r,o.precondition=i,o.type=Ze.Patch,o}return jt.__extends(e,t),e.prototype.applyToRemoteDocument=function(t,e){if(this.verifyKeyMatches(t),c(null==e.transformResults,"Transform results received by PatchMutation."),!this.precondition.isValidFor(t))return new de(this.key,e.version);var n=this.patchDocument(t);return new le(this.key,e.version,n,{hasCommittedMutations:!0})},e.prototype.applyToLocalView=function(t,e,n){if(this.verifyKeyMatches(t),!this.precondition.isValidFor(t))return t;var r=un.getPostMutationVersion(t),i=this.patchDocument(t);return new le(this.key,r,i,{hasLocalMutations:!0})},e.prototype.isEqual=function(t){return t instanceof e&&this.key.isEqual(t.key)&&this.fieldMask.isEqual(t.fieldMask)&&this.precondition.isEqual(t.precondition)},e.prototype.patchDocument=function(t){var e;return e=t instanceof le?t.data:Me.EMPTY,this.patchObject(e)},e.prototype.patchObject=function(t){var e=this;return this.fieldMask.fields.forEach(function(n){if(!n.isEmpty()){var r=e.data.field(n);t=void 0!==r?t.set(n,r):t.delete(n)}}),t},e}(un),ln=function(t){function e(e,n){var r=t.call(this)||this;return r.key=e,r.fieldTransforms=n,r.type=Ze.Transform,r.precondition=an.exists(!0),r}return jt.__extends(e,t),e.prototype.applyToRemoteDocument=function(t,e){if(this.verifyKeyMatches(t),c(null!=e.transformResults,"Transform results missing for TransformMutation."),!this.precondition.isValidFor(t))return new de(this.key,e.version);var n=this.requireDocument(t),r=this.serverTransformResults(t,e.transformResults),i=e.version,o=this.transformObject(n.data,r);return new le(this.key,i,o,{hasCommittedMutations:!0})},e.prototype.applyToLocalView=function(t,e,n){if(this.verifyKeyMatches(t),!this.precondition.isValidFor(t))return t;var r=this.requireDocument(t),i=this.localTransformResults(n,e),o=this.transformObject(r.data,i);return new le(this.key,r.version,o,{hasLocalMutations:!0})},e.prototype.isEqual=function(t){return t instanceof e&&this.key.isEqual(t.key)&&L(this.fieldTransforms,t.fieldTransforms)&&this.precondition.isEqual(t.precondition)},e.prototype.requireDocument=function(t){c(t instanceof le,"Unknown MaybeDocument type "+t);var e=t;return c(e.key.isEqual(this.key),"Can only transform a document with the same key"),e},e.prototype.serverTransformResults=function(t,e){var n=[];c(this.fieldTransforms.length===e.length,"server transform result count ("+e.length+") should match field transform count ("+this.fieldTransforms.length+")");for(var r=0;r<e.length;r++){var i=this.fieldTransforms[r],o=i.transform,s=null;t instanceof le&&(s=t.field(i.field)||null),n.push(o.applyToRemoteDocument(s,e[r]))}return n},e.prototype.localTransformResults=function(t,e){for(var n=[],r=0,i=this.fieldTransforms;r<i.length;r++){var o=i[r],s=o.transform,a=null;e instanceof le&&(a=e.field(o.field)||null),n.push(s.applyToLocalView(a,t))}return n},e.prototype.transformObject=function(t,e){c(e.length===this.fieldTransforms.length,"TransformResults length mismatch.");for(var n=0;n<this.fieldTransforms.length;n++){t=t.set(this.fieldTransforms[n].field,e[n])}return t},e}(un),fn=function(t){function e(e,n){var r=t.call(this)||this;return r.key=e,r.precondition=n,r.type=Ze.Delete,r}return jt.__extends(e,t),e.prototype.applyToRemoteDocument=function(t,e){return this.verifyKeyMatches(t),c(null==e.transformResults,"Transform results received by DeleteMutation."),new fe(this.key,e.version,{hasCommittedMutations:!0})},e.prototype.applyToLocalView=function(t,e,n){return this.verifyKeyMatches(t),this.precondition.isValidFor(t)?(t&&c(t.key.isEqual(this.key),"Can only apply mutation to document with same key"),new fe(this.key,Je.forDeletedDoc())):t},e.prototype.isEqual=function(t){return t instanceof e&&this.key.isEqual(t.key)&&this.precondition.isEqual(t.precondition)},e}(un),dn=function(){function t(){}return t.prototype.applyToLocalView=function(t,e){return new ke(e,t)},t.prototype.applyToRemoteDocument=function(t,e){return e},t.prototype.isEqual=function(e){return e instanceof t},t.instance=new t,t}(),pn=function(){function t(t){this.elements=t}return t.prototype.applyToLocalView=function(t,e){return this.apply(t)},t.prototype.applyToRemoteDocument=function(t,e){return this.apply(t)},t.prototype.apply=function(t){for(var e=V(t),n=function(t){e.find(function(e){return e.isEqual(t)})||e.push(t)},r=0,i=this.elements;r<i.length;r++){n(i[r])}return new Le(e)},t.prototype.isEqual=function(e){return e instanceof t&&L(e.elements,this.elements)},t}(),mn=function(){function t(t){this.elements=t}return t.prototype.applyToLocalView=function(t,e){return this.apply(t)},t.prototype.applyToRemoteDocument=function(t,e){return this.apply(t)},t.prototype.apply=function(t){for(var e=V(t),n=function(t){e=e.filter(function(e){return!e.isEqual(t)})},r=0,i=this.elements;r<i.length;r++){n(i[r])}return new Le(e)},t.prototype.isEqual=function(e){return e instanceof t&&L(e.elements,this.elements)},t}(),yn=function(){function t(t){this.count=t}return t.prototype.isEqual=function(t){return t&&t.count===this.count},t}();!function(t){t[t.OK=0]="OK",t[t.CANCELLED=1]="CANCELLED",t[t.UNKNOWN=2]="UNKNOWN",t[t.INVALID_ARGUMENT=3]="INVALID_ARGUMENT",t[t.DEADLINE_EXCEEDED=4]="DEADLINE_EXCEEDED",t[t.NOT_FOUND=5]="NOT_FOUND",t[t.ALREADY_EXISTS=6]="ALREADY_EXISTS",t[t.PERMISSION_DENIED=7]="PERMISSION_DENIED",t[t.UNAUTHENTICATED=16]="UNAUTHENTICATED",t[t.RESOURCE_EXHAUSTED=8]="RESOURCE_EXHAUSTED",t[t.FAILED_PRECONDITION=9]="FAILED_PRECONDITION",t[t.ABORTED=10]="ABORTED",t[t.OUT_OF_RANGE=11]="OUT_OF_RANGE",t[t.UNIMPLEMENTED=12]="UNIMPLEMENTED",t[t.INTERNAL=13]="INTERNAL",t[t.UNAVAILABLE=14]="UNAVAILABLE",t[t.DATA_LOSS=15]="DATA_LOSS"}(sn||(sn={}));var gn,vn=new pe(ce.comparator),bn=new pe(ce.comparator),_n=new pe(ce.comparator),wn=new tn(ce.comparator),En=new tn(M),Tn=function(){function t(t){this.comparator=t?function(e,n){return t(e,n)||ce.comparator(e.key,n.key)}:function(t,e){return ce.comparator(t.key,e.key)},this.keyedMap=G(),this.sortedSet=new pe(this.comparator)}return t.emptySet=function(e){return new t(e.comparator)},t.prototype.has=function(t){return null!=this.keyedMap.get(t)},t.prototype.get=function(t){return this.keyedMap.get(t)},t.prototype.first=function(){return this.sortedSet.minKey()},t.prototype.last=function(){return this.sortedSet.maxKey()},t.prototype.isEmpty=function(){return this.sortedSet.isEmpty()},t.prototype.indexOf=function(t){var e=this.keyedMap.get(t);return e?this.sortedSet.indexOf(e):-1},Object.defineProperty(t.prototype,"size",{get:function(){return this.sortedSet.size},enumerable:!0,configurable:!0}),t.prototype.forEach=function(t){this.sortedSet.inorderTraversal(function(e,n){return t(e),!1})},t.prototype.add=function(t){var e=this.delete(t.key);return e.copy(e.keyedMap.insert(t.key,t),e.sortedSet.insert(t,null))},t.prototype.delete=function(t){var e=this.get(t);return e?this.copy(this.keyedMap.remove(t),this.sortedSet.remove(e)):this},t.prototype.isEqual=function(e){if(!(e instanceof t))return!1;if(this.size!==e.size)return!1;for(var n=this.sortedSet.getIterator(),r=e.sortedSet.getIterator();n.hasNext();){var i=n.getNext().key,o=r.getNext().key;if(!i.isEqual(o))return!1}return!0},t.prototype.toString=function(){var t=[];return this.forEach(function(e){t.push(e.toString())}),0===t.length?"DocumentSet ()":"DocumentSet (\n  "+t.join("  \n")+"\n)"},t.prototype.copy=function(e,n){var r=new t;return r.comparator=this.comparator,r.keyedMap=e,r.sortedSet=n,r},t}();!function(t){t[t.Added=0]="Added",t[t.Removed=1]="Removed",t[t.Modified=2]="Modified",t[t.Metadata=3]="Metadata"}(gn||(gn={}));var Sn;!function(t){t[t.Local=0]="Local",t[t.Synced=1]="Synced"}(Sn||(Sn={}));var In,Cn=function(){function t(){this.changeMap=new pe(ce.comparator)}return t.prototype.track=function(t){var e=t.doc.key,n=this.changeMap.get(e);n?t.type!==gn.Added&&n.type===gn.Metadata?this.changeMap=this.changeMap.insert(e,t):t.type===gn.Metadata&&n.type!==gn.Removed?this.changeMap=this.changeMap.insert(e,{type:n.type,doc:t.doc}):t.type===gn.Modified&&n.type===gn.Modified?this.changeMap=this.changeMap.insert(e,{type:gn.Modified,doc:t.doc}):t.type===gn.Modified&&n.type===gn.Added?this.changeMap=this.changeMap.insert(e,{type:gn.Added,doc:t.doc}):t.type===gn.Removed&&n.type===gn.Added?this.changeMap=this.changeMap.remove(e):t.type===gn.Removed&&n.type===gn.Modified?this.changeMap=this.changeMap.insert(e,{type:gn.Removed,doc:n.doc}):t.type===gn.Added&&n.type===gn.Removed?this.changeMap=this.changeMap.insert(e,{type:gn.Modified,doc:t.doc}):u("unsupported combination of changes: "+JSON.stringify(t)+" after "+JSON.stringify(n)):this.changeMap=this.changeMap.insert(e,t)},t.prototype.getChanges=function(){var t=[];return this.changeMap.inorderTraversal(function(e,n){t.push(n)}),t},t}(),Dn=function(){function t(t,e,n,r,i,o,s,a){this.query=t,this.docs=e,this.oldDocs=n,this.docChanges=r,this.mutatedKeys=i,this.fromCache=o,this.syncStateChanged=s,this.excludesMetadataChanges=a}return t.fromInitialDocuments=function(e,n,r,i){var o=[];return n.forEach(function(t){o.push({type:gn.Added,doc:t})}),new t(e,n,Tn.emptySet(n),o,r,i,!0,!1)},Object.defineProperty(t.prototype,"hasPendingWrites",{get:function(){return!this.mutatedKeys.isEmpty()},enumerable:!0,configurable:!0}),t.prototype.isEqual=function(t){if(!(this.fromCache===t.fromCache&&this.syncStateChanged===t.syncStateChanged&&this.mutatedKeys.isEqual(t.mutatedKeys)&&this.query.isEqual(t.query)&&this.docs.isEqual(t.docs)&&this.oldDocs.isEqual(t.oldDocs)))return!1;var e=this.docChanges,n=t.docChanges;if(e.length!==n.length)return!1;for(var r=0;r<e.length;r++)if(e[r].type!==n[r].type||!e[r].doc.isEqual(n[r].doc))return!1;return!0},t}(),Nn=function(){function t(t,e,n,r,i){this.snapshotVersion=t,this.targetChanges=e,this.targetMismatches=n,this.documentUpdates=r,this.resolvedLimboDocuments=i}return t.createSynthesizedRemoteEventForCurrentChange=function(e,n){var r=(i={},i[e]=An.createSynthesizedTargetChangeForCurrentChange(e,n),i);return new t(Je.MIN,r,X(),W(),H());var i},t}(),An=function(){function t(t,e,n,r,i){this.resumeToken=t,this.current=e,this.addedDocuments=n,this.modifiedDocuments=r,this.removedDocuments=i}return t.createSynthesizedTargetChangeForCurrentChange=function(e,n){return new t(h(),n,H(),H(),H())},t}(),kn=function(){return function(t,e,n,r){this.updatedTargetIds=t,this.removedTargetIds=e,this.key=n,this.newDoc=r}}(),Rn=function(){return function(t,e){this.targetId=t,this.existenceFilter=e}}();!function(t){t[t.NoChange=0]="NoChange",t[t.Added=1]="Added",t[t.Removed=2]="Removed",t[t.Current=3]="Current",t[t.Reset=4]="Reset"}(In||(In={}));var On=function(){return function(t,e,n,r){void 0===n&&(n=h()),void 0===r&&(r=null),this.state=t,this.targetIds=e,this.resumeToken=n,this.cause=r}}(),Pn=function(){function t(){this.pendingResponses=0,this.documentChanges=J(),this._resumeToken=h(),this._current=!1,this._hasPendingChanges=!0}return Object.defineProperty(t.prototype,"current",{get:function(){return this._current},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"resumeToken",{get:function(){return this._resumeToken},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"isPending",{get:function(){return 0!==this.pendingResponses},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"hasPendingChanges",{get:function(){return this._hasPendingChanges},enumerable:!0,configurable:!0}),t.prototype.updateResumeToken=function(t){t.length>0&&(this._hasPendingChanges=!0,this._resumeToken=t)},t.prototype.toTargetChange=function(){var t=H(),e=H(),n=H();return this.documentChanges.forEach(function(r,i){switch(i){case gn.Added:t=t.add(r);break;case gn.Modified:e=e.add(r);break;case gn.Removed:n=n.add(r);break;default:u("Encountered invalid change type: "+i)}}),new An(this._resumeToken,this._current,t,e,n)},t.prototype.clearPendingChanges=function(){this._hasPendingChanges=!1,this.documentChanges=J()},t.prototype.addDocumentChange=function(t,e){this._hasPendingChanges=!0,this.documentChanges=this.documentChanges.insert(t,e)},t.prototype.removeDocumentChange=function(t){this._hasPendingChanges=!0,this.documentChanges=this.documentChanges.remove(t)},t.prototype.recordPendingTargetRequest=function(){this.pendingResponses+=1},t.prototype.recordTargetResponse=function(){this.pendingResponses-=1},t.prototype.markCurrent=function(){this._hasPendingChanges=!0,this._current=!0},t}(),Mn=function(){function t(t){this.metadataProvider=t,this.targetStates={},this.pendingDocumentUpdates=W(),this.pendingDocumentTargetMapping=Y(),this.pendingTargetResets=new tn(M)}return t.prototype.handleDocumentChange=function(t){for(var e=0,n=t.updatedTargetIds;e<n.length;e++){var r=n[e];t.newDoc instanceof le?this.addDocumentToTarget(r,t.newDoc):t.newDoc instanceof fe&&this.removeDocumentFromTarget(r,t.key,t.newDoc)}for(var i=0,o=t.removedTargetIds;i<o.length;i++){this.removeDocumentFromTarget(r=o[i],t.key,t.newDoc)}},t.prototype.handleTargetChange=function(t){var e=this;this.forEachTarget(t,function(n){var r=e.ensureTargetState(n);switch(t.state){case In.NoChange:e.isActiveTarget(n)&&r.updateResumeToken(t.resumeToken);break;case In.Added:r.recordTargetResponse(),r.isPending||r.clearPendingChanges(),r.updateResumeToken(t.resumeToken);break;case In.Removed:r.recordTargetResponse(),r.isPending||e.removeTarget(n),c(!t.cause,"WatchChangeAggregator does not handle errored targets");break;case In.Current:e.isActiveTarget(n)&&(r.markCurrent(),r.updateResumeToken(t.resumeToken));break;case In.Reset:e.isActiveTarget(n)&&(e.resetTarget(n),r.updateResumeToken(t.resumeToken));break;default:u("Unknown target watch change state: "+t.state)}})},t.prototype.forEachTarget=function(t,e){t.targetIds.length>0?t.targetIds.forEach(e):p(this.targetStates,e)},t.prototype.handleExistenceFilter=function(t){var e=t.targetId,n=t.existenceFilter.count,r=this.queryDataForActiveTarget(e);if(r){var i=r.query;if(i.isDocumentQuery())if(0===n){var o=new ce(i.path);this.removeDocumentFromTarget(e,o,new fe(o,Je.forDeletedDoc()))}else c(1===n,"Single document existence filter with count: "+n);else{this.getCurrentDocumentCountForTarget(e)!==n&&(this.resetTarget(e),this.pendingTargetResets=this.pendingTargetResets.add(e))}}},t.prototype.createRemoteEvent=function(t){var e=this,n={};p(this.targetStates,function(r,i){var o=e.queryDataForActiveTarget(r);if(o){if(i.current&&o.query.isDocumentQuery()){var s=new ce(o.query.path);null!==e.pendingDocumentUpdates.get(s)||e.targetContainsDocument(r,s)||e.removeDocumentFromTarget(r,s,new fe(s,t))}i.hasPendingChanges&&(n[r]=i.toTargetChange(),i.clearPendingChanges())}});var r=H();this.pendingDocumentTargetMapping.forEach(function(t,n){var i=!0;n.forEachWhile(function(t){var n=e.queryDataForActiveTarget(t);return!n||n.purpose===_e.LimboResolution||(i=!1,!1)}),i&&(r=r.add(t))});var i=new Nn(t,n,this.pendingTargetResets,this.pendingDocumentUpdates,r);return this.pendingDocumentUpdates=W(),this.pendingDocumentTargetMapping=Y(),this.pendingTargetResets=new tn(M),i},t.prototype.addDocumentToTarget=function(t,e){if(this.isActiveTarget(t)){var n=this.targetContainsDocument(t,e.key)?gn.Modified:gn.Added;this.ensureTargetState(t).addDocumentChange(e.key,n),this.pendingDocumentUpdates=this.pendingDocumentUpdates.insert(e.key,e),this.pendingDocumentTargetMapping=this.pendingDocumentTargetMapping.insert(e.key,this.ensureDocumentTargetMapping(e.key).add(t))}},t.prototype.removeDocumentFromTarget=function(t,e,n){if(this.isActiveTarget(t)){var r=this.ensureTargetState(t);this.targetContainsDocument(t,e)?r.addDocumentChange(e,gn.Removed):r.removeDocumentChange(e),this.pendingDocumentTargetMapping=this.pendingDocumentTargetMapping.insert(e,this.ensureDocumentTargetMapping(e).delete(t)),n&&(this.pendingDocumentUpdates=this.pendingDocumentUpdates.insert(e,n))}},t.prototype.removeTarget=function(t){delete this.targetStates[t]},t.prototype.getCurrentDocumentCountForTarget=function(t){var e=this.ensureTargetState(t).toTargetChange();return this.metadataProvider.getRemoteKeysForTarget(t).size+e.addedDocuments.size-e.removedDocuments.size},t.prototype.recordPendingTargetRequest=function(t){this.ensureTargetState(t).recordPendingTargetRequest()},t.prototype.ensureTargetState=function(t){return this.targetStates[t]||(this.targetStates[t]=new Pn),this.targetStates[t]},t.prototype.ensureDocumentTargetMapping=function(t){var e=this.pendingDocumentTargetMapping.get(t);return e||(e=new tn(M),this.pendingDocumentTargetMapping=this.pendingDocumentTargetMapping.insert(t,e)),e},t.prototype.isActiveTarget=function(t){return null!==this.queryDataForActiveTarget(t)},t.prototype.queryDataForActiveTarget=function(t){var e=this.targetStates[t];return e&&e.isPending?null:this.metadataProvider.getQueryDataForTarget(t)},t.prototype.resetTarget=function(t){var e=this;c(!this.targetStates[t].isPending,"Should only reset active targets"),this.targetStates[t]=new Pn;this.metadataProvider.getRemoteKeysForTarget(t).forEach(function(n){e.removeDocumentFromTarget(t,n,null)})},t.prototype.targetContainsDocument=function(t,e){return this.metadataProvider.getRemoteKeysForTarget(t).has(e)},t}(),Ln=function(){var t={};return t[Ge.ASCENDING.name]="ASCENDING",t[Ge.DESCENDING.name]="DESCENDING",t}(),xn=function(){var t={};return t[Ke.LESS_THAN.name]="LESS_THAN",t[Ke.LESS_THAN_OR_EQUAL.name]="LESS_THAN_OR_EQUAL",t[Ke.GREATER_THAN.name]="GREATER_THAN",t[Ke.GREATER_THAN_OR_EQUAL.name]="GREATER_THAN_OR_EQUAL",t[Ke.EQUAL.name]="EQUAL",t[Ke.ARRAY_CONTAINS.name]="ARRAY_CONTAINS",t}(),Un=new RegExp(/^\d{4}-\d\d-\d\dT\d\d:\d\d:\d\d(?:\.(\d+))?Z$/),Bn=function(){function t(t,e){this.databaseId=t,this.options=e}return t.prototype.emptyByteString=function(){return this.options.useProto3Json?"":new Uint8Array(0)},t.prototype.unsafeCastProtoByteString=function(t){return t},t.prototype.fromRpcStatus=function(t){var e=void 0===t.code?Xt.UNKNOWN:j(t.code);return new Yt(e,t.message||"")},t.prototype.toInt32Value=function(t){return F(t)?void 0:{value:t}},t.prototype.fromInt32Value=function(t){var e;return e="object"==typeof t?t.value:t,F(e)?null:e},t.prototype.toTimestamp=function(t){return{seconds:t.seconds,nanos:t.nanoseconds}},t.prototype.fromTimestamp=function(t){if("string"==typeof t)return this.fromIso8601String(t);c(!!t,"Cannot deserialize null or undefined timestamp.");var e=$(t.seconds||"0");return new ee(e,t.nanos||0)},t.prototype.fromIso8601String=function(t){var e=0,n=Un.exec(t);if(c(!!n,"invalid timestamp: "+t),n[1]){var r=n[1];r=(r+"000000000").substr(0,9),e=Number(r)}var i=new Date(t),o=Math.floor(i.getTime()/1e3);return new ee(o,e)},t.prototype.toBytes=function(t){return this.options.useProto3Json?t.toBase64():this.unsafeCastProtoByteString(t.toUint8Array())},t.prototype.fromBlob=function(t){return"string"==typeof t?(c(this.options.useProto3Json,"Expected bytes to be passed in as Uint8Array, but got a string instead."),Zt.fromBase64String(t)):(c(!this.options.useProto3Json,"Expected bytes to be passed in as string, but got something else instead."),Zt.fromUint8Array(t))},t.prototype.toVersion=function(t){return this.toTimestamp(t.toTimestamp())},t.prototype.fromVersion=function(t){return c(!!t,"Trying to deserialize version that isn't set"),Je.fromTimestamp(this.fromTimestamp(t))},t.prototype.toResourceName=function(t,e){return this.fullyQualifiedPrefixPath(t).child("documents").child(e).canonicalString()},t.prototype.fromResourceName=function(t){var e=se.fromString(t);return c(this.isValidResourceName(e),"Tried to deserialize invalid key "+e.toString()),e},t.prototype.toName=function(t){return this.toResourceName(this.databaseId,t.path)},t.prototype.fromName=function(t){var e=this.fromResourceName(t);return c(e.get(1)===this.databaseId.projectId,"Tried to deserialize key from different project: "+e.get(1)+" vs "+this.databaseId.projectId),c(!e.get(3)&&!this.databaseId.database||e.get(3)===this.databaseId.database,"Tried to deserialize key from different database: "+e.get(3)+" vs "+this.databaseId.database),new ce(this.extractLocalPathFromResourceName(e))},t.prototype.toQueryPath=function(t){return 0===t.length?this.encodedDatabaseId:this.toResourceName(this.databaseId,t)},t.prototype.fromQueryPath=function(t){var e=this.fromResourceName(t);return 4===e.length?se.EMPTY_PATH:this.extractLocalPathFromResourceName(e)},Object.defineProperty(t.prototype,"encodedDatabaseId",{get:function(){return new se(["projects",this.databaseId.projectId,"databases",this.databaseId.database]).canonicalString()},enumerable:!0,configurable:!0}),t.prototype.fullyQualifiedPrefixPath=function(t){return new se(["projects",t.projectId,"databases",t.database])},t.prototype.extractLocalPathFromResourceName=function(t){return c(t.length>4&&"documents"===t.get(4),"tried to deserialize invalid key "+t.toString()),t.popFirst(5)},t.prototype.isValidResourceName=function(t){return t.length>=4&&"projects"===t.get(0)&&"databases"===t.get(2)},t.prototype.toValue=function(t){if(t instanceof Te)return{nullValue:"NULL_VALUE"};if(t instanceof Se)return{booleanValue:t.value()};if(t instanceof Ce)return{integerValue:""+t.value()};if(t instanceof De){var e=t.value();if(this.options.useProto3Json){if(isNaN(e))return{doubleValue:"NaN"};if(e===1/0)return{doubleValue:"Infinity"};if(e===-1/0)return{doubleValue:"-Infinity"}}return{doubleValue:t.value()}}return t instanceof Ne?{stringValue:t.value()}:t instanceof Me?{mapValue:this.toMapValue(t)}:t instanceof Le?{arrayValue:this.toArrayValue(t)}:t instanceof Ae?{timestampValue:this.toTimestamp(t.internalValue)}:t instanceof Pe?{geoPointValue:{latitude:t.value().latitude,longitude:t.value().longitude}}:t instanceof Re?{bytesValue:this.toBytes(t.value())}:t instanceof Oe?{referenceValue:this.toResourceName(t.databaseId,t.key.path)}:u("Unknown FieldValue "+JSON.stringify(t))},t.prototype.fromValue=function(t){var e=this,n=t.value_type;if(tt(t,n,"nullValue"))return Te.INSTANCE;if(tt(t,n,"booleanValue"))return Se.of(t.booleanValue);if(tt(t,n,"integerValue"))return new Ce($(t.integerValue));if(tt(t,n,"doubleValue")){if(this.options.useProto3Json){if("NaN"===t.doubleValue)return De.NAN;if("Infinity"===t.doubleValue)return De.POSITIVE_INFINITY;if("-Infinity"===t.doubleValue)return De.NEGATIVE_INFINITY}return new De(t.doubleValue)}if(tt(t,n,"stringValue"))return new Ne(t.stringValue);if(tt(t,n,"mapValue"))return this.fromFields(t.mapValue.fields||{});if(tt(t,n,"arrayValue")){Z(t.arrayValue,"arrayValue");return new Le((t.arrayValue.values||[]).map(function(t){return e.fromValue(t)}))}if(tt(t,n,"timestampValue"))return Z(t.timestampValue,"timestampValue"),new Ae(this.fromTimestamp(t.timestampValue));if(tt(t,n,"geoPointValue")){Z(t.geoPointValue,"geoPointValue");return new Pe(new te(t.geoPointValue.latitude||0,t.geoPointValue.longitude||0))}if(tt(t,n,"bytesValue")){Z(t.bytesValue,"bytesValue");var r=this.fromBlob(t.bytesValue);return new Re(r)}if(tt(t,n,"referenceValue")){Z(t.referenceValue,"referenceValue");var i=this.fromResourceName(t.referenceValue),o=new ie(i.get(1),i.get(3)),s=new ce(this.extractLocalPathFromResourceName(i));return new Oe(o,s)}return u("Unknown Value proto "+JSON.stringify(t))},t.prototype.toMutationDocument=function(t,e){return{name:this.toName(t),fields:this.toFields(e)}},t.prototype.toDocument=function(t){return c(!t.hasLocalMutations,"Can't serialize documents with mutations."),{name:this.toName(t.key),fields:this.toFields(t.data),updateTime:this.toTimestamp(t.version.toTimestamp())}},t.prototype.fromDocument=function(t,e){return new le(this.fromName(t.name),this.fromVersion(t.updateTime),this.fromFields(t.fields||{}),{hasCommittedMutations:!!e})},t.prototype.toFields=function(t){var e=this,n={};return t.forEach(function(t,r){n[t]=e.toValue(r)}),n},t.prototype.fromFields=function(t){var e=this,n=Me.EMPTY;return m(t,function(t,r){n=n.set(new ue([t]),e.fromValue(r))}),n},t.prototype.toMapValue=function(t){return{fields:this.toFields(t)}},t.prototype.toArrayValue=function(t){var e=this,n=[];return t.forEach(function(t){n.push(e.toValue(t))}),{values:n}},t.prototype.fromFound=function(t){c(!!t.found,"Tried to deserialize a found document from a missing document."),Z(t.found.name,"doc.found.name"),Z(t.found.updateTime,"doc.found.updateTime");var e=this.fromName(t.found.name),n=this.fromVersion(t.found.updateTime),r=this.fromFields(t.found.fields||{});return new le(e,n,r,{},t.found)},t.prototype.fromMissing=function(t){c(!!t.missing,"Tried to deserialize a missing document from a found document."),c(!!t.readTime,"Tried to deserialize a missing document without a read time.");var e=this.fromName(t.missing),n=this.fromVersion(t.readTime);return new fe(e,n)},t.prototype.fromMaybeDocument=function(t){var e=t.result;return tt(t,e,"found")?this.fromFound(t):tt(t,e,"missing")?this.fromMissing(t):u("invalid batch get response: "+JSON.stringify(t))},t.prototype.toWatchTargetChangeState=function(t){switch(t){case In.Added:return"ADD";case In.Current:return"CURRENT";case In.NoChange:return"NO_CHANGE";case In.Removed:return"REMOVE";case In.Reset:return"RESET";default:return u("Unknown WatchTargetChangeState: "+t)}},t.prototype.toTestWatchChange=function(t){if(t instanceof Rn)return{filter:{count:t.existenceFilter.count,targetId:t.targetId}};if(t instanceof kn){if(t.newDoc instanceof le){return{documentChange:{document:{name:this.toName((e=t.newDoc).key),fields:this.toFields(e.data),updateTime:this.toVersion(e.version)},targetIds:t.updatedTargetIds,removedTargetIds:t.removedTargetIds}}}if(t.newDoc instanceof fe){var e;return{documentDelete:{document:this.toName((e=t.newDoc).key),readTime:this.toVersion(e.version),removedTargetIds:t.removedTargetIds}}}if(null===t.newDoc)return{documentRemove:{document:this.toName(t.key),removedTargetIds:t.removedTargetIds}}}if(t instanceof On){var n=void 0;return t.cause&&(n={code:function(t){if(void 0===t)return sn.OK;switch(t){case Xt.OK:return sn.OK;case Xt.CANCELLED:return sn.CANCELLED;case Xt.UNKNOWN:return sn.UNKNOWN;case Xt.DEADLINE_EXCEEDED:return sn.DEADLINE_EXCEEDED;case Xt.RESOURCE_EXHAUSTED:return sn.RESOURCE_EXHAUSTED;case Xt.INTERNAL:return sn.INTERNAL;case Xt.UNAVAILABLE:return sn.UNAVAILABLE;case Xt.UNAUTHENTICATED:return sn.UNAUTHENTICATED;case Xt.INVALID_ARGUMENT:return sn.INVALID_ARGUMENT;case Xt.NOT_FOUND:return sn.NOT_FOUND;case Xt.ALREADY_EXISTS:return sn.ALREADY_EXISTS;case Xt.PERMISSION_DENIED:return sn.PERMISSION_DENIED;case Xt.FAILED_PRECONDITION:return sn.FAILED_PRECONDITION;case Xt.ABORTED:return sn.ABORTED;case Xt.OUT_OF_RANGE:return sn.OUT_OF_RANGE;case Xt.UNIMPLEMENTED:return sn.UNIMPLEMENTED;case Xt.DATA_LOSS:return sn.DATA_LOSS;default:return u("Unknown status code: "+t)}}(t.cause.code),message:t.cause.message}),{targetChange:{targetChangeType:this.toWatchTargetChangeState(t.state),targetIds:t.targetIds,resumeToken:this.unsafeCastProtoByteString(t.resumeToken),cause:n}}}return u("Unrecognized watch change: "+JSON.stringify(t))},t.prototype.fromWatchChange=function(t){var e,n=t.response_type;if(tt(t,n,"targetChange")){Z(t.targetChange,"targetChange");var r=this.fromWatchTargetChangeState(t.targetChange.targetChangeType||"NO_CHANGE"),i=t.targetChange.targetIds||[],o=t.targetChange.resumeToken||this.emptyByteString(),s=t.targetChange.cause,a=s&&this.fromRpcStatus(s);e=new On(r,i,o,a||null)}else if(tt(t,n,"documentChange")){Z(t.documentChange,"documentChange"),Z(t.documentChange.document,"documentChange.name"),Z(t.documentChange.document.name,"documentChange.document.name"),Z(t.documentChange.document.updateTime,"documentChange.document.updateTime");var c=t.documentChange,h=this.fromName(c.document.name),l=this.fromVersion(c.document.updateTime),f=this.fromFields(c.document.fields||{}),d=new le(h,l,f,{},c.document);e=new kn(c.targetIds||[],c.removedTargetIds||[],d.key,d)}else if(tt(t,n,"documentDelete")){Z(t.documentDelete,"documentDelete"),Z(t.documentDelete.document,"documentDelete.document");var p=t.documentDelete;h=this.fromName(p.document),l=p.readTime?this.fromVersion(p.readTime):Je.forDeletedDoc(),d=new fe(h,l);e=new kn([],p.removedTargetIds||[],d.key,d)}else if(tt(t,n,"documentRemove")){Z(t.documentRemove,"documentRemove"),Z(t.documentRemove.document,"documentRemove");var m=t.documentRemove;h=this.fromName(m.document);e=new kn([],m.removedTargetIds||[],h,null)}else{if(!tt(t,n,"filter"))return u("Unknown change type "+JSON.stringify(t));Z(t.filter,"filter"),Z(t.filter.targetId,"filter.targetId");var y=t.filter,g=new yn(y.count||0);e=new Rn(y.targetId,g)}return e},t.prototype.fromWatchTargetChangeState=function(t){return"NO_CHANGE"===t?In.NoChange:"ADD"===t?In.Added:"REMOVE"===t?In.Removed:"CURRENT"===t?In.Current:"RESET"===t?In.Reset:u("Got unexpected TargetChange.state: "+t)},t.prototype.versionFromListenResponse=function(t){if(!tt(t,t.response_type,"targetChange"))return Je.MIN;var e=t.targetChange;return e.targetIds&&e.targetIds.length?Je.MIN:e.readTime?this.fromVersion(e.readTime):Je.MIN},t.prototype.toMutation=function(t){var e,n=this;if(t instanceof cn)e={update:this.toMutationDocument(t.key,t.value)};else if(t instanceof fn)e={delete:this.toName(t.key)};else if(t instanceof hn)e={update:this.toMutationDocument(t.key,t.data),updateMask:this.toDocumentMask(t.fieldMask)};else{if(!(t instanceof ln))return u("Unknown mutation type "+t.type);e={transform:{document:this.toName(t.key),fieldTransforms:t.fieldTransforms.map(function(t){return n.toFieldTransform(t)})}}}return t.precondition.isNone||(e.currentDocument=this.toPrecondition(t.precondition)),e},t.prototype.fromMutation=function(t){var e=this,n=t.currentDocument?this.fromPrecondition(t.currentDocument):an.NONE;if(t.update){Z(t.update.name,"name");var r=this.fromName(t.update.name),i=this.fromFields(t.update.fields||{});if(t.updateMask){var o=this.fromDocumentMask(t.updateMask);return new hn(r,i,o,n)}return new cn(r,i,n)}if(t.delete){r=this.fromName(t.delete);return new fn(r,n)}if(t.transform){r=this.fromName(t.transform.document);var s=t.transform.fieldTransforms.map(function(t){return e.fromFieldTransform(t)});return c(!0===n.exists,'Transforms only support precondition "exists == true"'),new ln(r,s)}return u("unknown mutation proto: "+JSON.stringify(t))},t.prototype.toPrecondition=function(t){return c(!t.isNone,"Can't serialize an empty precondition"),void 0!==t.updateTime?{updateTime:this.toVersion(t.updateTime)}:void 0!==t.exists?{exists:t.exists}:u("Unknown precondition")},t.prototype.fromPrecondition=function(t){return void 0!==t.updateTime?an.updateTime(this.fromVersion(t.updateTime)):void 0!==t.exists?an.exists(t.exists):an.NONE},t.prototype.fromWriteResult=function(t,e){var n=this,r=this.fromVersion(t.updateTime?t.updateTime:e),i=null;return t.transformResults&&t.transformResults.length>0&&(i=t.transformResults.map(function(t){return n.fromValue(t)})),new on(r,i)},t.prototype.fromWriteResults=function(t,e){var n=this;return t&&t.length>0?(c(void 0!==e,"Received a write result without a commit time"),t.map(function(t){return n.fromWriteResult(t,e)})):[]},t.prototype.toFieldTransform=function(t){var e=this,n=t.transform;if(n instanceof dn)return{fieldPath:t.field.canonicalString(),setToServerValue:"REQUEST_TIME"};if(n instanceof pn)return{fieldPath:t.field.canonicalString(),appendMissingElements:{values:n.elements.map(function(t){return e.toValue(t)})}};if(n instanceof mn)return{fieldPath:t.field.canonicalString(),removeAllFromArray:{values:n.elements.map(function(t){return e.toValue(t)})}};throw u("Unknown transform: "+t.transform)},t.prototype.fromFieldTransform=function(t){var e=this,n=t.transform_type,r=null;if(tt(t,n,"setToServerValue"))c("REQUEST_TIME"===t.setToServerValue,"Unknown server value transform proto: "+JSON.stringify(t)),r=dn.instance;else if(tt(t,n,"appendMissingElements")){r=new pn((t.appendMissingElements.values||[]).map(function(t){return e.fromValue(t)}))}else if(tt(t,n,"removeAllFromArray")){r=new mn((t.removeAllFromArray.values||[]).map(function(t){return e.fromValue(t)}))}else u("Unknown transform proto: "+JSON.stringify(t));var i=ue.fromServerFormat(t.fieldPath);return new rn(i,r)},t.prototype.toDocumentsTarget=function(t){return{documents:[this.toQueryPath(t.path)]}},t.prototype.fromDocumentsTarget=function(t){var e=t.documents.length;c(1===e,"DocumentsTarget contained other than 1 document: "+e);return qe.atPath(this.fromQueryPath(t.documents[0]))},t.prototype.toQueryTarget=function(t){var e={structuredQuery:{}};if(t.path.isEmpty())e.parent=this.toQueryPath(se.EMPTY_PATH);else{var n=t.path;c(n.length%2!=0,"Document queries with filters are not supported."),e.parent=this.toQueryPath(n.popLast()),e.structuredQuery.from=[{collectionId:n.lastSegment()}]}var r=this.toFilter(t.filters);r&&(e.structuredQuery.where=r);var i=this.toOrder(t.orderBy);i&&(e.structuredQuery.orderBy=i);var o=this.toInt32Value(t.limit);return void 0!==o&&(e.structuredQuery.limit=o),t.startAt&&(e.structuredQuery.startAt=this.toCursor(t.startAt)),t.endAt&&(e.structuredQuery.endAt=this.toCursor(t.endAt)),e},t.prototype.fromQueryTarget=function(t){var e=this.fromQueryPath(t.parent),n=t.structuredQuery,r=n.from?n.from.length:0;if(r>0){c(1===r,"StructuredQuery.from with more than one collection is not supported.");e=e.child(n.from[0].collectionId)}var i=[];n.where&&(i=this.fromFilter(n.where));var o=[];n.orderBy&&(o=this.fromOrder(n.orderBy));var s=null;n.limit&&(s=this.fromInt32Value(n.limit));var a=null;n.startAt&&(a=this.fromCursor(n.startAt));var u=null;return n.endAt&&(u=this.fromCursor(n.endAt)),new qe(e,o,i,s,a,u)},t.prototype.toListenRequestLabels=function(t){var e=this.toLabel(t.purpose);return null==e?null:{"goog-listen-tags":e}},t.prototype.toLabel=function(t){switch(t){case _e.Listen:return null;case _e.ExistenceFilterMismatch:return"existence-filter-mismatch";case _e.LimboResolution:return"limbo-document";default:return u("Unrecognized query purpose: "+t)}},t.prototype.toTarget=function(t){var e,n=t.query;return e=n.isDocumentQuery()?{documents:this.toDocumentsTarget(n)}:{query:this.toQueryTarget(n)},e.targetId=t.targetId,t.resumeToken.length>0&&(e.resumeToken=this.unsafeCastProtoByteString(t.resumeToken)),e},t.prototype.toFilter=function(t){var e=this;if(0!==t.length){var n=t.map(function(t){return t instanceof je?e.toRelationFilter(t):e.toUnaryFilter(t)});return 1===n.length?n[0]:{compositeFilter:{op:"AND",filters:n}}}},t.prototype.fromFilter=function(t){var e=this;return t?void 0!==t.unaryFilter?[this.fromUnaryFilter(t)]:void 0!==t.fieldFilter?[this.fromRelationFilter(t)]:void 0!==t.compositeFilter?t.compositeFilter.filters.map(function(t){return e.fromFilter(t)}).reduce(function(t,e){return t.concat(e)}):u("Unknown filter: "+JSON.stringify(t)):[]},t.prototype.toOrder=function(t){var e=this;if(0!==t.length)return t.map(function(t){return e.toPropertyOrder(t)})},t.prototype.fromOrder=function(t){var e=this;return t.map(function(t){return e.fromPropertyOrder(t)})},t.prototype.toCursor=function(t){var e=this;return{before:t.before,values:t.position.map(function(t){return e.toValue(t)})}},t.prototype.fromCursor=function(t){var e=this,n=!!t.before,r=t.values.map(function(t){return e.fromValue(t)});return new ze(r,n)},t.prototype.toDirection=function(t){return Ln[t.name]},t.prototype.fromDirection=function(t){switch(t){case"ASCENDING":return Ge.ASCENDING;case"DESCENDING":return Ge.DESCENDING;default:return}},t.prototype.toOperatorName=function(t){return xn[t.name]},t.prototype.fromOperatorName=function(t){switch(t){case"EQUAL":return Ke.EQUAL;case"GREATER_THAN":return Ke.GREATER_THAN;case"GREATER_THAN_OR_EQUAL":return Ke.GREATER_THAN_OR_EQUAL;case"LESS_THAN":return Ke.LESS_THAN;case"LESS_THAN_OR_EQUAL":return Ke.LESS_THAN_OR_EQUAL;case"ARRAY_CONTAINS":return Ke.ARRAY_CONTAINS;case"OPERATOR_UNSPECIFIED":return u("Unspecified relation");default:return u("Unknown relation")}},t.prototype.toFieldPathReference=function(t){return{fieldPath:t.canonicalString()}},t.prototype.fromFieldPathReference=function(t){return ue.fromServerFormat(t.fieldPath)},t.prototype.toPropertyOrder=function(t){return{field:this.toFieldPathReference(t.field),direction:this.toDirection(t.dir)}},t.prototype.fromPropertyOrder=function(t){return new He(this.fromFieldPathReference(t.field),this.fromDirection(t.direction))},t.prototype.toRelationFilter=function(t){return t instanceof je?{fieldFilter:{field:this.toFieldPathReference(t.field),op:this.toOperatorName(t.op),value:this.toValue(t.value)}}:u("Unrecognized filter: "+JSON.stringify(t))},t.prototype.fromRelationFilter=function(t){return new je(this.fromFieldPathReference(t.fieldFilter.field),this.fromOperatorName(t.fieldFilter.op),this.fromValue(t.fieldFilter.value))},t.prototype.toUnaryFilter=function(t){return t instanceof Qe?{unaryFilter:{field:this.toFieldPathReference(t.field),op:"IS_NAN"}}:t instanceof We?{unaryFilter:{field:this.toFieldPathReference(t.field),op:"IS_NULL"}}:u("Unrecognized filter: "+JSON.stringify(t))},t.prototype.fromUnaryFilter=function(t){switch(t.unaryFilter.op){case"IS_NAN":var e=this.fromFieldPathReference(t.unaryFilter.field);return new Qe(e);case"IS_NULL":var n=this.fromFieldPathReference(t.unaryFilter.field);return new We(n);case"OPERATOR_UNSPECIFIED":return u("Unspecified filter");default:return u("Unknown filter")}},t.prototype.toDocumentMask=function(t){var e=[];return t.fields.forEach(function(t){return e.push(t.canonicalString())}),{fieldPaths:e}},t.prototype.fromDocumentMask=function(t){var e=(t.fieldPaths||[]).map(function(t){return ue.fromServerFormat(t)});return nn.fromArray(e)},t}(),Fn=function(){function t(t){this.sendFn=t.sendFn,this.closeFn=t.closeFn}return t.prototype.onOpen=function(t){c(!this.wrappedOnOpen,"Called onOpen on stream twice!"),this.wrappedOnOpen=t},t.prototype.onClose=function(t){c(!this.wrappedOnClose,"Called onClose on stream twice!"),this.wrappedOnClose=t},t.prototype.onMessage=function(t){c(!this.wrappedOnMessage,"Called onMessage on stream twice!"),this.wrappedOnMessage=t},t.prototype.close=function(){this.closeFn()},t.prototype.send=function(t){this.sendFn(t)},t.prototype.callOnOpen=function(){c(void 0!==this.wrappedOnOpen,"Cannot call onOpen because no callback was set"),this.wrappedOnOpen()},t.prototype.callOnClose=function(t){c(void 0!==this.wrappedOnClose,"Cannot call onClose because no callback was set"),this.wrappedOnClose(t)},t.prototype.callOnMessage=function(t){c(void 0!==this.wrappedOnMessage,"Cannot call onMessage because no callback was set"),this.wrappedOnMessage(t)},t}(),qn="Connection",Vn={BatchGetDocuments:"batchGet",Commit:"commit"},Kn="gl-js/ fire/"+Gt,jn=function(){function t(t){this.databaseId=t.databaseId,this.pool=new Wt.XhrIoPool;this.baseUrl=(t.ssl?"https":"http")+"://"+t.host}return t.prototype.modifyHeadersForRequest=function(t,e){if(e)for(var n in e.authHeaders)e.authHeaders.hasOwnProperty(n)&&(t[n]=e.authHeaders[n]);t["X-Goog-Api-Client"]=Kn},t.prototype.invokeRPC=function(t,e,n){var r=this,i=this.makeUrl(t);return new Promise(function(s,a){r.pool.getObject(function(c){c.listenOnce(Wt.EventType.COMPLETE,function(){try{switch(c.getLastErrorCode()){case Wt.ErrorCode.NO_ERROR:var e=c.getResponseJson();o(qn,"XHR received:",JSON.stringify(e)),s(e);break;case Wt.ErrorCode.TIMEOUT:o(qn,'RPC "'+t+'" timed out'),a(new Yt(Xt.DEADLINE_EXCEEDED,"Request time out"));break;case Wt.ErrorCode.HTTP_ERROR:var n=c.getStatus();o(qn,'RPC "'+t+'" failed with status:',n,"response text:",c.getResponseText()),n>0?a(new Yt(function(t){switch(t){case 200:return Xt.OK;case 400:return Xt.INVALID_ARGUMENT;case 401:return Xt.UNAUTHENTICATED;case 403:return Xt.PERMISSION_DENIED;case 404:return Xt.NOT_FOUND;case 409:return Xt.ABORTED;case 416:return Xt.OUT_OF_RANGE;case 429:return Xt.RESOURCE_EXHAUSTED;case 499:return Xt.CANCELLED;case 500:return Xt.UNKNOWN;case 501:return Xt.UNIMPLEMENTED;case 503:return Xt.UNAVAILABLE;case 504:return Xt.DEADLINE_EXCEEDED;default:return t>=200&&t<300?Xt.OK:t>=400&&t<500?Xt.FAILED_PRECONDITION:t>=500&&t<600?Xt.INTERNAL:Xt.UNKNOWN}}(n),"Server responded with status "+c.getStatusText())):(o(qn,'RPC "'+t+'" failed'),a(new Yt(Xt.UNAVAILABLE,"Connection failed.")));break;default:u('RPC "'+t+'" failed with unanticipated webchannel error '+c.getLastErrorCode()+": "+c.getLastError()+", giving up.")}}finally{o(qn,'RPC "'+t+'" completed.'),r.pool.releaseObject(c)}});var h=JSON.stringify(e);o(qn,"XHR sending: ",i+" "+h);var l={"Content-Type":"text/plain"};r.modifyHeadersForRequest(l,n),c.send(i,"POST",h,l,15)})})},t.prototype.invokeStreamingRPC=function(t,e,n){return this.invokeRPC(t,e,n)},t.prototype.openStream=function(t,e){var n=[this.baseUrl,"/","google.firestore.v1beta1.Firestore","/",t,"/channel"],r=Wt.createWebChannelTransport(),i={backgroundChannelTest:!0,httpSessionIdParam:"gsessionid",initMessageHeaders:{},messageUrlParams:{database:"projects/"+this.databaseId.projectId+"/databases/"+this.databaseId.database},sendRawJson:!0,supportsCrossDomainXhr:!0};this.modifyHeadersForRequest(i.initMessageHeaders,e),Qt.isReactNative()||(i.httpHeadersOverwriteParam="$httpHeaders");var s=n.join("");o(qn,"Creating WebChannel: "+s+" "+i);var a=r.createWebChannel(s,i),u=!1,h=!1,l=new Fn({sendFn:function(t){h?o(qn,"Not sending because WebChannel is closed:",t):(u||(o(qn,"Opening WebChannel transport."),a.open(),u=!0),o(qn,"WebChannel sending:",t),a.send(t))},closeFn:function(){return a.close()}}),f=function(t,e){a.listen(t,function(t){try{e(t)}catch(t){setTimeout(function(){throw t},0)}})};return f(Wt.WebChannel.EventType.OPEN,function(){h||o(qn,"WebChannel transport opened.")}),f(Wt.WebChannel.EventType.CLOSE,function(){h||(h=!0,o(qn,"WebChannel transport closed"),l.callOnClose())}),f(Wt.WebChannel.EventType.ERROR,function(t){h||(h=!0,o(qn,"WebChannel transport errored:",t),l.callOnClose(new Yt(Xt.UNAVAILABLE,"The operation could not be completed")))}),f(Wt.WebChannel.EventType.MESSAGE,function(t){if(!h){var e=t.data[0];c(!!e,"Got a webchannel message without data.");var n=e.error||e[0]&&e[0].error;if(n){o(qn,"WebChannel received error:",n);var r=n.status,i=function(t){var e=sn[t];if(void 0!==e)return j(e)}(r),s=n.message;void 0===i&&(i=Xt.INTERNAL,s="Unknown error status: "+r+" with message "+n.message),h=!0,l.callOnClose(new Yt(i,s)),a.close()}else o(qn,"WebChannel received:",e),l.callOnMessage(e)}}),setTimeout(function(){l.callOnOpen()},0),l},t.prototype.makeUrl=function(t){var e=Vn[t];c(void 0!==e,"Unknown REST mapping for: "+t);var n=[this.baseUrl,"/","v1beta1"];return n.push("/projects/"),n.push(this.databaseId.projectId),n.push("/databases/"),n.push(this.databaseId.database),n.push("/documents"),n.push(":"),n.push(e),n.join("")},t}(),Wn=function(){function t(){this.emptyByteString="",this.base64Available="undefined"!=typeof atob}return Object.defineProperty(t.prototype,"document",{get:function(){return"undefined"!=typeof document?document:null},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"window",{get:function(){return"undefined"!=typeof window?window:null},enumerable:!0,configurable:!0}),t.prototype.loadConnection=function(t){return Promise.resolve(new jn(t))},t.prototype.newSerializer=function(t){return new Bn(t,{useProto3Json:!0})},t.prototype.formatJSON=function(t){return JSON.stringify(t)},t.prototype.atob=function(t){return atob(t)},t.prototype.btoa=function(t){return btoa(t)},t}();Ht.setPlatform(new Wn);var Qn,Gn=function(){function t(t,e){var n=this;this.previousValue=t,e&&(e.sequenceNumberHandler=function(t){return n.setPreviousValue(t)},this.writeNewSequenceNumber=function(t){return e.writeSequenceNumber(t)})}return t.prototype.setPreviousValue=function(t){return this.previousValue=Math.max(t,this.previousValue),this.previousValue},t.prototype.next=function(){var t=++this.previousValue;return this.writeNewSequenceNumber&&this.writeNewSequenceNumber(t),t},t.INVALID=-1,t}(),zn=function(){return function(){var t=this;this.promise=new Promise(function(e,n){t.resolve=e,t.reject=n})}}();!function(t){t.All="all",t.ListenStreamIdle="listen_stream_idle",t.ListenStreamConnectionBackoff="listen_stream_connection_backoff",t.WriteStreamIdle="write_stream_idle",t.WriteStreamConnectionBackoff="write_stream_connection_backoff",t.OnlineStateTimeout="online_state_timeout",t.ClientMetadataRefresh="client_metadata_refresh",t.LruGarbageCollection="lru_garbage_collection"}(Qn||(Qn={}));var Hn,Xn=function(){function t(t,e,n,r,i){this.asyncQueue=t,this.timerId=e,this.targetTimeMs=n,this.op=r,this.removalCallback=i,this.deferred=new zn,this.then=this.deferred.promise.then.bind(this.deferred.promise),this.catch=this.deferred.promise.catch.bind(this.deferred.promise),this.deferred.promise.catch(function(t){})}return t.createAndSchedule=function(e,n,r,i,o){var s=new t(e,n,Date.now()+r,i,o);return s.start(r),s},t.prototype.start=function(t){var e=this;this.timerHandle=setTimeout(function(){return e.handleDelayElapsed()},t)},t.prototype.skipDelay=function(){return this.handleDelayElapsed()},t.prototype.cancel=function(t){null!==this.timerHandle&&(this.clearTimeout(),this.deferred.reject(new Yt(Xt.CANCELLED,"Operation cancelled"+(t?": "+t:""))))},t.prototype.handleDelayElapsed=function(){var t=this;this.asyncQueue.enqueueAndForget(function(){return null!==t.timerHandle?(t.clearTimeout(),t.op().then(function(e){return t.deferred.resolve(e)})):Promise.resolve()})},t.prototype.clearTimeout=function(){null!==this.timerHandle&&(this.removalCallback(this),clearTimeout(this.timerHandle),this.timerHandle=null)},t}(),Yn=function(){function t(){this.tail=Promise.resolve(),this.delayedOperations=[],this.operationInProgress=!1}return t.prototype.enqueueAndForget=function(t){this.enqueue(t)},t.prototype.enqueue=function(t){var e=this;this.verifyNotFailed();var n=this.tail.then(function(){return e.operationInProgress=!0,t().catch(function(t){e.failure=t,e.operationInProgress=!1;var n=t.stack||t.message||"";throw s("INTERNAL UNHANDLED ERROR: ",n),n.indexOf("Firestore Test Simulated Error")<0&&setTimeout(function(){throw t},0),t}).then(function(t){return e.operationInProgress=!1,t})});return this.tail=n,n},t.prototype.enqueueAfterDelay=function(t,e,n){var r=this;this.verifyNotFailed(),c(e>=0,"Attempted to schedule an operation with a negative delay of "+e),c(!this.containsDelayedOperation(t),"Attempted to schedule multiple operations with timer id "+t+".");var i=Xn.createAndSchedule(this,t,e,n,function(t){return r.removeDelayedOperation(t)});return this.delayedOperations.push(i),i},t.prototype.verifyNotFailed=function(){this.failure&&u("AsyncQueue is already failed: "+(this.failure.stack||this.failure.message))},t.prototype.verifyOperationInProgress=function(){c(this.operationInProgress,"verifyOpInProgress() called when no op in progress on this queue.")},t.prototype.drain=function(){return this.enqueue(function(){return Promise.resolve()})},t.prototype.containsDelayedOperation=function(t){for(var e=0,n=this.delayedOperations;e<n.length;e++){if(n[e].timerId===t)return!0}return!1},t.prototype.runDelayedOperationsEarly=function(t){var e=this;return this.drain().then(function(){c(t===Qn.All||e.containsDelayedOperation(t),"Attempted to drain to missing operation "+t),e.delayedOperations.sort(function(t,e){return t.targetTimeMs-e.targetTimeMs});for(var n=0,r=e.delayedOperations;n<r.length;n++){var i=r[n];if(i.skipDelay(),t!==Qn.All&&i.timerId===t)break}return e.drain()})},t.prototype.removeDelayedOperation=function(t){var e=this.delayedOperations.indexOf(t);c(e>=0,"Delayed operation not found."),this.delayedOperations.splice(e,1)},t}(),Jn="",Zn="",$n="",tr="",er=-1,nr=function(){function t(t,e,n){this.batchId=t,this.localWriteTime=e,this.mutations=n,c(n.length>0,"Cannot create an empty mutation batch")}return t.prototype.applyToRemoteDocument=function(t,e,n){e&&c(e.key.isEqual(t),"applyToRemoteDocument: key "+t+" should match maybeDoc key\n        "+e.key);var r=n.mutationResults;c(r.length===this.mutations.length,"Mismatch between mutations length\n      ("+this.mutations.length+") and mutation results length\n      ("+r.length+").");for(var i=0;i<this.mutations.length;i++){var o=this.mutations[i];if(o.key.isEqual(t)){e=o.applyToRemoteDocument(e,r[i])}}return e},t.prototype.applyToLocalView=function(t,e){e&&c(e.key.isEqual(t),"applyToLocalDocument: key "+t+" should match maybeDoc key\n        "+e.key);for(var n=e,r=0;r<this.mutations.length;r++){var i=this.mutations[r];i.key.isEqual(t)&&(e=i.applyToLocalView(e,n,this.localWriteTime))}return e},t.prototype.keys=function(){for(var t=H(),e=0,n=this.mutations;e<n.length;e++){t=t.add(n[e].key)}return t},t.prototype.isEqual=function(t){return this.batchId===t.batchId&&L(this.mutations,t.mutations)},t}(),rr=function(){function t(t,e,n,r,i){this.batch=t,this.commitVersion=e,this.mutationResults=n,this.streamToken=r,this.docVersions=i}return t.from=function(e,n,r,i){c(e.mutations.length===r.length,"Mutations sent "+e.mutations.length+" must equal results received "+r.length);for(var o=z(),s=e.mutations,a=0;a<s.length;a++)o=o.insert(s[a].key,r[a].version);return new t(e,n,r,i,o)},t}(),ir=1;!function(t){t[t.QueryCache=0]="QueryCache",t[t.SyncEngine=1]="SyncEngine"}(Hn||(Hn={}));var or,sr=function(){function t(t,e){this.generatorId=t,c((t&ir)===t,"Generator ID "+t+" contains more than "+ir+" reserved bits"),this.seek(void 0!==e?e:this.generatorId)}return t.prototype.next=function(){var t=this.nextId;return this.nextId+=1<<ir,t},t.prototype.after=function(t){return this.seek(t+(1<<ir)),this.next()},t.prototype.seek=function(t){c((t&ir)===this.generatorId,"Cannot supply target ID from different generator ID"),this.nextId=t},t.forQueryCache=function(){return new t(Hn.QueryCache,2)},t.forSyncEngine=function(){return new t(Hn.SyncEngine)},t}(),ar=function(){function t(t){var e=this;this.nextCallback=null,this.catchCallback=null,this.result=void 0,this.error=void 0,this.isDone=!1,this.callbackAttached=!1,t(function(t){e.isDone=!0,e.result=t,e.nextCallback&&e.nextCallback(t)},function(t){e.isDone=!0,e.error=t,e.catchCallback&&e.catchCallback(t)})}return t.prototype.catch=function(t){return this.next(void 0,t)},t.prototype.next=function(e,n){var r=this;return this.callbackAttached&&u("Called next() or catch() twice for PersistencePromise"),this.callbackAttached=!0,this.isDone?this.error?this.wrapFailure(n,this.error):this.wrapSuccess(e,this.result):new t(function(t,i){r.nextCallback=function(n){r.wrapSuccess(e,n).next(t,i)},r.catchCallback=function(e){r.wrapFailure(n,e).next(t,i)}})},t.prototype.toPromise=function(){var t=this;return new Promise(function(e,n){t.next(e,n)})},t.prototype.wrapUserFunction=function(e){try{var n=e();return n instanceof t?n:t.resolve(n)}catch(e){return t.reject(e)}},t.prototype.wrapSuccess=function(e,n){return e?this.wrapUserFunction(function(){return e(n)}):t.resolve(n)},t.prototype.wrapFailure=function(e,n){return e?this.wrapUserFunction(function(){return e(n)}):t.reject(n)},t.resolve=function(e){return new t(function(t,n){t(e)})},t.reject=function(e){return new t(function(t,n){n(e)})},t.waitFor=function(e){return new t(function(t,n){var r=0,i=0,o=!1;e.forEach(function(e){++r,e.next(function(){++i,o&&i===r&&t()},function(t){return n(t)})}),o=!0,i===r&&t()})},t.or=function(e){for(var n=t.resolve(!1),r=function(e){n=n.next(function(n){return n?t.resolve(n):e()})},i=0,o=e;i<o.length;i++){r(o[i])}return n},t.forEach=function(t,e){var n=this,r=[];return t.forEach(function(t,i){r.push(e.call(n,t,i))}),this.waitFor(r)},t}(),ur="SimpleDb",cr=function(){function e(t){this.db=t}return e.openOrCreate=function(t,n,r){return c(e.isAvailable(),"IndexedDB not supported in current environment."),o(ur,"Opening database:",t),new ar(function(i,s){var a=window.indexedDB.open(t,n);a.onsuccess=function(t){i(new e(t.target.result))},a.onblocked=function(){s(new Yt(Xt.FAILED_PRECONDITION,"Cannot upgrade IndexedDB schema while another tab is open. Close all tabs that access Firestore and reload this page to proceed."))},a.onerror=function(t){var e=t.target.error;s("VersionError"===e.name?new Yt(Xt.FAILED_PRECONDITION,"A newer version of the Firestore SDK was previously used and so the persisted data is not compatible with the version of the SDK you are now using. The SDK will operate with persistence disabled. If you need persistence, please re-upgrade to a newer version of the SDK or else clear the persisted IndexedDB data for your app to start fresh."):e)},a.onupgradeneeded=function(e){o(ur,'Database "'+t+'" requires upgrade from version:',e.oldVersion);var n=e.target.result,i=new lr(a.transaction);r.createOrUpgrade(n,i,e.oldVersion,br).next(function(){o(ur,"Database upgrade to version "+br+" complete")})}}).toPromise()},e.delete=function(t){return o(ur,"Removing database:",t),it(window.indexedDB.deleteDatabase(t)).toPromise()},e.isAvailable=function(){if("undefined"==typeof window||null==window.indexedDB)return!1;if(void 0===window.navigator)return"YES"===t.env.USE_MOCK_PERSISTENCE;var e=window.navigator.userAgent;return!(e.indexOf("MSIE ")>0||e.indexOf("Trident/")>0||e.indexOf("Edge/")>0)},e.getStore=function(t,e){return t.store(e)},e.prototype.runTransaction=function(t,e,n){var r=lr.open(this.db,t,e),i=n(r).catch(function(t){return r.abort(t),ar.reject(t)}).toPromise();return r.completionPromise.then(function(){return i})},e.prototype.close=function(){this.db.close()},e}(),hr=function(){function t(t){this.dbCursor=t,this.shouldStop=!1,this.nextKey=null}return Object.defineProperty(t.prototype,"isDone",{get:function(){return this.shouldStop},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"skipToKey",{get:function(){return this.nextKey},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"cursor",{set:function(t){this.dbCursor=t},enumerable:!0,configurable:!0}),t.prototype.done=function(){this.shouldStop=!0},t.prototype.skip=function(t){this.nextKey=t},t.prototype.delete=function(){return it(this.dbCursor.delete())},t}(),lr=function(){function t(t){var e=this;this.transaction=t,this.aborted=!1,this.completionDeferred=new zn,this.transaction.oncomplete=function(){e.completionDeferred.resolve()},this.transaction.onabort=function(){t.error?e.completionDeferred.reject(t.error):e.completionDeferred.resolve()},this.transaction.onerror=function(t){e.completionDeferred.reject(t.target.error)}}return t.open=function(e,n,r){return new t(e.transaction(r,n))},Object.defineProperty(t.prototype,"completionPromise",{get:function(){return this.completionDeferred.promise},enumerable:!0,configurable:!0}),t.prototype.abort=function(t){t&&this.completionDeferred.reject(t),this.aborted||(o(ur,"Aborting transaction:",t?t.message:"Client-initiated abort"),this.aborted=!0,this.transaction.abort())},t.prototype.store=function(t){var e=this.transaction.objectStore(t);return c(!!e,"Object store not part of transaction: "+t),new fr(e)},t}(),fr=function(){function t(t){this.store=t}return t.prototype.put=function(t,e){var n;return void 0!==e?(o(ur,"PUT",this.store.name,t,e),n=this.store.put(e,t)):(o(ur,"PUT",this.store.name,"<auto-key>",t),n=this.store.put(t)),it(n)},t.prototype.add=function(t){o(ur,"ADD",this.store.name,t,t);return it(this.store.add(t))},t.prototype.get=function(t){var e=this;return it(this.store.get(t)).next(function(n){return void 0===n&&(n=null),o(ur,"GET",e.store.name,t,n),n})},t.prototype.delete=function(t){o(ur,"DELETE",this.store.name,t);return it(this.store.delete(t))},t.prototype.count=function(){o(ur,"COUNT",this.store.name);return it(this.store.count())},t.prototype.loadAll=function(t,e){var n=this.cursor(this.options(t,e)),r=[];return this.iterateCursor(n,function(t,e){r.push(e)}).next(function(){return r})},t.prototype.deleteAll=function(t,e){o(ur,"DELETE ALL",this.store.name);var n=this.options(t,e);n.keysOnly=!1;var r=this.cursor(n);return this.iterateCursor(r,function(t,e,n){return n.delete()})},t.prototype.iterate=function(t,e){var n;e?n=t:(n={},e=t);var r=this.cursor(n);return this.iterateCursor(r,e)},t.prototype.iterateSerial=function(t){var e=this.cursor({});return new ar(function(n,r){e.onerror=function(t){r(t.target.error)},e.onsuccess=function(e){var r=e.target.result;r?t(r.primaryKey,r.value).next(function(t){t?r.continue():n()}):n()}})},t.prototype.iterateCursor=function(t,e){var n=[];return new ar(function(r,i){t.onerror=function(t){i(t.target.error)},t.onsuccess=function(t){var i=t.target.result;if(i){var o=new hr(i),s=e(i.primaryKey,i.value,o);if(s instanceof ar){var a=s.catch(function(t){return o.done(),ar.reject(t)});n.push(a)}o.isDone?r():null===o.skipToKey?i.continue():i.continue(o.skipToKey)}else r()}}).next(function(){return ar.waitFor(n)})},t.prototype.options=function(t,e){var n=void 0;return void 0!==t&&("string"==typeof t?n=t:(c(void 0===e,"3rd argument must not be defined if 2nd is a range."),e=t)),{index:n,range:e}},t.prototype.cursor=function(t){var e="next";if(t.reverse&&(e="prev"),t.index){var n=this.store.index(t.index);return t.keysOnly?n.openKeyCursor(t.range,e):n.openCursor(t.range,e)}return this.store.openCursor(t.range,e)},t}(),dr=function(){function t(t,e){this.referenceDelegate=t,this.serializer=e,this.targetIdGenerator=sr.forQueryCache()}return t.prototype.allocateTargetId=function(t){var e=this;return this.retrieveMetadata(t).next(function(n){return n.highestTargetId=e.targetIdGenerator.after(n.highestTargetId),e.saveMetadata(t,n).next(function(){return n.highestTargetId})})},t.prototype.getLastRemoteSnapshotVersion=function(t){return this.retrieveMetadata(t).next(function(t){return Je.fromTimestamp(new ee(t.lastRemoteSnapshotVersion.seconds,t.lastRemoteSnapshotVersion.nanoseconds))})},t.prototype.getHighestSequenceNumber=function(t){return at(t.simpleDbTransaction)},t.prototype.setTargetsMetadata=function(t,e,n){var r=this;return this.retrieveMetadata(t).next(function(i){return i.highestListenSequenceNumber=e,n&&(i.lastRemoteSnapshotVersion=n.toTimestamp()),e>i.highestListenSequenceNumber&&(i.highestListenSequenceNumber=e),r.saveMetadata(t,i)})},t.prototype.addQueryData=function(t,e){var n=this;return this.saveQueryData(t,e).next(function(){return n.retrieveMetadata(t).next(function(r){return r.targetCount+=1,n.updateMetadataFromQueryData(e,r),n.saveMetadata(t,r)})})},t.prototype.updateQueryData=function(t,e){return this.saveQueryData(t,e)},t.prototype.removeQueryData=function(t,e){var n=this;return this.removeMatchingKeysForTargetId(t,e.targetId).next(function(){return ot(t).delete(e.targetId)}).next(function(){return n.retrieveMetadata(t)}).next(function(e){return c(e.targetCount>0,"Removing from an empty query cache"),e.targetCount-=1,n.saveMetadata(t,e)})},t.prototype.removeTargets=function(t,e,n){var r=this,i=0,o=[];return ot(t).iterate(function(s,a){var u=r.serializer.fromDbTarget(a);u.sequenceNumber<=e&&void 0===n[u.targetId]&&(i++,o.push(r.removeQueryData(t,u)))}).next(function(){return ar.waitFor(o)}).next(function(){return i})},t.prototype.forEachTarget=function(t,e){var n=this;return ot(t).iterate(function(t,r){var i=n.serializer.fromDbTarget(r);e(i)})},t.prototype.retrieveMetadata=function(t){return st(t.simpleDbTransaction)},t.prototype.saveMetadata=function(t,e){return function(t){return Hr.getStore(t,Or.store)}(t).put(Or.key,e)},t.prototype.saveQueryData=function(t,e){return ot(t).put(this.serializer.toDbTarget(e))},t.prototype.updateMetadataFromQueryData=function(t,e){var n=!1;return t.targetId>e.highestTargetId&&(e.highestTargetId=t.targetId,n=!0),t.sequenceNumber>e.highestListenSequenceNumber&&(e.highestListenSequenceNumber=t.sequenceNumber,n=!0),n},t.prototype.getQueryCount=function(t){return this.retrieveMetadata(t).next(function(t){return t.targetCount})},t.prototype.getQueryData=function(t,e){var n=this,r=e.canonicalId(),i=IDBKeyRange.bound([r,Number.NEGATIVE_INFINITY],[r,Number.POSITIVE_INFINITY]),o=null;return ot(t).iterate({range:i,index:kr.queryTargetsIndexName},function(t,r,i){var s=n.serializer.fromDbTarget(r);e.isEqual(s.query)&&(o=s,i.done())}).next(function(){return o})},t.prototype.addMatchingKeys=function(t,e,n){var r=this,i=[],o=ut(t);return e.forEach(function(e){var s=et(e.path);i.push(o.put(new Rr(n,s))),i.push(r.referenceDelegate.addReference(t,e))}),ar.waitFor(i)},t.prototype.removeMatchingKeys=function(t,e,n){var r=this,i=ut(t);return ar.forEach(e,function(e){var o=et(e.path);return ar.waitFor([i.delete([n,o]),r.referenceDelegate.removeReference(t,e)])})},t.prototype.removeMatchingKeysForTargetId=function(t,e){var n=ut(t),r=IDBKeyRange.bound([e],[e+1],!1,!0);return n.delete(r)},t.prototype.getMatchingKeysForTargetId=function(t,e){var n=IDBKeyRange.bound([e],[e+1],!1,!0),r=ut(t),i=H();return r.iterate({range:n,keysOnly:!0},function(t,e,n){var r=rt(t[1]),o=new ce(r);i=i.add(o)}).next(function(){return i})},t.prototype.containsKey=function(t,e){var n=et(e.path),r=IDBKeyRange.bound([n],[function(t){return t+"\0"}(n)],!1,!0),i=0;return ut(t).iterate({index:Rr.documentTargetsIndex,keysOnly:!0,range:r},function(t,e,n){0!==t[0]&&(i++,n.done())}).next(function(){return i>0})},t.prototype.getQueryDataForTarget=function(t,e){var n=this;return ot(t).get(e).next(function(t){return t?n.serializer.fromDbTarget(t):null})},t}(),pr=function(){function t(t){this.mapKeyFn=t,this.inner={}}return t.prototype.get=function(t){var e=this.mapKeyFn(t),n=this.inner[e];if(void 0!==n)for(var r=0,i=n;r<i.length;r++){var o=i[r],s=o[1];if(o[0].isEqual(t))return s}},t.prototype.has=function(t){return void 0!==this.get(t)},t.prototype.set=function(t,e){var n=this.mapKeyFn(t),r=this.inner[n];if(void 0!==r){for(var i=0;i<r.length;i++)if(r[i][0].isEqual(t))return void(r[i]=[t,e]);r.push([t,e])}else this.inner[n]=[[t,e]]},t.prototype.delete=function(t){var e=this.mapKeyFn(t),n=this.inner[e];if(void 0===n)return!1;for(var r=0;r<n.length;r++)if(n[r][0].isEqual(t))return 1===n.length?delete this.inner[e]:n.splice(r,1),!0;return!1},t.prototype.forEach=function(t){m(this.inner,function(e,n){for(var r=0,i=n;r<i.length;r++){var o=i[r];t(o[0],o[1])}})},t.prototype.isEmpty=function(){return y(this.inner)},t}(),mr=function(){function t(){this.changes=W(),this.documentSizes=new pr(function(t){return t.toString()})}return t.prototype.addEntry=function(t){var e=this.assertChanges();this.changes=e.insert(t.key,t)},t.prototype.getEntry=function(t,e){var n=this,r=this.assertChanges().get(e);return r?ar.resolve(r):this.getFromCache(t,e).next(function(t){return null===t?(n.documentSizes.set(e,0),null):(n.documentSizes.set(e,t.size),t.maybeDocument)})},t.prototype.getEntries=function(t,e){var n=this;return this.getAllFromCache(t,e).next(function(t){var e=t.maybeDocuments;return t.sizeMap.forEach(function(t,e){n.documentSizes.set(t,e)}),e})},t.prototype.apply=function(t){var e=this.applyChanges(t);return this.changes=null,e},t.prototype.assertChanges=function(){return c(null!==this.changes,"Changes have already been applied."),this.changes},t}(),yr="The remote document changelog no longer contains all changes for all local query views. It may be necessary to rebuild these views.",gr=function(){function t(t,e){this.serializer=t,this.keepDocumentChangeLog=e,this._lastProcessedDocumentChangeId=0}return Object.defineProperty(t.prototype,"lastProcessedDocumentChangeId",{get:function(){return this._lastProcessedDocumentChangeId},enumerable:!0,configurable:!0}),t.prototype.start=function(t){var e=cr.getStore(t,Pr.store);return this.synchronizeLastDocumentChangeId(e)},t.prototype.addEntries=function(t,e,n){var r=[];if(e.length>0){for(var i=ht(t),o=H(),s=0,a=e;s<a.length;s++){var u=a[s],c=u.key,h=u.doc;r.push(i.put(ft(c),h)),o=o.add(c)}this.keepDocumentChangeLog&&r.push(lt(t).put({changes:this.serializer.toDbResourcePaths(o)})),r.push(this.updateSize(t,n))}return ar.waitFor(r)},t.prototype.removeEntry=function(t,e){var n=ht(t),r=ft(e);return n.get(r).next(function(t){return t?n.delete(r).next(function(){return dt(t)}):ar.resolve(0)})},t.prototype.getEntry=function(t,e){var n=this;return ht(t).get(ft(e)).next(function(t){return t?n.serializer.fromDbRemoteDocument(t):null})},t.prototype.getSizedEntry=function(t,e){var n=this;return ht(t).get(ft(e)).next(function(t){return t?{maybeDocument:n.serializer.fromDbRemoteDocument(t),size:dt(t)}:null})},t.prototype.getEntries=function(t,e){var n=this,r=Q();return this.forEachDbEntry(t,e,function(t,e){r=r.insert(t,e?n.serializer.fromDbRemoteDocument(e):null)}).next(function(){return r})},t.prototype.getSizedEntries=function(t,e){var n=this,r=Q(),i=new pe(ce.comparator);return this.forEachDbEntry(t,e,function(t,e){e?(r=r.insert(t,n.serializer.fromDbRemoteDocument(e)),i=i.insert(t,dt(e))):(r=r.insert(t,null),i=i.insert(t,0))}).next(function(){return{maybeDocuments:r,sizeMap:i}})},t.prototype.forEachDbEntry=function(t,e,n){if(e.isEmpty())return ar.resolve();var r=IDBKeyRange.bound(e.first().path.toArray(),e.last().path.toArray()),i=e.getIterator(),o=i.getNext();return ht(t).iterate({range:r},function(t,e,r){for(var s=ce.fromSegments(t);o&&ce.comparator(o,s)<0;)n(o,null),o=i.getNext();o&&o.isEqual(s)&&(n(o,e),o=i.hasNext()?i.getNext():null),o?r.skip(o.path.toArray()):r.done()}).next(function(){for(;o;)n(o,null),o=i.hasNext()?i.getNext():null})},t.prototype.getDocumentsMatchingQuery=function(t,e){var n=this,r=G(),i=e.path.toArray(),o=IDBKeyRange.lowerBound(i);return ht(t).iterate({range:o},function(t,i,o){var s=n.serializer.fromDbRemoteDocument(i);e.path.isPrefixOf(s.key.path)?s instanceof le&&e.matches(s)&&(r=r.insert(s.key,s)):o.done()}).next(function(){return r})},t.prototype.getNewDocumentChanges=function(t){var e=this;c(this.keepDocumentChangeLog,"Can only call getNewDocumentChanges() when document change log is enabled");var n=H(),r=W(),i=IDBKeyRange.lowerBound(this._lastProcessedDocumentChangeId+1),o=!0,s=lt(t);return s.iterate({range:i},function(t,r){if(o&&(o=!1,e._lastProcessedDocumentChangeId+1!==r.id))return e.synchronizeLastDocumentChangeId(s).next(function(){return ar.reject(new Yt(Xt.DATA_LOSS,yr))});n=n.unionWith(e.serializer.fromDbResourcePaths(r.changes)),e._lastProcessedDocumentChangeId=r.id}).next(function(){var i=[];return n.forEach(function(n){i.push(e.getEntry(t,n).next(function(t){var e=t||new fe(n,Je.forDeletedDoc());r=r.insert(n,e)}))}),ar.waitFor(i)}).next(function(){return r})},t.prototype.removeDocumentChangesThroughChangeId=function(t,e){var n=IDBKeyRange.upperBound(e);return lt(t).delete(n)},t.prototype.synchronizeLastDocumentChangeId=function(t){var e=this;return this._lastProcessedDocumentChangeId=0,t.iterate({keysOnly:!0,reverse:!0},function(t,n,r){e._lastProcessedDocumentChangeId=t,r.done()})},t.prototype.newChangeBuffer=function(){return new vr(this)},t.prototype.getSize=function(t){return this.getMetadata(t).next(function(t){return t.byteSize})},t.prototype.getMetadata=function(t){return ct(t).get(Ar.key).next(function(t){return c(!!t,"Missing document cache metadata"),t})},t.prototype.setMetadata=function(t,e){return ct(t).put(Ar.key,e)},t.prototype.updateSize=function(t,e){var n=this;return this.getMetadata(t).next(function(r){return r.byteSize+=e,n.setMetadata(t,r)})},t}(),vr=function(t){function e(e){var n=t.call(this)||this;return n.documentCache=e,n}return jt.__extends(e,t),e.prototype.applyChanges=function(t){var e=this,n=0,r=[];return this.assertChanges().forEach(function(t,i){var o=e.documentCache.serializer.toDbRemoteDocument(i),s=e.documentSizes.get(t);c(void 0!==s,"Attempting to change document "+t.toString()+" without having read it first");var a=dt(o);n+=a-s,r.push({key:t,doc:o})}),this.documentCache.addEntries(t,r,n)},e.prototype.getFromCache=function(t,e){return this.documentCache.getSizedEntry(t,e)},e.prototype.getAllFromCache=function(t,e){return this.documentCache.getSizedEntries(t,e)},e}(mr),br=7,_r=function(){function t(t){this.serializer=t}return t.prototype.createOrUpgrade=function(t,e,n,r){var i=this;c(n<r&&n>=0&&r<=br,"Unexpected schema upgrade from v"+n+" to v{toVersion}."),n<1&&r>=1&&(function(t){t.createObjectStore(Er.store)}(t),function(t){t.createObjectStore(Tr.store,{keyPath:Tr.keyPath}),t.createObjectStore(Sr.store,{keyPath:Sr.keyPath,autoIncrement:!0}).createIndex(Sr.userMutationsIndex,Sr.userMutationsKeyPath,{unique:!0}),t.createObjectStore(Ir.store)}(t),pt(t),function(t){t.createObjectStore(Nr.store)}(t));var o=ar.resolve();return n<3&&r>=3&&(0!==n&&(!function(t){t.deleteObjectStore(Rr.store),t.deleteObjectStore(kr.store),t.deleteObjectStore(Or.store)}(t),pt(t)),o=o.next(function(){return function(t){var e=t.store(Or.store),n=new Or(0,0,Je.MIN.toTimestamp(),0);return e.put(Or.key,n)}(e)})),n<4&&r>=4&&(0!==n&&(o=o.next(function(){return function(t,e){return e.store(Sr.store).loadAll().next(function(n){t.deleteObjectStore(Sr.store),t.createObjectStore(Sr.store,{keyPath:Sr.keyPath,autoIncrement:!0}).createIndex(Sr.userMutationsIndex,Sr.userMutationsKeyPath,{unique:!0});var r=e.store(Sr.store),i=n.map(function(t){return r.put(t)});return ar.waitFor(i)})}(t,e)})),o=o.next(function(){!function(t){t.createObjectStore(Mr.store,{keyPath:Mr.keyPath})}(t),function(t){t.createObjectStore(Pr.store,{keyPath:"id",autoIncrement:!0})}(t)})),n<5&&r>=5&&(o=o.next(function(){return i.removeAcknowledgedMutations(e)})),n<6&&r>=6&&(o=o.next(function(){return function(t){t.createObjectStore(Ar.store)}(t),i.addDocumentGlobal(e)})),n<7&&r>=7&&(o=o.next(function(){return i.ensureSequenceNumbers(e)})),o},t.prototype.addDocumentGlobal=function(t){var e=0;return t.store(Nr.store).iterate(function(t,n){e+=dt(n)}).next(function(){var n=new Ar(e);return t.store(Ar.store).put(Ar.key,n)})},t.prototype.removeAcknowledgedMutations=function(t){var e=this,n=t.store(Tr.store),r=t.store(Sr.store);return n.loadAll().next(function(n){return ar.forEach(n,function(n){var i=IDBKeyRange.bound([n.userId,er],[n.userId,n.lastAcknowledgedBatchId]);return r.loadAll(Sr.userMutationsIndex,i).next(function(r){return ar.forEach(r,function(r){c(r.userId===n.userId,"Cannot process batch "+r.batchId+" from unexpected user");var i=e.serializer.fromDbMutationBatch(r);return yt(t,n.userId,i).next(function(){})})})})})},t.prototype.ensureSequenceNumbers=function(t){var e=t.store(Rr.store),n=t.store(Nr.store);return at(t).next(function(t){var r=[];return n.iterate(function(n,i){var o=new se(n),s=function(t){return[0,et(t)]}(o);r.push(e.get(s).next(function(n){return n?ar.resolve():function(n){return e.put(new Rr(0,et(n),t))}(o)}))}).next(function(){return ar.waitFor(r)})})},t}(),wr=function(){return function(t,e){this.seconds=t,this.nanoseconds=e}}(),Er=function(){function t(t,e,n){this.ownerId=t,this.allowTabSynchronization=e,this.leaseTimestampMs=n}return t.store="owner",t.key="owner",t}(),Tr=function(){function t(t,e,n){this.userId=t,this.lastAcknowledgedBatchId=e,this.lastStreamToken=n}return t.store="mutationQueues",t.keyPath="userId",t}(),Sr=function(){function t(t,e,n,r){this.userId=t,this.batchId=e,this.localWriteTimeMs=n,this.mutations=r}return t.store="mutations",t.keyPath="batchId",t.userMutationsIndex="userMutationsIndex",t.userMutationsKeyPath=["userId","batchId"],t}(),Ir=function(){function t(){}return t.prefixForUser=function(t){return[t]},t.prefixForPath=function(t,e){return[t,et(e)]},t.key=function(t,e,n){return[t,et(e),n]},t.store="documentMutations",t.PLACEHOLDER=new t,t}(),Cr=function(){return function(t,e){this.path=t,this.readTime=e}}(),Dr=function(){return function(t,e){this.path=t,this.version=e}}(),Nr=function(){function t(t,e,n,r){this.unknownDocument=t,this.noDocument=e,this.document=n,this.hasCommittedMutations=r}return t.store="remoteDocuments",t}(),Ar=function(){function t(t){this.byteSize=t}return t.store="remoteDocumentGlobal",t.key="remoteDocumentGlobalKey",t}(),kr=function(){function t(t,e,n,r,i,o){this.targetId=t,this.canonicalId=e,this.readTime=n,this.resumeToken=r,this.lastListenSequenceNumber=i,this.query=o}return t.store="targets",t.keyPath="targetId",t.queryTargetsIndexName="queryTargetsIndex",t.queryTargetsKeyPath=["canonicalId","targetId"],t}(),Rr=function(){function t(t,e,n){this.targetId=t,this.path=e,this.sequenceNumber=n,c(0===t==(void 0!==n),"A target-document row must either have targetId == 0 and a defined sequence number, or a non-zero targetId and no sequence number")}return t.store="targetDocuments",t.keyPath=["targetId","path"],t.documentTargetsIndex="documentTargetsIndex",t.documentTargetsKeyPath=["path","targetId"],t}(),Or=function(){function t(t,e,n,r){this.highestTargetId=t,this.highestListenSequenceNumber=e,this.lastRemoteSnapshotVersion=n,this.targetCount=r}return t.key="targetGlobalKey",t.store="targetGlobal",t}(),Pr=function(){function t(t){this.changes=t}return t.store="remoteDocumentChanges",t.keyPath="id",t}(),Mr=function(){function t(t,e,n,r,i){this.clientId=t,this.updateTimeMs=e,this.networkEnabled=n,this.inForeground=r,this.lastProcessedDocumentChangeId=i}return t.store="clientMetadata",t.keyPath="clientId",t}(),Lr=[Tr.store,Sr.store,Ir.store,Nr.store,kr.store,Er.store,Or.store,Rr.store].concat([Mr.store,Pr.store]).concat([Ar.store]),xr=function(){function t(t,e,n){this.userId=t,this.serializer=e,this.referenceDelegate=n,this.documentKeysByBatchId={}}return t.forUser=function(e,n,r){c(""!==e.uid,"UserID must not be an empty string.");return new t(e.isAuthenticated()?e.uid:"",n,r)},t.prototype.checkEmpty=function(t){var e=!0,n=IDBKeyRange.bound([this.userId,Number.NEGATIVE_INFINITY],[this.userId,Number.POSITIVE_INFINITY]);return vt(t).iterate({index:Sr.userMutationsIndex,range:n},function(t,n,r){e=!1,r.done()}).next(function(){return e})},t.prototype.acknowledgeBatch=function(t,e,n){return this.getMutationQueueMetadata(t).next(function(r){var i=e.batchId;return c(i>r.lastAcknowledgedBatchId,"Mutation batchIDs must be acknowledged in order"),r.lastAcknowledgedBatchId=i,r.lastStreamToken=gt(n),_t(t).put(r)})},t.prototype.getLastStreamToken=function(t){return this.getMutationQueueMetadata(t).next(function(t){return t.lastStreamToken})},t.prototype.setLastStreamToken=function(t,e){return this.getMutationQueueMetadata(t).next(function(n){return n.lastStreamToken=gt(e),_t(t).put(n)})},t.prototype.addMutationBatch=function(t,e,n){var r=this,i=bt(t),o=vt(t);return o.add({}).next(function(t){c("number"==typeof t,"Auto-generated key is not a number");var s=new nr(t,e,n),a=r.serializer.toDbMutationBatch(r.userId,s);r.documentKeysByBatchId[t]=s.keys();for(var u=[],h=0,l=n;h<l.length;h++){var f=Ir.key(r.userId,l[h].key.path,t);u.push(o.put(a)),u.push(i.put(f,Ir.PLACEHOLDER))}return ar.waitFor(u).next(function(){return s})})},t.prototype.lookupMutationBatch=function(t,e){var n=this;return vt(t).get(e).next(function(t){return t?(c(t.userId===n.userId,"Unexpected user '"+t.userId+"' for mutation batch "+e),n.serializer.fromDbMutationBatch(t)):null})},t.prototype.lookupMutationKeys=function(t,e){var n=this;return this.documentKeysByBatchId[e]?ar.resolve(this.documentKeysByBatchId[e]):this.lookupMutationBatch(t,e).next(function(t){if(t){var r=t.keys();return n.documentKeysByBatchId[e]=r,r}return null})},t.prototype.getNextMutationBatchAfterBatchId=function(t,e){var n=this;return this.getMutationQueueMetadata(t).next(function(r){var i=Math.max(e,r.lastAcknowledgedBatchId)+1,o=IDBKeyRange.lowerBound([n.userId,i]),s=null;return vt(t).iterate({index:Sr.userMutationsIndex,range:o},function(t,e,r){e.userId===n.userId&&(c(e.batchId>=i,"Should have found mutation after "+i),s=n.serializer.fromDbMutationBatch(e)),r.done()}).next(function(){return s})})},t.prototype.getAllMutationBatches=function(t){var e=this,n=IDBKeyRange.bound([this.userId,er],[this.userId,Number.POSITIVE_INFINITY]);return vt(t).loadAll(Sr.userMutationsIndex,n).next(function(t){return t.map(function(t){return e.serializer.fromDbMutationBatch(t)})})},t.prototype.getAllMutationBatchesAffectingDocumentKey=function(t,e){var n=this,r=Ir.prefixForPath(this.userId,e.path),i=IDBKeyRange.lowerBound(r),o=[];return bt(t).iterate({range:i},function(r,i,s){var a=r[0],h=r[2],l=rt(r[1]);if(a===n.userId&&e.path.isEqual(l))return vt(t).get(h).next(function(t){if(!t)throw u("Dangling document-mutation reference found: "+r+" which points to "+h);c(t.userId===n.userId,"Unexpected user '"+t.userId+"' for mutation batch "+h),o.push(n.serializer.fromDbMutationBatch(t))});s.done()}).next(function(){return o})},t.prototype.getAllMutationBatchesAffectingDocumentKeys=function(t,e){var n=this,r=new tn(M),i=[];return e.forEach(function(e){var o=Ir.prefixForPath(n.userId,e.path),s=IDBKeyRange.lowerBound(o),a=bt(t).iterate({range:s},function(t,i,o){var s=t[0],a=t[2],u=rt(t[1]);s===n.userId&&e.path.isEqual(u)?r=r.add(a):o.done()});i.push(a)}),ar.waitFor(i).next(function(){return n.lookupMutationBatches(t,r)})},t.prototype.getAllMutationBatchesAffectingQuery=function(t,e){var n=this;c(!e.isDocumentQuery(),"Document queries shouldn't go down this path");var r=e.path,i=r.length+1,o=Ir.prefixForPath(this.userId,r),s=IDBKeyRange.lowerBound(o),a=new tn(M);return bt(t).iterate({range:s},function(t,e,o){var s=t[0],u=t[2],c=rt(t[1]);s===n.userId&&r.isPrefixOf(c)?c.length===i&&(a=a.add(u)):o.done()}).next(function(){return n.lookupMutationBatches(t,a)})},t.prototype.lookupMutationBatches=function(t,e){var n=this,r=[],i=[];return e.forEach(function(e){i.push(vt(t).get(e).next(function(t){if(null===t)throw u("Dangling document-mutation reference found, which points to "+e);c(t.userId===n.userId,"Unexpected user '"+t.userId+"' for mutation batch "+e),r.push(n.serializer.fromDbMutationBatch(t))}))}),ar.waitFor(i).next(function(){return r})},t.prototype.removeMutationBatch=function(t,e){var n=this;return yt(t.simpleDbTransaction,this.userId,e).next(function(r){return n.removeCachedMutationKeys(e.batchId),ar.forEach(r,function(e){return n.referenceDelegate.removeMutationReference(t,e)})})},t.prototype.removeCachedMutationKeys=function(t){delete this.documentKeysByBatchId[t]},t.prototype.performConsistencyCheck=function(t){var e=this;return this.checkEmpty(t).next(function(n){if(!n)return ar.resolve();var r=IDBKeyRange.lowerBound(Ir.prefixForUser(e.userId)),i=[];return bt(t).iterate({range:r},function(t,n,r){if(t[0]===e.userId){var o=rt(t[1]);i.push(o)}else r.done()}).next(function(){c(0===i.length,"Document leak -- detected dangling mutation references when queue is empty. Dangling keys: "+i.map(function(t){return t.canonicalString()}))})})},t.prototype.containsKey=function(t,e){return mt(t,this.userId,e)},t.prototype.getMutationQueueMetadata=function(t){var e=this;return _t(t).get(this.userId).next(function(t){return t||new Tr(e.userId,er,"")})},t}(),Ur=function(){function e(t){this.remoteSerializer=t}return e.prototype.fromDbRemoteDocument=function(t){if(t.document)return this.remoteSerializer.fromDocument(t.document,!!t.hasCommittedMutations);if(t.noDocument){var e=ce.fromSegments(t.noDocument.path),n=this.fromDbTimestamp(t.noDocument.readTime);return new fe(e,n,{hasCommittedMutations:!!t.hasCommittedMutations})}if(t.unknownDocument){e=ce.fromSegments(t.unknownDocument.path),n=this.fromDbTimestamp(t.unknownDocument.version);return new de(e,n)}return u("Unexpected DbRemoteDocument")},e.prototype.toDbRemoteDocument=function(t){if(t instanceof le){var e=t.proto?t.proto:this.remoteSerializer.toDocument(t);return new Nr(null,null,e,i=t.hasCommittedMutations)}if(t instanceof fe){var n=t.key.path.toArray(),r=this.toDbTimestamp(t.version),i=t.hasCommittedMutations;return new Nr(null,new Cr(n,r),null,i)}if(t instanceof de){n=t.key.path.toArray(),r=this.toDbTimestamp(t.version);return new Nr(new Dr(n,r),null,null,!0)}return u("Unexpected MaybeDocumment")},e.prototype.toDbTimestamp=function(t){var e=t.toTimestamp();return new wr(e.seconds,e.nanoseconds)},e.prototype.fromDbTimestamp=function(t){var e=new ee(t.seconds,t.nanoseconds);return Je.fromTimestamp(e)},e.prototype.toDbMutationBatch=function(t,e){var n=this,r=e.mutations.map(function(t){return n.remoteSerializer.toMutation(t)});return new Sr(t,e.batchId,e.localWriteTime.toMillis(),r)},e.prototype.fromDbMutationBatch=function(t){var e=this,n=t.mutations.map(function(t){return e.remoteSerializer.fromMutation(t)}),r=ee.fromMillis(t.localWriteTimeMs);return new nr(t.batchId,r,n)},e.prototype.toDbResourcePaths=function(t){var e=[];return t.forEach(function(t){e.push(et(t.path))}),e},e.prototype.fromDbResourcePaths=function(t){for(var e=H(),n=0,r=t;n<r.length;n++){e=e.add(new ce(rt(r[n])))}return e},e.prototype.fromDbTarget=function(t){var e,n=this.fromDbTimestamp(t.readTime);return e=function(t){return void 0!==t.documents}(t.query)?this.remoteSerializer.fromDocumentsTarget(t.query):this.remoteSerializer.fromQueryTarget(t.query),new $e(e,t.targetId,_e.Listen,t.lastListenSequenceNumber,n,t.resumeToken)},e.prototype.toDbTarget=function(e){c(_e.Listen===e.purpose,"Only queries with purpose "+_e.Listen+" may be stored, got "+e.purpose);var n,r=this.toDbTimestamp(e.snapshotVersion);n=e.query.isDocumentQuery()?this.remoteSerializer.toDocumentsTarget(e.query):this.remoteSerializer.toQueryTarget(e.query);var i;return e.resumeToken instanceof Uint8Array?(c("YES"===t.env.USE_MOCK_PERSISTENCE,"Persisting non-string stream tokens is only supported with mock persistence ."),i=e.resumeToken.toString()):i=e.resumeToken,new kr(e.targetId,e.query.canonicalId(),r,i,e.sequenceNumber,n)},e}(),Br=function(){function t(t){this.maxElements=t,this.buffer=new tn(wt),this.previousIndex=0}return t.prototype.nextIndex=function(){return++this.previousIndex},t.prototype.addElement=function(t){var e=[t,this.nextIndex()];if(this.buffer.size<this.maxElements)this.buffer=this.buffer.add(e);else{var n=this.buffer.last();wt(e,n)<0&&(this.buffer=this.buffer.delete(n).add(e))}},Object.defineProperty(t.prototype,"maxValue",{get:function(){return this.buffer.last()[0]},enumerable:!0,configurable:!0}),t}(),Fr={didRun:!1,sequenceNumbersCollected:0,targetsRemoved:0,documentsRemoved:0},qr=function(){function t(t,e,n){this.cacheSizeCollectionThreshold=t,this.percentileToCollect=e,this.maximumSequenceNumbersToCollect=n}return t.withCacheSize=function(e){return new t(e,t.DEFAULT_COLLECTION_PERCENTILE,t.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT)},t.COLLECTION_DISABLED=-1,t.MINIMUM_CACHE_SIZE_BYTES=1048576,t.DEFAULT_CACHE_SIZE_BYTES=41943040,t.DEFAULT_COLLECTION_PERCENTILE=10,t.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT=1e3,t.DEFAULT=new t(t.DEFAULT_CACHE_SIZE_BYTES,t.DEFAULT_COLLECTION_PERCENTILE,t.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT),t.DISABLED=new t(t.COLLECTION_DISABLED,0,0),t}(),Vr=function(){function t(t,e,n){this.garbageCollector=t,this.asyncQueue=e,this.localStore=n,this.gcTask=null}return t.prototype.start=function(){c(null===this.gcTask,"Cannot start an already started LruScheduler"),this.garbageCollector.params.cacheSizeCollectionThreshold!==wo&&this.scheduleGC()},t.prototype.stop=function(){this.gcTask&&(this.gcTask.cancel(),this.gcTask=null)},Object.defineProperty(t.prototype,"started",{get:function(){return null!==this.gcTask},enumerable:!0,configurable:!0}),t.prototype.scheduleGC=function(){var t=this;c(null===this.gcTask,"Cannot schedule GC while a task is pending");var e=this.hasRun?3e5:6e4;o("LruGarbageCollector","Garbage collection scheduled in "+e+"ms"),this.gcTask=this.asyncQueue.enqueueAfterDelay(Qn.LruGarbageCollection,e,function(){return t.gcTask=null,t.hasRun=!0,t.localStore.collectGarbage(t.garbageCollector).then(function(){return t.scheduleGC()}).catch(Et)})},t}(),Kr=function(){function t(t,e){this.delegate=t,this.params=e}return t.prototype.calculateTargetCount=function(t,e){return this.delegate.getSequenceNumberCount(t).next(function(t){return Math.floor(e/100*t)})},t.prototype.nthSequenceNumber=function(t,e){var n=this;if(0===e)return ar.resolve(Gn.INVALID);var r=new Br(e);return this.delegate.forEachTarget(t,function(t){return r.addElement(t.sequenceNumber)}).next(function(){return n.delegate.forEachOrphanedDocumentSequenceNumber(t,function(t){return r.addElement(t)})}).next(function(){return r.maxValue})},t.prototype.removeTargets=function(t,e,n){return this.delegate.removeTargets(t,e,n)},t.prototype.removeOrphanedDocuments=function(t,e){return this.delegate.removeOrphanedDocuments(t,e)},t.prototype.collect=function(t,e){var n=this;return this.params.cacheSizeCollectionThreshold===qr.COLLECTION_DISABLED?(o("LruGarbageCollector","Garbage collection skipped; disabled"),ar.resolve(Fr)):this.getCacheSize(t).next(function(r){return r<n.params.cacheSizeCollectionThreshold?(o("LruGarbageCollector","Garbage collection skipped; Cache size "+r+" is lower than threshold "+n.params.cacheSizeCollectionThreshold),Fr):n.runGarbageCollection(t,e)})},t.prototype.getCacheSize=function(t){return this.delegate.getCacheSize(t)},t.prototype.runGarbageCollection=function(t,e){var n,i,s,a,u,c,h,l,f=this;return a=Date.now(),this.calculateTargetCount(t,this.params.percentileToCollect).next(function(e){return e>f.params.maximumSequenceNumbersToCollect?(o("LruGarbageCollector","Capping sequence numbers to collect down to the maximum of "+f.params.maximumSequenceNumbersToCollect+" from "+e),i=f.params.maximumSequenceNumbersToCollect):i=e,u=Date.now(),f.nthSequenceNumber(t,i)}).next(function(r){return n=r,c=Date.now(),f.removeTargets(t,n,e)}).next(function(e){return s=e,h=Date.now(),f.removeOrphanedDocuments(t,n)}).next(function(t){if(l=Date.now(),r()<=qt.DEBUG){o("LruGarbageCollector","LRU Garbage Collection\n\tCounted targets in "+(u-a)+"ms\n\tDetermined least recently used "+i+" in "+(c-u)+"ms\n\tRemoved "+s+" targets in "+(h-c)+"ms\n\tRemoved "+t+" documents in "+(l-h)+"ms\nTotal Duration: "+(l-a)+"ms")}return ar.resolve({didRun:!0,sequenceNumbersCollected:i,targetsRemoved:s,documentsRemoved:t})})},t}(),jr="IndexedDbPersistence",Wr="The current tab is not in the required state to perform this operation. It might be necessary to refresh the browser tab.",Qr="Another tab has exclusive access to the persistence layer. To allow shared access, make sure to invoke `enablePersistence()` with `experimentalTabSynchronization:true` in all tabs.",Gr="This platform is either missing IndexedDB or is known to have an incomplete implementation. Offline persistence has been disabled.",zr=function(t){function e(e,n){var r=t.call(this)||this;return r.simpleDbTransaction=e,r.currentSequenceNumber=n,r}return jt.__extends(e,t),e}(function(){return function(){}}()),Hr=function(){function t(e,n,r,i,o,s,a){if(this.persistenceKey=e,this.clientId=n,this.queue=i,this.multiClientParams=a,this._started=!1,this.isPrimary=!1,this.networkEnabled=!0,this.inForeground=!1,this.lastGarbageCollectionTime=Number.NEGATIVE_INFINITY,this.primaryStateListener=function(t){return Promise.resolve()},!t.isAvailable())throw new Yt(Xt.UNIMPLEMENTED,Gr);if(this.referenceDelegate=new Xr(this,s),this.dbName=e+t.MAIN_DATABASE,this.serializer=new Ur(o),this.document=r.document,this.allowTabSynchronization=void 0!==a,this.queryCache=new dr(this.referenceDelegate,this.serializer),this.remoteDocumentCache=new gr(this.serializer,this.allowTabSynchronization),!r.window||!r.window.localStorage)throw new Yt(Xt.UNIMPLEMENTED,"IndexedDB persistence is only available on platforms that support LocalStorage.");this.window=r.window,this.webStorage=this.window.localStorage}return t.getStore=function(t,e){if(t instanceof zr)return cr.getStore(t.simpleDbTransaction,e);throw u("IndexedDbPersistence must use instances of IndexedDbTransaction")},t.createIndexedDbPersistence=function(e,n,r,i,o,s){return jt.__awaiter(this,void 0,void 0,function(){var a;return jt.__generator(this,function(u){switch(u.label){case 0:return a=new t(e,n,r,i,o,s),[4,a.start()];case 1:return u.sent(),[2,a]}})})},t.createMultiClientIndexedDbPersistence=function(e,n,r,i,o,s,a){return jt.__awaiter(this,void 0,void 0,function(){var u;return jt.__generator(this,function(c){switch(c.label){case 0:return u=new t(e,n,r,i,o,s,a),[4,u.start()];case 1:return c.sent(),[2,u]}})})},t.prototype.start=function(){var t=this;return c(!this.started,"IndexedDbPersistence double-started!"),c(null!==this.window,"Expected 'window' to be defined"),cr.openOrCreate(this.dbName,br,new _r(this.serializer)).then(function(e){t.simpleDb=e}).then(function(){return t.startRemoteDocumentCache()}).then(function(){return t.attachVisibilityHandler(),t.attachWindowUnloadHook(),t.updateClientMetadataAndTryBecomePrimary().then(function(){return t.scheduleClientMetadataAndPrimaryLeaseRefreshes()})}).then(function(){return t.simpleDb.runTransaction("readonly",[Or.store],function(e){return at(e).next(function(e){t.listenSequence=new Gn(e,t.multiClientParams?t.multiClientParams.sequenceNumberSyncer:void 0)})})}).then(function(){t._started=!0}).catch(function(e){return t.simpleDb&&t.simpleDb.close(),Promise.reject(e)})},t.prototype.startRemoteDocumentCache=function(){var t=this;return this.simpleDb.runTransaction("readonly",Lr,function(e){return t.remoteDocumentCache.start(e)})},t.prototype.setPrimaryStateListener=function(t){var e=this;return this.primaryStateListener=function(n){return jt.__awaiter(e,void 0,void 0,function(){return jt.__generator(this,function(e){return this.started?[2,t(n)]:[2]})})},t(this.isPrimary)},t.prototype.setNetworkEnabled=function(t){var e=this;this.networkEnabled!==t&&(this.networkEnabled=t,this.queue.enqueueAndForget(function(){return jt.__awaiter(e,void 0,void 0,function(){return jt.__generator(this,function(t){switch(t.label){case 0:return this.started?[4,this.updateClientMetadataAndTryBecomePrimary()]:[3,2];case 1:t.sent(),t.label=2;case 2:return[2]}})})}))},t.prototype.updateClientMetadataAndTryBecomePrimary=function(){var t=this;return this.simpleDb.runTransaction("readwrite",Lr,function(e){return St(e).put(new Mr(t.clientId,Date.now(),t.networkEnabled,t.inForeground,t.remoteDocumentCache.lastProcessedDocumentChangeId)).next(function(){if(t.isPrimary)return t.verifyPrimaryLease(e).next(function(e){e||(t.isPrimary=!1,t.queue.enqueueAndForget(function(){return t.primaryStateListener(!1)}))})}).next(function(){return t.canActAsPrimary(e)}).next(function(n){var r=t.isPrimary;return t.isPrimary=n,r!==t.isPrimary&&t.queue.enqueueAndForget(function(){return t.primaryStateListener(t.isPrimary)}),r&&!t.isPrimary?t.releasePrimaryLeaseIfHeld(e):t.isPrimary?t.acquireOrExtendPrimaryLease(e):void 0})})},t.prototype.verifyPrimaryLease=function(t){var e=this;return Tt(t).get(Er.key).next(function(t){return ar.resolve(e.isLocalClient(t))})},t.prototype.removeClientMetadata=function(t){return St(t).delete(this.clientId)},t.prototype.maybeGarbageCollectMultiClientState=function(){return jt.__awaiter(this,void 0,void 0,function(){var e,n,r=this;return jt.__generator(this,function(i){switch(i.label){case 0:return!this.isPrimary||this.isWithinAge(this.lastGarbageCollectionTime,18e5)?[3,2]:(this.lastGarbageCollectionTime=Date.now(),n=[],[4,this.runTransaction("maybeGarbageCollectMultiClientState","readwrite-primary",function(i){var o=t.getStore(i,Mr.store);return o.loadAll().next(function(t){e=r.filterActiveClients(t,18e5),n=t.filter(function(t){return-1===e.indexOf(t)})}).next(function(){return ar.forEach(n,function(t){return o.delete(t.clientId)})}).next(function(){if((e=e.filter(function(t){return t.clientId!==r.clientId})).length>0){var t=e.map(function(t){return t.lastProcessedDocumentChangeId||0}),n=Math.min.apply(Math,t);return r.remoteDocumentCache.removeDocumentChangesThroughChangeId(i,n)}})})]);case 1:i.sent(),n.forEach(function(t){r.window.localStorage.removeItem(r.zombiedClientLocalStorageKey(t.clientId))}),i.label=2;case 2:return[2]}})})},t.prototype.scheduleClientMetadataAndPrimaryLeaseRefreshes=function(){var t=this;this.clientMetadataRefresher=this.queue.enqueueAfterDelay(Qn.ClientMetadataRefresh,4e3,function(){return t.updateClientMetadataAndTryBecomePrimary().then(function(){return t.maybeGarbageCollectMultiClientState()}).then(function(){return t.scheduleClientMetadataAndPrimaryLeaseRefreshes()})})},t.prototype.isLocalClient=function(t){return!!t&&t.ownerId===this.clientId},t.prototype.canActAsPrimary=function(t){var e=this;return Tt(t).get(Er.key).next(function(n){if(null!==n&&e.isWithinAge(n.leaseTimestampMs,5e3)&&!e.isClientZombied(n.ownerId)){if(e.isLocalClient(n)&&e.networkEnabled)return!0;if(!e.isLocalClient(n)){if(!n.allowTabSynchronization)throw new Yt(Xt.FAILED_PRECONDITION,Qr);return!1}}return!(!e.networkEnabled||!e.inForeground)||St(t).loadAll().next(function(t){return void 0===e.filterActiveClients(t,5e3).find(function(t){if(e.clientId!==t.clientId){if(!e.networkEnabled&&t.networkEnabled||!e.inForeground&&t.inForeground&&e.networkEnabled===t.networkEnabled)return!0}return!1})})}).next(function(t){return e.isPrimary!==t&&o(jr,"Client "+(t?"is":"is not")+" eligible for a primary lease."),t})},t.prototype.shutdown=function(t){return jt.__awaiter(this,void 0,void 0,function(){var e=this;return jt.__generator(this,function(n){switch(n.label){case 0:return this._started=!1,this.markClientZombied(),this.clientMetadataRefresher&&this.clientMetadataRefresher.cancel(),this.detachVisibilityHandler(),this.detachWindowUnloadHook(),[4,this.simpleDb.runTransaction("readwrite",[Er.store,Mr.store],function(t){return e.releasePrimaryLeaseIfHeld(t).next(function(){return e.removeClientMetadata(t)})})];case 1:return n.sent(),this.simpleDb.close(),this.removeClientZombiedEntry(),t?[4,cr.delete(this.dbName)]:[3,3];case 2:n.sent(),n.label=3;case 3:return[2]}})})},t.prototype.filterActiveClients=function(t,e){var n=this;return t.filter(function(t){return n.isWithinAge(t.updateTimeMs,e)&&!n.isClientZombied(t.clientId)})},t.prototype.getActiveClients=function(){var t=this;return this.simpleDb.runTransaction("readonly",[Mr.store],function(e){return St(e).loadAll().next(function(e){return t.filterActiveClients(e,18e5).map(function(t){return t.clientId})})})},Object.defineProperty(t.prototype,"started",{get:function(){return this._started},enumerable:!0,configurable:!0}),t.prototype.getMutationQueue=function(t){return c(this.started,"Cannot initialize MutationQueue before persistence is started."),xr.forUser(t,this.serializer,this.referenceDelegate)},t.prototype.getQueryCache=function(){return c(this.started,"Cannot initialize QueryCache before persistence is started."),this.queryCache},t.prototype.getRemoteDocumentCache=function(){return c(this.started,"Cannot initialize RemoteDocumentCache before persistence is started."),this.remoteDocumentCache},t.prototype.runTransaction=function(t,e,n){var r=this;return o(jr,"Starting transaction:",t),this.simpleDb.runTransaction("readonly"===e?"readonly":"readwrite",Lr,function(i){return"readwrite-primary"===e?r.verifyPrimaryLease(i).next(function(e){if(!e)throw s("Failed to obtain primary lease for action '"+t+"'."),r.isPrimary=!1,r.queue.enqueueAndForget(function(){return r.primaryStateListener(!1)}),new Yt(Xt.FAILED_PRECONDITION,Wr);return n(new zr(i,r.listenSequence.next()))}).next(function(t){return r.acquireOrExtendPrimaryLease(i).next(function(){return t})}):r.verifyAllowTabSynchronization(i).next(function(){return n(new zr(i,r.listenSequence.next()))})})},t.prototype.verifyAllowTabSynchronization=function(t){var e=this;return Tt(t).get(Er.key).next(function(t){if(null!==t&&e.isWithinAge(t.leaseTimestampMs,5e3)&&!e.isClientZombied(t.ownerId)&&!e.isLocalClient(t)&&!t.allowTabSynchronization)throw new Yt(Xt.FAILED_PRECONDITION,Qr)})},t.prototype.acquireOrExtendPrimaryLease=function(t){var e=new Er(this.clientId,this.allowTabSynchronization,Date.now());return Tt(t).put(Er.key,e)},t.isAvailable=function(){return cr.isAvailable()},t.buildStoragePrefix=function(t){var e=t.databaseId.projectId;return t.databaseId.isDefaultDatabase||(e+="."+t.databaseId.database),"firestore/"+t.persistenceKey+"/"+e+"/"},t.prototype.releasePrimaryLeaseIfHeld=function(t){var e=this,n=Tt(t);return n.get(Er.key).next(function(t){return e.isLocalClient(t)?(o(jr,"Releasing primary lease."),n.delete(Er.key)):ar.resolve()})},t.prototype.isWithinAge=function(t,e){var n=Date.now();return!(t<n-e)&&(!(t>n)||(s("Detected an update time that is in the future: "+t+" > "+n),!1))},t.prototype.attachVisibilityHandler=function(){var t=this;null!==this.document&&"function"==typeof this.document.addEventListener&&(this.documentVisibilityHandler=function(){t.queue.enqueueAndForget(function(){return t.inForeground="visible"===t.document.visibilityState,t.updateClientMetadataAndTryBecomePrimary()})},this.document.addEventListener("visibilitychange",this.documentVisibilityHandler),this.inForeground="visible"===this.document.visibilityState)},t.prototype.detachVisibilityHandler=function(){this.documentVisibilityHandler&&(c(null!==this.document&&"function"==typeof this.document.addEventListener,"Expected 'document.addEventListener' to be a function"),this.document.removeEventListener("visibilitychange",this.documentVisibilityHandler),this.documentVisibilityHandler=null)},t.prototype.attachWindowUnloadHook=function(){var t=this;"function"==typeof this.window.addEventListener&&(this.windowUnloadHandler=function(){t.markClientZombied(),t.queue.enqueueAndForget(function(){return t.shutdown()})},this.window.addEventListener("unload",this.windowUnloadHandler))},t.prototype.detachWindowUnloadHook=function(){this.windowUnloadHandler&&(c("function"==typeof this.window.removeEventListener,"Expected 'window.removeEventListener' to be a function"),this.window.removeEventListener("unload",this.windowUnloadHandler),this.windowUnloadHandler=null)},t.prototype.isClientZombied=function(t){try{var e=null!==this.webStorage.getItem(this.zombiedClientLocalStorageKey(t));return o(jr,"Client '"+t+"' "+(e?"is":"is not")+" zombied in LocalStorage"),e}catch(t){return s(jr,"Failed to get zombied client id.",t),!1}},t.prototype.markClientZombied=function(){try{this.webStorage.setItem(this.zombiedClientLocalStorageKey(this.clientId),String(Date.now()))}catch(t){s("Failed to set zombie client id.",t)}},t.prototype.removeClientZombiedEntry=function(){try{this.webStorage.removeItem(this.zombiedClientLocalStorageKey(this.clientId))}catch(t){}},t.prototype.zombiedClientLocalStorageKey=function(t){return"firestore_zombie_"+this.persistenceKey+"_"+t},t.MAIN_DATABASE="main",t}(),Xr=function(){function t(t,e){this.db=t,this.garbageCollector=new Kr(this,e)}return t.prototype.getSequenceNumberCount=function(t){var e=this.orphanedDocmentCount(t);return this.db.getQueryCache().getQueryCount(t).next(function(t){return e.next(function(e){return t+e})})},t.prototype.orphanedDocmentCount=function(t){var e=0;return this.forEachOrphanedDocumentSequenceNumber(t,function(t){e++}).next(function(){return e})},t.prototype.forEachTarget=function(t,e){return this.db.getQueryCache().forEachTarget(t,e)},t.prototype.forEachOrphanedDocumentSequenceNumber=function(t,e){return this.forEachOrphanedDocument(t,function(t,n){return e(n)})},t.prototype.setInMemoryPins=function(t){this.inMemoryPins=t},t.prototype.addReference=function(t,e){return It(t,e)},t.prototype.removeReference=function(t,e){return It(t,e)},t.prototype.removeTargets=function(t,e,n){return this.db.getQueryCache().removeTargets(t,e,n)},t.prototype.removeMutationReference=function(t,e){return It(t,e)},t.prototype.isPinned=function(t,e){return this.inMemoryPins.containsKey(e)?ar.resolve(!0):function(t,e){var n=!1;return _t(t).iterateSerial(function(r){return mt(t,r,e).next(function(t){return t&&(n=!0),ar.resolve(!t)})}).next(function(){return n})}(t,e)},t.prototype.removeOrphanedDocuments=function(t,e){var n=this,r=0,i=0,o=[];return this.forEachOrphanedDocument(t,function(s,a){if(a<=e){var u=n.isPinned(t,s).next(function(e){if(!e)return r++,n.removeOrphanedDocument(t,s).next(function(t){i+=t})});o.push(u)}}).next(function(){return ar.waitFor(o)}).next(function(){return n.db.getRemoteDocumentCache().updateSize(t,-i)}).next(function(){return r})},t.prototype.removeOrphanedDocument=function(t,e){var n=0,r=this.db.getRemoteDocumentCache();return ar.waitFor([ut(t).delete(function(t){return[0,et(t.path)]}(e)),r.removeEntry(t,e).next(function(t){n+=t})]).next(function(){return n})},t.prototype.removeTarget=function(t,e){var n=e.copy({sequenceNumber:t.currentSequenceNumber});return this.db.getQueryCache().updateQueryData(t,n)},t.prototype.updateLimboDocument=function(t,e){return It(t,e)},t.prototype.forEachOrphanedDocument=function(t,e){var n,r=ut(t),i=Gn.INVALID;return r.iterate({index:Rr.documentTargetsIndex},function(t,r){var o=r.path,s=r.sequenceNumber;0===t[0]?(i!==Gn.INVALID&&e(new ce(rt(n)),i),i=s,n=o):i=Gn.INVALID}).next(function(){i!==Gn.INVALID&&e(new ce(rt(n)),i)})},t.prototype.getCacheSize=function(t){return this.db.getRemoteDocumentCache().getSize(t)},t}(),Yr=function(){function t(t,e){this.remoteDocumentCache=t,this.mutationQueue=e}return t.prototype.getDocument=function(t,e){var n=this;return this.mutationQueue.getAllMutationBatchesAffectingDocumentKey(t,e).next(function(r){return n.getDocumentInternal(t,e,r)})},t.prototype.getDocumentInternal=function(t,e,n){return this.remoteDocumentCache.getEntry(t,e).next(function(t){for(var r=0,i=n;r<i.length;r++){t=i[r].applyToLocalView(e,t)}return t})},t.prototype.applyLocalMutationsToDocuments=function(t,e,n){var r=Q();return e.forEach(function(t,e){for(var i=0,o=n;i<o.length;i++){e=o[i].applyToLocalView(t,e)}r=r.insert(t,e)}),r},t.prototype.getDocuments=function(t,e){var n=this;return this.remoteDocumentCache.getEntries(t,e).next(function(e){return n.getLocalViewOfDocuments(t,e)})},t.prototype.getLocalViewOfDocuments=function(t,e){var n=this;return this.mutationQueue.getAllMutationBatchesAffectingDocumentKeys(t,e).next(function(r){var i=n.applyLocalMutationsToDocuments(t,e,r),o=W();return i.forEach(function(t,e){e||(e=new fe(t,Je.forDeletedDoc())),o=o.insert(t,e)}),o})},t.prototype.getDocumentsMatchingQuery=function(t,e){return ce.isDocumentKey(e.path)?this.getDocumentsMatchingDocumentQuery(t,e.path):this.getDocumentsMatchingCollectionQuery(t,e)},t.prototype.getDocumentsMatchingDocumentQuery=function(t,e){return this.getDocument(t,new ce(e)).next(function(t){var e=G();return t instanceof le&&(e=e.insert(t.key,t)),e})},t.prototype.getDocumentsMatchingCollectionQuery=function(t,e){var n,r=this;return this.remoteDocumentCache.getDocumentsMatchingQuery(t,e).next(function(i){return n=i,r.mutationQueue.getAllMutationBatchesAffectingQuery(t,e)}).next(function(t){for(var r=0,i=t;r<i.length;r++)for(var o=i[r],s=0,a=o.mutations;s<a.length;s++){var u=a[s],c=u.key;if(e.path.isImmediateParentOf(c.path)){var h=n.get(c),l=u.applyToLocalView(h,h,o.localWriteTime);n=l instanceof le?n.insert(c,l):n.remove(c)}}}).next(function(){return n.forEach(function(t,r){e.matches(r)||(n=n.remove(t))}),n})},t}(),Jr=function(){function t(){this.refsByKey=new tn(Zr.compareByKey),this.refsByTarget=new tn(Zr.compareByTargetId)}return t.prototype.isEmpty=function(){return this.refsByKey.isEmpty()},t.prototype.addReference=function(t,e){var n=new Zr(t,e);this.refsByKey=this.refsByKey.add(n),this.refsByTarget=this.refsByTarget.add(n)},t.prototype.addReferences=function(t,e){var n=this;t.forEach(function(t){return n.addReference(t,e)})},t.prototype.removeReference=function(t,e){this.removeRef(new Zr(t,e))},t.prototype.removeReferences=function(t,e){var n=this;t.forEach(function(t){return n.removeReference(t,e)})},t.prototype.removeReferencesForId=function(t){var e=this,n=ce.EMPTY,r=new Zr(n,t),i=new Zr(n,t+1),o=[];return this.refsByTarget.forEachInRange([r,i],function(t){e.removeRef(t),o.push(t.key)}),o},t.prototype.removeAllReferences=function(){var t=this;this.refsByKey.forEach(function(e){return t.removeRef(e)})},t.prototype.removeRef=function(t){this.refsByKey=this.refsByKey.delete(t),this.refsByTarget=this.refsByTarget.delete(t)},t.prototype.referencesForId=function(t){var e=ce.EMPTY,n=new Zr(e,t),r=new Zr(e,t+1),i=H();return this.refsByTarget.forEachInRange([n,r],function(t){i=i.add(t.key)}),i},t.prototype.containsKey=function(t){var e=new Zr(t,0),n=this.refsByKey.firstAfterOrEqual(e);return null!==n&&t.isEqual(n.key)},t}(),Zr=function(){function t(t,e){this.key=t,this.targetOrBatchId=e}return t.compareByKey=function(t,e){return ce.comparator(t.key,e.key)||M(t.targetOrBatchId,e.targetOrBatchId)},t.compareByTargetId=function(t,e){return M(t.targetOrBatchId,e.targetOrBatchId)||ce.comparator(t.key,e.key)},t}(),$r=function(){function t(t,e){this.persistence=t,this.localViewReferences=new Jr,this.queryDataByTarget={},c(t.started,"LocalStore was passed an unstarted persistence implementation"),this.persistence.referenceDelegate.setInMemoryPins(this.localViewReferences),this.mutationQueue=t.getMutationQueue(e),this.remoteDocuments=t.getRemoteDocumentCache(),this.queryCache=t.getQueryCache(),this.localDocuments=new Yr(this.remoteDocuments,this.mutationQueue)}return t.prototype.handleUserChange=function(t){var e=this;return this.persistence.runTransaction("Handle user change","readonly",function(n){var r;return e.mutationQueue.getAllMutationBatches(n).next(function(i){return r=i,e.mutationQueue=e.persistence.getMutationQueue(t),e.localDocuments=new Yr(e.remoteDocuments,e.mutationQueue),e.mutationQueue.getAllMutationBatches(n)}).next(function(t){for(var i=[],o=[],s=H(),a=0,u=r;a<u.length;a++){i.push((d=u[a]).batchId);for(var c=0,h=d.mutations;c<h.length;c++){s=s.add(h[c].key)}}for(var l=0,f=t;l<f.length;l++){var d;o.push((d=f[l]).batchId);for(var p=0,m=d.mutations;p<m.length;p++){s=s.add(m[p].key)}}return e.localDocuments.getDocuments(n,s).next(function(t){return{affectedDocuments:t,removedBatchIds:i,addedBatchIds:o}})})})},t.prototype.localWrite=function(t){var e=this;return this.persistence.runTransaction("Locally write mutations","readwrite",function(n){var r,i=ee.now();return e.mutationQueue.addMutationBatch(n,i,t).next(function(t){var i=(r=t).keys();return e.localDocuments.getDocuments(n,i)}).next(function(t){return{batchId:r.batchId,changes:t}})})},t.prototype.lookupMutationDocuments=function(t){var e=this;return this.persistence.runTransaction("Lookup mutation documents","readonly",function(n){return e.mutationQueue.lookupMutationKeys(n,t).next(function(t){return t?e.localDocuments.getDocuments(n,t):ar.resolve(null)})})},t.prototype.acknowledgeBatch=function(t){var e=this;return this.persistence.runTransaction("Acknowledge batch","readwrite-primary",function(n){var r=t.batch.keys(),i=e.remoteDocuments.newChangeBuffer();return e.mutationQueue.acknowledgeBatch(n,t.batch,t.streamToken).next(function(){return e.applyWriteToRemoteDocuments(n,t,i)}).next(function(){return i.apply(n)}).next(function(){return e.mutationQueue.performConsistencyCheck(n)}).next(function(){return e.localDocuments.getDocuments(n,r)})})},t.prototype.rejectBatch=function(t){var e=this;return this.persistence.runTransaction("Reject batch","readwrite-primary",function(n){var r;return e.mutationQueue.lookupMutationBatch(n,t).next(function(t){return c(null!==t,"Attempt to reject nonexistent batch!"),r=t.keys(),e.mutationQueue.removeMutationBatch(n,t)}).next(function(){return e.mutationQueue.performConsistencyCheck(n)}).next(function(){return e.localDocuments.getDocuments(n,r)})})},t.prototype.getLastStreamToken=function(){var t=this;return this.persistence.runTransaction("Get last stream token","readonly",function(e){return t.mutationQueue.getLastStreamToken(e)})},t.prototype.setLastStreamToken=function(t){var e=this;return this.persistence.runTransaction("Set last stream token","readwrite-primary",function(n){return e.mutationQueue.setLastStreamToken(n,t)})},t.prototype.getLastRemoteSnapshotVersion=function(){var t=this;return this.persistence.runTransaction("Get last remote snapshot version","readonly",function(e){return t.queryCache.getLastRemoteSnapshotVersion(e)})},t.prototype.applyRemoteEvent=function(e){var n=this,r=this.remoteDocuments.newChangeBuffer();return this.persistence.runTransaction("Apply remote event","readwrite-primary",function(i){var s=[],a=H();p(e.targetChanges,function(r,o){var u=n.queryDataByTarget[r];if(u){o.addedDocuments.forEach(function(t){a=a.add(t)}),o.modifiedDocuments.forEach(function(t){a=a.add(t)}),s.push(n.queryCache.removeMatchingKeys(i,o.removedDocuments,r).next(function(){return n.queryCache.addMatchingKeys(i,o.addedDocuments,r)}));var c=o.resumeToken;if(c.length>0){var h=u;u=u.copy({resumeToken:c,snapshotVersion:e.snapshotVersion}),n.queryDataByTarget[r]=u,t.shouldPersistQueryData(h,u,o)&&s.push(n.queryCache.updateQueryData(i,u))}}});var u=W(),h=H();e.documentUpdates.forEach(function(t,e){h=h.add(t)}),s.push(r.getEntries(i,h).next(function(t){e.documentUpdates.forEach(function(c,h){var l=t.get(c);null==l||h.version.isEqual(Je.MIN)||a.has(h.key)&&!l.hasPendingWrites||h.version.compareTo(l.version)>=0?(r.addEntry(h),u=u.insert(c,h)):o("LocalStore","Ignoring outdated watch update for ",c,". Current version:",l.version," Watch version:",h.version),e.resolvedLimboDocuments.has(c)&&s.push(n.persistence.referenceDelegate.updateLimboDocument(i,c))})}));var l=e.snapshotVersion;if(!l.isEqual(Je.MIN)){var f=n.queryCache.getLastRemoteSnapshotVersion(i).next(function(t){return c(l.compareTo(t)>=0,"Watch stream reverted to previous snapshot?? "+l+" < "+t),n.queryCache.setTargetsMetadata(i,i.currentSequenceNumber,l)});s.push(f)}return ar.waitFor(s).next(function(){return r.apply(i)}).next(function(){return n.localDocuments.getLocalViewOfDocuments(i,u)})})},t.shouldPersistQueryData=function(t,e,n){if(0===e.resumeToken.length)return!1;if(0===t.resumeToken.length)return!0;if(e.snapshotVersion.toMicroseconds()-t.snapshotVersion.toMicroseconds()>=this.RESUME_TOKEN_MAX_AGE_MICROS)return!0;return n.addedDocuments.size+n.modifiedDocuments.size+n.removedDocuments.size>0},t.prototype.notifyLocalViewChanges=function(t){var e=this;return this.persistence.runTransaction("notifyLocalViewChanges","readwrite",function(n){return ar.forEach(t,function(t){return e.localViewReferences.addReferences(t.addedKeys,t.targetId),e.localViewReferences.removeReferences(t.removedKeys,t.targetId),ar.forEach(t.removedKeys,function(t){return e.persistence.referenceDelegate.removeReference(n,t)})})})},t.prototype.nextMutationBatch=function(t){var e=this;return this.persistence.runTransaction("Get next mutation batch","readonly",function(n){return void 0===t&&(t=er),e.mutationQueue.getNextMutationBatchAfterBatchId(n,t)})},t.prototype.readDocument=function(t){var e=this;return this.persistence.runTransaction("read document","readonly",function(n){return e.localDocuments.getDocument(n,t)})},t.prototype.allocateQuery=function(t){var e=this;return this.persistence.runTransaction("Allocate query","readwrite",function(n){var r;return e.queryCache.getQueryData(n,t).next(function(i){return i?(r=i,ar.resolve()):e.queryCache.allocateTargetId(n).next(function(i){return r=new $e(t,i,_e.Listen,n.currentSequenceNumber),e.queryCache.addQueryData(n,r)})}).next(function(){return c(!e.queryDataByTarget[r.targetId],"Tried to allocate an already allocated query: "+t),e.queryDataByTarget[r.targetId]=r,r})})},t.prototype.releaseQuery=function(t,e){var n=this;return this.persistence.runTransaction("Release query",e?"readwrite":"readwrite-primary",function(r){return n.queryCache.getQueryData(r,t).next(function(i){c(null!=i,"Tried to release nonexistent query: "+t);var o=i.targetId,s=n.queryDataByTarget[o],a=n.localViewReferences.removeReferencesForId(o);return delete n.queryDataByTarget[o],e?ar.resolve():ar.forEach(a,function(t){return n.persistence.referenceDelegate.removeReference(r,t)}).next(function(){return n.persistence.referenceDelegate.removeTarget(r,s)})})})},t.prototype.executeQuery=function(t){var e=this;return this.persistence.runTransaction("Execute query","readonly",function(n){return e.localDocuments.getDocumentsMatchingQuery(n,t)})},t.prototype.remoteDocumentKeys=function(t){var e=this;return this.persistence.runTransaction("Remote document keys","readonly",function(n){return e.queryCache.getMatchingKeysForTargetId(n,t)})},t.prototype.getActiveClients=function(){return this.persistence.getActiveClients()},t.prototype.removeCachedMutationBatchMetadata=function(t){this.mutationQueue.removeCachedMutationKeys(t)},t.prototype.setNetworkEnabled=function(t){this.persistence.setNetworkEnabled(t)},t.prototype.applyWriteToRemoteDocuments=function(t,e,n){var r=this,i=e.batch,o=i.keys(),s=ar.resolve();return o.forEach(function(r){s=s.next(function(){return n.getEntry(t,r)}).next(function(t){var o=t,s=e.docVersions.get(r);c(null!==s,"ackVersions should contain every doc in the write."),(!o||o.version.compareTo(s)<0)&&((o=i.applyToRemoteDocument(r,o,e))?n.addEntry(o):c(!t,"Mutation batch "+i+" applied to document "+t+" resulted in null"))})}),s.next(function(){return r.mutationQueue.removeMutationBatch(t,i)})},t.prototype.collectGarbage=function(t){var e=this;return this.persistence.runTransaction("Collect garbage","readwrite-primary",function(n){return t.collect(n,e.queryDataByTarget)})},t.prototype.getQueryForTarget=function(t){var e=this;return this.queryDataByTarget[t]?Promise.resolve(this.queryDataByTarget[t].query):this.persistence.runTransaction("Get query data","readonly",function(n){return e.queryCache.getQueryDataForTarget(n,t).next(function(t){return t?t.query:null})})},t.prototype.getNewDocumentChanges=function(){var t=this;return this.persistence.runTransaction("Get new document changes","readonly",function(e){return t.remoteDocuments.getNewDocumentChanges(e)})},t.RESUME_TOKEN_MAX_AGE_MICROS=3e8,t}(),ti=function(){function t(t){this.referenceDelegate=t,this.mutationQueue=[],this.nextBatchId=1,this.highestAcknowledgedBatchId=er,this.lastStreamToken=h(),this.batchesByDocumentKey=new tn(Zr.compareByKey)}return t.prototype.checkEmpty=function(t){return ar.resolve(0===this.mutationQueue.length)},t.prototype.acknowledgeBatch=function(t,e,n){var r=e.batchId;c(r>this.highestAcknowledgedBatchId,"Mutation batchIDs must be acknowledged in order");var i=this.indexOfExistingBatchId(r,"acknowledged");c(0===i,"Can only acknowledge the first batch in the mutation queue");var o=this.mutationQueue[i];return c(r===o.batchId,"Queue ordering failure: expected batch "+r+", got batch "+o.batchId),this.highestAcknowledgedBatchId=r,this.lastStreamToken=n,ar.resolve()},t.prototype.getLastStreamToken=function(t){return ar.resolve(this.lastStreamToken)},t.prototype.setLastStreamToken=function(t,e){return this.lastStreamToken=e,ar.resolve()},t.prototype.addMutationBatch=function(t,e,n){c(0!==n.length,"Mutation batches should not be empty");var r=this.nextBatchId;if(this.nextBatchId++,this.mutationQueue.length>0){c(this.mutationQueue[this.mutationQueue.length-1].batchId<r,"Mutation batchIDs must be monotonically increasing order")}var i=new nr(r,e,n);this.mutationQueue.push(i);for(var o=0,s=n;o<s.length;o++){this.batchesByDocumentKey=this.batchesByDocumentKey.add(new Zr(s[o].key,r))}return ar.resolve(i)},t.prototype.lookupMutationBatch=function(t,e){return ar.resolve(this.findMutationBatch(e))},t.prototype.lookupMutationKeys=function(t,e){var n=this.findMutationBatch(e);return c(null!=n,"Failed to find local mutation batch."),ar.resolve(n.keys())},t.prototype.getNextMutationBatchAfterBatchId=function(t,e){var n=Math.max(e,this.highestAcknowledgedBatchId)+1,r=this.indexOfBatchId(n),i=r<0?0:r;return ar.resolve(this.mutationQueue.length>i?this.mutationQueue[i]:null)},t.prototype.getAllMutationBatches=function(t){return ar.resolve(this.mutationQueue.slice())},t.prototype.getAllMutationBatchesAffectingDocumentKey=function(t,e){var n=this,r=new Zr(e,0),i=new Zr(e,Number.POSITIVE_INFINITY),o=[];return this.batchesByDocumentKey.forEachInRange([r,i],function(t){c(e.isEqual(t.key),"Should only iterate over a single key's batches");var r=n.findMutationBatch(t.targetOrBatchId);c(null!==r,"Batches in the index must exist in the main table"),o.push(r)}),ar.resolve(o)},t.prototype.getAllMutationBatchesAffectingDocumentKeys=function(t,e){var n=this,r=new tn(M);return e.forEach(function(t){var e=new Zr(t,0),i=new Zr(t,Number.POSITIVE_INFINITY);n.batchesByDocumentKey.forEachInRange([e,i],function(e){c(t.isEqual(e.key),"For each key, should only iterate over a single key's batches"),r=r.add(e.targetOrBatchId)})}),ar.resolve(this.findMutationBatches(r))},t.prototype.getAllMutationBatchesAffectingQuery=function(t,e){var n=e.path,r=n.length+1,i=n;ce.isDocumentKey(i)||(i=i.child(""));var o=new Zr(new ce(i),0),s=new tn(M);return this.batchesByDocumentKey.forEachWhile(function(t){var e=t.key.path;return!!n.isPrefixOf(e)&&(e.length===r&&(s=s.add(t.targetOrBatchId)),!0)},o),ar.resolve(this.findMutationBatches(s))},t.prototype.findMutationBatches=function(t){var e=this,n=[];return t.forEach(function(t){var r=e.findMutationBatch(t);null!==r&&n.push(r)}),n},t.prototype.removeMutationBatch=function(t,e){var n=this;c(0===this.indexOfExistingBatchId(e.batchId,"removed"),"Can only remove the first entry of the mutation queue"),this.mutationQueue.shift();var r=this.batchesByDocumentKey;return ar.forEach(e.mutations,function(i){var o=new Zr(i.key,e.batchId);return r=r.delete(o),n.referenceDelegate.removeMutationReference(t,i.key)}).next(function(){n.batchesByDocumentKey=r})},t.prototype.removeCachedMutationKeys=function(t){},t.prototype.containsKey=function(t,e){var n=new Zr(e,0),r=this.batchesByDocumentKey.firstAfterOrEqual(n);return ar.resolve(e.isEqual(r&&r.key))},t.prototype.performConsistencyCheck=function(t){return 0===this.mutationQueue.length&&c(this.batchesByDocumentKey.isEmpty(),"Document leak -- detected dangling mutation references when queue is empty."),ar.resolve()},t.prototype.indexOfExistingBatchId=function(t,e){var n=this.indexOfBatchId(t);return c(n>=0&&n<this.mutationQueue.length,"Batches must exist to be "+e),n},t.prototype.indexOfBatchId=function(t){if(0===this.mutationQueue.length)return 0;return t-this.mutationQueue[0].batchId},t.prototype.findMutationBatch=function(t){var e=this.indexOfBatchId(t);if(e<0||e>=this.mutationQueue.length)return null;var n=this.mutationQueue[e];return c(n.batchId===t,"If found batch must match"),n},t}(),ei=function(){function t(t){this.persistence=t,this.queries=new pr(function(t){return t.canonicalId()}),this.lastRemoteSnapshotVersion=Je.MIN,this.highestTargetId=0,this.highestSequenceNumber=0,this.references=new Jr,this.targetCount=0,this.targetIdGenerator=sr.forQueryCache()}return t.prototype.getTargetCount=function(t){return ar.resolve(this.targetCount)},t.prototype.forEachTarget=function(t,e){return this.queries.forEach(function(t,n){return e(n)}),ar.resolve()},t.prototype.getLastRemoteSnapshotVersion=function(t){return ar.resolve(this.lastRemoteSnapshotVersion)},t.prototype.getHighestSequenceNumber=function(t){return ar.resolve(this.highestSequenceNumber)},t.prototype.allocateTargetId=function(t){var e=this.targetIdGenerator.after(this.highestTargetId);return this.highestTargetId=e,ar.resolve(e)},t.prototype.setTargetsMetadata=function(t,e,n){return n&&(this.lastRemoteSnapshotVersion=n),e>this.highestSequenceNumber&&(this.highestSequenceNumber=e),ar.resolve()},t.prototype.saveQueryData=function(t){this.queries.set(t.query,t);var e=t.targetId;e>this.highestTargetId&&(this.highestTargetId=e),t.sequenceNumber>this.highestSequenceNumber&&(this.highestSequenceNumber=t.sequenceNumber)},t.prototype.addQueryData=function(t,e){return c(!this.queries.has(e.query),"Adding a query that already exists"),this.saveQueryData(e),this.targetCount+=1,ar.resolve()},t.prototype.updateQueryData=function(t,e){return c(this.queries.has(e.query),"Updating a non-existent query"),this.saveQueryData(e),ar.resolve()},t.prototype.removeQueryData=function(t,e){return c(this.targetCount>0,"Removing a target from an empty cache"),c(this.queries.has(e.query),"Removing a non-existent target from the cache"),this.queries.delete(e.query),this.references.removeReferencesForId(e.targetId),this.targetCount-=1,ar.resolve()},t.prototype.removeTargets=function(t,e,n){var r=this,i=0,o=[];return this.queries.forEach(function(s,a){a.sequenceNumber<=e&&!n[a.targetId]&&(r.queries.delete(s),o.push(r.removeMatchingKeysForTargetId(t,a.targetId)),i++)}),ar.waitFor(o).next(function(){return i})},t.prototype.getQueryCount=function(t){return ar.resolve(this.targetCount)},t.prototype.getQueryData=function(t,e){var n=this.queries.get(e)||null;return ar.resolve(n)},t.prototype.getQueryDataForTarget=function(t,e){return u("Not yet implemented.")},t.prototype.addMatchingKeys=function(t,e,n){this.references.addReferences(e,n);var r=this.persistence.referenceDelegate,i=[];return r&&e.forEach(function(e){i.push(r.addReference(t,e))}),ar.waitFor(i)},t.prototype.removeMatchingKeys=function(t,e,n){this.references.removeReferences(e,n);var r=this.persistence.referenceDelegate,i=[];return r&&e.forEach(function(e){i.push(r.removeReference(t,e))}),ar.waitFor(i)},t.prototype.removeMatchingKeysForTargetId=function(t,e){return this.references.removeReferencesForId(e),ar.resolve()},t.prototype.getMatchingKeysForTargetId=function(t,e){var n=this.references.referencesForId(e);return ar.resolve(n)},t.prototype.containsKey=function(t,e){return ar.resolve(this.references.containsKey(e))},t}(),ni=function(){function t(t){this.sizer=t,this.docs=new pe(ce.comparator),this.newDocumentChanges=H(),this.size=0}return t.prototype.addEntries=function(t,e,n){for(var r=0,i=e;r<i.length;r++){var o=i[r],s=o.maybeDocument.key;this.docs=this.docs.insert(s,o),this.newDocumentChanges=this.newDocumentChanges.add(s)}return this.size+=n,ar.resolve()},t.prototype.removeEntry=function(t,e){var n=this.docs.get(e);return n?(this.docs=this.docs.remove(e),this.size-=n.size,ar.resolve(n.size)):ar.resolve(0)},t.prototype.getEntry=function(t,e){var n=this.docs.get(e);return ar.resolve(n?n.maybeDocument:null)},t.prototype.getSizedEntry=function(t,e){return ar.resolve(this.docs.get(e))},t.prototype.getEntries=function(t,e){var n=this,r=Q();return e.forEach(function(t){var e=n.docs.get(t);r=r.insert(t,e?e.maybeDocument:null)}),ar.resolve(r)},t.prototype.getSizedEntries=function(t,e){var n=this,r=Q(),i=new pe(ce.comparator);return e.forEach(function(t){var e=n.docs.get(t);r=r.insert(t,e?e.maybeDocument:null),i=i.insert(t,e?e.size:0)}),ar.resolve({maybeDocuments:r,sizeMap:i})},t.prototype.getDocumentsMatchingQuery=function(t,e){for(var n=G(),r=new ce(e.path.child("")),i=this.docs.getIteratorFrom(r);i.hasNext();){var o=i.getNext(),s=o.value.maybeDocument;if(!e.path.isPrefixOf(o.key.path))break;s instanceof le&&e.matches(s)&&(n=n.insert(s.key,s))}return ar.resolve(n)},t.prototype.forEachDocumentKey=function(t,e){return ar.forEach(this.docs,function(t){return e(t)})},t.prototype.getNewDocumentChanges=function(t){var e=this,n=W();return this.newDocumentChanges.forEach(function(t){var r=e.docs.get(t),i=r?r.maybeDocument:new fe(t,Je.forDeletedDoc());n=n.insert(t,i)}),this.newDocumentChanges=H(),ar.resolve(n)},t.prototype.newChangeBuffer=function(){return new ri(this.sizer,this)},t.prototype.getSize=function(t){return ar.resolve(this.size)},t}(),ri=function(t){function e(e,n){var r=t.call(this)||this;return r.sizer=e,r.documentCache=n,r}return jt.__extends(e,t),e.prototype.applyChanges=function(t){var e=this,n=0,r=[];return this.assertChanges().forEach(function(t,i){var o=e.documentSizes.get(t);c(void 0!==o,"Attempting to change document "+t.toString()+" without having read it first");var s=e.sizer(i);n+=s-o,r.push({maybeDocument:i,size:s})}),this.documentCache.addEntries(t,r,n)},e.prototype.getFromCache=function(t,e){return this.documentCache.getSizedEntry(t,e)},e.prototype.getAllFromCache=function(t,e){return this.documentCache.getSizedEntries(t,e)},e}(mr),ii=function(){function t(t,e){var n=this;this.clientId=t,this.mutationQueues={},this.listenSequence=new Gn(0),this._started=!1,this._started=!0,this.referenceDelegate=e(this),this.queryCache=new ei(this);this.remoteDocumentCache=new ni(function(t){return n.referenceDelegate.documentSize(t)})}return t.createLruPersistence=function(e,n,r){return new t(e,function(t){return new ai(t,new Ur(n),r)})},t.createEagerPersistence=function(e){return new t(e,function(t){return new si(t)})},t.prototype.shutdown=function(t){return this._started=!1,Promise.resolve()},Object.defineProperty(t.prototype,"started",{get:function(){return this._started},enumerable:!0,configurable:!0}),t.prototype.getActiveClients=function(){return jt.__awaiter(this,void 0,void 0,function(){return jt.__generator(this,function(t){return[2,[this.clientId]]})})},t.prototype.setPrimaryStateListener=function(t){return t(!0)},t.prototype.setNetworkEnabled=function(t){},t.prototype.getMutationQueue=function(t){var e=this.mutationQueues[t.toKey()];return e||(e=new ti(this.referenceDelegate),this.mutationQueues[t.toKey()]=e),e},t.prototype.getQueryCache=function(){return this.queryCache},t.prototype.getRemoteDocumentCache=function(){return this.remoteDocumentCache},t.prototype.runTransaction=function(t,e,n){var r=this;o("MemoryPersistence","Starting transaction:",t);var i=new oi(this.listenSequence.next());return this.referenceDelegate.onTransactionStarted(),n(i).next(function(t){return r.referenceDelegate.onTransactionCommitted(i).next(function(){return t})}).toPromise()},t.prototype.mutationQueuesContainKey=function(t,e){return ar.or(function(t){var e=[];return m(t,function(t,n){return e.push(n)}),e}(this.mutationQueues).map(function(n){return function(){return n.containsKey(t,e)}}))},t}(),oi=function(){return function(t){this.currentSequenceNumber=t}}(),si=function(){function t(t){this.persistence=t}return t.prototype.setInMemoryPins=function(t){this.inMemoryPins=t},t.prototype.addReference=function(t,e){return this.orphanedDocuments.delete(e),ar.resolve()},t.prototype.removeReference=function(t,e){return this.orphanedDocuments.add(e),ar.resolve()},t.prototype.removeMutationReference=function(t,e){return this.orphanedDocuments.add(e),ar.resolve()},t.prototype.removeTarget=function(t,e){var n=this,r=this.persistence.getQueryCache();return r.getMatchingKeysForTargetId(t,e.targetId).next(function(t){t.forEach(function(t){return n.orphanedDocuments.add(t)})}).next(function(){return r.removeQueryData(t,e)})},t.prototype.onTransactionStarted=function(){this.orphanedDocuments=new Set},t.prototype.onTransactionCommitted=function(t){var e=this,n=this.persistence.getRemoteDocumentCache();return ar.forEach(this.orphanedDocuments,function(r){return e.isReferenced(t,r).next(function(e){return e?ar.resolve():n.removeEntry(t,r).next(function(){})})})},t.prototype.updateLimboDocument=function(t,e){var n=this;return this.isReferenced(t,e).next(function(t){t?n.orphanedDocuments.delete(e):n.orphanedDocuments.add(e)})},t.prototype.documentSize=function(t){return 0},t.prototype.isReferenced=function(t,e){var n=this;return ar.or([function(){return n.persistence.getQueryCache().containsKey(t,e)},function(){return n.persistence.mutationQueuesContainKey(t,e)},function(){return ar.resolve(n.inMemoryPins.containsKey(e))}])},t}(),ai=function(){function t(t,e,n){this.persistence=t,this.serializer=e,this.orphanedSequenceNumbers=new pr(function(t){return et(t.path)}),this.garbageCollector=new Kr(this,n)}return t.prototype.onTransactionStarted=function(){},t.prototype.onTransactionCommitted=function(t){return ar.resolve()},t.prototype.forEachTarget=function(t,e){return this.persistence.getQueryCache().forEachTarget(t,e)},t.prototype.getSequenceNumberCount=function(t){var e=this.orphanedDocumentCount(t);return this.persistence.getQueryCache().getTargetCount(t).next(function(t){return e.next(function(e){return t+e})})},t.prototype.orphanedDocumentCount=function(t){var e=0;return this.forEachOrphanedDocumentSequenceNumber(t,function(t){e++}).next(function(){return e})},t.prototype.forEachOrphanedDocumentSequenceNumber=function(t,e){var n=this;return ar.forEach(this.orphanedSequenceNumbers,function(r,i){return n.isPinned(t,r,i).next(function(t){return t?ar.resolve():e(i)})})},t.prototype.setInMemoryPins=function(t){this.inMemoryPins=t},t.prototype.removeTargets=function(t,e,n){return this.persistence.getQueryCache().removeTargets(t,e,n)},t.prototype.removeOrphanedDocuments=function(t,e){var n=this,r=0,i=this.persistence.getRemoteDocumentCache();return i.forEachDocumentKey(t,function(o){return n.isPinned(t,o,e).next(function(e){return e?ar.resolve():(r++,i.removeEntry(t,o).next())})}).next(function(){return r})},t.prototype.removeMutationReference=function(t,e){return this.orphanedSequenceNumbers.set(e,t.currentSequenceNumber),ar.resolve()},t.prototype.removeTarget=function(t,e){var n=e.copy({sequenceNumber:t.currentSequenceNumber});return this.persistence.getQueryCache().updateQueryData(t,n)},t.prototype.addReference=function(t,e){return this.orphanedSequenceNumbers.set(e,t.currentSequenceNumber),ar.resolve()},t.prototype.removeReference=function(t,e){return this.orphanedSequenceNumbers.set(e,t.currentSequenceNumber),ar.resolve()},t.prototype.updateLimboDocument=function(t,e){return this.orphanedSequenceNumbers.set(e,t.currentSequenceNumber),ar.resolve()},t.prototype.documentSize=function(t){var e,n=this.serializer.toDbRemoteDocument(t);if(n.document)e=n.document;else if(n.unknownDocument)e=n.unknownDocument;else{if(!n.noDocument)throw u("Unknown remote document type");e=n.noDocument}return JSON.stringify(e).length},t.prototype.isPinned=function(t,e,n){var r=this;return ar.or([function(){return r.persistence.mutationQueuesContainKey(t,e)},function(){return ar.resolve(r.inMemoryPins.containsKey(e))},function(){return r.persistence.getQueryCache().containsKey(t,e)},function(){var t=r.orphanedSequenceNumbers.get(e);return ar.resolve(void 0!==t&&t>n)}])},t.prototype.getCacheSize=function(t){return this.persistence.getRemoteDocumentCache().getSize(t)},t}(),ui=function(){function t(t,e,n,r,i){this.queue=t,this.timerId=e,this.initialDelayMs=n,this.backoffFactor=r,this.maxDelayMs=i,this.timerPromise=null,this.lastAttemptTime=Date.now(),this.reset()}return t.prototype.reset=function(){this.currentBaseMs=0},t.prototype.resetToMax=function(){this.currentBaseMs=this.maxDelayMs},t.prototype.backoffAndRun=function(t){var e=this;this.cancel();var n=Math.floor(this.currentBaseMs+this.jitterDelayMs()),r=Math.max(0,Date.now()-this.lastAttemptTime),i=Math.max(0,n-r);this.currentBaseMs>0&&o("ExponentialBackoff","Backing off for "+i+" ms (base delay: "+this.currentBaseMs+" ms, delay with jitter: "+n+" ms, last attempt: "+r+" ms ago)"),this.timerPromise=this.queue.enqueueAfterDelay(this.timerId,i,function(){return e.lastAttemptTime=Date.now(),t()}),this.currentBaseMs*=this.backoffFactor,this.currentBaseMs<this.initialDelayMs&&(this.currentBaseMs=this.initialDelayMs),this.currentBaseMs>this.maxDelayMs&&(this.currentBaseMs=this.maxDelayMs)},t.prototype.cancel=function(){null!==this.timerPromise&&(this.timerPromise.cancel(),this.timerPromise=null)},t.prototype.jitterDelayMs=function(){return(Math.random()-.5)*this.currentBaseMs},t}();!function(t){t[t.Initial=0]="Initial",t[t.Starting=1]="Starting",t[t.Open=2]="Open",t[t.Error=3]="Error",t[t.Backoff=4]="Backoff"}(or||(or={}));var ci,hi=1e3,li=6e4,fi=1.5,di=function(){function t(t,e,n,r,i,o){this.queue=t,this.idleTimerId=n,this.connection=r,this.credentialsProvider=i,this.listener=o,this.state=or.Initial,this.closeCount=0,this.idleTimer=null,this.stream=null,this.backoff=new ui(t,e,hi,fi,li)}return t.prototype.isStarted=function(){return this.state===or.Starting||this.state===or.Open||this.state===or.Backoff},t.prototype.isOpen=function(){return this.state===or.Open},t.prototype.start=function(){this.state!==or.Error?(c(this.state===or.Initial,"Already started"),this.auth()):this.performBackoff()},t.prototype.stop=function(){return jt.__awaiter(this,void 0,void 0,function(){return jt.__generator(this,function(t){switch(t.label){case 0:return this.isStarted()?[4,this.close(or.Initial)]:[3,2];case 1:t.sent(),t.label=2;case 2:return[2]}})})},t.prototype.inhibitBackoff=function(){c(!this.isStarted(),"Can only inhibit backoff in a stopped state"),this.state=or.Initial,this.backoff.reset()},t.prototype.markIdle=function(){var t=this;this.isOpen()&&null===this.idleTimer&&(this.idleTimer=this.queue.enqueueAfterDelay(this.idleTimerId,6e4,function(){return t.handleIdleCloseTimer()}))},t.prototype.sendRequest=function(t){this.cancelIdleCheck(),this.stream.send(t)},t.prototype.handleIdleCloseTimer=function(){return jt.__awaiter(this,void 0,void 0,function(){return jt.__generator(this,function(t){return this.isOpen()?[2,this.close(or.Initial)]:[2]})})},t.prototype.cancelIdleCheck=function(){this.idleTimer&&(this.idleTimer.cancel(),this.idleTimer=null)},t.prototype.close=function(t,e){return jt.__awaiter(this,void 0,void 0,function(){return jt.__generator(this,function(n){switch(n.label){case 0:return c(this.isStarted(),"Only started streams should be closed."),c(t===or.Error||F(e),"Can't provide an error when not in an error state."),this.cancelIdleCheck(),this.backoff.cancel(),this.closeCount++,t!==or.Error?this.backoff.reset():e&&e.code===Xt.RESOURCE_EXHAUSTED?(s(e.toString()),s("Using maximum backoff delay to prevent overloading the backend."),this.backoff.resetToMax()):e&&e.code===Xt.UNAUTHENTICATED&&this.credentialsProvider.invalidateToken(),null!==this.stream&&(this.tearDown(),this.stream.close(),this.stream=null),this.state=t,[4,this.listener.onClose(e)];case 1:return n.sent(),[2]}})})},t.prototype.tearDown=function(){},t.prototype.auth=function(){var t=this;c(this.state===or.Initial,"Must be in initial state to auth"),this.state=or.Starting;var e=this.getCloseGuardedDispatcher(this.closeCount),n=this.closeCount;this.credentialsProvider.getToken().then(function(e){t.closeCount===n&&t.startStream(e)},function(n){e(function(){var e=new Yt(Xt.UNKNOWN,"Fetching auth token failed: "+n.message);return t.handleStreamClose(e)})})},t.prototype.startStream=function(t){var e=this;c(this.state===or.Starting,"Trying to start stream in a non-starting state");var n=this.getCloseGuardedDispatcher(this.closeCount);this.stream=this.startRpc(t),this.stream.onOpen(function(){n(function(){return c(e.state===or.Starting,"Expected stream to be in state Starting, but was "+e.state),e.state=or.Open,e.listener.onOpen()})}),this.stream.onClose(function(t){n(function(){return e.handleStreamClose(t)})}),this.stream.onMessage(function(t){n(function(){return e.onMessage(t)})})},t.prototype.performBackoff=function(){var t=this;c(this.state===or.Error,"Should only perform backoff when in Error state"),this.state=or.Backoff,this.backoff.backoffAndRun(function(){return jt.__awaiter(t,void 0,void 0,function(){return jt.__generator(this,function(t){return c(this.state===or.Backoff,"Backoff elapsed but state is now: "+this.state),this.state=or.Initial,this.start(),c(this.isStarted(),"PersistentStream should have started"),[2]})})})},t.prototype.handleStreamClose=function(t){return c(this.isStarted(),"Can't handle server close on non-started stream"),o("PersistentStream","close with error: "+t),this.stream=null,this.close(or.Error,t)},t.prototype.getCloseGuardedDispatcher=function(t){var e=this;return function(n){e.queue.enqueueAndForget(function(){return e.closeCount===t?n():(o("PersistentStream","stream callback skipped by getCloseGuardedDispatcher."),Promise.resolve())})}},t}(),pi=function(t){function e(e,n,r,i,o){var s=t.call(this,e,Qn.ListenStreamConnectionBackoff,Qn.ListenStreamIdle,n,r,o)||this;return s.serializer=i,s}return jt.__extends(e,t),e.prototype.startRpc=function(t){return this.connection.openStream("Listen",t)},e.prototype.onMessage=function(t){this.backoff.reset();var e=this.serializer.fromWatchChange(t),n=this.serializer.versionFromListenResponse(t);return this.listener.onWatchChange(e,n)},e.prototype.watch=function(t){var e={};e.database=this.serializer.encodedDatabaseId,e.addTarget=this.serializer.toTarget(t);var n=this.serializer.toListenRequestLabels(t);n&&(e.labels=n),this.sendRequest(e)},e.prototype.unwatch=function(t){var e={};e.database=this.serializer.encodedDatabaseId,e.removeTarget=t,this.sendRequest(e)},e}(di),mi=function(t){function e(e,n,r,i,o){var s=t.call(this,e,Qn.WriteStreamConnectionBackoff,Qn.WriteStreamIdle,n,r,o)||this;return s.serializer=i,s.handshakeComplete_=!1,s}return jt.__extends(e,t),Object.defineProperty(e.prototype,"handshakeComplete",{get:function(){return this.handshakeComplete_},enumerable:!0,configurable:!0}),e.prototype.start=function(){this.handshakeComplete_=!1,t.prototype.start.call(this)},e.prototype.tearDown=function(){this.handshakeComplete_&&this.writeMutations([])},e.prototype.startRpc=function(t){return this.connection.openStream("Write",t)},e.prototype.onMessage=function(t){if(c(!!t.streamToken,"Got a write response without a stream token"),this.lastStreamToken=t.streamToken,this.handshakeComplete_){this.backoff.reset();var e=this.serializer.fromWriteResults(t.writeResults,t.commitTime),n=this.serializer.fromVersion(t.commitTime);return this.listener.onMutationResult(n,e)}return c(!t.writeResults||0===t.writeResults.length,"Got mutation results for handshake"),this.handshakeComplete_=!0,this.listener.onHandshakeComplete()},e.prototype.writeHandshake=function(){c(this.isOpen(),"Writing handshake requires an opened stream"),c(!this.handshakeComplete_,"Handshake already completed");var t={};t.database=this.serializer.encodedDatabaseId,this.sendRequest(t)},e.prototype.writeMutations=function(t){var e=this;c(this.isOpen(),"Writing mutations requires an opened stream"),c(this.handshakeComplete_,"Handshake must be complete before writing mutations"),c(this.lastStreamToken.length>0,"Trying to write mutation without a token");var n={streamToken:this.lastStreamToken,writes:t.map(function(t){return e.serializer.toMutation(t)})};this.sendRequest(n)},e}(di),yi=function(){function t(t,e,n,r){this.queue=t,this.connection=e,this.credentials=n,this.serializer=r}return t.prototype.newPersistentWriteStream=function(t){return new mi(this.queue,this.connection,this.credentials,this.serializer,t)},t.prototype.newPersistentWatchStream=function(t){return new pi(this.queue,this.connection,this.credentials,this.serializer,t)},t.prototype.commit=function(t){var e=this,n={database:this.serializer.encodedDatabaseId,writes:t.map(function(t){return e.serializer.toMutation(t)})};return this.invokeRPC("Commit",n).then(function(t){return e.serializer.fromWriteResults(t.writeResults,t.commitTime)})},t.prototype.lookup=function(t){var e=this,n={database:this.serializer.encodedDatabaseId,documents:t.map(function(t){return e.serializer.toName(t)})};return this.invokeStreamingRPC("BatchGetDocuments",n).then(function(n){var r=W();n.forEach(function(t){var n=e.serializer.fromMaybeDocument(t);r=r.insert(n.key,n)});var i=[];return t.forEach(function(t){var e=r.get(t);c(!!e,"Missing entity in write response for "+t),i.push(e)}),i})},t.prototype.invokeRPC=function(t,e){var n=this;return this.credentials.getToken().then(function(r){return n.connection.invokeRPC(t,e,r)}).catch(function(t){throw t.code===Xt.UNAUTHENTICATED&&n.credentials.invalidateToken(),t})},t.prototype.invokeStreamingRPC=function(t,e){var n=this;return this.credentials.getToken().then(function(r){return n.connection.invokeStreamingRPC(t,e,r)}).catch(function(t){throw t.code===Xt.UNAUTHENTICATED&&n.credentials.invalidateToken(),t})},t}(),gi=function(){function t(t){this.datastore=t,this.readVersions=z(),this.mutations=[],this.committed=!1}return t.prototype.recordVersion=function(t){var e;if(t instanceof le)e=t.version;else{if(!(t instanceof fe))throw u("Document in a transaction was a "+t.constructor.name);e=Je.forDeletedDoc()}var n=this.readVersions.get(t.key);if(null!==n){if(!e.isEqual(n))throw new Yt(Xt.ABORTED,"Document version changed between two reads.")}else this.readVersions=this.readVersions.insert(t.key,e)},t.prototype.lookup=function(t){var e=this;return this.committed?Promise.reject("Transaction has already completed."):this.mutations.length>0?Promise.reject("Transactions lookups are invalid after writes."):this.datastore.lookup(t).then(function(t){return t.forEach(function(t){t instanceof fe||t instanceof le?e.recordVersion(t):u("Document in a transaction was a "+t.constructor.name)}),t})},t.prototype.write=function(t){if(this.committed)throw new Yt(Xt.FAILED_PRECONDITION,"Transaction has already completed.");this.mutations=this.mutations.concat(t)},t.prototype.precondition=function(t){var e=this.readVersions.get(t);return e?an.updateTime(e):an.NONE},t.prototype.preconditionForUpdate=function(t){var e=this.readVersions.get(t);if(e&&e.isEqual(Je.forDeletedDoc()))throw new Yt(Xt.FAILED_PRECONDITION,"Can't update a document that doesn't exist.");return e?an.updateTime(e):an.exists(!0)},t.prototype.set=function(t,e){this.write(e.toMutations(t,this.precondition(t)))},t.prototype.update=function(t,e){this.write(e.toMutations(t,this.preconditionForUpdate(t)))},t.prototype.delete=function(t){this.write([new fn(t,this.precondition(t))]),this.readVersions=this.readVersions.insert(t,Je.forDeletedDoc())},t.prototype.commit=function(){var t=this,e=this.readVersions;return this.mutations.forEach(function(t){e=e.remove(t.key)}),e.isEmpty()?this.datastore.commit(this.mutations).then(function(){t.committed=!0}):Promise.reject(Error("Every document read in a transaction must also be written."))},t}();!function(t){t[t.Unknown=0]="Unknown",t[t.Online=1]="Online",t[t.Offline=2]="Offline"}(ci||(ci={}));var vi;!function(t){t[t.RemoteStore=0]="RemoteStore",t[t.SharedClientState=1]="SharedClientState"}(vi||(vi={}));var bi,_i=function(){function t(t,e){this.asyncQueue=t,this.onlineStateHandler=e,this.state=ci.Unknown,this.watchStreamFailures=0,this.onlineStateTimer=null,this.shouldWarnClientIsOffline=!0}return t.prototype.handleWatchStreamStart=function(){var t=this;0===this.watchStreamFailures&&(this.setAndBroadcast(ci.Unknown),c(null===this.onlineStateTimer,"onlineStateTimer shouldn't be started yet"),this.onlineStateTimer=this.asyncQueue.enqueueAfterDelay(Qn.OnlineStateTimeout,1e4,function(){return t.onlineStateTimer=null,c(t.state===ci.Unknown,"Timer should be canceled if we transitioned to a different state."),t.logClientOfflineWarningIfNecessary("Backend didn't respond within 10 seconds."),t.setAndBroadcast(ci.Offline),Promise.resolve()}))},t.prototype.handleWatchStreamFailure=function(t){this.state===ci.Online?(this.setAndBroadcast(ci.Unknown),c(0===this.watchStreamFailures,"watchStreamFailures must be 0"),c(null===this.onlineStateTimer,"onlineStateTimer must be null")):(this.watchStreamFailures++,this.watchStreamFailures>=1&&(this.clearOnlineStateTimer(),this.logClientOfflineWarningIfNecessary("Connection failed 1 times. Most recent error: "+t.toString()),this.setAndBroadcast(ci.Offline)))},t.prototype.set=function(t){this.clearOnlineStateTimer(),this.watchStreamFailures=0,t===ci.Online&&(this.shouldWarnClientIsOffline=!1),this.setAndBroadcast(t)},t.prototype.setAndBroadcast=function(t){t!==this.state&&(this.state=t,this.onlineStateHandler(t))},t.prototype.logClientOfflineWarningIfNecessary=function(t){var e="Could not reach Cloud Firestore backend. "+t+"\nThis typically indicates that your device does not have a healthy Internet connection at the moment. The client will operate in offline mode until it is able to successfully connect to the backend.";this.shouldWarnClientIsOffline?(s(e),this.shouldWarnClientIsOffline=!1):o("OnlineStateTracker",e)},t.prototype.clearOnlineStateTimer=function(){null!==this.onlineStateTimer&&(this.onlineStateTimer.cancel(),this.onlineStateTimer=null)},t}(),wi="RemoteStore",Ei=function(){function t(t,e,n,r){this.localStore=t,this.datastore=e,this.writePipeline=[],this.listenTargets={},this.watchChangeAggregator=null,this.networkEnabled=!1,this.isPrimary=!1,this.onlineStateTracker=new _i(n,r),this.watchStream=this.datastore.newPersistentWatchStream({onOpen:this.onWatchStreamOpen.bind(this),onClose:this.onWatchStreamClose.bind(this),onWatchChange:this.onWatchStreamChange.bind(this)}),this.writeStream=this.datastore.newPersistentWriteStream({onOpen:this.onWriteStreamOpen.bind(this),onClose:this.onWriteStreamClose.bind(this),onHandshakeComplete:this.onWriteHandshakeComplete.bind(this),onMutationResult:this.onMutationResult.bind(this)})}return t.prototype.start=function(){return this.enableNetwork()},t.prototype.enableNetwork=function(){return jt.__awaiter(this,void 0,void 0,function(){var t;return jt.__generator(this,function(e){switch(e.label){case 0:return this.networkEnabled=!0,this.canUseNetwork()?(t=this.writeStream,[4,this.localStore.getLastStreamToken()]):[3,3];case 1:return t.lastStreamToken=e.sent(),this.shouldStartWatchStream()?this.startWatchStream():this.onlineStateTracker.set(ci.Unknown),[4,this.fillWritePipeline()];case 2:e.sent(),e.label=3;case 3:return[2]}})})},t.prototype.disableNetwork=function(){return jt.__awaiter(this,void 0,void 0,function(){return jt.__generator(this,function(t){switch(t.label){case 0:return this.networkEnabled=!1,[4,this.disableNetworkInternal()];case 1:return t.sent(),this.onlineStateTracker.set(ci.Offline),[2]}})})},t.prototype.disableNetworkInternal=function(){return jt.__awaiter(this,void 0,void 0,function(){return jt.__generator(this,function(t){switch(t.label){case 0:return[4,this.writeStream.stop()];case 1:return t.sent(),[4,this.watchStream.stop()];case 2:return t.sent(),this.writePipeline.length>0&&(o(wi,"Stopping write stream with "+this.writePipeline.length+" pending writes"),this.writePipeline=[]),this.cleanUpWatchStreamState(),[2]}})})},t.prototype.shutdown=function(){return jt.__awaiter(this,void 0,void 0,function(){return jt.__generator(this,function(t){switch(t.label){case 0:return o(wi,"RemoteStore shutting down."),this.networkEnabled=!1,[4,this.disableNetworkInternal()];case 1:return t.sent(),this.onlineStateTracker.set(ci.Unknown),[2]}})})},t.prototype.listen=function(t){c(!f(this.listenTargets,t.targetId),"listen called with duplicate targetId!"),this.listenTargets[t.targetId]=t,this.shouldStartWatchStream()?this.startWatchStream():this.watchStream.isOpen()&&this.sendWatchRequest(t)},t.prototype.unlisten=function(t){c(f(this.listenTargets,t),"unlisten called without assigned target ID!"),delete this.listenTargets[t],this.watchStream.isOpen()&&this.sendUnwatchRequest(t),y(this.listenTargets)&&(this.watchStream.isOpen()?this.watchStream.markIdle():this.canUseNetwork()&&this.onlineStateTracker.set(ci.Unknown))},t.prototype.getQueryDataForTarget=function(t){return this.listenTargets[t]||null},t.prototype.getRemoteKeysForTarget=function(t){return this.syncEngine.getRemoteKeysForTarget(t)},t.prototype.sendWatchRequest=function(t){this.watchChangeAggregator.recordPendingTargetRequest(t.targetId),this.watchStream.watch(t)},t.prototype.sendUnwatchRequest=function(t){this.watchChangeAggregator.recordPendingTargetRequest(t),this.watchStream.unwatch(t)},t.prototype.startWatchStream=function(){c(this.shouldStartWatchStream(),"startWatchStream() called when shouldStartWatchStream() is false."),this.watchChangeAggregator=new Mn(this),this.watchStream.start(),this.onlineStateTracker.handleWatchStreamStart()},t.prototype.shouldStartWatchStream=function(){return this.canUseNetwork()&&!this.watchStream.isStarted()&&!y(this.listenTargets)},t.prototype.canUseNetwork=function(){return this.isPrimary&&this.networkEnabled},t.prototype.cleanUpWatchStreamState=function(){this.watchChangeAggregator=null},t.prototype.onWatchStreamOpen=function(){return jt.__awaiter(this,void 0,void 0,function(){var t=this;return jt.__generator(this,function(e){return p(this.listenTargets,function(e,n){t.sendWatchRequest(n)}),[2]})})},t.prototype.onWatchStreamClose=function(t){return jt.__awaiter(this,void 0,void 0,function(){return jt.__generator(this,function(e){return void 0===t&&c(!this.shouldStartWatchStream(),"Watch stream was stopped gracefully while still needed."),this.cleanUpWatchStreamState(),this.shouldStartWatchStream()?(this.onlineStateTracker.handleWatchStreamFailure(t),this.startWatchStream()):this.onlineStateTracker.set(ci.Unknown),[2]})})},t.prototype.onWatchStreamChange=function(t,e){return jt.__awaiter(this,void 0,void 0,function(){var n;return jt.__generator(this,function(r){switch(r.label){case 0:return this.onlineStateTracker.set(ci.Online),t instanceof On&&t.state===In.Removed&&t.cause?[2,this.handleTargetError(t)]:(t instanceof kn?this.watchChangeAggregator.handleDocumentChange(t):t instanceof Rn?this.watchChangeAggregator.handleExistenceFilter(t):(c(t instanceof On,"Expected watchChange to be an instance of WatchTargetChange"),this.watchChangeAggregator.handleTargetChange(t)),e.isEqual(Je.MIN)?[3,3]:[4,this.localStore.getLastRemoteSnapshotVersion()]);case 1:return n=r.sent(),e.compareTo(n)>=0?[4,this.raiseWatchSnapshot(e)]:[3,3];case 2:r.sent(),r.label=3;case 3:return[2]}})})},t.prototype.raiseWatchSnapshot=function(t){var e=this;c(!t.isEqual(Je.MIN),"Can't raise event for unknown SnapshotVersion");var n=this.watchChangeAggregator.createRemoteEvent(t);return p(n.targetChanges,function(n,r){if(r.resumeToken.length>0){var i=e.listenTargets[n];i&&(e.listenTargets[n]=i.copy({resumeToken:r.resumeToken,snapshotVersion:t}))}}),n.targetMismatches.forEach(function(t){var n=e.listenTargets[t];if(n){e.listenTargets[t]=n.copy({resumeToken:h()}),e.sendUnwatchRequest(t);var r=new $e(n.query,t,_e.ExistenceFilterMismatch,n.sequenceNumber);e.sendWatchRequest(r)}}),this.syncEngine.applyRemoteEvent(n)},t.prototype.handleTargetError=function(t){var e=this;c(!!t.cause,"Handling target error without a cause");var n=t.cause,r=Promise.resolve();return t.targetIds.forEach(function(t){r=r.then(function(){return jt.__awaiter(e,void 0,void 0,function(){return jt.__generator(this,function(e){return f(this.listenTargets,t)?(delete this.listenTargets[t],this.watchChangeAggregator.removeTarget(t),[2,this.syncEngine.rejectListen(t,n)]):[2]})})})}),r},t.prototype.fillWritePipeline=function(){return jt.__awaiter(this,void 0,void 0,function(){var t,e;return jt.__generator(this,function(n){switch(n.label){case 0:return this.canAddToWritePipeline()?(t=this.writePipeline.length>0?this.writePipeline[this.writePipeline.length-1].batchId:er,[4,this.localStore.nextMutationBatch(t)]):[3,4];case 1:return null!==(e=n.sent())?[3,2]:(0===this.writePipeline.length&&this.writeStream.markIdle(),[3,4]);case 2:return this.addToWritePipeline(e),[4,this.fillWritePipeline()];case 3:n.sent(),n.label=4;case 4:return this.shouldStartWriteStream()&&this.startWriteStream(),[2]}})})},t.prototype.canAddToWritePipeline=function(){return this.canUseNetwork()&&this.writePipeline.length<10},t.prototype.outstandingWrites=function(){return this.writePipeline.length},t.prototype.addToWritePipeline=function(t){c(this.canAddToWritePipeline(),"addToWritePipeline called when pipeline is full"),this.writePipeline.push(t),this.writeStream.isOpen()&&this.writeStream.handshakeComplete&&this.writeStream.writeMutations(t.mutations)},t.prototype.shouldStartWriteStream=function(){return this.canUseNetwork()&&!this.writeStream.isStarted()&&this.writePipeline.length>0},t.prototype.startWriteStream=function(){c(this.shouldStartWriteStream(),"startWriteStream() called when shouldStartWriteStream() is false."),this.writeStream.start()},t.prototype.onWriteStreamOpen=function(){return jt.__awaiter(this,void 0,void 0,function(){return jt.__generator(this,function(t){return this.writeStream.writeHandshake(),[2]})})},t.prototype.onWriteHandshakeComplete=function(){var t=this;return this.localStore.setLastStreamToken(this.writeStream.lastStreamToken).then(function(){for(var e=0,n=t.writePipeline;e<n.length;e++){t.writeStream.writeMutations(n[e].mutations)}}).catch(Et)},t.prototype.onMutationResult=function(t,e){var n=this;c(this.writePipeline.length>0,"Got result for empty write pipeline");var r=this.writePipeline.shift(),i=rr.from(r,t,e,this.writeStream.lastStreamToken);return this.syncEngine.applySuccessfulWrite(i).then(function(){return n.fillWritePipeline()})},t.prototype.onWriteStreamClose=function(t){return jt.__awaiter(this,void 0,void 0,function(){var e,n=this;return jt.__generator(this,function(r){return void 0===t&&c(!this.shouldStartWriteStream(),"Write stream was stopped gracefully while still needed."),t&&this.writePipeline.length>0?(e=void 0,e=this.writeStream.handshakeComplete?this.handleWriteError(t):this.handleHandshakeError(t),[2,e.then(function(){n.shouldStartWriteStream()&&n.startWriteStream()})]):[2]})})},t.prototype.handleHandshakeError=function(t){return jt.__awaiter(this,void 0,void 0,function(){return jt.__generator(this,function(e){return K(t.code)||t.code===Xt.ABORTED?(o(wi,"RemoteStore error before completed handshake; resetting stream token: ",this.writeStream.lastStreamToken),this.writeStream.lastStreamToken=h(),[2,this.localStore.setLastStreamToken(h()).catch(Et)]):[2]})})},t.prototype.handleWriteError=function(t){return jt.__awaiter(this,void 0,void 0,function(){var e,n=this;return jt.__generator(this,function(r){return K(t.code)?(e=this.writePipeline.shift(),this.writeStream.inhibitBackoff(),[2,this.syncEngine.rejectFailedWrite(e.batchId,t).then(function(){return n.fillWritePipeline()})]):[2]})})},t.prototype.createTransaction=function(){return new gi(this.datastore)},t.prototype.handleCredentialChange=function(){return jt.__awaiter(this,void 0,void 0,function(){return jt.__generator(this,function(t){switch(t.label){case 0:return this.canUseNetwork()?(o(wi,"RemoteStore restarting streams for new credential"),this.networkEnabled=!1,[4,this.disableNetworkInternal()]):[3,3];case 1:return t.sent(),this.onlineStateTracker.set(ci.Unknown),[4,this.enableNetwork()];case 2:t.sent(),t.label=3;case 3:return[2]}})})},t.prototype.applyPrimaryState=function(t){return jt.__awaiter(this,void 0,void 0,function(){return jt.__generator(this,function(e){switch(e.label){case 0:return this.isPrimary=t,t&&this.networkEnabled?[4,this.enableNetwork()]:[3,2];case 1:return e.sent(),[3,4];case 2:return t?[3,4]:[4,this.disableNetworkInternal()];case 3:e.sent(),this.onlineStateTracker.set(ci.Unknown),e.label=4;case 4:return[2]}})})},t}(),Ti=function(){return function(){this.listeners=[]}}(),Si=function(){function t(t){this.syncEngine=t,this.queries=new pr(function(t){return t.canonicalId()}),this.onlineState=ci.Unknown,this.syncEngine.subscribe(this)}return t.prototype.listen=function(t){var e=t.query,n=!1,r=this.queries.get(e);return r||(n=!0,r=new Ti,this.queries.set(e,r)),r.listeners.push(t),t.applyOnlineStateChange(this.onlineState),r.viewSnap&&t.onViewSnapshot(r.viewSnap),n?this.syncEngine.listen(e).then(function(t){return r.targetId=t,t}):Promise.resolve(r.targetId)},t.prototype.unlisten=function(t){return jt.__awaiter(this,void 0,void 0,function(){var e,n,r,i;return jt.__generator(this,function(o){return e=t.query,n=!1,(r=this.queries.get(e))&&(i=r.listeners.indexOf(t))>=0&&(r.listeners.splice(i,1),n=0===r.listeners.length),n?(this.queries.delete(e),[2,this.syncEngine.unlisten(e)]):[2]})})},t.prototype.onWatchChange=function(t){for(var e=0,n=t;e<n.length;e++){var r=n[e],i=this.queries.get(r.query);if(i){for(var o=0,s=i.listeners;o<s.length;o++){s[o].onViewSnapshot(r)}i.viewSnap=r}}},t.prototype.onWatchError=function(t,e){var n=this.queries.get(t);if(n)for(var r=0,i=n.listeners;r<i.length;r++){i[r].onError(e)}this.queries.delete(t)},t.prototype.onOnlineStateChange=function(t){this.onlineState=t,this.queries.forEach(function(e,n){for(var r=0,i=n.listeners;r<i.length;r++){i[r].applyOnlineStateChange(t)}})},t}(),Ii=function(){function t(t,e,n){this.query=t,this.queryObserver=e,this.raisedInitialEvent=!1,this.onlineState=ci.Unknown,this.options=n||{}}return t.prototype.onViewSnapshot=function(t){if(c(t.docChanges.length>0||t.syncStateChanged,"We got a new snapshot with no changes?"),!this.options.includeMetadataChanges){for(var e=[],n=0,r=t.docChanges;n<r.length;n++){var i=r[n];i.type!==gn.Metadata&&e.push(i)}t=new Dn(t.query,t.docs,t.oldDocs,e,t.mutatedKeys,t.fromCache,t.syncStateChanged,!0)}this.raisedInitialEvent?this.shouldRaiseEvent(t)&&this.queryObserver.next(t):this.shouldRaiseInitialEvent(t,this.onlineState)&&this.raiseInitialEvent(t),this.snap=t},t.prototype.onError=function(t){this.queryObserver.error(t)},t.prototype.applyOnlineStateChange=function(t){this.onlineState=t,this.snap&&!this.raisedInitialEvent&&this.shouldRaiseInitialEvent(this.snap,t)&&this.raiseInitialEvent(this.snap)},t.prototype.shouldRaiseInitialEvent=function(t,e){if(c(!this.raisedInitialEvent,"Determining whether to raise first event but already had first event"),!t.fromCache)return!0;return this.options.waitForSyncWhenOnline&&e!==ci.Offline?(c(t.fromCache,"Waiting for sync, but snapshot is not from cache"),!1):!t.docs.isEmpty()||e===ci.Offline},t.prototype.shouldRaiseEvent=function(t){if(t.docChanges.length>0)return!0;return!!(t.syncStateChanged||this.snap&&this.snap.hasPendingWrites!==t.hasPendingWrites)&&!0===this.options.includeMetadataChanges},t.prototype.raiseInitialEvent=function(t){c(!this.raisedInitialEvent,"Trying to raise initial events for second time"),t=Dn.fromInitialDocuments(t.query,t.docs,t.mutatedKeys,t.fromCache),this.raisedInitialEvent=!0,this.queryObserver.next(t)},t}(),Ci=function(){function t(t,e,n){this.targetId=t,this.addedKeys=e,this.removedKeys=n}return t.fromSnapshot=function(e,n){for(var r=H(),i=H(),o=0,s=n.docChanges;o<s.length;o++){var a=s[o];switch(a.type){case gn.Added:r=r.add(a.doc.key);break;case gn.Removed:i=i.add(a.doc.key)}}return new t(e,r,i)},t}(),Di=function(){return function(t){this.key=t}}(),Ni=function(){return function(t){this.key=t}}(),Ai=function(){function t(t,e){this.query=t,this._syncedDocuments=e,this.syncState=null,this.current=!1,this.limboDocuments=H(),this.mutatedKeys=H(),this.documentSet=new Tn(t.docComparator.bind(t))}return Object.defineProperty(t.prototype,"syncedDocuments",{get:function(){return this._syncedDocuments},enumerable:!0,configurable:!0}),t.prototype.computeDocChanges=function(t,e){var n=this,r=e?e.changeSet:new Cn,i=e?e.documentSet:this.documentSet,o=e?e.mutatedKeys:this.mutatedKeys,s=i,a=!1,u=this.query.hasLimit()&&i.size===this.query.limit?i.last():null;if(t.inorderTraversal(function(t,e){var h=i.get(t),l=e instanceof le?e:null;l&&(c(t.isEqual(l.key),"Mismatching keys found in document changes: "+t+" != "+l.key),l=n.query.matches(l)?l:null);var f=!!h&&n.mutatedKeys.has(h.key),d=!!l&&(l.hasLocalMutations||n.mutatedKeys.has(l.key)&&l.hasCommittedMutations),p=!1;if(h&&l){h.data.isEqual(l.data)?f!==d&&(r.track({type:gn.Metadata,doc:l}),p=!0):n.shouldWaitForSyncedDocument(h,l)||(r.track({type:gn.Modified,doc:l}),p=!0,u&&n.query.docComparator(l,u)>0&&(a=!0))}else!h&&l?(r.track({type:gn.Added,doc:l}),p=!0):h&&!l&&(r.track({type:gn.Removed,doc:h}),p=!0,u&&(a=!0));p&&(l?(s=s.add(l),o=d?o.add(t):o.delete(t)):(s=s.delete(t),o=o.delete(t)))}),this.query.hasLimit())for(;s.size>this.query.limit;){var h=s.last();s=s.delete(h.key),o=o.delete(h.key),r.track({type:gn.Removed,doc:h})}return c(!a||!e,"View was refilled using docs that themselves needed refilling."),{documentSet:s,changeSet:r,needsRefill:a,mutatedKeys:o}},t.prototype.shouldWaitForSyncedDocument=function(t,e){return t.hasLocalMutations&&e.hasCommittedMutations&&!e.hasLocalMutations},t.prototype.applyChanges=function(t,e,n){var r=this;c(!t.needsRefill,"Cannot apply changes that need a refill");var i=this.documentSet;this.documentSet=t.documentSet,this.mutatedKeys=t.mutatedKeys;var o=t.changeSet.getChanges();o.sort(function(t,e){return function(t,e){var n=function(t){switch(t){case gn.Added:return 1;case gn.Modified:case gn.Metadata:return 2;case gn.Removed:return 0;default:return u("Unknown ChangeType: "+t)}};return n(t)-n(e)}(t.type,e.type)||r.query.docComparator(t.doc,e.doc)}),this.applyTargetChange(n);var s=e?this.updateLimboDocuments():[],a=0===this.limboDocuments.size&&this.current?Sn.Synced:Sn.Local,h=a!==this.syncState;if(this.syncState=a,0!==o.length||h){return{snapshot:new Dn(this.query,t.documentSet,i,o,t.mutatedKeys,a===Sn.Local,h,!1),limboChanges:s}}return{limboChanges:s}},t.prototype.applyOnlineStateChange=function(t){return this.current&&t===ci.Offline?(this.current=!1,this.applyChanges({documentSet:this.documentSet,changeSet:new Cn,mutatedKeys:this.mutatedKeys,needsRefill:!1},!1)):{limboChanges:[]}},t.prototype.shouldBeInLimbo=function(t){return!this._syncedDocuments.has(t)&&(!!this.documentSet.has(t)&&!this.documentSet.get(t).hasLocalMutations)},t.prototype.applyTargetChange=function(t){var e=this;t&&(t.addedDocuments.forEach(function(t){return e._syncedDocuments=e._syncedDocuments.add(t)}),t.modifiedDocuments.forEach(function(t){return c(e._syncedDocuments.has(t),"Modified document "+t+" not found in view.")}),t.removedDocuments.forEach(function(t){return e._syncedDocuments=e._syncedDocuments.delete(t)}),this.current=t.current)},t.prototype.updateLimboDocuments=function(){var t=this;if(!this.current)return[];var e=this.limboDocuments;this.limboDocuments=H(),this.documentSet.forEach(function(e){t.shouldBeInLimbo(e.key)&&(t.limboDocuments=t.limboDocuments.add(e.key))});var n=[];return e.forEach(function(e){t.limboDocuments.has(e)||n.push(new Ni(e))}),this.limboDocuments.forEach(function(t){e.has(t)||n.push(new Di(t))}),n},t.prototype.synchronizeWithPersistedState=function(t,e){this._syncedDocuments=e,this.limboDocuments=H();var n=this.computeDocChanges(t);return this.applyChanges(n,!0)},t.prototype.computeInitialSnapshot=function(){return Dn.fromInitialDocuments(this.query,this.documentSet,this.mutatedKeys,this.syncState===Sn.Local)},t}(),ki="SyncEngine",Ri=function(){return function(t,e,n){this.query=t,this.targetId=e,this.view=n}}(),Oi=function(){return function(t){this.key=t}}(),Pi=function(){function t(t,e,n,r){this.localStore=t,this.remoteStore=e,this.sharedClientState=n,this.currentUser=r,this.syncEngineListener=null,this.queryViewsByQuery=new pr(function(t){return t.canonicalId()}),this.queryViewsByTarget={},this.limboTargetsByKey=new pe(ce.comparator),this.limboResolutionsByTarget={},this.limboDocumentRefs=new Jr,this.mutationUserCallbacks={},this.limboTargetIdGenerator=sr.forSyncEngine(),this.isPrimary=void 0,this.onlineState=ci.Unknown}return Object.defineProperty(t.prototype,"isPrimaryClient",{get:function(){return!0===this.isPrimary},enumerable:!0,configurable:!0}),t.prototype.subscribe=function(t){c(null!==t,"SyncEngine listener cannot be null"),c(null===this.syncEngineListener,"SyncEngine already has a subscriber."),this.syncEngineListener=t},t.prototype.listen=function(t){return jt.__awaiter(this,void 0,void 0,function(){var e,n,r,i,o;return jt.__generator(this,function(s){switch(s.label){case 0:return this.assertSubscribed("listen()"),(r=this.queryViewsByQuery.get(t))?(e=r.targetId,this.sharedClientState.addLocalQueryTarget(e),n=r.view.computeInitialSnapshot(),[3,4]):[3,1];case 1:return[4,this.localStore.allocateQuery(t)];case 2:return i=s.sent(),o=this.sharedClientState.addLocalQueryTarget(i.targetId),e=i.targetId,[4,this.initializeViewAndComputeSnapshot(i,"current"===o)];case 3:n=s.sent(),this.isPrimary&&this.remoteStore.listen(i),s.label=4;case 4:return this.syncEngineListener.onWatchChange([n]),[2,e]}})})},t.prototype.initializeViewAndComputeSnapshot=function(t,e){var n=this,r=t.query;return this.localStore.executeQuery(r).then(function(i){return n.localStore.remoteDocumentKeys(t.targetId).then(function(o){var s=new Ai(r,o),a=s.computeDocChanges(i),u=An.createSynthesizedTargetChangeForCurrentChange(t.targetId,e&&n.onlineState!==ci.Offline),h=s.applyChanges(a,!0===n.isPrimary,u);c(0===h.limboChanges.length,"View returned limbo docs before target ack from the server."),c(!!h.snapshot,"applyChanges for new view should always return a snapshot");var l=new Ri(r,t.targetId,s);return n.queryViewsByQuery.set(r,l),n.queryViewsByTarget[t.targetId]=l,h.snapshot})})},t.prototype.synchronizeViewAndComputeSnapshot=function(t){var e=this;return this.localStore.executeQuery(t.query).then(function(n){return e.localStore.remoteDocumentKeys(t.targetId).then(function(r){return jt.__awaiter(e,void 0,void 0,function(){var e;return jt.__generator(this,function(i){return e=t.view.synchronizeWithPersistedState(n,r),this.isPrimary&&this.updateTrackedLimbos(t.targetId,e.limboChanges),[2,e]})})})})},t.prototype.unlisten=function(t){return jt.__awaiter(this,void 0,void 0,function(){var e,n=this;return jt.__generator(this,function(r){switch(r.label){case 0:return this.assertSubscribed("unlisten()"),e=this.queryViewsByQuery.get(t),c(!!e,"Trying to unlisten on query not found:"+t),this.isPrimary?(this.sharedClientState.removeLocalQueryTarget(e.targetId),this.sharedClientState.isActiveQueryTarget(e.targetId)?[3,2]:[4,this.localStore.releaseQuery(t,!1).then(function(){n.sharedClientState.clearQueryState(e.targetId),n.remoteStore.unlisten(e.targetId),n.removeAndCleanupQuery(e)}).catch(Et)]):[3,3];case 1:r.sent(),r.label=2;case 2:return[3,5];case 3:return this.removeAndCleanupQuery(e),[4,this.localStore.releaseQuery(t,!0)];case 4:r.sent(),r.label=5;case 5:return[2]}})})},t.prototype.write=function(t,e){var n=this;return this.assertSubscribed("write()"),this.localStore.localWrite(t).then(function(t){return n.sharedClientState.addPendingMutation(t.batchId),n.addMutationCallback(t.batchId,e),n.emitNewSnapsAndNotifyLocalStore(t.changes)}).then(function(){return n.remoteStore.fillWritePipeline()})},t.prototype.wrapUpdateFunctionError=function(t){return t},t.prototype.runTransaction=function(t,e){var n=this;void 0===e&&(e=5),c(e>=0,"Got negative number of retries for transaction.");var r=this.remoteStore.createTransaction();return function(){try{var e=t(r);return!F(e)&&e.catch&&e.then?e.catch(function(t){return Promise.reject(n.wrapUpdateFunctionError(t))}):Promise.reject(Error("Transaction callback must return a Promise"))}catch(t){return Promise.reject(n.wrapUpdateFunctionError(t))}}().then(function(i){return r.commit().then(function(){return i}).catch(function(r){return 0===e?Promise.reject(r):n.runTransaction(t,e-1)})})},t.prototype.applyRemoteEvent=function(t){var e=this;return this.assertSubscribed("applyRemoteEvent()"),this.localStore.applyRemoteEvent(t).then(function(n){return m(t.targetChanges,function(t,n){var r=e.limboResolutionsByTarget[t];r&&(c(n.addedDocuments.size+n.modifiedDocuments.size+n.removedDocuments.size<=1,"Limbo resolution for single document contains multiple changes."),n.addedDocuments.size>0?r.receivedDocument=!0:n.modifiedDocuments.size>0?c(r.receivedDocument,"Received change for limbo target document without add."):n.removedDocuments.size>0&&(c(r.receivedDocument,"Received remove for limbo target document without add."),r.receivedDocument=!1))}),e.emitNewSnapsAndNotifyLocalStore(n,t)}).catch(Et)},t.prototype.applyOnlineStateChange=function(t,e){if(this.isPrimary&&e===vi.RemoteStore||!this.isPrimary&&e===vi.SharedClientState){var n=[];this.queryViewsByQuery.forEach(function(e,r){var i=r.view.applyOnlineStateChange(t);c(0===i.limboChanges.length,"OnlineState should not affect limbo documents."),i.snapshot&&n.push(i.snapshot)}),this.syncEngineListener.onOnlineStateChange(t),this.syncEngineListener.onWatchChange(n),this.onlineState=t,this.isPrimary&&this.sharedClientState.setOnlineState(t)}},t.prototype.rejectListen=function(t,e){return jt.__awaiter(this,void 0,void 0,function(){var n,r,i,o,s,a,u=this;return jt.__generator(this,function(h){switch(h.label){case 0:return this.assertSubscribed("rejectListens()"),this.sharedClientState.updateQueryState(t,"rejected",e),n=this.limboResolutionsByTarget[t],(r=n&&n.key)?(this.limboTargetsByKey=this.limboTargetsByKey.remove(r),delete this.limboResolutionsByTarget[t],i=new pe(ce.comparator),i=i.insert(r,new fe(r,Je.forDeletedDoc())),o=H().add(r),s=new Nn(Je.MIN,{},new tn(M),i,o),[2,this.applyRemoteEvent(s)]):[3,1];case 1:return a=this.queryViewsByTarget[t],c(!!a,"Unknown targetId: "+t),[4,this.localStore.releaseQuery(a.query,!1).then(function(){return u.removeAndCleanupQuery(a)}).catch(Et)];case 2:h.sent(),this.syncEngineListener.onWatchError(a.query,e),h.label=3;case 3:return[2]}})})},t.prototype.applyBatchState=function(t,e,n){return jt.__awaiter(this,void 0,void 0,function(){var r;return jt.__generator(this,function(i){switch(i.label){case 0:return this.assertSubscribed("applyBatchState()"),[4,this.localStore.lookupMutationDocuments(t)];case 1:return null===(r=i.sent())?(o(ki,"Cannot apply mutation batch with id: "+t),[2]):"pending"!==e?[3,3]:[4,this.remoteStore.fillWritePipeline()];case 2:return i.sent(),[3,4];case 3:"acknowledged"===e||"rejected"===e?(this.processUserCallback(t,n||null),this.localStore.removeCachedMutationBatchMetadata(t)):u("Unknown batchState: "+e),i.label=4;case 4:return[4,this.emitNewSnapsAndNotifyLocalStore(r)];case 5:return i.sent(),[2]}})})},t.prototype.applySuccessfulWrite=function(t){var e=this;this.assertSubscribed("applySuccessfulWrite()");var n=t.batch.batchId;return this.processUserCallback(n,null),this.localStore.acknowledgeBatch(t).then(function(t){return e.sharedClientState.updateMutationState(n,"acknowledged"),e.emitNewSnapsAndNotifyLocalStore(t)}).catch(Et)},t.prototype.rejectFailedWrite=function(t,e){var n=this;return this.assertSubscribed("rejectFailedWrite()"),this.processUserCallback(t,e),this.localStore.rejectBatch(t).then(function(r){return n.sharedClientState.updateMutationState(t,"rejected",e),n.emitNewSnapsAndNotifyLocalStore(r)}).catch(Et)},t.prototype.addMutationCallback=function(t,e){var n=this.mutationUserCallbacks[this.currentUser.toKey()];n||(n=new pe(M)),n=n.insert(t,e),this.mutationUserCallbacks[this.currentUser.toKey()]=n},t.prototype.processUserCallback=function(t,e){var n=this.mutationUserCallbacks[this.currentUser.toKey()];if(n){var r=n.get(t);r&&(c(t===n.minKey(),"Mutation callbacks processed out-of-order?"),e?r.reject(e):r.resolve(),n=n.remove(t)),this.mutationUserCallbacks[this.currentUser.toKey()]=n}},t.prototype.removeAndCleanupQuery=function(t){var e=this;if(this.sharedClientState.removeLocalQueryTarget(t.targetId),this.queryViewsByQuery.delete(t.query),delete this.queryViewsByTarget[t.targetId],this.isPrimary){var n=this.limboDocumentRefs.referencesForId(t.targetId);this.limboDocumentRefs.removeReferencesForId(t.targetId),n.forEach(function(t){e.limboDocumentRefs.containsKey(t)||e.removeLimboTarget(t)})}},t.prototype.removeLimboTarget=function(t){var e=this.limboTargetsByKey.get(t);null!==e&&(this.remoteStore.unlisten(e),this.limboTargetsByKey=this.limboTargetsByKey.remove(t),delete this.limboResolutionsByTarget[e])},t.prototype.updateTrackedLimbos=function(t,e){for(var n=0,r=e;n<r.length;n++){var i=r[n];if(i instanceof Di)this.limboDocumentRefs.addReference(i.key,t),this.trackLimboChange(i);else if(i instanceof Ni){o(ki,"Document no longer in limbo: "+i.key),this.limboDocumentRefs.removeReference(i.key,t);this.limboDocumentRefs.containsKey(i.key)||this.removeLimboTarget(i.key)}else u("Unknown limbo change: "+JSON.stringify(i))}},t.prototype.trackLimboChange=function(t){var e=t.key;if(!this.limboTargetsByKey.get(e)){o(ki,"New document in limbo: "+e);var n=this.limboTargetIdGenerator.next(),r=qe.atPath(e.path);this.limboResolutionsByTarget[n]=new Oi(e),this.remoteStore.listen(new $e(r,n,_e.LimboResolution,Gn.INVALID)),this.limboTargetsByKey=this.limboTargetsByKey.insert(e,n)}},t.prototype.currentLimboDocs=function(){return this.limboTargetsByKey},t.prototype.emitNewSnapsAndNotifyLocalStore=function(t,e){return jt.__awaiter(this,void 0,void 0,function(){var n,r,i,o=this;return jt.__generator(this,function(s){switch(s.label){case 0:return n=[],r=[],i=[],this.queryViewsByQuery.forEach(function(s,a){i.push(Promise.resolve().then(function(){var e=a.view.computeDocChanges(t);return e.needsRefill?o.localStore.executeQuery(a.query).then(function(t){return a.view.computeDocChanges(t,e)}):e}).then(function(t){var i=a.view.applyChanges(t,!0===o.isPrimary,e&&e.targetChanges[a.targetId]);if(o.updateTrackedLimbos(a.targetId,i.limboChanges),i.snapshot){o.isPrimary&&o.sharedClientState.updateQueryState(a.targetId,i.snapshot.fromCache?"not-current":"current"),n.push(i.snapshot);var s=Ci.fromSnapshot(a.targetId,i.snapshot);r.push(s)}}))}),[4,Promise.all(i)];case 1:return s.sent(),this.syncEngineListener.onWatchChange(n),[4,this.localStore.notifyLocalViewChanges(r)];case 2:return s.sent(),[2]}})})},t.prototype.assertSubscribed=function(t){c(null!==this.syncEngineListener,"Trying to call "+t+" before calling subscribe().")},t.prototype.handleCredentialChange=function(t){return jt.__awaiter(this,void 0,void 0,function(){var e,n;return jt.__generator(this,function(r){switch(r.label){case 0:return e=!this.currentUser.isEqual(t),this.currentUser=t,e?[4,this.localStore.handleUserChange(t)]:[3,3];case 1:return n=r.sent(),this.sharedClientState.handleUserChange(t,n.removedBatchIds,n.addedBatchIds),[4,this.emitNewSnapsAndNotifyLocalStore(n.affectedDocuments)];case 2:r.sent(),r.label=3;case 3:return[4,this.remoteStore.handleCredentialChange()];case 4:return r.sent(),[2]}})})},t.prototype.applyPrimaryState=function(t){return jt.__awaiter(this,void 0,void 0,function(){var e,n,r,i,o,s,a=this;return jt.__generator(this,function(u){switch(u.label){case 0:return!0!==t||!0===this.isPrimary?[3,3]:(this.isPrimary=!0,[4,this.remoteStore.applyPrimaryState(!0)]);case 1:return u.sent(),e=this.sharedClientState.getAllActiveQueryTargets(),[4,this.synchronizeQueryViewsAndRaiseSnapshots(e.toArray())];case 2:for(n=u.sent(),r=0,i=n;r<i.length;r++)this.remoteStore.listen(i[r]);return[3,7];case 3:return!1!==t||!1===this.isPrimary?[3,7]:(this.isPrimary=!1,o=[],s=Promise.resolve(),p(this.queryViewsByTarget,function(t,e){a.sharedClientState.isLocalQueryTarget(t)?o.push(t):s=s.then(function(){return a.unlisten(e.query)}),a.remoteStore.unlisten(e.targetId)}),[4,s]);case 4:return u.sent(),[4,this.synchronizeQueryViewsAndRaiseSnapshots(o)];case 5:return u.sent(),this.resetLimboDocuments(),[4,this.remoteStore.applyPrimaryState(!1)];case 6:u.sent(),u.label=7;case 7:return[2]}})})},t.prototype.resetLimboDocuments=function(){var t=this;p(this.limboResolutionsByTarget,function(e){t.remoteStore.unlisten(e)}),this.limboDocumentRefs.removeAllReferences(),this.limboResolutionsByTarget=[],this.limboTargetsByKey=new pe(ce.comparator)},t.prototype.synchronizeQueryViewsAndRaiseSnapshots=function(t){for(var e=this,n=Promise.resolve(),r=[],i=[],o=function(t){n=n.then(function(){return jt.__awaiter(e,void 0,void 0,function(){var e,n,o,s;return jt.__generator(this,function(a){switch(a.label){case 0:return(n=this.queryViewsByTarget[t])?[4,this.localStore.releaseQuery(n.query,!0)]:[3,4];case 1:return a.sent(),[4,this.localStore.allocateQuery(n.query)];case 2:return e=a.sent(),[4,this.synchronizeViewAndComputeSnapshot(n)];case 3:return(o=a.sent()).snapshot&&i.push(o.snapshot),[3,8];case 4:return c(!0===this.isPrimary,"A secondary tab should never have an active query without an active view."),[4,this.localStore.getQueryForTarget(t)];case 5:return s=a.sent(),c(!!s,"Query data for target "+t+" not found"),[4,this.localStore.allocateQuery(s)];case 6:return e=a.sent(),[4,this.initializeViewAndComputeSnapshot(e,!1)];case 7:a.sent(),a.label=8;case 8:return r.push(e),[2]}})})})},s=0,a=t;s<a.length;s++){o(a[s])}return n.then(function(){return e.syncEngineListener.onWatchChange(i),r})},t.prototype.getActiveClients=function(){return this.localStore.getActiveClients()},t.prototype.applyTargetState=function(t,e,n){return jt.__awaiter(this,void 0,void 0,function(){var r,i=this;return jt.__generator(this,function(s){switch(s.label){case 0:if(this.isPrimary)return o(ki,"Ignoring unexpected query state notification."),[2];if(!this.queryViewsByTarget[t])return[3,5];switch(e){case"current":case"not-current":return[3,1];case"rejected":return[3,2]}return[3,4];case 1:return[2,this.localStore.getNewDocumentChanges().then(function(n){return jt.__awaiter(i,void 0,void 0,function(){var r;return jt.__generator(this,function(i){switch(i.label){case 0:return r=Nn.createSynthesizedRemoteEventForCurrentChange(t,"current"===e),[4,this.emitNewSnapsAndNotifyLocalStore(n,r)];case 1:return i.sent(),[2]}})})},function(t){return jt.__awaiter(i,void 0,void 0,function(){var e;return jt.__generator(this,function(n){switch(n.label){case 0:return function(t){return t.code===Xt.DATA_LOSS&&t.message===yr}(t)?(e=[],p(this.queryViewsByTarget,function(t){return e.push(t)}),[4,this.synchronizeQueryViewsAndRaiseSnapshots(e)]):[3,2];case 1:return n.sent(),[3,3];case 2:throw t;case 3:return[2]}})})})];case 2:return r=this.queryViewsByTarget[t],this.removeAndCleanupQuery(r),[4,this.localStore.releaseQuery(r.query,!0)];case 3:return s.sent(),this.syncEngineListener.onWatchError(r.query,n),[3,5];case 4:u("Unexpected target state: "+e),s.label=5;case 5:return[2]}})})},t.prototype.applyActiveTargetsChange=function(t,e){return jt.__awaiter(this,void 0,void 0,function(){var n,r,i,o,s,a,u,h,l,f=this;return jt.__generator(this,function(d){switch(d.label){case 0:if(!this.isPrimary)return[2];n=0,r=t,d.label=1;case 1:return n<r.length?(l=r[n],c(!this.queryViewsByTarget[l],"Trying to add an already active target"),[4,this.localStore.getQueryForTarget(l)]):[3,6];case 2:return i=d.sent(),c(!!i,"Query data for active target "+l+" not found"),[4,this.localStore.allocateQuery(i)];case 3:return o=d.sent(),[4,this.initializeViewAndComputeSnapshot(o,!1)];case 4:d.sent(),this.remoteStore.listen(o),d.label=5;case 5:return n++,[3,1];case 6:s=function(t){var e;return jt.__generator(this,function(n){switch(n.label){case 0:return(e=a.queryViewsByTarget[t])?[4,a.localStore.releaseQuery(e.query,!1).then(function(){f.remoteStore.unlisten(t),f.removeAndCleanupQuery(e)}).catch(Et)]:[3,2];case 1:n.sent(),n.label=2;case 2:return[2]}})},a=this,u=0,h=e,d.label=7;case 7:return u<h.length?(l=h[u],[5,s(l)]):[3,10];case 8:d.sent(),d.label=9;case 9:return u++,[3,7];case 10:return[2]}})})},t.prototype.enableNetwork=function(){return this.localStore.setNetworkEnabled(!0),this.remoteStore.enableNetwork()},t.prototype.disableNetwork=function(){return this.localStore.setNetworkEnabled(!1),this.remoteStore.disableNetwork()},t.prototype.getRemoteKeysForTarget=function(t){var e=this.limboResolutionsByTarget[t];return e&&e.receivedDocument?H().add(e.key):this.queryViewsByTarget[t]?this.queryViewsByTarget[t].view.syncedDocuments:H()},t}(),Mi=function(){function t(t){this.uid=t}return t.prototype.isAuthenticated=function(){return null!=this.uid},t.prototype.toKey=function(){return this.isAuthenticated()?"uid:"+this.uid:"anonymous-user"},t.prototype.isEqual=function(t){return t.uid===this.uid},t.UNAUTHENTICATED=new t(null),t.GOOGLE_CREDENTIALS=new t("google-credentials-uid"),t.FIRST_PARTY=new t("first-party-uid"),t}(),Li="SharedClientState",xi="firestore_clients",Ui="firestore_mutations",Bi="firestore_targets",Fi="firestore_online_state",qi="firestore_sequence_number",Vi=function(){function t(t,e,n,r){this.user=t,this.batchId=e,this.state=n,this.error=r,c(void 0!==r==("rejected"===n),"MutationMetadata must contain an error iff state is 'rejected'")}return t.fromWebStorageEntry=function(e,n,r){var i=JSON.parse(r),o="object"==typeof i&&-1!==["pending","acknowledged","rejected"].indexOf(i.state)&&(void 0===i.error||"object"==typeof i.error),a=void 0;return o&&i.error&&(o="string"==typeof i.error.message&&"string"==typeof i.error.code)&&(a=new Yt(i.error.code,i.error.message)),o?new t(e,n,i.state,a):(s(Li,"Failed to parse mutation state for ID '"+n+"': "+r),null)},t.prototype.toWebStorageJSON=function(){var t={state:this.state,updateTimeMs:Date.now()};return this.error&&(t.error={code:this.error.code,message:this.error.message}),JSON.stringify(t)},t}(),Ki=function(){function t(t,e,n){this.targetId=t,this.state=e,this.error=n,c(void 0!==n==("rejected"===e),"QueryTargetMetadata must contain an error iff state is 'rejected'")}return t.fromWebStorageEntry=function(e,n){var r=JSON.parse(n),i="object"==typeof r&&-1!==["not-current","current","rejected"].indexOf(r.state)&&(void 0===r.error||"object"==typeof r.error),o=void 0;return i&&r.error&&(i="string"==typeof r.error.message&&"string"==typeof r.error.code)&&(o=new Yt(r.error.code,r.error.message)),i?new t(e,r.state,o):(s(Li,"Failed to parse target state for ID '"+e+"': "+n),null)},t.prototype.toWebStorageJSON=function(){var t={state:this.state,updateTimeMs:Date.now()};return this.error&&(t.error={code:this.error.code,message:this.error.message}),JSON.stringify(t)},t}(),ji=function(){function t(t,e){this.clientId=t,this.activeTargetIds=e}return t.fromWebStorageEntry=function(e,n){for(var r=JSON.parse(n),i="object"==typeof r&&r.activeTargetIds instanceof Array,o=X(),a=0;i&&a<r.activeTargetIds.length;++a)i=q(r.activeTargetIds[a]),o=o.add(r.activeTargetIds[a]);return i?new t(e,o):(s(Li,"Failed to parse client data for instance '"+e+"': "+n),null)},t}(),Wi=function(){function t(t,e){this.clientId=t,this.onlineState=e}return t.fromWebStorageEntry=function(e){var n=JSON.parse(e);return"object"==typeof n&&void 0!==ci[n.onlineState]&&"string"==typeof n.clientId?new t(n.clientId,ci[n.onlineState]):(s(Li,"Failed to parse online state: "+e),null)},t}(),Qi=function(){function t(){this.activeTargetIds=X()}return t.prototype.addQueryTarget=function(t){c(!this.activeTargetIds.has(t),"Target with ID '"+t+"' already active."),this.activeTargetIds=this.activeTargetIds.add(t)},t.prototype.removeQueryTarget=function(t){this.activeTargetIds=this.activeTargetIds.delete(t)},t.prototype.toWebStorageJSON=function(){var t={activeTargetIds:this.activeTargetIds.toArray(),updateTimeMs:Date.now()};return JSON.stringify(t)},t}(),Gi=function(){function t(e,n,r,i,o){if(this.queue=e,this.platform=n,this.persistenceKey=r,this.localClientId=i,this.syncEngine=null,this.onlineStateHandler=null,this.sequenceNumberHandler=null,this.activeClients={},this.storageListener=this.handleWebStorageEvent.bind(this),this.started=!1,this.earlyEvents=[],!t.isAvailable(this.platform))throw new Yt(Xt.UNIMPLEMENTED,"LocalStorage is not available on this platform.");var s=r.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");this.storage=this.platform.window.localStorage,this.currentUser=o,this.localClientStorageKey=this.toWebStorageClientStateKey(this.localClientId),this.sequenceNumberKey=qi+"_"+r,this.activeClients[this.localClientId]=new Qi,this.clientStateKeyRe=new RegExp("^"+xi+"_"+s+"_([^_]*)$"),this.mutationBatchKeyRe=new RegExp("^"+Ui+"_"+s+"_(\\d+)(?:_(.*))?$"),this.queryTargetKeyRe=new RegExp("^"+Bi+"_"+s+"_(\\d+)$"),this.onlineStateKey=Fi+"_"+r,this.platform.window.addEventListener("storage",this.storageListener)}return t.isAvailable=function(t){return!(!t.window||null==t.window.localStorage)},t.prototype.start=function(){return jt.__awaiter(this,void 0,void 0,function(){var t,e,n,r,i,o,s,a,u,h,l=this;return jt.__generator(this,function(f){switch(f.label){case 0:return c(!this.started,"WebStorageSharedClientState already started"),c(null!==this.syncEngine,"syncEngine property must be set before calling start()"),c(null!==this.onlineStateHandler,"onlineStateHandler property must be set before calling start()"),[4,this.syncEngine.getActiveClients()];case 1:for(t=f.sent(),e=0,n=t;e<n.length;e++)(r=n[e])!==this.localClientId&&(i=this.getItem(this.toWebStorageClientStateKey(r)))&&(o=ji.fromWebStorageEntry(r,i))&&(this.activeClients[o.clientId]=o);for(this.persistClientState(),(s=this.storage.getItem(this.onlineStateKey))&&(a=this.fromWebStorageOnlineState(s))&&this.handleOnlineStateEvent(a),u=0,h=this.earlyEvents;u<h.length;u++)this.handleWebStorageEvent(h[u]);return this.earlyEvents=[],this.platform.window.addEventListener("unload",function(){return l.shutdown()}),this.started=!0,[2]}})})},t.prototype.writeSequenceNumber=function(t){this.setItem(this.sequenceNumberKey,JSON.stringify(t))},t.prototype.getAllActiveQueryTargets=function(){var t=X();return m(this.activeClients,function(e,n){t=t.unionWith(n.activeTargetIds)}),t},t.prototype.isActiveQueryTarget=function(t){for(var e in this.activeClients)if(this.activeClients.hasOwnProperty(e)&&this.activeClients[e].activeTargetIds.has(t))return!0;return!1},t.prototype.addPendingMutation=function(t){this.persistMutationState(t,"pending")},t.prototype.updateMutationState=function(t,e,n){this.persistMutationState(t,e,n),this.removeMutationState(t)},t.prototype.addLocalQueryTarget=function(t){var e="not-current";if(this.isActiveQueryTarget(t)){var n=this.storage.getItem(this.toWebStorageQueryTargetMetadataKey(t));if(n){var r=Ki.fromWebStorageEntry(t,n);r&&(e=r.state)}}return this.localClientState.addQueryTarget(t),this.persistClientState(),e},t.prototype.removeLocalQueryTarget=function(t){this.localClientState.removeQueryTarget(t),this.persistClientState()},t.prototype.isLocalQueryTarget=function(t){return this.localClientState.activeTargetIds.has(t)},t.prototype.clearQueryState=function(t){this.removeItem(this.toWebStorageQueryTargetMetadataKey(t))},t.prototype.updateQueryState=function(t,e,n){this.persistQueryTargetState(t,e,n)},t.prototype.handleUserChange=function(t,e,n){var r=this;e.forEach(function(t){r.removeMutationState(t)}),this.currentUser=t,n.forEach(function(t){r.addPendingMutation(t)})},t.prototype.setOnlineState=function(t){this.persistOnlineState(t)},t.prototype.shutdown=function(){this.started&&(this.platform.window.removeEventListener("storage",this.storageListener),this.removeItem(this.localClientStorageKey),this.started=!1)},t.prototype.getItem=function(t){var e=this.storage.getItem(t);return o(Li,"READ",t,e),e},t.prototype.setItem=function(t,e){o(Li,"SET",t,e),this.storage.setItem(t,e)},t.prototype.removeItem=function(t){o(Li,"REMOVE",t),this.storage.removeItem(t)},t.prototype.handleWebStorageEvent=function(t){var e=this;if(t.storageArea===this.storage){if(o(Li,"EVENT",t.key,t.newValue),t.key===this.localClientStorageKey)return void s("Received WebStorage notification for local change. Another client might have garbage-collected our state");this.queue.enqueueAndForget(function(){return jt.__awaiter(e,void 0,void 0,function(){var e,n,r,i,o,a;return jt.__generator(this,function(u){if(!this.started)return this.earlyEvents.push(t),[2];if(null===t.key)return[2];if(this.clientStateKeyRe.test(t.key)){if(null==t.newValue)return n=this.fromWebStorageClientStateKey(t.key),[2,this.handleClientStateEvent(n,null)];if(e=this.fromWebStorageClientState(t.key,t.newValue))return[2,this.handleClientStateEvent(e.clientId,e)]}else if(this.mutationBatchKeyRe.test(t.key)){if(null!==t.newValue&&(r=this.fromWebStorageMutationMetadata(t.key,t.newValue)))return[2,this.handleMutationBatchEvent(r)]}else if(this.queryTargetKeyRe.test(t.key)){if(null!==t.newValue&&(i=this.fromWebStorageQueryTargetMetadata(t.key,t.newValue)))return[2,this.handleQueryTargetEvent(i)]}else if(t.key===this.onlineStateKey){if(null!==t.newValue&&(o=this.fromWebStorageOnlineState(t.newValue)))return[2,this.handleOnlineStateEvent(o)]}else t.key===this.sequenceNumberKey&&(c(!!this.sequenceNumberHandler,"Missing sequenceNumberHandler"),(a=function(t){var e=Gn.INVALID;if(null!=t)try{var n=JSON.parse(t);c("number"==typeof n,"Found non-numeric sequence number"),e=n}catch(t){s(Li,"Failed to read sequence number from WebStorage",t)}return e}(t.newValue))!==Gn.INVALID&&this.sequenceNumberHandler(a));return[2]})})})}},Object.defineProperty(t.prototype,"localClientState",{get:function(){return this.activeClients[this.localClientId]},enumerable:!0,configurable:!0}),t.prototype.persistClientState=function(){this.setItem(this.localClientStorageKey,this.localClientState.toWebStorageJSON())},t.prototype.persistMutationState=function(t,e,n){var r=new Vi(this.currentUser,t,e,n),i=this.toWebStorageMutationBatchKey(t);this.setItem(i,r.toWebStorageJSON())},t.prototype.removeMutationState=function(t){var e=this.toWebStorageMutationBatchKey(t);this.removeItem(e)},t.prototype.persistOnlineState=function(t){var e={clientId:this.localClientId,onlineState:ci[t]};this.storage.setItem(this.onlineStateKey,JSON.stringify(e))},t.prototype.persistQueryTargetState=function(t,e,n){var r=this.toWebStorageQueryTargetMetadataKey(t),i=new Ki(t,e,n);this.setItem(r,i.toWebStorageJSON())},t.prototype.toWebStorageClientStateKey=function(t){return c(-1===t.indexOf("_"),"Client key cannot contain '_', but was '"+t+"'"),xi+"_"+this.persistenceKey+"_"+t},t.prototype.toWebStorageQueryTargetMetadataKey=function(t){return Bi+"_"+this.persistenceKey+"_"+t},t.prototype.toWebStorageMutationBatchKey=function(t){var e=Ui+"_"+this.persistenceKey+"_"+t;return this.currentUser.isAuthenticated()&&(e+="_"+this.currentUser.uid),e},t.prototype.fromWebStorageClientStateKey=function(t){var e=this.clientStateKeyRe.exec(t);return e?e[1]:null},t.prototype.fromWebStorageClientState=function(t,e){var n=this.fromWebStorageClientStateKey(t);return c(null!==n,"Cannot parse client state key '"+t+"'"),ji.fromWebStorageEntry(n,e)},t.prototype.fromWebStorageMutationMetadata=function(t,e){var n=this.mutationBatchKeyRe.exec(t);c(null!==n,"Cannot parse mutation batch key '"+t+"'");var r=Number(n[1]);return Vi.fromWebStorageEntry(new Mi(void 0!==n[2]?n[2]:null),r,e)},t.prototype.fromWebStorageQueryTargetMetadata=function(t,e){var n=this.queryTargetKeyRe.exec(t);c(null!==n,"Cannot parse query target key '"+t+"'");var r=Number(n[1]);return Ki.fromWebStorageEntry(r,e)},t.prototype.fromWebStorageOnlineState=function(t){return Wi.fromWebStorageEntry(t)},t.prototype.handleMutationBatchEvent=function(t){return jt.__awaiter(this,void 0,void 0,function(){return jt.__generator(this,function(e){return t.user.uid!==this.currentUser.uid?(o(Li,"Ignoring mutation for non-active user "+t.user.uid),[2]):[2,this.syncEngine.applyBatchState(t.batchId,t.state,t.error)]})})},t.prototype.handleQueryTargetEvent=function(t){return this.syncEngine.applyTargetState(t.targetId,t.state,t.error)},t.prototype.handleClientStateEvent=function(t,e){var n=this,r=this.getAllActiveQueryTargets();e?this.activeClients[t]=e:delete this.activeClients[t];var i=this.getAllActiveQueryTargets(),o=[],s=[];return i.forEach(function(t){return jt.__awaiter(n,void 0,void 0,function(){return jt.__generator(this,function(e){return r.has(t)||o.push(t),[2]})})}),r.forEach(function(t){return jt.__awaiter(n,void 0,void 0,function(){return jt.__generator(this,function(e){return i.has(t)||s.push(t),[2]})})}),this.syncEngine.applyActiveTargetsChange(o,s)},t.prototype.handleOnlineStateEvent=function(t){this.activeClients[t.clientId]&&this.onlineStateHandler(t.onlineState)},t}(),zi=function(){function t(){this.localState=new Qi,this.queryState={},this.syncEngine=null,this.onlineStateHandler=null,this.sequenceNumberHandler=null}return t.prototype.addPendingMutation=function(t){},t.prototype.updateMutationState=function(t,e,n){},t.prototype.addLocalQueryTarget=function(t){return this.localState.addQueryTarget(t),this.queryState[t]||"not-current"},t.prototype.updateQueryState=function(t,e,n){this.queryState[t]=e},t.prototype.removeLocalQueryTarget=function(t){this.localState.removeQueryTarget(t)},t.prototype.isLocalQueryTarget=function(t){return this.localState.activeTargetIds.has(t)},t.prototype.clearQueryState=function(t){delete this.queryState[t]},t.prototype.getAllActiveQueryTargets=function(){return this.localState.activeTargetIds},t.prototype.isActiveQueryTarget=function(t){return this.localState.activeTargetIds.has(t)},t.prototype.start=function(){return this.localState=new Qi,Promise.resolve()},t.prototype.handleUserChange=function(t,e,n){},t.prototype.setOnlineState=function(t){},t.prototype.shutdown=function(){},t.prototype.writeSequenceNumber=function(t){},t}(),Hi=function(){function t(t,e){this.cacheSizeBytes=t,this.experimentalTabSynchronization=e}return t.prototype.lruParams=function(){return qr.withCacheSize(this.cacheSizeBytes)},t}(),Xi=function(){return function(){}}(),Yi=function(){function t(t,e,n,r){this.platform=t,this.databaseInfo=e,this.credentials=n,this.asyncQueue=r,this.clientId=Jt.newId()}return t.prototype.start=function(t){var e=this,n=new zn,r=new zn,i=!1;return this.credentials.setChangeListener(function(o){i?e.asyncQueue.enqueueAndForget(function(){return e.handleCredentialChange(o)}):(i=!0,e.initializePersistence(t,r,o).then(function(t){return e.initializeRest(o,t)}).then(n.resolve,n.reject))}),this.asyncQueue.enqueueAndForget(function(){return n.promise}),r.promise},t.prototype.enableNetwork=function(){var t=this;return this.asyncQueue.enqueue(function(){return t.syncEngine.enableNetwork()})},t.prototype.initializePersistence=function(t,e,n){var r=this;return t instanceof Hi?this.startIndexedDbPersistence(n,t).then(function(t){return e.resolve(),t}).catch(function(t){if(e.reject(t),!r.canFallback(t))throw t;return console.warn("Error enabling offline storage. Falling back to storage disabled: "+t),r.startMemoryPersistence()}):(e.resolve(),this.startMemoryPersistence())},t.prototype.canFallback=function(t){return t instanceof Yt?t.code===Xt.FAILED_PRECONDITION||t.code===Xt.UNIMPLEMENTED:!("undefined"!=typeof DOMException&&t instanceof DOMException)||(22===t.code||20===t.code)},t.prototype.startIndexedDbPersistence=function(t,e){var n=this,r=Hr.buildStoragePrefix(this.databaseInfo),i=new Bn(this.databaseInfo.databaseId,{useProto3Json:!0});return Promise.resolve().then(function(){return jt.__awaiter(n,void 0,void 0,function(){var n,o;return jt.__generator(this,function(s){switch(s.label){case 0:if(e.experimentalTabSynchronization&&!Gi.isAvailable(this.platform))throw new Yt(Xt.UNIMPLEMENTED,"IndexedDB persistence is only available on platforms that support LocalStorage.");return o=e.lruParams(),e.experimentalTabSynchronization?(this.sharedClientState=new Gi(this.asyncQueue,this.platform,r,this.clientId,t),[4,Hr.createMultiClientIndexedDbPersistence(r,this.clientId,this.platform,this.asyncQueue,i,o,{sequenceNumberSyncer:this.sharedClientState})]):[3,2];case 1:return n=s.sent(),[3,4];case 2:return this.sharedClientState=new zi,[4,Hr.createIndexedDbPersistence(r,this.clientId,this.platform,this.asyncQueue,i,o)];case 3:n=s.sent(),s.label=4;case 4:return this.persistence=n,[2,n.referenceDelegate.garbageCollector]}})})})},t.prototype.startMemoryPersistence=function(){return this.persistence=ii.createEagerPersistence(this.clientId),this.sharedClientState=new zi,Promise.resolve(null)},t.prototype.initializeRest=function(t,e){var n=this;return o("FirestoreClient","Initializing. user=",t.uid),this.platform.loadConnection(this.databaseInfo).then(function(r){return jt.__awaiter(n,void 0,void 0,function(){var n,i,o,s,a=this;return jt.__generator(this,function(u){switch(u.label){case 0:return this.localStore=new $r(this.persistence,t),e&&(this.lruScheduler=new Vr(e,this.asyncQueue,this.localStore)),n=this.platform.newSerializer(this.databaseInfo.databaseId),i=new yi(this.asyncQueue,r,this.credentials,n),o=function(t){return a.syncEngine.applyOnlineStateChange(t,vi.RemoteStore)},s=function(t){return a.syncEngine.applyOnlineStateChange(t,vi.SharedClientState)},this.remoteStore=new Ei(this.localStore,i,this.asyncQueue,o),this.syncEngine=new Pi(this.localStore,this.remoteStore,this.sharedClientState,t),this.sharedClientState.onlineStateHandler=s,this.remoteStore.syncEngine=this.syncEngine,this.sharedClientState.syncEngine=this.syncEngine,this.eventMgr=new Si(this.syncEngine),[4,this.sharedClientState.start()];case 1:return u.sent(),[4,this.remoteStore.start()];case 2:return u.sent(),[4,this.persistence.setPrimaryStateListener(function(t){return jt.__awaiter(a,void 0,void 0,function(){return jt.__generator(this,function(e){switch(e.label){case 0:return[4,this.syncEngine.applyPrimaryState(t)];case 1:return e.sent(),this.lruScheduler&&(t&&!this.lruScheduler.started?this.lruScheduler.start():t||this.lruScheduler.stop()),[2]}})})})];case 3:return u.sent(),[2]}})})})},t.prototype.handleCredentialChange=function(t){return this.asyncQueue.verifyOperationInProgress(),o("FirestoreClient","Credential Changed. Current user: "+t.uid),this.syncEngine.handleCredentialChange(t)},t.prototype.disableNetwork=function(){var t=this;return this.asyncQueue.enqueue(function(){return t.syncEngine.disableNetwork()})},t.prototype.shutdown=function(t){var e=this;return this.asyncQueue.enqueue(function(){return jt.__awaiter(e,void 0,void 0,function(){return jt.__generator(this,function(e){switch(e.label){case 0:return this.lruScheduler&&this.lruScheduler.stop(),[4,this.remoteStore.shutdown()];case 1:return e.sent(),[4,this.sharedClientState.shutdown()];case 2:return e.sent(),[4,this.persistence.shutdown(t&&t.purgePersistenceWithDataLoss)];case 3:return e.sent(),this.credentials.removeChangeListener(),[2]}})})})},t.prototype.listen=function(t,e,n){var r=this,i=new Ii(t,e,n);return this.asyncQueue.enqueueAndForget(function(){return r.eventMgr.listen(i)}),i},t.prototype.unlisten=function(t){var e=this;this.asyncQueue.enqueueAndForget(function(){return e.eventMgr.unlisten(t)})},t.prototype.getDocumentFromLocalCache=function(t){var e=this;return this.asyncQueue.enqueue(function(){return e.localStore.readDocument(t)}).then(function(t){if(t instanceof le)return t;if(t instanceof fe)return null;throw new Yt(Xt.UNAVAILABLE,"Failed to get document from cache. (However, this document may exist on the server. Run again without setting 'source' in the GetOptions to attempt to retrieve the document from the server.)")})},t.prototype.getDocumentsFromLocalCache=function(t){var e=this;return this.asyncQueue.enqueue(function(){return e.localStore.executeQuery(t)}).then(function(e){var n=H(),r=new Ai(t,n),i=r.computeDocChanges(e);return r.applyChanges(i,!1).snapshot})},t.prototype.write=function(t){var e=this,n=new zn;return this.asyncQueue.enqueueAndForget(function(){return e.syncEngine.write(t,n)}),n.promise},t.prototype.databaseId=function(){return this.databaseInfo.databaseId},t.prototype.transaction=function(t){var e=this;return this.asyncQueue.enqueue(function(){return jt.__awaiter(e,void 0,void 0,function(){return jt.__generator(this,function(t){return[2]})})}).then(function(){return e.syncEngine.runTransaction(t)})},t}(),Ji=function(){function t(t){this.observer=t,this.muted=!1}return t.prototype.next=function(t){this.scheduleEvent(this.observer.next,t)},t.prototype.error=function(t){this.scheduleEvent(this.observer.error,t)},t.prototype.mute=function(){this.muted=!0},t.prototype.scheduleEvent=function(t,e){var n=this;this.muted||setTimeout(function(){n.muted||t(e)},0)},t}(),Zi=function(){function t(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];!function(t,e,n,r){if(!(e instanceof Array)||e.length<r)throw new Yt(Xt.INVALID_ARGUMENT,"Function "+t+"() requires its "+n+" argument to be an array with at least "+P(r,"element")+".")}("FieldPath",t,"fieldNames",1);for(var n=0;n<t.length;++n)if(_("FieldPath","string",n,t[n]),0===t[n].length)throw new Yt(Xt.INVALID_ARGUMENT,"Invalid field name at argument $(i + 1). Field names must not be empty.");this._internalPath=new ue(t)}return t.documentId=function(){return t._DOCUMENT_ID},t.prototype.isEqual=function(e){if(!(e instanceof t))throw R("isEqual","FieldPath",1,e);return this._internalPath.isEqual(e._internalPath)},t._DOCUMENT_ID=new t(ue.keyField().canonicalString()),t}(),$i=new RegExp("[~\\*/\\[\\]]"),to=function(){return function(t,e){this.user=e,this.type="OAuth",this.authHeaders={Authorization:"Bearer "+t}}}(),eo=function(){function t(){this.changeListener=null}return t.prototype.getToken=function(){return Promise.resolve(null)},t.prototype.invalidateToken=function(){},t.prototype.setChangeListener=function(t){c(!this.changeListener,"Can only call setChangeListener() once."),this.changeListener=t,t(Mi.UNAUTHENTICATED)},t.prototype.removeChangeListener=function(){c(null!==this.changeListener,"removeChangeListener() when no listener registered"),this.changeListener=null},t}(),no=function(){function t(t){var e=this;this.app=t,this.tokenListener=null,this.tokenCounter=0,this.changeListener=null,this.forceRefresh=!1,this.tokenListener=function(){e.tokenCounter++,e.currentUser=e.getUser(),e.changeListener&&e.changeListener(e.currentUser)},this.tokenCounter=0,this.app.INTERNAL.addAuthTokenListener(this.tokenListener)}return t.prototype.getToken=function(){var t=this;c(null!=this.tokenListener,"getToken cannot be called after listener removed.");var e=this.tokenCounter,n=this.forceRefresh;return this.forceRefresh=!1,this.app.INTERNAL.getToken(n).then(function(n){if(t.tokenCounter!==e)throw new Yt(Xt.ABORTED,"getToken aborted due to token change.");return n?(c("string"==typeof n.accessToken,"Invalid tokenData returned from getToken():"+n),new to(n.accessToken,t.currentUser)):null})},t.prototype.invalidateToken=function(){this.forceRefresh=!0},t.prototype.setChangeListener=function(t){c(!this.changeListener,"Can only call setChangeListener() once."),this.changeListener=t,this.currentUser&&t(this.currentUser)},t.prototype.removeChangeListener=function(){c(null!=this.tokenListener,"removeChangeListener() called twice"),c(null!==this.changeListener,"removeChangeListener() called when no listener registered"),this.app.INTERNAL.removeAuthTokenListener(this.tokenListener),this.tokenListener=null,this.changeListener=null},t.prototype.getUser=function(){var t=this.app.INTERNAL.getUid();return c(null===t||"string"==typeof t,"Received invalid UID: "+t),new Mi(t)},t}(),ro=function(){function t(t,e){this.gapi=t,this.sessionIndex=e,this.type="FirstParty",this.user=Mi.FIRST_PARTY,c(this.gapi&&this.gapi.auth&&this.gapi.auth.getAuthHeaderValueForFirstParty,"unexpected gapi interface")}return Object.defineProperty(t.prototype,"authHeaders",{get:function(){return{Authorization:this.gapi.auth.getAuthHeaderValueForFirstParty([]),"X-Goog-AuthUser":this.sessionIndex}},enumerable:!0,configurable:!0}),t}(),io=function(){function t(t,e){this.gapi=t,this.sessionIndex=e,c(this.gapi&&this.gapi.auth&&this.gapi.auth.getAuthHeaderValueForFirstParty,"unexpected gapi interface")}return t.prototype.getToken=function(){return Promise.resolve(new ro(this.gapi,this.sessionIndex))},t.prototype.setChangeListener=function(t){t(Mi.FIRST_PARTY)},t.prototype.removeChangeListener=function(){},t.prototype.invalidateToken=function(){},t}(),oo=function(){function t(t){this._methodName=t}return t.delete=function(){return so.instance},t.serverTimestamp=function(){return ao.instance},t.arrayUnion=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return v("FieldValue.arrayUnion",arguments,1),new uo(t)},t.arrayRemove=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return v("FieldValue.arrayRemove",arguments,1),new co(t)},t.prototype.isEqual=function(t){return this===t},t}(),so=function(t){function e(){return t.call(this,"FieldValue.delete")||this}return jt.__extends(e,t),e.instance=new e,e}(oo),ao=function(t){function e(){return t.call(this,"FieldValue.serverTimestamp")||this}return jt.__extends(e,t),e.instance=new e,e}(oo),uo=function(t){function e(e){var n=t.call(this,"FieldValue.arrayUnion")||this;return n._elements=e,n}return jt.__extends(e,t),e}(oo),co=function(t){function e(e){var n=t.call(this,"FieldValue.arrayRemove")||this;return n._elements=e,n}return jt.__extends(e,t),e}(oo),ho=l(oo,"Use FieldValue.<field>() instead."),lo=/^__.*__$/,fo=function(){function t(t,e,n){this.data=t,this.fieldMask=e,this.fieldTransforms=n}return t.prototype.toMutations=function(t,e){var n=[];return n.push(null!==this.fieldMask?new hn(t,this.data,this.fieldMask,e):new cn(t,this.data,e)),this.fieldTransforms.length>0&&n.push(new ln(t,this.fieldTransforms)),n},t}(),po=function(){function t(t,e,n){this.data=t,this.fieldMask=e,this.fieldTransforms=n}return t.prototype.toMutations=function(t,e){var n=[new hn(t,this.data,this.fieldMask,e)];return this.fieldTransforms.length>0&&n.push(new ln(t,this.fieldTransforms)),n},t}();!function(t){t[t.Set=0]="Set",t[t.Update=1]="Update",t[t.MergeSet=2]="MergeSet",t[t.Argument=3]="Argument"}(bi||(bi={}));var mo=function(){function t(t,e,n,r,i,o){this.dataSource=t,this.methodName=e,this.path=n,this.arrayElement=r,void 0===i&&this.validatePath(),this.arrayElement=void 0!==r&&r,this.fieldTransforms=i||[],this.fieldMask=o||[]}return t.prototype.childContextForField=function(e){var n=null==this.path?null:this.path.child(e),r=new t(this.dataSource,this.methodName,n,!1,this.fieldTransforms,this.fieldMask);return r.validatePathSegment(e),r},t.prototype.childContextForFieldPath=function(e){var n=null==this.path?null:this.path.child(e),r=new t(this.dataSource,this.methodName,n,!1,this.fieldTransforms,this.fieldMask);return r.validatePath(),r},t.prototype.childContextForArray=function(e){return new t(this.dataSource,this.methodName,null,!0,this.fieldTransforms,this.fieldMask)},t.prototype.createError=function(t){var e=null===this.path||this.path.isEmpty()?"":" (found in field "+this.path.toString()+")";return new Yt(Xt.INVALID_ARGUMENT,"Function "+this.methodName+"() called with invalid data. "+t+e)},t.prototype.contains=function(t){return void 0!==this.fieldMask.find(function(e){return t.isPrefixOf(e)})||void 0!==this.fieldTransforms.find(function(e){return t.isPrefixOf(e.field)})},t.prototype.validatePath=function(){if(null!==this.path)for(var t=0;t<this.path.length;t++)this.validatePathSegment(this.path.get(t))},t.prototype.validatePathSegment=function(t){if(Dt(this.dataSource)&&lo.test(t))throw this.createError("Document fields cannot begin and end with __")},t}(),yo=function(){return function(t,e){this.databaseId=t,this.key=e}}(),go=function(){function t(t){this.preConverter=t}return t.prototype.parseSetData=function(t,e){var n=new mo(bi.Set,t,ue.EMPTY_PATH);At("Data must be an object, but it was:",n,e);var r=this.parseData(e,n);return new fo(r,null,n.fieldTransforms)},t.prototype.parseMergeData=function(t,e,n){var r=new mo(bi.MergeSet,t,ue.EMPTY_PATH);At("Data must be an object, but it was:",r,e);var i,o,s=this.parseData(e,r);if(n){for(var a=new tn(ue.comparator),c=0,h=n;c<h.length;c++){var l=h[c],f=void 0;if(l instanceof Zi)f=l._internalPath;else{if("string"!=typeof l)throw u("Expected stringOrFieldPath to be a string or a FieldPath");f=Rt(t,l)}if(!r.contains(f))throw new Yt(Xt.INVALID_ARGUMENT,"Field '"+f+"' is specified in your field mask but missing from your input data.");a=a.add(f)}i=nn.fromSet(a),o=r.fieldTransforms.filter(function(t){return i.covers(t.field)})}else i=nn.fromArray(r.fieldMask),o=r.fieldTransforms;return new fo(s,i,o)},t.prototype.parseUpdateData=function(t,e){var n=this,r=new mo(bi.Update,t,ue.EMPTY_PATH);At("Data must be an object, but it was:",r,e);var i=new tn(ue.comparator),o=Me.EMPTY;m(e,function(e,s){var a=Rt(t,e),u=r.childContextForFieldPath(a);if((s=n.runPreConverter(s,u))instanceof so)i=i.add(a);else{var c=n.parseData(s,u);null!=c&&(i=i.add(a),o=o.set(a,c))}});var s=nn.fromSet(i);return new po(o,s,r.fieldTransforms)},t.prototype.parseUpdateVarargs=function(t,e,n,r){var i=new mo(bi.Update,t,ue.EMPTY_PATH),o=[kt(t,e)],s=[n];if(r.length%2!=0)throw new Yt(Xt.INVALID_ARGUMENT,"Function "+t+"() needs to be called with an even number of arguments that alternate between field names and values.");for(var a=0;a<r.length;a+=2)o.push(kt(t,r[a])),s.push(r[a+1]);var u=new tn(ue.comparator),c=Me.EMPTY;for(a=0;a<o.length;++a){var h=o[a],l=i.childContextForFieldPath(h),f=this.runPreConverter(s[a],l);if(f instanceof so)u=u.add(h);else{var d=this.parseData(f,l);null!=d&&(u=u.add(h),c=c.set(h,d))}}var p=nn.fromSet(u);return new po(c,p,i.fieldTransforms)},t.prototype.parseQueryValue=function(t,e){var n=new mo(bi.Argument,t,ue.EMPTY_PATH),r=this.parseData(e,n);return c(null!=r,"Parsed data should not be null."),c(0===n.fieldTransforms.length,"Field transforms should have been disallowed."),r},t.prototype.runPreConverter=function(t,e){try{return this.preConverter(t)}catch(t){var n=Ot(t);throw e.createError(n)}},t.prototype.parseData=function(t,e){if(t=this.runPreConverter(t,e),Nt(t))return At("Unsupported field value:",e,t),this.parseObject(t,e);if(t instanceof oo)return this.parseSentinelFieldValue(t,e),null;if(e.path&&e.fieldMask.push(e.path),t instanceof Array){if(e.arrayElement)throw e.createError("Nested arrays are not supported");return this.parseArray(t,e)}return this.parseScalarValue(t,e)},t.prototype.parseObject=function(t,e){var n=this,r=new pe(M);return y(t)?e.path&&e.path.length>0&&e.fieldMask.push(e.path):m(t,function(t,i){var o=n.parseData(i,e.childContextForField(t));null!=o&&(r=r.insert(t,o))}),new Me(r)},t.prototype.parseArray=function(t,e){for(var n=[],r=0,i=0,o=t;i<o.length;i++){var s=this.parseData(o[i],e.childContextForArray(r));null==s&&(s=Te.INSTANCE),n.push(s),r++}return new Le(n)},t.prototype.parseSentinelFieldValue=function(t,e){if(!Dt(e.dataSource))throw e.createError(t._methodName+"() can only be used with update() and set()");if(null===e.path)throw e.createError(t._methodName+"() is not currently supported inside arrays");if(t instanceof so){if(e.dataSource!==bi.MergeSet)throw e.dataSource===bi.Update?(c(e.path.length>0,"FieldValue.delete() at the top level should have already been handled."),e.createError("FieldValue.delete() can only appear at the top level of your update data")):e.createError("FieldValue.delete() cannot be used with set() unless you pass {merge:true}");e.fieldMask.push(e.path)}else if(t instanceof ao)e.fieldTransforms.push(new rn(e.path,dn.instance));else if(t instanceof uo){var n=this.parseArrayTransformElements(t._methodName,t._elements),r=new pn(n);e.fieldTransforms.push(new rn(e.path,r))}else if(t instanceof co){n=this.parseArrayTransformElements(t._methodName,t._elements);var i=new mn(n);e.fieldTransforms.push(new rn(e.path,i))}else u("Unknown FieldValue type: "+t)},t.prototype.parseScalarValue=function(t,e){if(null===t)return Te.INSTANCE;if("number"==typeof t)return q(t)?new Ce(t):new De(t);if("boolean"==typeof t)return Se.of(t);if("string"==typeof t)return new Ne(t);if(t instanceof Date)return new Ae(ee.fromDate(t));if(t instanceof ee)return new Ae(new ee(t.seconds,1e3*Math.floor(t.nanoseconds/1e3)));if(t instanceof te)return new Pe(t);if(t instanceof Zt)return new Re(t);if(t instanceof yo)return new Oe(t.databaseId,t.key);throw e.createError("Unsupported field value: "+N(t))},t.prototype.parseArrayTransformElements=function(t,e){var n=this;return e.map(function(e,r){var i=new mo(bi.Argument,t,ue.EMPTY_PATH);return n.parseData(e,i.childContextForArray(r))})},t}(),vo="firestore.googleapis.com",bo=!0,_o=!1,wo=qr.COLLECTION_DISABLED,Eo=function(){function t(t){if(void 0===t.host){if(void 0!==t.ssl)throw new Yt(Xt.INVALID_ARGUMENT,"Can't provide ssl option if host option is not set");this.host=vo,this.ssl=bo}else E("settings","non-empty string","host",t.host),this.host=t.host,T("settings","boolean","ssl",t.ssl),this.ssl=d(t.ssl,bo);if(k("settings",t,["host","ssl","credentials","timestampsInSnapshots","cacheSizeBytes"]),T("settings","object","credentials",t.credentials),this.credentials=t.credentials,T("settings","boolean","timestampsInSnapshots",t.timestampsInSnapshots),this.timestampsInSnapshots=d(t.timestampsInSnapshots,_o),T("settings","number","cacheSizeBytes",t.cacheSizeBytes),void 0===t.cacheSizeBytes)this.cacheSizeBytes=qr.DEFAULT_CACHE_SIZE_BYTES;else{if(t.cacheSizeBytes!==wo&&t.cacheSizeBytes<qr.MINIMUM_CACHE_SIZE_BYTES)throw new Yt(Xt.INVALID_ARGUMENT,"cacheSizeBytes must be at least "+qr.MINIMUM_CACHE_SIZE_BYTES);this.cacheSizeBytes=t.cacheSizeBytes}}return t.prototype.isEqual=function(t){return this.host===t.host&&this.ssl===t.ssl&&this.timestampsInSnapshots===t.timestampsInSnapshots&&this.credentials===t.credentials&&this.cacheSizeBytes===t.cacheSizeBytes},t}(),To=function(){return function(){}}(),So=function(){function t(e){var n=this;this._queue=new Yn,this.INTERNAL={delete:function(t){return jt.__awaiter(n,void 0,void 0,function(){return jt.__generator(this,function(e){return this._firestoreClient?[2,this._firestoreClient.shutdown(t)]:[2]})})}};var r=new To;if("object"==typeof e.options){var i=e;r.firebaseApp=i,r.databaseId=t.databaseIdFromApp(i),r.persistenceKey=r.firebaseApp.name,r.credentials=new no(i)}else{var o=e;if(!o.projectId)throw new Yt(Xt.INVALID_ARGUMENT,"Must provide projectId");r.databaseId=new ie(o.projectId,o.database),r.persistenceKey="[DEFAULT]",r.credentials=new eo}r.settings=new Eo({}),this._config=r,this._databaseId=r.databaseId}return t.prototype.settings=function(t){if(g("Firestore.settings",arguments,1),_("Firestore.settings","object",1,t),f(t,"persistence"))throw new Yt(Xt.INVALID_ARGUMENT,'"persistence" is now specified with a separate call to firestore.enablePersistence().');var e=new Eo(t);if(this._firestoreClient&&!this._config.settings.isEqual(e))throw new Yt(Xt.FAILED_PRECONDITION,"Firestore has already been started and its settings can no longer be changed. You can only call settings() before calling any other methods on a Firestore object.");this._config.settings=e,void 0!==e.credentials&&(this._config.credentials=function(t){if(!t)return new eo;switch(t.type){case"gapi":return new io(t.client,t.sessionIndex||"0");case"provider":return t.client;default:throw new Yt(Xt.INVALID_ARGUMENT,"makeCredentialsProvider failed due to invalid credential type")}}(e.credentials))},t.prototype.enableNetwork=function(){return this.ensureClientConfigured(),this._firestoreClient.enableNetwork()},t.prototype.disableNetwork=function(){return this.ensureClientConfigured(),this._firestoreClient.disableNetwork()},t.prototype.enablePersistence=function(t){if(this._firestoreClient)throw new Yt(Xt.FAILED_PRECONDITION,"Firestore has already been started and persistence can no longer be enabled. You can only call enablePersistence() before calling any other methods on a Firestore object.");return this.configureClient(new Hi(this._config.settings.cacheSizeBytes,void 0!==t&&d(t.experimentalTabSynchronization,!1)))},t.prototype.ensureClientConfigured=function(){return this._firestoreClient||this.configureClient(new Xi),this._firestoreClient},t.prototype.configureClient=function(t){var e=this;c(!!this._config.settings.host,"FirestoreSettings.host cannot be falsey"),this._config.settings.timestampsInSnapshots||s("\nThe behavior for Date objects stored in Firestore is going to change\nAND YOUR APP MAY BREAK.\nTo hide this warning and ensure your app does not break, you need to add the\nfollowing code to your app before calling any other Cloud Firestore methods:\n\n  const firestore = firebase.firestore();\n  const settings = {/* your settings... */ timestampsInSnapshots: true};\n  firestore.settings(settings);\n\nWith this change, timestamps stored in Cloud Firestore will be read back as\nFirebase Timestamp objects instead of as system Date objects. So you will also\nneed to update code expecting a Date to instead expect a Timestamp. For example:\n\n  // Old:\n  const date = snapshot.get('created_at');\n  // New:\n  const timestamp = snapshot.get('created_at');\n  const date = timestamp.toDate();\n\nPlease audit all existing usages of Date when you enable the new behavior. In a\nfuture release, the behavior will change to the new behavior, so if you do not\nfollow these steps, YOUR APP MAY BREAK."),c(!this._firestoreClient,"configureClient() called multiple times");var n=new ne(this._config.databaseId,this._config.persistenceKey,this._config.settings.host,this._config.settings.ssl);return this._dataConverter=new go(function(t){if(t instanceof Do){var n=e._config.databaseId,r=t.firestore._config.databaseId;if(!r.isEqual(n))throw new Yt(Xt.INVALID_ARGUMENT,"Document reference is for database "+r.projectId+"/"+r.database+" but should be for database "+n.projectId+"/"+n.database);return new yo(e._config.databaseId,t._key)}return t}),this._firestoreClient=new Yi(Ht.getPlatform(),n,this._config.credentials,this._queue),this._firestoreClient.start(t)},t.databaseIdFromApp=function(t){var e=t.options;if(!f(e,"projectId"))throw new Yt(Xt.INVALID_ARGUMENT,'"projectId" not provided in firebase.initializeApp.');var n=e.projectId;if(!n||"string"!=typeof n)throw new Yt(Xt.INVALID_ARGUMENT,"projectId must be a string in FirebaseApp.options");return new ie(n)},Object.defineProperty(t.prototype,"app",{get:function(){if(!this._config.firebaseApp)throw new Yt(Xt.FAILED_PRECONDITION,"Firestore was not initialized using the Firebase SDK. 'app' is not available");return this._config.firebaseApp},enumerable:!0,configurable:!0}),t.prototype.collection=function(t){if(g("Firestore.collection",arguments,1),_("Firestore.collection","non-empty string",1,t),!t)throw new Yt(Xt.INVALID_ARGUMENT,"Must provide a non-empty collection path to collection()");return this.ensureClientConfigured(),new Po(se.fromString(t),this)},t.prototype.doc=function(t){if(g("Firestore.doc",arguments,1),_("Firestore.doc","non-empty string",1,t),!t)throw new Yt(Xt.INVALID_ARGUMENT,"Must provide a non-empty document path to doc()");return this.ensureClientConfigured(),Do.forPath(se.fromString(t),this)},t.prototype.runTransaction=function(t){var e=this;return g("Firestore.runTransaction",arguments,1),_("Firestore.runTransaction","function",1,t),this.ensureClientConfigured().transaction(function(n){return t(new Io(e,n))})},t.prototype.batch=function(){return this.ensureClientConfigured(),new Co(this)},Object.defineProperty(t,"logLevel",{get:function(){switch(r()){case qt.DEBUG:return"debug";case qt.ERROR:return"error";case qt.SILENT:return"silent";default:return u("Unknown log level: "+r())}},enumerable:!0,configurable:!0}),t.setLogLevel=function(t){switch(g("Firestore.setLogLevel",arguments,1),_("Firestore.setLogLevel","non-empty string",1,t),t){case"debug":i(qt.DEBUG);break;case"error":i(qt.ERROR);break;case"silent":i(qt.SILENT);break;default:throw new Yt(Xt.INVALID_ARGUMENT,"Invalid log level: "+t)}},t.prototype._areTimestampsInSnapshotsEnabled=function(){return this._config.settings.timestampsInSnapshots},t}(),Io=function(){function t(t,e){this._firestore=t,this._transaction=e}return t.prototype.get=function(t){var e=this;g("Transaction.get",arguments,1);var n=xt("Transaction.get",t,this._firestore);return this._transaction.lookup([n._key]).then(function(t){if(!t||1!==t.length)return u("Mismatch in docs returned from document lookup.");var r=t[0];if(r instanceof fe)return new Ao(e._firestore,n._key,null,!1,!1);if(r instanceof le)return new Ao(e._firestore,n._key,r,!1,!1);throw u("BatchGetDocumentsRequest returned unexpected document type: "+r.constructor.name)})},t.prototype.set=function(t,e,n){b("Transaction.set",arguments,2,3);var r=xt("Transaction.set",t,this._firestore),i=(n=Pt("Transaction.set",n)).merge||n.mergeFields?this._firestore._dataConverter.parseMergeData("Transaction.set",e,n.mergeFields):this._firestore._dataConverter.parseSetData("Transaction.set",e);return this._transaction.set(r._key,i),this},t.prototype.update=function(t,e,n){for(var r=[],i=3;i<arguments.length;i++)r[i-3]=arguments[i];var o,s;return"string"==typeof e||e instanceof Zi?(v("Transaction.update",arguments,3),o=xt("Transaction.update",t,this._firestore),s=this._firestore._dataConverter.parseUpdateVarargs("Transaction.update",e,n,r)):(g("Transaction.update",arguments,2),o=xt("Transaction.update",t,this._firestore),s=this._firestore._dataConverter.parseUpdateData("Transaction.update",e)),this._transaction.update(o._key,s),this},t.prototype.delete=function(t){g("Transaction.delete",arguments,1);var e=xt("Transaction.delete",t,this._firestore);return this._transaction.delete(e._key),this},t}(),Co=function(){function t(t){this._firestore=t,this._mutations=[],this._committed=!1}return t.prototype.set=function(t,e,n){b("WriteBatch.set",arguments,2,3),this.verifyNotCommitted();var r=xt("WriteBatch.set",t,this._firestore),i=(n=Pt("WriteBatch.set",n)).merge||n.mergeFields?this._firestore._dataConverter.parseMergeData("WriteBatch.set",e,n.mergeFields):this._firestore._dataConverter.parseSetData("WriteBatch.set",e);return this._mutations=this._mutations.concat(i.toMutations(r._key,an.NONE)),this},t.prototype.update=function(t,e,n){for(var r=[],i=3;i<arguments.length;i++)r[i-3]=arguments[i];this.verifyNotCommitted();var o,s;return"string"==typeof e||e instanceof Zi?(v("WriteBatch.update",arguments,3),o=xt("WriteBatch.update",t,this._firestore),s=this._firestore._dataConverter.parseUpdateVarargs("WriteBatch.update",e,n,r)):(g("WriteBatch.update",arguments,2),o=xt("WriteBatch.update",t,this._firestore),s=this._firestore._dataConverter.parseUpdateData("WriteBatch.update",e)),this._mutations=this._mutations.concat(s.toMutations(o._key,an.exists(!0))),this},t.prototype.delete=function(t){g("WriteBatch.delete",arguments,1),this.verifyNotCommitted();var e=xt("WriteBatch.delete",t,this._firestore);return this._mutations=this._mutations.concat(new fn(e._key,an.NONE)),this},t.prototype.commit=function(){return jt.__awaiter(this,void 0,void 0,function(){return jt.__generator(this,function(t){return this.verifyNotCommitted(),this._committed=!0,this._mutations.length>0?[2,this._firestore.ensureClientConfigured().write(this._mutations)]:[2]})})},t.prototype.verifyNotCommitted=function(){if(this._committed)throw new Yt(Xt.FAILED_PRECONDITION,"A write batch can no longer be used after commit() has been called.")},t}(),Do=function(){function t(t,e){this._key=t,this.firestore=e,this._firestoreClient=this.firestore.ensureClientConfigured()}return t.forPath=function(e,n){if(e.length%2!=0)throw new Yt(Xt.INVALID_ARGUMENT,"Invalid document reference. Document references must have an even number of segments, but "+e.canonicalString()+" has "+e.length);return new t(new ce(e),n)},Object.defineProperty(t.prototype,"id",{get:function(){return this._key.path.lastSegment()},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"parent",{get:function(){return new Po(this._key.path.popLast(),this.firestore)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"path",{get:function(){return this._key.path.canonicalString()},enumerable:!0,configurable:!0}),t.prototype.collection=function(t){if(g("DocumentReference.collection",arguments,1),_("DocumentReference.collection","non-empty string",1,t),!t)throw new Yt(Xt.INVALID_ARGUMENT,"Must provide a non-empty collection name to collection()");var e=se.fromString(t);return new Po(this._key.path.child(e),this.firestore)},t.prototype.isEqual=function(e){if(!(e instanceof t))throw R("isEqual","DocumentReference",1,e);return this.firestore===e.firestore&&this._key.isEqual(e._key)},t.prototype.set=function(t,e){b("DocumentReference.set",arguments,1,2);var n=(e=Pt("DocumentReference.set",e)).merge||e.mergeFields?this.firestore._dataConverter.parseMergeData("DocumentReference.set",t,e.mergeFields):this.firestore._dataConverter.parseSetData("DocumentReference.set",t);return this._firestoreClient.write(n.toMutations(this._key,an.NONE))},t.prototype.update=function(t,e){for(var n=[],r=2;r<arguments.length;r++)n[r-2]=arguments[r];var i;return"string"==typeof t||t instanceof Zi?(v("DocumentReference.update",arguments,2),i=this.firestore._dataConverter.parseUpdateVarargs("DocumentReference.update",t,e,n)):(g("DocumentReference.update",arguments,1),i=this.firestore._dataConverter.parseUpdateData("DocumentReference.update",t)),this._firestoreClient.write(i.toMutations(this._key,an.exists(!0)))},t.prototype.delete=function(){return g("DocumentReference.delete",arguments,0),this._firestoreClient.write([new fn(this._key,an.NONE)])},t.prototype.onSnapshot=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];b("DocumentReference.onSnapshot",arguments,1,4);var n,r={includeMetadataChanges:!1},i=0;"object"!=typeof t[i]||Ct(t[i])||(k("DocumentReference.onSnapshot",r=t[i],["includeMetadataChanges"]),T("DocumentReference.onSnapshot","boolean","includeMetadataChanges",r.includeMetadataChanges),i++);var o={includeMetadataChanges:r.includeMetadataChanges};return Ct(t[i])?n=t[i]:(_("DocumentReference.onSnapshot","function",i,t[i]),w("DocumentReference.onSnapshot","function",i+1,t[i+1]),w("DocumentReference.onSnapshot","function",i+2,t[i+2]),n={next:t[i],error:t[i+1],complete:t[i+2]}),this.onSnapshotInternal(o,n)},t.prototype.onSnapshotInternal=function(t,e){var n=this,r=function(t){console.error("Uncaught Error in onSnapshot:",t)};e.error&&(r=e.error.bind(e));var i=new Ji({next:function(t){if(e.next){c(t.docs.size<=1,"Too many documents returned on a document query");var r=t.docs.get(n._key);e.next(new Ao(n.firestore,n._key,r,t.fromCache,t.hasPendingWrites))}},error:r}),o=this._firestoreClient.listen(qe.atPath(this._key.path),i,t);return function(){i.mute(),n._firestoreClient.unlisten(o)}},t.prototype.get=function(t){var e=this;return b("DocumentReference.get",arguments,0,1),Lt("DocumentReference.get",t),new Promise(function(n,r){t&&"cache"===t.source?e.firestore.ensureClientConfigured().getDocumentFromLocalCache(e._key).then(function(t){n(new Ao(e.firestore,e._key,t,!0,t instanceof le&&t.hasLocalMutations))},r):e.getViaSnapshotListener(n,r,t)})},t.prototype.getViaSnapshotListener=function(t,e,n){var r=this.onSnapshotInternal({includeMetadataChanges:!0,waitForSyncWhenOnline:!0},{next:function(i){r(),!i.exists&&i.metadata.fromCache?e(new Yt(Xt.UNAVAILABLE,"Failed to get document because the client is offline.")):i.exists&&i.metadata.fromCache&&n&&"server"===n.source?e(new Yt(Xt.UNAVAILABLE,'Failed to get document from server. (However, this document does exist in the local cache. Run again without setting source to "server" to retrieve the cached document.)')):t(i)},error:e})},t}(),No=function(){function t(t,e){this.hasPendingWrites=t,this.fromCache=e}return t.prototype.isEqual=function(t){return this.hasPendingWrites===t.hasPendingWrites&&this.fromCache===t.fromCache},t}(),Ao=function(){function t(t,e,n,r,i){this._firestore=t,this._key=e,this._document=n,this._fromCache=r,this._hasPendingWrites=i}return t.prototype.data=function(t){return b("DocumentSnapshot.data",arguments,0,1),t=Mt("DocumentSnapshot.data",t),this._document?this.convertObject(this._document.data,we.fromSnapshotOptions(t,this._firestore._areTimestampsInSnapshotsEnabled())):void 0},t.prototype.get=function(t,e){if(b("DocumentSnapshot.get",arguments,1,2),e=Mt("DocumentSnapshot.get",e),this._document){var n=this._document.data.field(kt("DocumentSnapshot.get",t));if(void 0!==n)return this.convertValue(n,we.fromSnapshotOptions(e,this._firestore._areTimestampsInSnapshotsEnabled()))}},Object.defineProperty(t.prototype,"id",{get:function(){return this._key.path.lastSegment()},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"ref",{get:function(){return new Do(this._key,this._firestore)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"exists",{get:function(){return null!==this._document},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"metadata",{get:function(){return new No(this._hasPendingWrites,this._fromCache)},enumerable:!0,configurable:!0}),t.prototype.isEqual=function(e){if(!(e instanceof t))throw R("isEqual","DocumentSnapshot",1,e);return this._firestore===e._firestore&&this._fromCache===e._fromCache&&this._key.isEqual(e._key)&&(null===this._document?null===e._document:this._document.isEqual(e._document))},t.prototype.convertObject=function(t,e){var n=this,r={};return t.forEach(function(t,i){r[t]=n.convertValue(i,e)}),r},t.prototype.convertValue=function(t,e){if(t instanceof Me)return this.convertObject(t,e);if(t instanceof Le)return this.convertArray(t,e);if(t instanceof Oe){var n=t.value(e),r=this._firestore.ensureClientConfigured().databaseId();return t.databaseId.isEqual(r)||s("Document "+this._key.path+" contains a document reference within a different database ("+t.databaseId.projectId+"/"+t.databaseId.database+") which is not supported. It will be treated as a reference in the current database ("+r.projectId+"/"+r.database+") instead."),new Do(n,this._firestore)}return t.value(e)},t.prototype.convertArray=function(t,e){var n=this;return t.internalValue.map(function(t){return n.convertValue(t,e)})},t}(),ko=function(t){function e(e,n,r,i,o){return t.call(this,e,n,r,i,o)||this}return jt.__extends(e,t),e.prototype.data=function(e){var n=t.prototype.data.call(this,e);return c("object"==typeof n,"Document in a QueryDocumentSnapshot should exist"),n},e}(Ao),Ro=function(){function t(t,e){this._query=t,this.firestore=e}return t.prototype.where=function(e,n,r){g("Query.where",arguments,3),_("Query.where","non-empty string",2,n),A("Query.where",3,r);var i,o=kt("Query.where",e),s=Ke.fromString(n);if(o.isKeyField()){if(s===Ke.ARRAY_CONTAINS)throw new Yt(Xt.INVALID_ARGUMENT,"Invalid Query. You can't perform array-contains queries on FieldPath.documentId() since document IDs are not arrays.");if("string"==typeof r){if(-1!==r.indexOf("/"))throw new Yt(Xt.INVALID_ARGUMENT,"Function Query.where() requires its third parameter to be a valid document ID if the first parameter is FieldPath.documentId(), but it contains a slash.");if(""===r)throw new Yt(Xt.INVALID_ARGUMENT,"Function Query.where() requires its third parameter to be a valid document ID if the first parameter is FieldPath.documentId(), but it was an empty string.");var a=this._query.path.child(new se([r]));c(a.length%2==0,"Path should be a document key"),i=new Oe(this.firestore._databaseId,new ce(a))}else{if(!(r instanceof Do))throw new Yt(Xt.INVALID_ARGUMENT,"Function Query.where() requires its third parameter to be a string or a DocumentReference if the first parameter is FieldPath.documentId(), but it was: "+N(r)+".");i=new Oe(this.firestore._databaseId,r._key)}}else i=this.firestore._dataConverter.parseQueryValue("Query.where",r);var u=Ve.create(o,s,i);return this.validateNewFilter(u),new t(this._query.addFilter(u),this.firestore)},t.prototype.orderBy=function(e,n){b("Query.orderBy",arguments,1,2),w("Query.orderBy","non-empty string",2,n);var r;if(void 0===n||"asc"===n)r=Ge.ASCENDING;else{if("desc"!==n)throw new Yt(Xt.INVALID_ARGUMENT,"Function Query.orderBy() has unknown direction '"+n+"', expected 'asc' or 'desc'.");r=Ge.DESCENDING}if(null!==this._query.startAt)throw new Yt(Xt.INVALID_ARGUMENT,"Invalid query. You must not call Query.startAt() or Query.startAfter() before calling Query.orderBy().");if(null!==this._query.endAt)throw new Yt(Xt.INVALID_ARGUMENT,"Invalid query. You must not call Query.endAt() or Query.endBefore() before calling Query.orderBy().");var i=kt("Query.orderBy",e),o=new He(i,r);return this.validateNewOrderBy(o),new t(this._query.addOrderBy(o),this.firestore)},t.prototype.limit=function(e){if(g("Query.limit",arguments,1),_("Query.limit","number",1,e),e<=0)throw new Yt(Xt.INVALID_ARGUMENT,"Invalid Query. Query limit ("+e+") is invalid. Limit must be positive.");return new t(this._query.withLimit(e),this.firestore)},t.prototype.startAt=function(e){for(var n=[],r=1;r<arguments.length;r++)n[r-1]=arguments[r];v("Query.startAt",arguments,1);var i=this.boundFromDocOrFields("Query.startAt",e,n,!0);return new t(this._query.withStartAt(i),this.firestore)},t.prototype.startAfter=function(e){for(var n=[],r=1;r<arguments.length;r++)n[r-1]=arguments[r];v("Query.startAfter",arguments,1);var i=this.boundFromDocOrFields("Query.startAfter",e,n,!1);return new t(this._query.withStartAt(i),this.firestore)},t.prototype.endBefore=function(e){for(var n=[],r=1;r<arguments.length;r++)n[r-1]=arguments[r];v("Query.endBefore",arguments,1);var i=this.boundFromDocOrFields("Query.endBefore",e,n,!0);return new t(this._query.withEndAt(i),this.firestore)},t.prototype.endAt=function(e){for(var n=[],r=1;r<arguments.length;r++)n[r-1]=arguments[r];v("Query.endAt",arguments,1);var i=this.boundFromDocOrFields("Query.endAt",e,n,!1);return new t(this._query.withEndAt(i),this.firestore)},t.prototype.isEqual=function(e){if(!(e instanceof t))throw R("isEqual","Query",1,e);return this.firestore===e.firestore&&this._query.isEqual(e._query)},t.prototype.boundFromDocOrFields=function(t,e,n,r){if(A(t,1,e),e instanceof Ao){if(n.length>0)throw new Yt(Xt.INVALID_ARGUMENT,"Too many arguments provided to "+t+"().");var i=e;if(!i.exists)throw new Yt(Xt.NOT_FOUND,"Can't use a DocumentSnapshot that doesn't exist for "+t+"().");return this.boundFromDocument(t,i._document,r)}var o=[e].concat(n);return this.boundFromFields(t,o,r)},t.prototype.boundFromDocument=function(t,e,n){for(var r=[],i=0,o=this._query.orderBy;i<o.length;i++){var s=o[i];if(s.field.isKeyField())r.push(new Oe(this.firestore._databaseId,e.key));else{var a=e.field(s.field);if(void 0===a){var u=s.field.canonicalString();throw new Yt(Xt.INVALID_ARGUMENT,"Invalid query. You are trying to start or end a query using a document for which the field '"+u+"' (used as the orderBy) does not exist.")}r.push(a)}}return new ze(r,n)},t.prototype.boundFromFields=function(t,e,n){var r=this._query.explicitOrderBy;if(e.length>r.length)throw new Yt(Xt.INVALID_ARGUMENT,"Too many arguments provided to "+t+"(). The number of arguments must be less than or equal to the number of Query.orderBy() clauses");for(var i=[],o=0;o<e.length;o++){var s=e[o];if(r[o].field.isKeyField()){if("string"!=typeof s)throw new Yt(Xt.INVALID_ARGUMENT,"Invalid query. Expected a string for document ID in "+t+"(), but got a "+typeof s);if(-1!==s.indexOf("/"))throw new Yt(Xt.INVALID_ARGUMENT,"Invalid query. Document ID '"+s+"' contains a slash in "+t+"()");var a=new ce(this._query.path.child(s));i.push(new Oe(this.firestore._databaseId,a))}else{var u=this.firestore._dataConverter.parseQueryValue(t,s);i.push(u)}}return new ze(i,n)},t.prototype.onSnapshot=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];b("Query.onSnapshot",arguments,1,4);var n,r={},i=0;return"object"!=typeof t[i]||Ct(t[i])||(k("Query.onSnapshot",r=t[i],["includeMetadataChanges"]),T("Query.onSnapshot","boolean","includeMetadataChanges",r.includeMetadataChanges),i++),Ct(t[i])?n=t[i]:(_("Query.onSnapshot","function",i,t[i]),w("Query.onSnapshot","function",i+1,t[i+1]),w("Query.onSnapshot","function",i+2,t[i+2]),n={next:t[i],error:t[i+1],complete:t[i+2]}),this.onSnapshotInternal(r,n)},t.prototype.onSnapshotInternal=function(t,e){var n=this,r=function(t){console.error("Uncaught Error in onSnapshot:",t)};e.error&&(r=e.error.bind(e));var i=new Ji({next:function(t){e.next&&e.next(new Oo(n.firestore,n._query,t))},error:r}),o=this.firestore.ensureClientConfigured(),s=o.listen(this._query,i,t);return function(){i.mute(),o.unlisten(s)}},t.prototype.get=function(t){var e=this;return b("Query.get",arguments,0,1),Lt("Query.get",t),new Promise(function(n,r){t&&"cache"===t.source?e.firestore.ensureClientConfigured().getDocumentsFromLocalCache(e._query).then(function(t){n(new Oo(e.firestore,e._query,t))},r):e.getViaSnapshotListener(n,r,t)})},t.prototype.getViaSnapshotListener=function(t,e,n){var r=this.onSnapshotInternal({includeMetadataChanges:!0,waitForSyncWhenOnline:!0},{next:function(i){r(),i.metadata.fromCache&&n&&"server"===n.source?e(new Yt(Xt.UNAVAILABLE,'Failed to get documents from server. (However, these documents may exist in the local cache. Run again without setting source to "server" to retrieve the cached documents.)')):t(i)},error:e})},t.prototype.validateNewFilter=function(t){if(t instanceof je)if(t.isInequality()){var e=this._query.getInequalityFilterField();if(null!==e&&!e.isEqual(t.field))throw new Yt(Xt.INVALID_ARGUMENT,"Invalid query. All where filters with an inequality (<, <=, >, or >=) must be on the same field. But you have inequality filters on '"+e.toString()+"' and '"+t.field.toString()+"'");var n=this._query.getFirstOrderByField();null!==n&&this.validateOrderByAndInequalityMatch(t.field,n)}else if(t.op===Ke.ARRAY_CONTAINS&&this._query.hasArrayContainsFilter())throw new Yt(Xt.INVALID_ARGUMENT,"Invalid query. Queries only support a single array-contains filter.")},t.prototype.validateNewOrderBy=function(t){if(null===this._query.getFirstOrderByField()){var e=this._query.getInequalityFilterField();null!==e&&this.validateOrderByAndInequalityMatch(e,t.field)}},t.prototype.validateOrderByAndInequalityMatch=function(t,e){if(!e.isEqual(t))throw new Yt(Xt.INVALID_ARGUMENT,"Invalid query. You have a where filter with an inequality (<, <=, >, or >=) on field '"+t.toString()+"' and so you must also use '"+t.toString()+"' as your first Query.orderBy(), but your first Query.orderBy() is on field '"+e.toString()+"' instead.")},t}(),Oo=function(){function t(t,e,n){this._firestore=t,this._originalQuery=e,this._snapshot=n,this._cachedChanges=null,this._cachedChangesIncludeMetadataChanges=null,this.metadata=new No(n.hasPendingWrites,n.fromCache)}return Object.defineProperty(t.prototype,"docs",{get:function(){var t=[];return this.forEach(function(e){return t.push(e)}),t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"empty",{get:function(){return this._snapshot.docs.isEmpty()},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"size",{get:function(){return this._snapshot.docs.size},enumerable:!0,configurable:!0}),t.prototype.forEach=function(t,e){var n=this;b("QuerySnapshot.forEach",arguments,1,2),_("QuerySnapshot.forEach","function",1,t),this._snapshot.docs.forEach(function(r){t.call(e,n.convertToDocumentImpl(r))})},Object.defineProperty(t.prototype,"query",{get:function(){return new Ro(this._originalQuery,this._firestore)},enumerable:!0,configurable:!0}),t.prototype.docChanges=function(t){t&&(k("QuerySnapshot.docChanges",t,["includeMetadataChanges"]),T("QuerySnapshot.docChanges","boolean","includeMetadataChanges",t.includeMetadataChanges));var e=!(!t||!t.includeMetadataChanges);if(e&&this._snapshot.excludesMetadataChanges)throw new Yt(Xt.INVALID_ARGUMENT,"To include metadata changes with your document changes, you must also pass { includeMetadataChanges:true } to onSnapshot().");return this._cachedChanges&&this._cachedChangesIncludeMetadataChanges===e||(this._cachedChanges=Ut(this._firestore,e,this._snapshot),this._cachedChangesIncludeMetadataChanges=e),this._cachedChanges},t.prototype.isEqual=function(e){if(!(e instanceof t))throw R("isEqual","QuerySnapshot",1,e);return this._firestore===e._firestore&&this._originalQuery.isEqual(e._originalQuery)&&this._snapshot.isEqual(e._snapshot)},t.prototype.convertToDocumentImpl=function(t){return new ko(this._firestore,t.key,t,this.metadata.fromCache,this._snapshot.mutatedKeys.has(t.key))},t}();["length","forEach","map"].concat("undefined"!=typeof Symbol?[Symbol.iterator]:[]).forEach(function(t){try{Object.defineProperty(Oo.prototype.docChanges,t,{get:function(){return function(){throw new Yt(Xt.INVALID_ARGUMENT,'QuerySnapshot.docChanges has been changed from a property into a method, so usages like "querySnapshot.docChanges" should become "querySnapshot.docChanges()"')}()}})}catch(t){}});var Po=function(t){function e(e,n){var r=t.call(this,qe.atPath(e),n)||this;if(e.length%2!=1)throw new Yt(Xt.INVALID_ARGUMENT,"Invalid collection reference. Collection references must have an odd number of segments, but "+e.canonicalString()+" has "+e.length);return r}return jt.__extends(e,t),Object.defineProperty(e.prototype,"id",{get:function(){return this._query.path.lastSegment()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"parent",{get:function(){var t=this._query.path.popLast();return t.isEmpty()?null:new Do(new ce(t),this.firestore)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"path",{get:function(){return this._query.path.canonicalString()},enumerable:!0,configurable:!0}),e.prototype.doc=function(t){if(b("CollectionReference.doc",arguments,0,1),0===arguments.length&&(t=Jt.newId()),_("CollectionReference.doc","non-empty string",1,t),""===t)throw new Yt(Xt.INVALID_ARGUMENT,"Document path must be a non-empty string");var e=se.fromString(t);return Do.forPath(this._query.path.child(e),this.firestore)},e.prototype.add=function(t){g("CollectionReference.add",arguments,1),_("CollectionReference.add","object",1,t);var e=this.doc();return e.set(t).then(function(){return e})},e}(Ro),Mo=l(So,"Use firebase.firestore() instead."),Lo=l(Io,"Use firebase.firestore().runTransaction() instead."),xo=l(Co,"Use firebase.firestore().batch() instead."),Uo=l(Do,"Use firebase.firestore().doc() instead."),Bo=l(Ao),Fo=l(ko),qo=l(Ro),Vo=l(Oo),Ko=l(Po,"Use firebase.firestore().collection() instead."),jo={Firestore:Mo,GeoPoint:te,Timestamp:ee,Blob:$t,Transaction:Lo,WriteBatch:xo,DocumentReference:Uo,DocumentSnapshot:Bo,Query:qo,QueryDocumentSnapshot:Fo,QuerySnapshot:Vo,CollectionReference:Ko,FieldPath:Zi,FieldValue:ho,setLogLevel:So.setLogLevel,CACHE_SIZE_UNLIMITED:wo};Ft(Vt),e.registerFirestore=Ft}).call(e,n(209))},418:function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),function(t){function r(t){return"string"==typeof t}function i(t,e){t=t.split("."),e=e||he;for(var n=0;n<t.length;n++)if(null==(e=e[t[n]]))return null;return e}function o(){}function s(t){var e=typeof t;if("object"==e){if(!t)return"null";if(t instanceof Array)return"array";if(t instanceof Object)return e;var n=Object.prototype.toString.call(t);if("[object Window]"==n)return"object";if("[object Array]"==n||"number"==typeof t.length&&void 0!==t.splice&&void 0!==t.propertyIsEnumerable&&!t.propertyIsEnumerable("splice"))return"array";if("[object Function]"==n||void 0!==t.call&&void 0!==t.propertyIsEnumerable&&!t.propertyIsEnumerable("call"))return"function"}else if("function"==e&&void 0===t.call)return"object";return e}function a(t){return"array"==s(t)}function u(t){var e=s(t);return"array"==e||"object"==e&&"number"==typeof t.length}function c(t){return"function"==s(t)}function h(t){var e=typeof t;return"object"==e&&null!=t||"function"==e}function l(t,e,n){return t.call.apply(t.bind,arguments)}function f(t,e,n){if(!t)throw Error();if(2<arguments.length){var r=Array.prototype.slice.call(arguments,2);return function(){var n=Array.prototype.slice.call(arguments);return Array.prototype.unshift.apply(n,r),t.apply(e,n)}}return function(){return t.apply(e,arguments)}}function d(t,e,n){return(d=Function.prototype.bind&&-1!=Function.prototype.bind.toString().indexOf("native code")?l:f).apply(null,arguments)}function p(t,e){var n=Array.prototype.slice.call(arguments,1);return function(){var e=n.slice();return e.push.apply(e,arguments),t.apply(this,e)}}function m(t,e){function n(){}n.prototype=e.prototype,t.L=e.prototype,t.prototype=new n,t.prototype.constructor=t,t.mh=function(t,n,r){for(var i=Array(arguments.length-2),o=2;o<arguments.length;o++)i[o-2]=arguments[o];return e.prototype[n].apply(t,i)}}function y(t){if(Error.captureStackTrace)Error.captureStackTrace(this,y);else{var e=Error().stack;e&&(this.stack=e)}t&&(this.message=String(t))}function g(t,e){for(var n="",r=(t=t.split("%s")).length-1,i=0;i<r;i++)n+=t[i]+(i<e.length?e[i]:"%s");y.call(this,n+t[r])}function v(){0!=pe&&(me[this[le]||(this[le]=++fe)]=this),this.Ka=this.Ka,this.Qa=this.Qa}function b(t){if(!a(t))for(var e=t.length-1;0<=e;e--)delete t[e];t.length=0}function _(t,e){var n;return(n=0<=(e=ge(t,e)))&&Array.prototype.splice.call(t,e,1),n}function w(t){return Array.prototype.concat.apply([],arguments)}function E(t){var e=t.length;if(0<e){for(var n=Array(e),r=0;r<e;r++)n[r]=t[r];return n}return[]}function T(t){return/^[\s\xa0]*$/.test(t)}function S(t,e){return t<e?-1:t>e?1:0}function I(t){return-1!=ye.indexOf(t)}function C(t,e,n){for(var r in t)e.call(n,t[r],r,t)}function D(t){var e,n=[],r=0;for(e in t)n[r++]=t[e];return n}function N(t){var e,n=[],r=0;for(e in t)n[r++]=e;return n}function A(t){var e,n={};for(e in t)n[e]=t[e];return n}function k(t,e){for(var n,r,i=1;i<arguments.length;i++){r=arguments[i];for(n in r)t[n]=r[n];for(var o=0;o<Se.length;o++)n=Se[o],Object.prototype.hasOwnProperty.call(r,n)&&(t[n]=r[n])}}function R(t){return R[" "](t),t}function O(){var t=he.document;return t?t.documentMode:void 0}function P(t){return function(t,e){var n=xe;return Object.prototype.hasOwnProperty.call(n,t)?n[t]:n[t]=e(t)}(t,function(){for(var e=0,n=we(String(Ie)).split("."),r=we(String(t)).split("."),i=Math.max(n.length,r.length),o=0;0==e&&o<i;o++){var s=n[o]||"",a=r[o]||"";do{if(s=/(\d*)(\D*)(.*)/.exec(s)||["","","",""],a=/(\d*)(\D*)(.*)/.exec(a)||["","","",""],0==s[0].length&&0==a[0].length)break;e=S(0==s[1].length?0:parseInt(s[1],10),0==a[1].length?0:parseInt(a[1],10))||S(0==s[2].length,0==a[2].length)||S(s[2],a[2]),s=s[3],a=a[3]}while(0==e)}return 0<=e})}function M(t,e){this.type=t,this.currentTarget=this.target=e,this.defaultPrevented=this.Ea=!1,this.Be=!0}function L(t,e){M.call(this,t?t.type:""),this.relatedTarget=this.currentTarget=this.target=null,this.button=this.screenY=this.screenX=this.clientY=this.clientX=this.offsetY=this.offsetX=0,this.key="",this.charCode=this.keyCode=0,this.metaKey=this.shiftKey=this.altKey=this.ctrlKey=!1,this.state=null,this.pointerId=0,this.pointerType="",this.fb=null,t&&this.Kf(t,e)}function x(t){return!(!t||!t[je])}function U(t,e,n,r,i){this.listener=t,this.proxy=null,this.src=e,this.type=n,this.capture=!!r,this.Ob=i,this.key=++We,this.Sa=this.Eb=!1}function B(t){this.src=t,this.J={},this.xb=0}function F(t,e,n,r){for(var i=0;i<t.length;++i){var o=t[i];if(!o.Sa&&o.listener==e&&o.capture==!!n&&o.Ob==r)return i}return-1}function q(t,e,n,r,i){if(r&&r.once)return K(t,e,n,r,i);if(a(e)){for(var o=0;o<e.length;o++)q(t,e[o],n,r,i);return null}return n=Y(n),x(t)?t.nb(e,n,h(r)?!!r.capture:!!r,i):V(t,e,n,!1,r,i)}function V(t,e,n,r,i,o){if(!e)throw Error("Invalid event type");var s=h(i)?!!i.capture:!!i,a=X(t);if(a||(t[Qe]=a=new B(t)),(n=a.add(e,n,r,s,o)).proxy)return n;if(r=function(){var t=H,e=Fe?function(n){return t.call(e.src,e.listener,n)}:function(n){if(!(n=t.call(e.src,e.listener,n)))return n};return e}(),n.proxy=r,r.src=t,r.listener=n,t.addEventListener)Ve||(i=s),void 0===i&&(i=!1),t.addEventListener(e.toString(),r,i);else if(t.attachEvent)t.attachEvent(Q(e.toString()),r);else{if(!t.addListener||!t.removeListener)throw Error("addEventListener and attachEvent are unavailable.");t.addListener(r)}return n}function K(t,e,n,r,i){if(a(e)){for(var o=0;o<e.length;o++)K(t,e[o],n,r,i);return null}return n=Y(n),x(t)?t.Oc(e,n,h(r)?!!r.capture:!!r,i):V(t,e,n,!0,r,i)}function j(t,e,n,r,i){if(a(e))for(var o=0;o<e.length;o++)j(t,e[o],n,r,i);else r=h(r)?!!r.capture:!!r,n=Y(n),x(t)?t.ed(e,n,r,i):t&&(t=X(t))&&(e=t.jb(e,n,r,i))&&W(e)}function W(t){if("number"!=typeof t&&t&&!t.Sa){var e=t.src;if(x(e))e.Le(t);else{var n=t.type,r=t.proxy;e.removeEventListener?e.removeEventListener(n,r,t.capture):e.detachEvent?e.detachEvent(Q(n),r):e.addListener&&e.removeListener&&e.removeListener(r),(n=X(e))?(n.ye(t),0==n.xb&&(n.src=null,e[Qe]=null)):t.Vb()}}}function Q(t){return t in Ge?Ge[t]:Ge[t]="on"+t}function G(t,e,n,r){var i=!0;if((t=X(t))&&(e=t.J[e.toString()]))for(e=e.concat(),t=0;t<e.length;t++){var o=e[t];o&&o.capture==n&&!o.Sa&&(o=z(o,r),i=i&&!1!==o)}return i}function z(t,e){var n=t.listener,r=t.Ob||t.src;return t.Eb&&W(t),n.call(r,e)}function H(t,e){if(t.Sa)return!0;if(!Fe){var n=e||i("window.event");e=new L(n,this);var r=!0;if(!(0>n.keyCode||void 0!=n.returnValue)){t:{var o=!1;if(0==n.keyCode)try{n.keyCode=-1;break t}catch(t){o=!0}(o||void 0==n.returnValue)&&(n.returnValue=!0)}for(n=[],o=e.currentTarget;o;o=o.parentNode)n.push(o);for(t=t.type,o=n.length-1;!e.Ea&&0<=o;o--){e.currentTarget=n[o];var s=G(n[o],t,!0,e);r=r&&s}for(o=0;!e.Ea&&o<n.length;o++)e.currentTarget=n[o],s=G(n[o],t,!1,e),r=r&&s}return r}return z(t,new L(e,this))}function X(t){return(t=t[Qe])instanceof B?t:null}function Y(t){return c(t)?t:(t[ze]||(t[ze]=function(e){return t.handleEvent(e)}),t[ze])}function J(){v.call(this),this.ka=new B(this),this.Pe=this,this.Uc=null}function Z(t,e){this.Sf=100,this.ef=t,this.ug=e,this.Zb=0,this.Pb=null}function $(){this.lc=this.Va=null}function tt(){this.next=this.scope=this.Gc=null}function et(t){he.setTimeout(function(){throw t},0)}function nt(){if(he.Promise&&he.Promise.resolve){var t=he.Promise.resolve(void 0);Je=function(){t.then(rt)}}else Je=function(){var t=rt;!c(he.setImmediate)||he.Window&&he.Window.prototype&&!I("Edge")&&he.Window.prototype.setImmediate==he.setImmediate?(Ye||(Ye=function(){var t=he.MessageChannel;if(void 0===t&&"undefined"!=typeof window&&window.postMessage&&window.addEventListener&&!I("Presto")&&(t=function(){var t=document.createElement("IFRAME");t.style.display="none",t.src="",document.documentElement.appendChild(t);var e=t.contentWindow;(t=e.document).open(),t.write(""),t.close();var n="callImmediate"+Math.random(),r="file:"==e.location.protocol?"*":e.location.protocol+"//"+e.location.host;t=d(function(t){"*"!=r&&t.origin!=r||t.data!=n||this.port1.onmessage()},this),e.addEventListener("message",t,!1),this.port1={},this.port2={postMessage:function(){e.postMessage(n,r)}}}),void 0!==t&&!I("Trident")&&!I("MSIE")){var e=new t,n={},r=n;return e.port1.onmessage=function(){if(void 0!==n.next){var t=(n=n.next).rd;n.rd=null,t()}},function(t){r.next={rd:t},r=r.next,e.port2.postMessage(0)}}return"undefined"!=typeof document&&"onreadystatechange"in document.createElement("SCRIPT")?function(t){var e=document.createElement("SCRIPT");e.onreadystatechange=function(){e.onreadystatechange=null,e.parentNode.removeChild(e),e=null,t(),t=null},document.documentElement.appendChild(e)}:function(t){he.setTimeout(t,0)}}()),Ye(t)):he.setImmediate(t)}}function rt(){for(var t;t=$e.remove();){try{t.Gc.call(t.scope)}catch(t){et(t)}$e.wg(t)}Ze=!1}function it(t,e){J.call(this),this.Na=t||1,this.wb=e||he,this.nd=d(this.Rg,this),this.ie=de()}function ot(t,e,n){if(c(t))n&&(t=d(t,n));else{if(!t||"function"!=typeof t.handleEvent)throw Error("Invalid listener argument");t=d(t.handleEvent,t)}return 2147483647<Number(e)?-1:he.setTimeout(t,e||0)}function st(t,e,n){v.call(this),this.Uf=null!=n?d(t,n):t,this.Na=e,this.Xe=d(this.fg,this),this.qc=[]}function at(t){v.call(this),this.i=t,this.o={}}function ut(t,e,n){this.reset(t,e,n,void 0,void 0)}function ct(t){this.pe=t,this.Zd=this.uc=this.mb=this.$b=null}function ht(t,e){this.name=t,this.value=e}function lt(t){un||(un=new ct(""),an[""]=un,un.Ge(on));var e;if(!(e=an[t])){e=new ct(t);var n=t.lastIndexOf("."),r=t.substr(n+1);(n=lt(t.substr(0,n))).Qe(r,e),e.Fg(n),an[t]=e}return e}function ft(t,e){t&&t.info(e,void 0)}function dt(t,e){t&&t.lf(e)}function pt(){this.s=lt("goog.labs.net.webChannel.WebChannelDebug"),this.Wc=!0}function mt(t){M.call(this,"serverreachability",t)}function yt(t){cn.dispatchEvent(new mt(cn,t))}function gt(t,e){M.call(this,"statevent",t),this.stat=e}function vt(t){cn.dispatchEvent(new gt(cn,t))}function bt(t,e,n){M.call(this,"timingevent",t),this.size=e,this.rtt=n}function _t(t,e){if(!c(t))throw Error("Fn must not be null and must be a function");return he.setTimeout(function(){t()},e)}function wt(){}function Et(){}function Tt(){M.call(this,"d")}function St(){M.call(this,"c")}function It(){}function Ct(t,e,n,r,i){this.b=t,this.a=e,this.ra=n,this.R=r,this.Xc=i||1,this.Fc=new at(this),this.Ua=pn,this.Vc=new it(t=Ae?125:void 0),this.A=null,this.S=!1,this.Da=this.pa=this.ua=this.ic=this.qb=this.hd=this.Ga=null,this.ba=[],this.h=null,this.Bb=0,this.I=this.Fa=null,this.w=-1,this.Za=!1,this.Ra=0,this.ac=null,this.lb=this.Ed=this.yc=!1}function Dt(t){if(t.H&&"function"==typeof t.H)return t.H();if(r(t))return t.split("");if(u(t)){for(var e=[],n=t.length,i=0;i<n;i++)e.push(t[i]);return e}return D(t)}function Nt(t,e,n){if(t.forEach&&"function"==typeof t.forEach)t.forEach(e,n);else if(u(t)||r(t))be(t,e,n);else{if(t.W&&"function"==typeof t.W)var i=t.W();else if(t.H&&"function"==typeof t.H)i=void 0;else if(u(t)||r(t)){i=[];for(var o=t.length,s=0;s<o;s++)i.push(s)}else i=N(t);s=(o=Dt(t)).length;for(var a=0;a<s;a++)e.call(n,o[a],i&&i[a],t)}}function At(t,e){this.D={},this.o=[],this.j=0;var n=arguments.length;if(1<n){if(n%2)throw Error("Uneven number of arguments");for(var r=0;r<n;r+=2)this.set(arguments[r],arguments[r+1])}else t&&this.addAll(t)}function kt(t,e){return Object.prototype.hasOwnProperty.call(t,e)}function Rt(t,e){this.xa=this.zb=this.qa="",this.Ca=null,this.ib=this.K="",this.O=this.Qf=!1;var n;t instanceof Rt?(this.O=void 0!==e?e:t.O,this.tb(t.qa),this.cd(t.zb),this.rb(t.xa),this.sb(t.Ca),this.ec(t.K),this.bd(t.P.clone()),this.$c(t.ib)):t&&(n=String(t).match(gn))?(this.O=!!e,this.tb(n[1]||"",!0),this.cd(n[2]||"",!0),this.rb(n[3]||"",!0),this.sb(n[4]),this.ec(n[5]||"",!0),this.bd(n[6]||"",!0),this.$c(n[7]||"",!0)):(this.O=!!e,this.P=new Lt(null,this.O))}function Ot(t,e){return t?e?decodeURI(t.replace(/%25/g,"%2525")):decodeURIComponent(t):""}function Pt(t,e,n){return r(t)?(t=encodeURI(t).replace(e,Mt),n&&(t=t.replace(/%25([0-9a-fA-F]{2})/g,"%$1")),t):null}function Mt(t){return"%"+((t=t.charCodeAt(0))>>4&15).toString(16)+(15&t).toString(16)}function Lt(t,e){this.j=this.m=null,this.ja=t||null,this.O=!!e}function xt(t,e){this.b=t,this.a=e,this.f=this.A=null,this.bc=!1,this.K=null,this.w=-1,this.Ad=this.na=null}function Ut(t){this.D=new At,t&&this.addAll(t)}function Bt(t){var e=typeof t;return"object"==e&&t||"function"==e?"o"+(t[le]||(t[le]=++fe)):e.substr(0,1)+t}function Ft(t){this.me=t||Tn,he.PerformanceNavigationTiming?(t=he.performance.getEntriesByType("navigation"),t=0<t.length&&("hq"==t[0].nextHopProtocol||"h2"==t[0].nextHopProtocol)):t=!!(he.vc&&he.vc.ke&&he.vc.ke()&&he.vc.ke().nh),this.Xb=t?this.me:1,this.v=null,1<this.Xb&&(this.v=new Ut),this.f=null,this.ba=[]}function qt(){this.xg=this.rg=void 0}function Vt(){this.jg=new qt}function Kt(t,e,n,r,i){try{t.debug(n),e.onload=null,e.onerror=null,e.onabort=null,e.ontimeout=null,i(r)}catch(e){t.cb(e)}}function jt(t){J.call(this),this.headers=new At,this.Xa=t||null,this.ha=!1,this.mc=this.c=null,this.ge=this.Tb="",this.Pa=0,this.I="",this.Aa=this.Lc=this.Qb=this.Ec=!1,this.vb=0,this.hc=null,this.Ae=In,this.jc=this.lg=this.Ab=!1}function Wt(t){return"content-type"==t.toLowerCase()}function Qt(t,e){return{type:e,lengthComputable:t.lengthComputable,loaded:t.loaded,total:t.total}}function Gt(t,e,n){t:{for(i in n){var i=!1;break t}i=!0}if(i)return t;if(n=function(t){var e="";return C(t,function(t,n){e+=n,e+=":",e+=t,e+="\r\n"}),e}(n),r(t)){if(e=encodeURIComponent(String(e)),n=null!=n?"="+encodeURIComponent(String(n)):"",e+=n){if(0>(n=t.indexOf("#"))&&(n=t.length),0>(i=t.indexOf("?"))||i>n){i=n;var o=""}else o=t.substring(i+1,n);n=(t=[t.substr(0,i),o,t.substr(n)])[1],t[1]=e?n?n+"&"+e:e:n,t=t[0]+(t[1]?"?"+t[1]:"")+t[2]}return t}return t.l(e,n),t}function zt(t){this.Bd=22,this.De=0,this.M=[],this.a=new pt,this.Ib=new function(){this.od=this.$d=null},this.na=this.md=this.hb=this.K=this.u=this.Kc=this.aa=this.gb=this.N=this.Rb=this.A=null,this.Te=!0,this.ag=this.Yb=0,this.kf=!!i("internalChannelParams.failFast",t),this.fd=this.Ja=this.wa=this.ia=this.ea=this.i=null,this.Se=!0,this.w=this.he=this.Sb=-1,this.rc=this.Ha=this.La=0,this.Ve=i("internalChannelParams.baseRetryDelayMs",t)||5e3,this.vg=i("internalChannelParams.retryDelaySeedMs",t)||1e4,this.nf=i("internalChannelParams.forwardChannelMaxRetries",t)||2,this.Od=i("internalChannelParams.forwardChannelRequestTimeoutMs",t)||2e4,this.Xa=t&&t.oh||void 0,this.Db=void 0,this.Ra=0,this.gc=t&&t.supportsCrossDomainXhr||!1,this.ra="",this.G=new Ft(t&&t.concurrentRequestLimit),this.kc=new Vt,this.ta=!t||void 0===t.backgroundChannelTest||t.backgroundChannelTest,(this.Nd=t&&t.fastHandshake||!1)&&!this.ta&&(this.a.T("Force backgroundChannelTest when fastHandshake is enabled."),this.ta=!0),t&&t.Id&&this.a.Id()}function Ht(){}function Xt(){if(De&&!(10<=Number(Le)))throw Error("Environmental error: no available transport.")}function Yt(t,e){J.call(this),this.b=new zt(e),this.yb=t,this.Qg=e&&e.testUrl?e.testUrl:function(t){for(var e=arguments[0],n=1;n<arguments.length;n++){var r=arguments[n];if(0==r.lastIndexOf("/",0))e=r;else{var i;(i=""==e)||(i=e.length-1,i=0<=i&&e.indexOf("/",i)==i),e=i?e+r:e+"/"+r}}return e}(this.yb,"test"),this.s=lt("goog.labs.net.webChannel.WebChannelBaseTransport"),this.Rc=e&&e.messageUrlParams||null,t=e&&e.messageHeaders||null,e&&e.clientProtocolHeaderRequired&&(t?t["X-Client-Protocol"]="webchannel":t={"X-Client-Protocol":"webchannel"}),this.b.ga(t),t=e&&e.initMessageHeaders||null,e&&e.messageContentType&&(t?t["X-WebChannel-Content-Type"]=e.messageContentType:t={"X-WebChannel-Content-Type":e.messageContentType}),e&&e.zd&&(t?t["X-WebChannel-Client-Profile"]=e.zd:t={"X-WebChannel-Client-Profile":e.zd}),this.b.Eg(t),(t=e&&e.httpHeadersOverwriteParam)&&!T(t)&&this.b.Cg(t),this.Og=e&&e.supportsCrossDomainXhr||!1,this.zg=e&&e.sendRawJson||!1,(e=e&&e.httpSessionIdParam)&&!T(e)&&(this.b.Dg(e),null!==(t=this.Rc)&&e in t&&(t=this.Rc,e in t&&delete t[e],(t=this.s)&&t.T("Ignore httpSessionIdParam also specified with messageUrlParams: "+e,void 0))),this.vd=new $t(this)}function Jt(t){Tt.call(this);var e=t.__sm__;if(e){t:{for(var n in e){t=n;break t}t=void 0}(this.ne=t)&&(t=this.ne,e=null!==e&&t in e?e[t]:void 0),this.data=e}else this.data=t}function Zt(t){St.call(this),this.status=1,this.errorCode=t}function $t(t){this.b=t}function te(){this.V=[],this.Z=[]}function ee(t,e){if(v.call(this),this.oe=t||0,this.Wb=e||10,this.oe>this.Wb)throw Error(An);this.fa=new te,this.oa=new Ut,this.Ac=0,this.Nc=null,this.Cb()}function ne(t,e){this.fe=t,this.gd=e}function re(t){this.Y=[],t&&this.Lf(t)}function ie(){re.call(this)}function oe(t,e){this.Gd=void 0,this.cc=new ie,ee.call(this,t,e)}function se(t,e,n,r){this.Jf=t,this.Ab=!!r,oe.call(this,e,n)}n.d(e,"createWebChannelTransport",function(){return Rn}),n.d(e,"ErrorCode",function(){return On}),n.d(e,"EventType",function(){return Pn}),n.d(e,"WebChannel",function(){return Mn}),n.d(e,"XhrIoPool",function(){return Ln});var ae,ue="undefined"!=typeof window?window:void 0!==t?t:"undefined"!=typeof self?self:{},ce=ce||{},he=ue,le="closure_uid_"+(1e9*Math.random()>>>0),fe=0,de=Date.now||function(){return+new Date};m(y,Error),y.prototype.name="CustomError",m(g,y),g.prototype.name="AssertionError";var pe=0,me={};v.prototype.Ka=!1,v.prototype.bb=function(){if(!this.Ka&&(this.Ka=!0,this.F(),0!=pe)){var t=this[le]||(this[le]=++fe);if(0!=pe&&this.Qa&&0<this.Qa.length)throw Error(this+" did not empty its onDisposeCallbacks queue. This probably means it overrode dispose() or disposeInternal() without calling the superclass' method.");delete me[t]}},v.prototype.F=function(){if(this.Qa)for(;this.Qa.length;)this.Qa.shift()()};var ye,ge=Array.prototype.indexOf?function(t,e){return Array.prototype.indexOf.call(t,e,void 0)}:function(t,e){if(r(t))return r(e)&&1==e.length?t.indexOf(e,0):-1;for(var n=0;n<t.length;n++)if(n in t&&t[n]===e)return n;return-1},ve=Array.prototype.lastIndexOf?function(t,e){return Array.prototype.lastIndexOf.call(t,e,t.length-1)}:function(t,e){var n=t.length-1;if(0>n&&(n=Math.max(0,t.length+n)),r(t))return r(e)&&1==e.length?t.lastIndexOf(e,n):-1;for(;0<=n;n--)if(n in t&&t[n]===e)return n;return-1},be=Array.prototype.forEach?function(t,e,n){Array.prototype.forEach.call(t,e,n)}:function(t,e,n){for(var i=t.length,o=r(t)?t.split(""):t,s=0;s<i;s++)s in o&&e.call(n,o[s],s,t)},_e=Array.prototype.some?function(t,e){return Array.prototype.some.call(t,e,void 0)}:function(t,e){for(var n=t.length,i=r(t)?t.split(""):t,o=0;o<n;o++)if(o in i&&e.call(void 0,i[o],o,t))return!0;return!1},we=String.prototype.trim?function(t){return t.trim()}:function(t){return/^[\s\xa0]*([\s\S]*?)[\s\xa0]*$/.exec(t)[1]};t:{var Ee=he.navigator;if(Ee){var Te=Ee.userAgent;if(Te){ye=Te;break t}}ye=""}var Se="constructor hasOwnProperty isPrototypeOf propertyIsEnumerable toLocaleString toString valueOf".split(" ");R[" "]=o;var Ie,Ce=I("Opera"),De=I("Trident")||I("MSIE"),Ne=I("Edge"),Ae=Ne||De,ke=I("Gecko")&&!(-1!=ye.toLowerCase().indexOf("webkit")&&!I("Edge"))&&!(I("Trident")||I("MSIE"))&&!I("Edge"),Re=-1!=ye.toLowerCase().indexOf("webkit")&&!I("Edge");t:{var Oe="",Pe=function(){var t=ye;return ke?/rv:([^\);]+)(\)|;)/.exec(t):Ne?/Edge\/([\d\.]+)/.exec(t):De?/\b(?:MSIE|rv)[: ]([^\);]+)(\)|;)/.exec(t):Re?/WebKit\/(\S+)/.exec(t):Ce?/(?:Version)[ \/]?(\S+)/.exec(t):void 0}();if(Pe&&(Oe=Pe?Pe[1]:""),De){var Me=O();if(null!=Me&&Me>parseFloat(Oe)){Ie=String(Me);break t}}Ie=Oe}var Le,xe={},Ue=he.document;Le=Ue&&De?O()||("CSS1Compat"==Ue.compatMode?parseInt(Ie,10):5):void 0;var Be=Object.freeze||function(t){return t},Fe=!De||9<=Number(Le),qe=De&&!P("9"),Ve=function(){if(!he.addEventListener||!Object.defineProperty)return!1;var t=!1,e=Object.defineProperty({},"passive",{get:function(){t=!0}});try{he.addEventListener("test",o,e),he.removeEventListener("test",o,e)}catch(t){}return t}();M.prototype.stopPropagation=function(){this.Ea=!0},M.prototype.preventDefault=function(){this.defaultPrevented=!0,this.Be=!1},m(L,M);var Ke=Be({2:"touch",3:"pen",4:"mouse"});L.prototype.Kf=function(t,e){var n=this.type=t.type,i=t.changedTouches?t.changedTouches[0]:null;if(this.target=t.target||t.srcElement,this.currentTarget=e,e=t.relatedTarget){if(ke){t:{try{R(e.nodeName);var o=!0;break t}catch(t){}o=!1}o||(e=null)}}else"mouseover"==n?e=t.fromElement:"mouseout"==n&&(e=t.toElement);this.relatedTarget=e,null===i?(this.offsetX=Re||void 0!==t.offsetX?t.offsetX:t.layerX,this.offsetY=Re||void 0!==t.offsetY?t.offsetY:t.layerY,this.clientX=void 0!==t.clientX?t.clientX:t.pageX,this.clientY=void 0!==t.clientY?t.clientY:t.pageY,this.screenX=t.screenX||0,this.screenY=t.screenY||0):(this.clientX=void 0!==i.clientX?i.clientX:i.pageX,this.clientY=void 0!==i.clientY?i.clientY:i.pageY,this.screenX=i.screenX||0,this.screenY=i.screenY||0),this.button=t.button,this.keyCode=t.keyCode||0,this.key=t.key||"",this.charCode=t.charCode||("keypress"==n?t.keyCode:0),this.ctrlKey=t.ctrlKey,this.altKey=t.altKey,this.shiftKey=t.shiftKey,this.metaKey=t.metaKey,this.pointerId=t.pointerId||0,this.pointerType=r(t.pointerType)?t.pointerType:Ke[t.pointerType]||"",this.state=t.state,this.fb=t,t.defaultPrevented&&this.preventDefault()},L.prototype.stopPropagation=function(){L.L.stopPropagation.call(this),this.fb.stopPropagation?this.fb.stopPropagation():this.fb.cancelBubble=!0},L.prototype.preventDefault=function(){L.L.preventDefault.call(this);var t=this.fb;if(t.preventDefault)t.preventDefault();else if(t.returnValue=!1,qe)try{(t.ctrlKey||112<=t.keyCode&&123>=t.keyCode)&&(t.keyCode=-1)}catch(t){}};var je="closure_listenable_"+(1e6*Math.random()|0),We=0;U.prototype.Vb=function(){this.Sa=!0,this.Ob=this.src=this.proxy=this.listener=null},(ae=B.prototype).add=function(t,e,n,r,i){var o=t.toString();(t=this.J[o])||(t=this.J[o]=[],this.xb++);var s=F(t,e,r,i);return-1<s?(e=t[s],n||(e.Eb=!1)):(e=new U(e,this.src,o,!!r,i),e.Eb=n,t.push(e)),e},ae.remove=function(t,e,n,r){if(!((t=t.toString())in this.J))return!1;var i=this.J[t];return-1<(e=F(i,e,n,r))&&(i[e].Vb(),Array.prototype.splice.call(i,e,1),0==i.length&&(delete this.J[t],this.xb--),!0)},ae.ye=function(t){var e=t.type;e in this.J&&_(this.J[e],t)&&(t.Vb(),0==this.J[e].length&&(delete this.J[e],this.xb--))},ae.pb=function(t){t=t&&t.toString();var e;for(e in this.J)if(!t||e==t){for(var n=this.J[e],r=0;r<n.length;r++)n[r].Vb();delete this.J[e],this.xb--}},ae.jb=function(t,e,n,r){var i=-1;return(t=this.J[t.toString()])&&(i=F(t,e,n,r)),-1<i?t[i]:null};var Qe="closure_lm_"+(1e6*Math.random()|0),Ge={},ze="__closure_events_fn_"+(1e9*Math.random()>>>0);m(J,v),J.prototype[je]=!0,(ae=J.prototype).addEventListener=function(t,e,n,r){q(this,t,e,n,r)},ae.removeEventListener=function(t,e,n,r){j(this,t,e,n,r)},ae.dispatchEvent=function(t){var e,n=this.Uc;if(n)for(e=[];n;n=n.Uc)e.push(n);n=this.Pe;var i=t.type||t;if(r(t))t=new M(t,n);else if(t instanceof M)t.target=t.target||n;else{var o=t;k(t=new M(i,n),o)}if(o=!0,e)for(var s=e.length-1;!t.Ea&&0<=s;s--){var a=t.currentTarget=e[s];o=a.Lb(i,!0,t)&&o}if(t.Ea||(a=t.currentTarget=n,o=a.Lb(i,!0,t)&&o,t.Ea||(o=a.Lb(i,!1,t)&&o)),e)for(s=0;!t.Ea&&s<e.length;s++)a=t.currentTarget=e[s],o=a.Lb(i,!1,t)&&o;return o},ae.F=function(){J.L.F.call(this),this.pg(),this.Uc=null},ae.nb=function(t,e,n,r){return this.ka.add(String(t),e,!1,n,r)},ae.Oc=function(t,e,n,r){return this.ka.add(String(t),e,!0,n,r)},ae.ed=function(t,e,n,r){this.ka.remove(String(t),e,n,r)},ae.Le=function(t){this.ka.ye(t)},ae.pg=function(){this.ka&&this.ka.pb(void 0)},ae.Lb=function(t,e,n){if(!(t=this.ka.J[String(t)]))return!0;t=t.concat();for(var r=!0,i=0;i<t.length;++i){var o=t[i];if(o&&!o.Sa&&o.capture==e){var s=o.listener,a=o.Ob||o.src;o.Eb&&this.Le(o),r=!1!==s.call(a,n)&&r}}return r&&0!=n.Be},ae.jb=function(t,e,n,r){return this.ka.jb(String(t),e,n,r)};var He=he.JSON.stringify;Z.prototype.get=function(){if(0<this.Zb){this.Zb--;var t=this.Pb;this.Pb=t.next,t.next=null}else t=this.ef();return t},Z.prototype.put=function(t){this.ug(t),this.Zb<this.Sf&&(this.Zb++,t.next=this.Pb,this.Pb=t)};var Xe=new Z(function(){return new tt},function(t){t.reset()});$.prototype.add=function(t,e){var n=this.Af();n.set(t,e),this.lc?this.lc.next=n:this.Va=n,this.lc=n},$.prototype.remove=function(){var t=null;return this.Va&&(t=this.Va,this.Va=this.Va.next,this.Va||(this.lc=null),t.next=null),t},$.prototype.wg=function(t){Xe.put(t)},$.prototype.Af=function(){return Xe.get()},tt.prototype.set=function(t,e){this.Gc=t,this.scope=e,this.next=null},tt.prototype.reset=function(){this.next=this.scope=this.Gc=null};var Ye,Je,Ze=!1,$e=new $;m(it,J),(ae=it.prototype).enabled=!1,ae.B=null,ae.setInterval=function(t){this.Na=t,this.B&&this.enabled?(this.stop(),this.start()):this.B&&this.stop()},ae.Rg=function(){if(this.enabled){var t=de()-this.ie;0<t&&t<.8*this.Na?this.B=this.wb.setTimeout(this.nd,this.Na-t):(this.B&&(this.wb.clearTimeout(this.B),this.B=null),this.ff(),this.enabled&&(this.stop(),this.start()))}},ae.ff=function(){this.dispatchEvent("tick")},ae.start=function(){this.enabled=!0,this.B||(this.B=this.wb.setTimeout(this.nd,this.Na),this.ie=de())},ae.stop=function(){this.enabled=!1,this.B&&(this.wb.clearTimeout(this.B),this.B=null)},ae.F=function(){it.L.F.call(this),this.stop(),delete this.wb},m(st,v),(ae=st.prototype).Ta=!1,ae.ob=0,ae.B=null,ae.mf=function(t){this.qc=arguments,this.B||this.ob?this.Ta=!0:this.Cc()},ae.stop=function(){this.B&&(he.clearTimeout(this.B),this.B=null,this.Ta=!1,this.qc=[])},ae.pause=function(){this.ob++},ae.resume=function(){this.ob--,this.ob||!this.Ta||this.B||(this.Ta=!1,this.Cc())},ae.F=function(){st.L.F.call(this),this.stop()},ae.fg=function(){this.B=null,this.Ta&&!this.ob&&(this.Ta=!1,this.Cc())},ae.Cc=function(){this.B=ot(this.Xe,this.Na),this.Uf.apply(null,this.qc)},m(at,v);var tn=[];(ae=at.prototype).nb=function(t,e,n,r){return this.Tf(t,e,n,r)},ae.Tf=function(t,e,n,r){a(e)||(e&&(tn[0]=e.toString()),e=tn);for(var i=0;i<e.length;i++){var o=q(t,e[i],n||this.handleEvent,r||!1,this.i||this);if(!o)break;this.o[o.key]=o}return this},ae.Oc=function(t,e,n,r){return this.je(t,e,n,r)},ae.je=function(t,e,n,r,i){if(a(e))for(var o=0;o<e.length;o++)this.je(t,e[o],n,r,i);else{if(!(t=K(t,e,n||this.handleEvent,r,i||this.i||this)))return this;this.o[t.key]=t}return this},ae.ed=function(t,e,n,r,i){if(a(e))for(var o=0;o<e.length;o++)this.ed(t,e[o],n,r,i);else n=n||this.handleEvent,r=h(r)?!!r.capture:!!r,i=i||this.i||this,n=Y(n),r=!!r,(e=x(t)?t.jb(e,n,r,i):t&&(t=X(t))?t.jb(e,n,r,i):null)&&(W(e),delete this.o[e.key])},ae.pb=function(){C(this.o,function(t,e){this.o.hasOwnProperty(e)&&W(t)},this),this.o={}},ae.F=function(){at.L.F.call(this),this.pb()},ae.handleEvent=function(){throw Error("EventHandler.handleEvent not implemented")},ut.prototype.Md=null,ut.prototype.reset=function(t,e,n,r,i){this.mb=t,delete this.Md},ut.prototype.Bg=function(t){this.Md=t},ut.prototype.Ge=function(t){this.mb=t},ht.prototype.toString=function(){return this.name};var en=new ht("SEVERE",1e3),nn=new ht("WARNING",900),rn=new ht("INFO",800),on=new ht("CONFIG",700),sn=new ht("FINE",500);(ae=ct.prototype).getName=function(){return this.pe},ae.getParent=function(){return this.$b},ae.pf=function(){return this.uc||(this.uc={}),this.uc},ae.Ge=function(t){this.mb=t},ae.Qd=function(){return this.mb?this.mb:this.$b?this.$b.Qd():(function(t,e){throw new g("Failure"+(t?": "+t:""),Array.prototype.slice.call(arguments,1))}("Root logger has no level set."),null)},ae.Pf=function(t){return t.value>=this.Qd().value},ae.log=function(t,e,n){this.Pf(t)&&(c(e)&&(e=e()),this.gf(this.uf(t,e,n)))},ae.uf=function(t,e,n){return t=new ut(t,String(e),this.pe),n&&t.Bg(n),t},ae.ca=function(t,e){this.log(en,t,e)},ae.T=function(t,e){this.log(nn,t,e)},ae.info=function(t,e){this.log(rn,t,e)},ae.lf=function(t){this.log(sn,t,void 0)},ae.gf=function(t){for(var e=this;e;)e.We(t),e=e.getParent()},ae.We=function(t){if(this.Zd)for(var e,n=0;e=this.Zd[n];n++)e(t)},ae.Fg=function(t){this.$b=t},ae.Qe=function(t,e){this.pf()[t]=e};var an={},un=null;(ae=pt.prototype).Id=function(){this.Wc=!1},ae.Tg=function(t,e,n,r,i){var o=this;this.info(function(){return"XMLHTTP REQ ("+n+") [attempt "+r+"]: "+t+"\n"+e+"\n"+o.Xf(i)})},ae.Ug=function(t,e,n,r,i,o){this.info(function(){return"XMLHTTP RESP ("+n+") [ attempt "+r+"]: "+t+"\n"+e+"\n"+i+" "+o})},ae.Wa=function(t,e,n){var r=this;this.info(function(){return"XMLHTTP TEXT ("+t+"): "+r.ng(e)+(n?" "+n:"")})},ae.Sg=function(t){this.info(function(){return"TIMEOUT: "+t})},ae.debug=function(t){dt(this.s,t)},ae.cb=function(t,e){var n=this.s;n&&n.ca(e||"Exception",t)},ae.info=function(t){ft(this.s,t)},ae.T=function(t){var e=this.s;e&&e.T(t,void 0)},ae.ca=function(t){var e=this.s;e&&e.ca(t,void 0)},ae.ng=function(t){if(!this.Wc)return t;if(!t)return null;try{var e=JSON.parse(t);if(e)for(var n=0;n<e.length;n++)a(e[n])&&this.Wf(e[n]);return He(e)}catch(e){return this.debug("Exception parsing expected JS array - probably was not JS"),t}},ae.Wf=function(t){if(!(2>t.length||(t=t[1],!a(t)||1>t.length))){var e=t[0];if("noop"!=e&&"stop"!=e&&"close"!=e)for(e=1;e<t.length;e++)t[e]=""}},ae.Xf=function(t){if(!this.Wc)return t;if(!t)return null;var e="";t=t.split("&");for(var n=0;n<t.length;n++){var r=t[n].split("=");if(1<r.length){var i=r[0];r=r[1];var o=i.split("_");e=2<=o.length&&"type"==o[1]?e+(i+"=")+r+"&":e+(i+"=redacted&")}}return e};var cn=new J;m(mt,M),m(gt,M),m(bt,M);var hn={NO_ERROR:0,Vg:1,bh:2,ah:3,Yg:4,$g:5,dh:6,Ne:7,TIMEOUT:8,gh:9},ln={Xg:"complete",kh:"success",Oe:"error",Ne:"abort",ih:"ready",jh:"readystatechange",TIMEOUT:"timeout",eh:"incrementaldata",hh:"progress",Zg:"downloadprogress",lh:"uploadprogress"};wt.prototype.pd=null,wt.prototype.Vd=function(){return this.pd||(this.pd=this.Mf())};var fn={OPEN:"a",Wg:"b",Oe:"c",fh:"d"};m(Tt,M),m(St,M);var dn;m(It,wt),It.prototype.Dd=function(){var t=this.Wd();return t?new ActiveXObject(t):new XMLHttpRequest},It.prototype.Mf=function(){var t={};return this.Wd()&&(t[0]=!0,t[1]=!0),t},It.prototype.Wd=function(){if(!this.be&&"undefined"==typeof XMLHttpRequest&&"undefined"!=typeof ActiveXObject){for(var t=["MSXML2.XMLHTTP.6.0","MSXML2.XMLHTTP.3.0","MSXML2.XMLHTTP","Microsoft.XMLHTTP"],e=0;e<t.length;e++){var n=t[e];try{return new ActiveXObject(n),this.be=n}catch(t){}}throw Error("Could not create ActiveXObject. ActiveX might be disabled, or MSXML might not be installed")}return this.be},dn=new It;var pn=45e3,mn={},yn={};(ae=Ct.prototype).ga=function(t){this.A=t},ae.setTimeout=function(t){this.Ua=t},ae.He=function(t){this.Ra=t},ae.Gg=function(t){this.ba=t},ae.la=function(){return this.ba},ae.kd=function(t,e){this.ic=1,this.ua=t.clone().Ub(),this.Da=e,this.yc=!0,this.Ce(null)},ae.jd=function(t,e,n){this.ic=1,this.ua=t.clone().Ub(),this.Da=null,this.yc=e,this.Ce(n)},ae.Ce=function(t){this.qb=de(),this.eb(),this.pa=this.ua.clone(),this.pa.dc("t",this.Xc),this.Bb=0,this.h=this.b.Jb(this.b.fc()?t:null),0<this.Ra&&(this.ac=new st(d(this.Me,this,this.h),this.Ra)),this.Fc.nb(this.h,"readystatechange",this.mg),t=this.A?A(this.A):{},this.Da?(this.Fa||(this.Fa="POST"),t["Content-Type"]="application/x-www-form-urlencoded",this.h.send(this.pa,this.Fa,this.Da,t)):(this.Fa="GET",this.h.send(this.pa,this.Fa,null,t)),yt(1),this.a.Tg(this.Fa,this.pa,this.R,this.Xc,this.Da)},ae.mg=function(t){t=t.target;var e=this.ac;e&&3==t.ma()?(this.a.debug("Throttling readystatechange."),e.mf()):this.Me(t)},ae.Me=function(t){try{t==this.h?this.hg():this.a.T("Called back with an unexpected xmlhttp")}catch(t){if(this.a.debug("Failed call to OnXmlHttpReadyStateChanged_"),this.h&&this.h.ya()){var e=this;this.a.cb(t,function(){return"ResponseText: "+e.h.ya()})}else this.a.cb(t,"No response text")}},ae.hg=function(){var t=this.h.ma(),e=this.h.Ud(),n=this.h.za();if(!(3>t||3==t&&!Ae&&!this.h.ya())){this.Za||4!=t||7==e||yt(8==e||0>=n?3:2),this.Fb();var r=this.h.za();if(this.w=r,!(e=this.h.ya())){var i=this;this.a.debug(function(){return"No response text for uri "+i.pa+" status "+r})}if(this.S=200==r,this.a.Ug(this.Fa,this.pa,this.R,this.Xc,t,r),this.S){if(this.Ig()){if(!(n=this.sf()))return this.S=!1,this.I=3,vt(12),this.a.T("XMLHTTP Missing X_HTTP_INITIAL_RESPONSE ("+this.R+")"),this.Ia(),void this.Kb();this.a.Wa(this.R,n,"Initial handshake response via X-HTTP-Initial-Response"),this.lb=!0,this.Yc(n)}this.yc?(this.Fd(t,e),Ae&&this.S&&3==t&&this.Ng()):(this.a.Wa(this.R,e,null),this.Yc(e)),4==t&&this.Ia(),this.S&&!this.Za&&(4==t?this.b.Tc(this):(this.S=!1,this.eb()))}else 400==r&&0<e.indexOf("Unknown SID")?(this.I=3,vt(12),this.a.T("XMLHTTP Unknown SID ("+this.R+")")):(this.I=0,vt(13),this.a.T("XMLHTTP Bad status "+r+" ("+this.R+")")),this.Ia(),this.Kb()}},ae.Ig=function(){return this.Ed&&!this.lb},ae.sf=function(){if(this.h){var t=this.h.kb("X-HTTP-Initial-Response");if(t&&!T(t))return t}return null},ae.Ag=function(){this.Ed=!0},ae.Fd=function(t,e){for(var n=!0;!this.Za&&this.Bb<e.length;){var r=this.vf(e);if(r==yn){4==t&&(this.I=4,vt(14),n=!1),this.a.Wa(this.R,null,"[Incomplete Response]");break}if(r==mn){this.I=4,vt(15),this.a.Wa(this.R,e,"[Invalid Chunk]"),n=!1;break}this.a.Wa(this.R,r,null),this.Yc(r)}4==t&&0==e.length&&(this.I=1,vt(16),n=!1),this.S=this.S&&n,n||(this.a.Wa(this.R,e,"[Invalid Chunked Response]"),this.Ia(),this.Kb())},ae.kg=function(){if(this.h){var t=this.h.ma(),e=this.h.ya();this.Bb<e.length&&(this.Fb(),this.Fd(t,e),this.S&&4!=t&&this.eb())}},ae.Ng=function(){this.Fc.nb(this.Vc,"tick",this.kg),this.Vc.start()},ae.vf=function(t){var e=this.Bb,n=t.indexOf("\n",e);return-1==n?yn:(e=Number(t.substring(e,n)),isNaN(e)?mn:(n+=1)+e>t.length?yn:(t=t.substr(n,e),this.Bb=n+e,t))},ae.yg=function(t){this.ic=2,this.ua=t.clone().Ub(),t=!1,he.navigator&&he.navigator.sendBeacon&&(t=he.navigator.sendBeacon(this.ua.toString(),"")),!t&&he.Image&&((new Image).src=this.ua,t=!0),t||(this.h=this.b.Jb(null),this.h.send(this.ua)),this.qb=de(),this.eb()},ae.cancel=function(){this.Za=!0,this.Ia()},ae.tg=function(t){t&&this.setTimeout(t),this.Ga&&(this.Fb(),this.eb())},ae.eb=function(){this.hd=de()+this.Ua,this.Ke(this.Ua)},ae.Ke=function(t){if(null!=this.Ga)throw Error("WatchDog timer not null");this.Ga=_t(d(this.gg,this),t)},ae.Fb=function(){this.Ga&&(he.clearTimeout(this.Ga),this.Ga=null)},ae.gg=function(){this.Ga=null;var t=de();0<=t-this.hd?this.Df():(this.a.T("WatchDog timer called too early"),this.Ke(this.hd-t))},ae.Df=function(){this.S&&this.a.ca("Received watchdog timeout even though request loaded successfully"),this.a.Sg(this.pa),2!=this.ic&&(yt(3),vt(17)),this.Ia(),this.I=2,this.Kb()},ae.Kb=function(){this.b.de()||this.Za||this.b.Tc(this)},ae.Ia=function(){this.Fb();var t=this.ac;t&&"function"==typeof t.bb&&t.bb(),this.ac=null,this.Vc.stop(),this.Fc.pb(),this.h&&(t=this.h,this.h=null,t.abort(),t.bb())},ae.Hc=function(){return this.I},ae.Yc=function(t){try{this.b.ue(this,t),yt(4)}catch(t){this.a.cb(t,"Error in httprequest callback")}},(ae=At.prototype).C=function(){return this.j},ae.H=function(){this.wc();for(var t=[],e=0;e<this.o.length;e++)t.push(this.D[this.o[e]]);return t},ae.W=function(){return this.wc(),this.o.concat()},ae.va=function(t){return kt(this.D,t)},ae.X=function(){return 0==this.j},ae.clear=function(){this.D={},this.j=this.o.length=0},ae.remove=function(t){return!!kt(this.D,t)&&(delete this.D[t],this.j--,this.o.length>2*this.j&&this.wc(),!0)},ae.wc=function(){if(this.j!=this.o.length){for(var t=0,e=0;t<this.o.length;){var n=this.o[t];kt(this.D,n)&&(this.o[e++]=n),t++}this.o.length=e}if(this.j!=this.o.length){var r={};for(e=t=0;t<this.o.length;)n=this.o[t],kt(r,n)||(this.o[e++]=n,r[n]=1),t++;this.o.length=e}},ae.get=function(t,e){return kt(this.D,t)?this.D[t]:e},ae.set=function(t,e){kt(this.D,t)||(this.j++,this.o.push(t)),this.D[t]=e},ae.addAll=function(t){if(t instanceof At)for(var e=t.W(),n=0;n<e.length;n++)this.set(e[n],t.get(e[n]));else for(e in t)this.set(e,t[e])},ae.forEach=function(t,e){for(var n=this.W(),r=0;r<n.length;r++){var i=n[r],o=this.get(i);t.call(e,o,i,this)}},ae.clone=function(){return new At(this)};var gn=/^(?:([^:/?#.]+):)?(?:\/\/(?:([^/?#]*)@)?([^/#?]*?)(?::([0-9]+))?(?=[/#?]|$))?([^?#]+)?(?:\?([^#]*))?(?:#([\s\S]*))?$/;(ae=Rt.prototype).toString=function(){var t=[],e=this.qa;e&&t.push(Pt(e,vn,!0),":");var n=this.xa;return(n||"file"==e)&&(t.push("//"),(e=this.zb)&&t.push(Pt(e,vn,!0),"@"),t.push(encodeURIComponent(String(n)).replace(/%25([0-9a-fA-F]{2})/g,"%$1")),null!=(n=this.Ca)&&t.push(":",String(n))),(n=this.K)&&(this.Ic()&&"/"!=n.charAt(0)&&t.push("/"),t.push(Pt(n,"/"==n.charAt(0)?_n:bn,!0))),(n=this.Rd())&&t.push("?",n),(n=this.ib)&&t.push("#",Pt(n,En)),t.join("")},ae.resolve=function(t){var e=this.clone(),n=t.Hf();n?e.tb(t.qa):n=t.If(),n?e.cd(t.zb):n=t.Ic(),n?e.rb(t.xa):n=t.Ff();var r=t.K;if(n)e.sb(t.Ca);else if(n=t.ae()){if("/"!=r.charAt(0))if(this.Ic()&&!this.ae())r="/"+r;else{var i=e.K.lastIndexOf("/");-1!=i&&(r=e.K.substr(0,i+1)+r)}if(".."==(i=r)||"."==i)r="";else if(-1!=i.indexOf("./")||-1!=i.indexOf("/.")){r=0==i.lastIndexOf("/",0),i=i.split("/");for(var o=[],s=0;s<i.length;){var a=i[s++];"."==a?r&&s==i.length&&o.push(""):".."==a?((1<o.length||1==o.length&&""!=o[0])&&o.pop(),r&&s==i.length&&o.push("")):(o.push(a),r=!0)}r=o.join("/")}else r=i}return n?e.ec(r):n=t.Gf(),n?e.bd(t.P.clone()):n=t.Ef(),n&&e.$c(t.ib),e},ae.clone=function(){return new Rt(this)},ae.tb=function(t,e){this.U(),(this.qa=e?Ot(t,!0):t)&&(this.qa=this.qa.replace(/:$/,""))},ae.Hf=function(){return!!this.qa},ae.cd=function(t,e){this.U(),this.zb=e?Ot(t):t},ae.If=function(){return!!this.zb},ae.rb=function(t,e){this.U(),this.xa=e?Ot(t,!0):t},ae.Ic=function(){return!!this.xa},ae.sb=function(t){if(this.U(),t){if(t=Number(t),isNaN(t)||0>t)throw Error("Bad port number "+t);this.Ca=t}else this.Ca=null},ae.Ff=function(){return null!=this.Ca},ae.ec=function(t,e){this.U(),this.K=e?Ot(t,!0):t},ae.ae=function(){return!!this.K},ae.Gf=function(){return""!==this.P.toString()},ae.bd=function(t,e){this.U(),t instanceof Lt?(this.P=t,this.P.ad(this.O)):(e||(t=Pt(t,wn)),this.P=new Lt(t,this.O))},ae.Rd=function(){return this.P.toString()},ae.getQuery=function(){return this.Rd()},ae.l=function(t,e){this.U(),this.P.set(t,e)},ae.dc=function(t,e){this.U(),a(e)||(e=[String(e)]),this.P.Ie(t,e)},ae.$c=function(t,e){this.U(),this.ib=e?Ot(t):t},ae.Ef=function(){return!!this.ib},ae.Ub=function(){return this.U(),this.l("zx",Math.floor(2147483648*Math.random()).toString(36)+Math.abs(Math.floor(2147483648*Math.random())^de()).toString(36)),this},ae.removeParameter=function(t){return this.U(),this.P.remove(t),this},ae.U=function(){if(this.Qf)throw Error("Tried to modify a read-only Uri")},ae.ad=function(t){this.O=t,this.P&&this.P.ad(t)};var vn=/[#\/\?@]/g,bn=/[#\?:]/g,_n=/[#\?]/g,wn=/[#\?@]/g,En=/#/g;(ae=Lt.prototype).$=function(){if(!this.m&&(this.m=new At,this.j=0,this.ja)){var t=this;!function(t,e){if(t){t=t.split("&");for(var n=0;n<t.length;n++){var r=t[n].indexOf("="),i=null;if(0<=r){var o=t[n].substring(0,r);i=t[n].substring(r+1)}else o=t[n];e(o,i?decodeURIComponent(i.replace(/\+/g," ")):"")}}}(this.ja,function(e,n){t.add(decodeURIComponent(e.replace(/\+/g," ")),n)})}},ae.C=function(){return this.$(),this.j},ae.add=function(t,e){this.$(),this.Oa(),t=this.Ma(t);var n=this.m.get(t);return n||this.m.set(t,n=[]),n.push(e),this.j+=1,this},ae.remove=function(t){return this.$(),t=this.Ma(t),!!this.m.va(t)&&(this.Oa(),this.j-=this.m.get(t).length,this.m.remove(t))},ae.clear=function(){this.Oa(),this.m=null,this.j=0},ae.X=function(){return this.$(),0==this.j},ae.va=function(t){return this.$(),t=this.Ma(t),this.m.va(t)},ae.forEach=function(t,e){this.$(),this.m.forEach(function(n,r){be(n,function(n){t.call(e,n,r,this)},this)},this)},ae.W=function(){this.$();for(var t=this.m.H(),e=this.m.W(),n=[],r=0;r<e.length;r++)for(var i=t[r],o=0;o<i.length;o++)n.push(e[r]);return n},ae.H=function(t){this.$();var e=[];if(r(t))this.va(t)&&(e=w(e,this.m.get(this.Ma(t))));else{t=this.m.H();for(var n=0;n<t.length;n++)e=w(e,t[n])}return e},ae.set=function(t,e){return this.$(),this.Oa(),t=this.Ma(t),this.va(t)&&(this.j-=this.m.get(t).length),this.m.set(t,[e]),this.j+=1,this},ae.get=function(t,e){return t&&0<(t=this.H(t)).length?String(t[0]):e},ae.Ie=function(t,e){this.remove(t),0<e.length&&(this.Oa(),this.m.set(this.Ma(t),E(e)),this.j+=e.length)},ae.toString=function(){if(this.ja)return this.ja;if(!this.m)return"";for(var t=[],e=this.m.W(),n=0;n<e.length;n++){var r=e[n],i=encodeURIComponent(String(r));r=this.H(r);for(var o=0;o<r.length;o++){var s=i;""!==r[o]&&(s+="="+encodeURIComponent(String(r[o]))),t.push(s)}}return this.ja=t.join("&")},ae.Oa=function(){this.ja=null},ae.clone=function(){var t=new Lt;return t.ja=this.ja,this.m&&(t.m=this.m.clone(),t.j=this.j),t},ae.Ma=function(t){return t=String(t),this.O&&(t=t.toLowerCase()),t},ae.ad=function(t){t&&!this.O&&(this.$(),this.Oa(),this.m.forEach(function(t,e){var n=e.toLowerCase();e!=n&&(this.remove(e),this.Ie(n,t))},this)),this.O=t},ae.extend=function(t){for(var e=0;e<arguments.length;e++)Nt(arguments[e],function(t,e){this.add(e,t)},this)},m(function(){},function(){}),(ae=xt.prototype).g=null,ae.ga=function(t){this.A=t},ae.connect=function(t){this.K=t,t=this.b.Sd(this.K),vt(3);var e=this.b.Ib.$d;null!=e?(this.na=this.b.$a(e[0]),this.g=1,this.xd()):(t.dc("MODE","init"),!this.b.ta&&this.b.aa&&t.dc("X-HTTP-Session-Id",this.b.aa),this.f=new Ct(this,this.a,void 0,void 0,void 0),this.f.ga(this.A),this.f.jd(t,!1,null),this.g=0)},ae.xd=function(){this.a.debug("TestConnection: starting stage 2");var t=this.b.Ib.od;if(null!=t)this.a.debug(function(){return"Buffered"}),vt(4),t?(vt(10),this.b.ub(this,!1)):(vt(11),this.b.ub(this,!0));else{this.f=new Ct(this,this.a,void 0,void 0,void 0),this.f.ga(this.A);var e=this.b.Pd(this.na,this.K);vt(4),e.dc("TYPE","xmlhttp");var n=this.b.aa,r=this.b.Kc;n&&r&&e.l(n,r),this.f.jd(e,!1,this.na)}},ae.Jb=function(t){return this.b.Jb(t)},ae.abort=function(){this.f&&(this.f.cancel(),this.f=null),this.w=-1},ae.de=function(){return!1},ae.ue=function(t,e){if(this.w=t.w,0==this.g)if(this.a.debug("TestConnection: Got data for stage 1"),this.pc(t),e){try{var n=this.b.kc.zc(e)}catch(t){return this.a.cb(t),void this.b.dd(this)}this.na=this.b.$a(n[0])}else this.a.debug("TestConnection: Null responseText"),this.b.dd(this);else 1==this.g&&(this.bc?vt(6):"11111"==e?(vt(5),this.bc=!0,this.Ze()&&(this.w=200,this.f.cancel(),this.a.debug("Test connection succeeded; using streaming connection"),vt(11),this.b.ub(this,!0))):(vt(7),this.bc=!1))},ae.Tc=function(){this.w=this.f.w,this.f.S?0==this.g?(this.g=1,this.a.debug("TestConnection: request complete for initial check"),this.xd()):1==this.g&&(this.a.debug("TestConnection: request complete for stage 2"),this.bc?(this.a.debug("Test connection succeeded; using streaming connection"),vt(11),this.b.ub(this,!0)):(this.a.debug("Test connection failed; not using streaming"),vt(10),this.b.ub(this,!1))):(this.a.debug("TestConnection: request failed, in state "+this.g),0==this.g?vt(8):1==this.g&&vt(9),this.b.dd(this))},ae.pc=function(t){if(!this.b.ta&&(t=t.h)){var e=t.kb("X-Client-Wire-Protocol");this.Ad=e||null,this.b.aa&&((t=t.kb("X-HTTP-Session-Id"))?this.b.Fe(t):this.a.T("Missing X_HTTP_SESSION_ID in the handshake response"))}},ae.fc=function(){return this.b.fc()},ae.Ba=function(){return this.b.Ba()},ae.Ze=function(){return!De||10<=Number(Le)},(ae=Ut.prototype).C=function(){return this.D.C()},ae.add=function(t){this.D.set(Bt(t),t)},ae.addAll=function(t){for(var e=(t=Dt(t)).length,n=0;n<e;n++)this.add(t[n])},ae.pb=function(t){for(var e=(t=Dt(t)).length,n=0;n<e;n++)this.remove(t[n])},ae.remove=function(t){return this.D.remove(Bt(t))},ae.clear=function(){this.D.clear()},ae.X=function(){return this.D.X()},ae.contains=function(t){return this.D.va(Bt(t))},ae.H=function(){return this.D.H()},ae.clone=function(){return new Ut(this)};var Tn=10;(ae=Ft.prototype).ld=function(t){this.v||-1==t.indexOf("spdy")&&-1==t.indexOf("quic")&&-1==t.indexOf("h2")||(this.Xb=this.me,this.v=new Ut,this.f&&(this.oc(this.f),this.f=null))},ae.ee=function(){return!!this.f||!!this.v&&this.v.C()>=this.Xb},ae.xf=function(){return this.f?1:this.v?this.v.C():0},ae.Jc=function(t){return this.f?this.f==t:!!this.v&&this.v.contains(t)},ae.oc=function(t){this.v?this.v.add(t):this.f=t},ae.ze=function(t){this.f&&this.f==t?this.f=null:this.v&&this.v.contains(t)&&this.v.remove(t)},ae.cancel=function(){this.ba=this.la(),this.f?(this.f.cancel(),this.f=null):this.v&&!this.v.X()&&(be(this.v.H(),function(t){t.cancel()}),this.v.clear())},ae.la=function(){if(null!=this.f)return this.ba.concat(this.f.la());if(null!=this.v&&!this.v.X()){var t=this.ba;return be(this.v.H(),function(e){t=t.concat(e.la())}),t}return E(this.ba)},ae.Re=function(t){this.ba=this.ba.concat(t)},ae.$e=function(){this.ba.length=0},qt.prototype.stringify=function(t){return he.JSON.stringify(t,this.rg)},qt.prototype.parse=function(t){return he.JSON.parse(t,this.xg)},Vt.prototype.hf=function(t,e,n){var r=n||"";try{Nt(t,function(t,n){var i=t;h(t)&&(i=He(t)),e.push(r+n+"="+encodeURIComponent(i))})}catch(t){throw e.push(r+"type="+encodeURIComponent("_badmap")),t}},Vt.prototype.jf=function(t,e,n){for(var r=-1;;){var i=["count="+e];-1==r?0<e?(r=t[0].Pc,i.push("ofs="+r)):r=0:i.push("ofs="+r);for(var o=!0,s=0;s<e;s++){var a=t[s].Pc,u=t[s].map;if(0>(a-=r))r=Math.max(0,t[s].Pc-100),o=!1;else try{this.hf(u,i,"req"+a+"_")}catch(t){n&&n(u)}}if(o)return i.join("&")}},Vt.prototype.zc=function(t){return this.jg.parse(t)};var Sn=he.JSON.parse;m(jt,J);var In="";jt.prototype.s=lt("goog.net.XhrIo");var Cn=/^https?$/i,Dn=["POST","PUT"];(ae=jt.prototype).Je=function(t){this.Ab=t},ae.send=function(t,e,n,i){if(this.c)throw Error("[goog.net.XhrIo] Object is active with another request="+this.Tb+"; newUri="+t);e=e?e.toUpperCase():"GET",this.Tb=t,this.I="",this.Pa=0,this.ge=e,this.Ec=!1,this.ha=!0,this.c=this.df(),this.mc=this.Xa?this.Xa.Vd():dn.Vd(),this.c.onreadystatechange=d(this.te,this),this.lg&&"onprogress"in this.c&&(this.c.onprogress=d(function(t){this.re(t,!0)},this),this.c.upload&&(this.c.upload.onprogress=d(this.re,this)));try{dt(this.s,this.da("Opening Xhr")),this.Lc=!0,this.c.open(e,String(t),!0),this.Lc=!1}catch(t){return dt(this.s,this.da("Error opening Xhr: "+t.message)),void this.Ld(t)}t=n||"";var o=this.headers.clone();i&&Nt(i,function(t,e){o.set(e,t)}),i=function(t){t:{for(var e=Wt,n=t.length,i=r(t)?t.split(""):t,o=0;o<n;o++)if(o in i&&e.call(void 0,i[o],o,t)){e=o;break t}e=-1}return 0>e?null:r(t)?t.charAt(e):t[e]}(o.W()),n=he.FormData&&t instanceof he.FormData,!(0<=ge(Dn,e))||i||n||o.set("Content-Type","application/x-www-form-urlencoded;charset=utf-8"),o.forEach(function(t,e){this.c.setRequestHeader(e,t)},this),this.Ae&&(this.c.responseType=this.Ae),"withCredentials"in this.c&&this.c.withCredentials!==this.Ab&&(this.c.withCredentials=this.Ab);try{this.yd(),0<this.vb&&(this.jc=function(t){return De&&P(9)&&"number"==typeof t.timeout&&void 0!==t.ontimeout}(this.c),dt(this.s,this.da("Will abort after "+this.vb+"ms if incomplete, xhr2 "+this.jc)),this.jc?(this.c.timeout=this.vb,this.c.ontimeout=d(this.Ua,this)):this.hc=ot(this.Ua,this.vb,this)),dt(this.s,this.da("Sending request")),this.Qb=!0,this.c.send(t),this.Qb=!1}catch(t){dt(this.s,this.da("Send error: "+t.message)),this.Ld(t)}},ae.df=function(){return this.Xa?this.Xa.Dd():dn.Dd()},ae.Ua=function(){void 0!==ce&&this.c&&(this.I="Timed out after "+this.vb+"ms, aborting",this.Pa=8,dt(this.s,this.da(this.I)),this.dispatchEvent("timeout"),this.abort(8))},ae.Ld=function(t){this.ha=!1,this.c&&(this.Aa=!0,this.c.abort(),this.Aa=!1),this.I=t,this.Pa=5,this.Jd(),this.Gb()},ae.Jd=function(){this.Ec||(this.Ec=!0,this.dispatchEvent("complete"),this.dispatchEvent("error"))},ae.abort=function(t){this.c&&this.ha&&(dt(this.s,this.da("Aborting")),this.ha=!1,this.Aa=!0,this.c.abort(),this.Aa=!1,this.Pa=t||7,this.dispatchEvent("complete"),this.dispatchEvent("abort"),this.Gb())},ae.F=function(){this.c&&(this.ha&&(this.ha=!1,this.Aa=!0,this.c.abort(),this.Aa=!1),this.Gb(!0)),jt.L.F.call(this)},ae.te=function(){this.Ka||(this.Lc||this.Qb||this.Aa?this.se():this.eg())},ae.eg=function(){this.se()},ae.se=function(){if(this.ha&&void 0!==ce)if(this.mc[1]&&4==this.ma()&&2==this.za())dt(this.s,this.da("Local request error detected and ignored"));else if(this.Qb&&4==this.ma())ot(this.te,0,this);else if(this.dispatchEvent("readystatechange"),this.Mc()){dt(this.s,this.da("Request complete")),this.ha=!1;try{this.Rf()?(this.dispatchEvent("complete"),this.dispatchEvent("success")):(this.Pa=6,this.I=this.Yd()+" ["+this.za()+"]",this.Jd())}finally{this.Gb()}}},ae.re=function(t,e){this.dispatchEvent(Qt(t,"progress")),this.dispatchEvent(Qt(t,e?"downloadprogress":"uploadprogress"))},ae.Gb=function(t){if(this.c){this.yd();var e=this.c,n=this.mc[0]?o:null;this.mc=this.c=null,t||this.dispatchEvent("ready");try{e.onreadystatechange=n}catch(e){(t=this.s)&&t.ca("Problem encountered resetting onreadystatechange: "+e.message,void 0)}}},ae.yd=function(){this.c&&this.jc&&(this.c.ontimeout=null),this.hc&&(he.clearTimeout(this.hc),this.hc=null)},ae.Ba=function(){return!!this.c},ae.Mc=function(){return 4==this.ma()},ae.Rf=function(){var t=this.za();t:switch(t){case 200:case 201:case 202:case 204:case 206:case 304:case 1223:var e=!0;break t;default:e=!1}return e||0===t&&!this.Of()},ae.Of=function(){var t=String(this.Tb).match(gn)[1]||null;return!t&&he.self&&he.self.location&&(t=he.self.location.protocol,t=t.substr(0,t.length-1)),Cn.test(t?t.toLowerCase():"")},ae.ma=function(){return this.c?this.c.readyState:0},ae.za=function(){try{return 2<this.ma()?this.c.status:-1}catch(t){return-1}},ae.Yd=function(){try{return 2<this.ma()?this.c.statusText:""}catch(t){return dt(this.s,"Can not get status: "+t.message),""}},ae.ya=function(){try{return this.c?this.c.responseText:""}catch(t){return dt(this.s,"Can not get responseText: "+t.message),""}},ae.yf=function(t){if(this.c){var e=this.c.responseText;return t&&0==e.indexOf(t)&&(e=e.substring(t.length)),Sn(e)}},ae.getResponseHeader=function(t){if(this.c&&this.Mc())return null===(t=this.c.getResponseHeader(t))?void 0:t},ae.getAllResponseHeaders=function(){return this.c&&this.Mc()?this.c.getAllResponseHeaders()||"":""},ae.kb=function(t){return this.c?this.c.getResponseHeader(t):null},ae.Ud=function(){return this.Pa},ae.Hc=function(){return r(this.I)?this.I:String(this.I)},ae.da=function(t){return t+" ["+this.ge+" "+this.Tb+" "+this.za()+"]"},(ae=zt.prototype).tc=8,ae.g=1,ae.connect=function(t,e,n,r,i){this.a.debug("connect()"),vt(0),this.K=e,this.gb=n||{},r&&void 0!==i&&(this.gb.OSID=r,this.gb.OAID=i),this.ta&&(this.a.debug("connect() bypassed channel-test."),this.Ib.$d=[],this.Ib.od=!1),this.bf(t)},ae.disconnect=function(){if(this.a.debug("disconnect()"),this.qd(),3==this.g){var t=this.Yb++,e=this.hb.clone();e.l("SID",this.ra),e.l("RID",t),e.l("TYPE","terminate"),this.Ya(e),new Ct(this,this.a,this.ra,t,void 0).yg(e)}this.qe()},ae.bf=function(t){this.a.debug("connectTest_()"),this.Ja=new xt(this,this.a),null===this.N&&this.Ja.ga(this.A);var e=t;this.N&&this.A&&(e=Gt(t,this.N,this.A)),this.Ja.connect(e)},ae.af=function(){this.a.debug("connectChannel_()"),this.hb=this.Sd(this.K),this.Dc()},ae.qd=function(){this.Ja&&(this.Ja.abort(),this.Ja=null),this.u&&(this.u.cancel(),this.u=null),this.ia&&(he.clearTimeout(this.ia),this.ia=null),this.Hb(),this.G.cancel(),this.ea&&(he.clearTimeout(this.ea),this.ea=null)},ae.ga=function(t){this.A=t},ae.Eg=function(t){this.Rb=t},ae.Cg=function(t){this.N=t},ae.Dg=function(t){this.aa=t},ae.Fe=function(t){this.Kc=t},ae.He=function(t){this.Ra=t},ae.Hg=function(){this.gc=!0},ae.Ee=function(t){this.i=t},ae.Nf=function(){return!this.fd},ae.Zc=function(t){1e3==this.M.length&&this.a.ca(function(){return"Already have 1000 queued maps upon queueing "+He(t)}),this.M.push(new function(t,e){this.Pc=t,this.map=e,this.context=null}(this.ag++,t)),3==this.g&&this.Dc()},ae.qf=function(){return this.kf?0:this.nf},ae.de=function(){return 0==this.g},ae.getState=function(){return this.g},ae.Dc=function(){this.G.ee()||this.ea||(this.ea=_t(d(this.we,this),0),this.La=0)},ae.Yf=function(t){return this.G.xf()>=this.G.Xb-(this.ea?1:0)?(this.a.ca("Unexpected retry request is scheduled."),!1):this.ea?(this.a.debug("Use the retry request that is already scheduled."),this.M=t.la().concat(this.M),!0):!(1==this.g||2==this.g||this.La>=this.qf())&&(this.a.debug("Going to retry POST"),this.ea=_t(d(this.we,this,t),this.Xd(this.La)),this.La++,!0)},ae.we=function(t){this.ea=null,this.Mg(t)},ae.Mg=function(t){this.a.debug("startForwardChannel_"),1==this.g?t?this.a.ca("Not supposed to retry the open"):(this.ig(),this.g=2):3==this.g&&(t?this.le(t):0==this.M.length?this.a.debug("startForwardChannel_ returned: nothing to send"):this.G.ee()?this.a.ca("startForwardChannel_ returned: connection already in progress"):(this.le(),this.a.debug("startForwardChannel_ finished, sent request")))},ae.ig=function(){this.a.debug("open_()"),this.Yb=Math.floor(1e5*Math.random());var t=this.Yb++,e=new Ct(this,this.a,"",t,void 0),n=this.A;this.Rb&&(n?(n=A(n),k(n,this.Rb)):n=this.Rb),null===this.N&&e.ga(n);var r=this.Hd(e),i=this.hb.clone();i.l("RID",t),0<this.Bd&&i.l("CVER",this.Bd),this.ta&&this.aa&&i.l("X-HTTP-Session-Id",this.aa),this.Ya(i),this.N&&n&&Gt(i,this.N,n),this.G.oc(e),this.Nd?(i.l("$req",r),i.l("SID","null"),e.Ag(),e.kd(i,null)):e.kd(i,r)},ae.le=function(t){var e=t?t.R:this.Yb++,n=this.hb.clone();n.l("SID",this.ra),n.l("RID",e),n.l("AID",this.Sb),this.Ya(n),this.N&&this.A&&Gt(n,this.N,this.A),e=new Ct(this,this.a,this.ra,e,this.La+1),null===this.N&&e.ga(this.A),t&&this.sg(t),t=this.Hd(e),e.setTimeout(Math.round(.5*this.Od)+Math.round(.5*this.Od*Math.random())),this.G.oc(e),e.kd(n,t)},ae.Ya=function(t){this.i&&Nt({},function(e,n){t.l(n,e)})},ae.Hd=function(t){var e=Math.min(this.M.length,1e3),n=this.i?d(this.i.Ue,this.i,this):null;return n=this.kc.jf(this.M,e,n),t.Gg(this.M.splice(0,e)),n},ae.sg=function(t){this.M=t.la().concat(this.M)},ae.Kd=function(){if(!this.u&&!this.ia){this.rc=1;var t=this.ve;Je||nt(),Ze||(Je(),Ze=!0),$e.add(t,this),this.Ha=0}},ae.Qc=function(){return this.u||this.ia?(this.a.ca("Request already in progress"),!1):!(3<=this.Ha)&&(this.a.debug("Going to retry GET"),this.rc++,this.ia=_t(d(this.ve,this),this.Xd(this.Ha)),this.Ha++,!0)},ae.ve=function(){this.ia=null,this.Kg()},ae.Kg=function(){this.a.debug("Creating new HttpRequest"),this.u=new Ct(this,this.a,this.ra,"rpc",this.rc),null===this.N&&this.u.ga(this.A),this.u.He(this.Ra);var t=this.md.clone();t.l("RID","rpc"),t.l("SID",this.ra),t.l("CI",this.fd?"0":"1"),t.l("AID",this.Sb),this.Ya(t),t.l("TYPE","xmlhttp"),this.N&&this.A&&Gt(t,this.N,this.A),this.Db&&this.u.setTimeout(this.Db),this.u.jd(t,!0,this.na),this.a.debug("New Request created")},ae.ub=function(t,e){this.a.debug("Test Connection Finished");var n=t.Ad;n&&this.G.ld(n),this.fd=this.Se&&e,this.w=t.w,this.af()},ae.dd=function(t){this.a.debug("Test Connection Failed"),this.w=t.w,this.sa(2)},ae.ue=function(t,e){if(0!=this.g&&(this.u==t||this.G.Jc(t)))if(this.w=t.w,!t.lb&&this.G.Jc(t)&&3==this.g){try{var n=this.kc.zc(e)}catch(t){n=null}a(n)&&3==n.length?this.Cf(n,t):(this.a.debug("Bad POST response data returned"),this.sa(11))}else(t.lb||this.u==t)&&this.Hb(),T(e)||(n=this.kc.zc(e),this.dg(n,t))},ae.Cf=function(t,e){0==t[0]?this.Bf(e):(this.he=t[1],0<(e=this.he-this.Sb)&&(t=t[2],this.a.debug(t+" bytes (in "+e+" arrays) are outstanding on the BackChannel"),this.Jg(t)&&!this.wa&&(this.wa=_t(d(this.bg,this),6e3))))},ae.Bf=function(t){if(this.a.debug("Server claims our backchannel is missing."),this.ia)this.a.debug("But we are currently starting the request.");else{if(this.u){if(!(this.u.qb+3e3<t.qb))return;this.Hb(),this.u.cancel(),this.u=null}else this.a.T("We do not have a BackChannel established");this.Qc(),vt(18)}},ae.Jg=function(t){return 37500>t&&!this.Nf()&&0==this.Ha},ae.$a=function(t){return this.Te?this.i?this.i.$a(t):t:null},ae.bg=function(){null!=this.wa&&(this.wa=null,this.u.cancel(),this.u=null,this.Qc(),vt(19))},ae.Hb=function(){null!=this.wa&&(he.clearTimeout(this.wa),this.wa=null)},ae.Tc=function(t){this.a.debug("Request complete");var e=null;if(this.u==t){this.Hb(),this.u=null;var n=2}else{if(!this.G.Jc(t))return;e=t.la(),this.G.ze(t),n=1}if(this.w=t.w,0!=this.g)if(t.S)1==n?(function(t,e,n){cn.dispatchEvent(new bt(cn,t,e,n))}(t.Da?t.Da.length:0,de()-t.qb,this.La),this.Dc()):this.Kd();else{var r=t.Hc();if(3==r||0==r&&0<this.w)this.a.debug("Not retrying due to error type");else{var i=this;if(this.a.debug(function(){return"Maybe retrying, last error: "+function(t,e){switch(t){case 0:return"Non-200 return code ("+e+")";case 1:return"XMLHTTP failure (no data)";case 2:return"HttpConnection timeout";default:return"Unknown error"}}(r,i.w)}),1==n&&this.Yf(t)||2==n&&this.Qc())return;this.a.debug("Exceeded max number of retries")}switch(e&&0<e.length&&this.G.Re(e),this.a.debug("Error: HTTP request failed"),r){case 1:this.sa(5);break;case 4:this.sa(10);break;case 3:this.sa(6);break;default:this.sa(2)}}},ae.Xd=function(t){var e=this.Ve+Math.floor(Math.random()*this.vg);return this.Ba()||(this.a.debug("Inactive channel"),e*=2),e*t},ae.pc=function(t){if(this.ta&&(t=t.h)){var e=t.kb("X-Client-Wire-Protocol");e&&this.G.ld(e),this.aa&&((t=t.kb("X-HTTP-Session-Id"))?(this.Fe(t),this.hb.l(this.aa,t)):this.a.T("Missing X_HTTP_SESSION_ID in the handshake response"))}},ae.dg=function(t,e){for(var n=this.i&&this.i.sc?[]:null,r=0;r<t.length;r++){var i=t[r];if(this.Sb=i[0],i=i[1],2==this.g)if("c"==i[0]){this.ra=i[1],this.na=this.$a(i[2]);var o=i[3];null!=o&&(this.tc=o,this.a.info("VER="+this.tc)),null!=(o=i[4])&&(this.De=o,this.a.info("SVER="+this.De)),null!=(i=i[5])&&"number"==typeof i&&0<i&&(this.Db=i*=1.5,this.a.info("backChannelRequestTimeoutMs_="+i)),this.pc(e),this.g=3,this.i&&this.i.wd(),this.Lg(e)}else"stop"!=i[0]&&"close"!=i[0]||this.sa(7);else 3==this.g&&("stop"==i[0]||"close"==i[0]?(n&&0!=n.length&&(this.i.sc(this,n),n.length=0),"stop"==i[0]?this.sa(7):this.disconnect()):"noop"!=i[0]&&(n?n.push(i):this.i&&this.i.ud(i)),this.Ha=0)}n&&0!=n.length&&this.i.sc(this,n)},ae.Lg=function(t){this.md=this.Pd(this.na,this.K),t.lb?(this.a.debug("Upgrade the handshake request to a backchannel."),this.G.ze(t),t.tg(this.Db),this.u=t):this.Kd()},ae.sa=function(t){if(this.a.info("Error code "+t),2==t){var e=null;this.i&&(e=null);var n=d(this.Pg,this);e||(e=new Rt("//www.google.com/images/cleardot.gif"),he.location&&"http"==he.location.protocol||e.tb("https"),e.Ub()),function(t,e){var n=new pt;n.debug("TestLoadImage: loading "+t);var r=new Image;r.onload=p(Kt,n,r,"TestLoadImage: loaded",!0,e),r.onerror=p(Kt,n,r,"TestLoadImage: error",!1,e),r.onabort=p(Kt,n,r,"TestLoadImage: abort",!1,e),r.ontimeout=p(Kt,n,r,"TestLoadImage: timeout",!1,e),he.setTimeout(function(){r.ontimeout&&r.ontimeout()},1e4),r.src=t}(e.toString(),n)}else vt(2);this.cg(t)},ae.Pg=function(t){t?(this.a.info("Successfully pinged google.com"),vt(2)):(this.a.info("Failed to ping google.com"),vt(1))},ae.cg=function(t){this.a.debug("HttpChannel: error - "+t),this.g=0,this.i&&this.i.td(t),this.qe(),this.qd()},ae.qe=function(){if(this.g=0,this.w=-1,this.i){var t=this.G.la();if(0!=t.length||0!=this.M.length){var e=this;this.a.debug(function(){return"Number of undelivered maps, pending: "+t.length+", outgoing: "+e.M.length}),this.G.$e(),E(this.M),this.M.length=0}this.i.sd()}},ae.Sd=function(t){return t=this.Cd(null,t),this.a.debug("GetForwardChannelUri: "+t),t},ae.Pd=function(t,e){return t=this.Cd(this.fc()?t:null,e),this.a.debug("GetBackChannelUri: "+t),t},ae.Cd=function(t,e){var n=function(t){return t instanceof Rt?t.clone():new Rt(t,void 0)}(e);if(""!=n.xa)t&&n.rb(t+"."+n.xa),n.sb(n.Ca);else{var r=he.location;n=function(t,e,n,r){var i=new Rt(null,void 0);return t&&i.tb(t),e&&i.rb(e),n&&i.sb(n),r&&i.ec(r),i}(r.protocol,t?t+"."+r.hostname:r.hostname,+r.port,e)}return this.gb&&C(this.gb,function(t,e){n.l(e,t)}),t=this.aa,e=this.Kc,t&&e&&n.l(t,e),n.l("VER",this.tc),this.Ya(n),n},ae.Jb=function(t){if(t&&!this.gc)throw Error("Can't create secondary domain capable XhrIo object.");return(t=new jt(this.Xa)).Je(this.gc),t},ae.Ba=function(){return!!this.i&&this.i.Ba()},ae.fc=function(){return this.gc},(ae=Ht.prototype).sc=null,ae.wd=function(){},ae.ud=function(){},ae.td=function(){},ae.sd=function(){},ae.Ba=function(){return!0},ae.Ue=function(){},ae.$a=function(t){return t},Xt.prototype.cf=function(t,e){return new Yt(t,e)},m(Yt,J),(ae=Yt.prototype).addEventListener=function(t,e,n,r){Yt.L.addEventListener.call(this,t,e,n,r)},ae.removeEventListener=function(t,e,n,r){Yt.L.removeEventListener.call(this,t,e,n,r)},ae.open=function(){this.b.Ee(this.vd),this.Og&&this.b.Hg(),this.b.connect(this.Qg,this.yb,this.Rc||void 0)},ae.close=function(){this.b.disconnect()},ae.send=function(t){if(r(t)){var e={};e.__data__=t,this.b.Zc(e)}else this.zg?(e={},e.__data__=He(t),this.b.Zc(e)):this.b.Zc(t)},ae.F=function(){this.b.Ee(null),delete this.vd,this.b.disconnect(),delete this.b,Yt.L.F.call(this)},m(Jt,Tt),m(Zt,St),m($t,Ht),$t.prototype.wd=function(){ft(this.b.s,"WebChannel opened on "+this.b.yb),this.b.dispatchEvent("a")},$t.prototype.ud=function(t){this.b.dispatchEvent(new Jt(t))},$t.prototype.td=function(t){ft(this.b.s,"WebChannel aborted on "+this.b.yb+" due to channel error: "+t),this.b.dispatchEvent(new Zt(t))},$t.prototype.sd=function(){ft(this.b.s,"WebChannel closed on "+this.b.yb),this.b.dispatchEvent("b")};var Nn=p(function(t,e){function n(){}n.prototype=t.prototype;var r=new n;return t.apply(r,Array.prototype.slice.call(arguments,1)),r},Xt);(ae=te.prototype).Vf=function(){0==this.V.length&&(this.V=this.Z,this.V.reverse(),this.Z=[])},ae.enqueue=function(t){this.Z.push(t)},ae.ab=function(){return this.Vf(),this.V.pop()},ae.C=function(){return this.V.length+this.Z.length},ae.X=function(){return 0==this.V.length&&0==this.Z.length},ae.clear=function(){this.V=[],this.Z=[]},ae.contains=function(t){return 0<=ge(this.V,t)||0<=ge(this.Z,t)},ae.remove=function(t){var e=this.V,n=ve(e,t);return 0<=n?(Array.prototype.splice.call(e,n,1),e=!0):e=!1,e||_(this.Z,t)},ae.H=function(){for(var t=[],e=this.V.length-1;0<=e;--e)t.push(this.V[e]);var n=this.Z.length;for(e=0;e<n;++e)t.push(this.Z[e]);return t},m(ee,v);var An="[goog.structs.Pool] Min can not be greater than max";(ae=ee.prototype).Mb=function(){var t=de();if(!(null!=this.Nc&&t-this.Nc<this.Ac)){var e=this.qg();return e&&(this.Nc=t,this.oa.add(e)),e}},ae.og=function(t){return!!this.oa.remove(t)&&(this.nc(t),!0)},ae.qg=function(){for(var t;0<this.Td()&&(t=this.fa.ab(),!this.Sc(t));)this.Cb();return!t&&this.C()<this.Wb&&(t=this.xc()),t},ae.nc=function(t){this.oa.remove(t),this.Sc(t)&&this.C()<this.Wb?this.fa.enqueue(t):this.Bc(t)},ae.Cb=function(){for(var t=this.fa;this.C()<this.oe;)t.enqueue(this.xc());for(;this.C()>this.Wb&&0<this.Td();)this.Bc(t.ab())},ae.xc=function(){return{}},ae.Bc=function(t){if("function"==typeof t.bb)t.bb();else for(var e in t)t[e]=null},ae.Sc=function(t){return"function"!=typeof t.Ye||t.Ye()},ae.contains=function(t){return this.fa.contains(t)||this.oa.contains(t)},ae.C=function(){return this.fa.C()+this.oa.C()},ae.rf=function(){return this.oa.C()},ae.Td=function(){return this.fa.C()},ae.X=function(){return this.fa.X()&&this.oa.X()},ae.F=function(){if(ee.L.F.call(this),0<this.rf())throw Error("[goog.structs.Pool] Objects not released");delete this.oa;for(var t=this.fa;!t.X();)this.Bc(t.ab());delete this.fa},ne.prototype.getKey=function(){return this.fe},ne.prototype.clone=function(){return new ne(this.fe,this.gd)},(ae=re.prototype).ce=function(t,e){var n=this.Y;n.push(new ne(t,e)),this.$f(n.length-1)},ae.Lf=function(t){if(t instanceof re){var e=t.W();if(t=t.H(),0>=this.C()){for(var n=this.Y,r=0;r<e.length;r++)n.push(new ne(e[r],t[r]));return}}else e=N(t),t=D(t);for(r=0;r<e.length;r++)this.ce(e[r],t[r])},ae.remove=function(){var t=this.Y,e=t.length,n=t[0];if(!(0>=e))return 1==e?b(t):(t[0]=t.pop(),this.Zf()),n.gd},ae.Zf=function(){for(var t=0,e=this.Y,n=e.length,r=e[t];t<n>>1;){var i=this.tf(t),o=this.zf(t);if(i=o<n&&e[o].getKey()<e[i].getKey()?o:i,e[i].getKey()>r.getKey())break;e[t]=e[i],t=i}e[t]=r},ae.$f=function(t){for(var e=this.Y,n=e[t];0<t;){var r=this.wf(t);if(!(e[r].getKey()>n.getKey()))break;e[t]=e[r],t=r}e[t]=n},ae.tf=function(t){return 2*t+1},ae.zf=function(t){return 2*t+2},ae.wf=function(t){return t-1>>1},ae.H=function(){for(var t=this.Y,e=[],n=t.length,r=0;r<n;r++)e.push(t[r].gd);return e},ae.W=function(){for(var t=this.Y,e=[],n=t.length,r=0;r<n;r++)e.push(t[r].getKey());return e},ae.va=function(t){return _e(this.Y,function(e){return e.getKey()==t})},ae.clone=function(){return new re(this)},ae.C=function(){return this.Y.length},ae.X=function(){return 0==this.Y.length},ae.clear=function(){b(this.Y)},m(ie,re),ie.prototype.enqueue=function(t,e){this.ce(t,e)},ie.prototype.ab=function(){return this.remove()},m(oe,ee),(ae=oe.prototype).Mb=function(t,e){if(!t)return(t=oe.L.Mb.call(this))&&this.Ac&&(this.Gd=he.setTimeout(d(this.Nb,this),this.Ac)),t;this.cc.enqueue(void 0!==e?e:100,t),this.Nb()},ae.Nb=function(){for(var t=this.cc;0<t.C();){var e=this.Mb();if(!e)break;t.ab().apply(this,[e])}},ae.nc=function(t){oe.L.nc.call(this,t),this.Nb()},ae.Cb=function(){oe.L.Cb.call(this),this.Nb()},ae.F=function(){oe.L.F.call(this),he.clearTimeout(this.Gd),this.cc.clear(),this.cc=null},m(se,oe),se.prototype.xc=function(){var t=new jt,e=this.Jf;return e&&e.forEach(function(e,n){t.headers.set(n,e)}),this.Ab&&t.Je(!0),t},se.prototype.Sc=function(t){return!t.Ka&&!t.Ba()},Xt.prototype.createWebChannel=Xt.prototype.cf,Yt.prototype.send=Yt.prototype.send,Yt.prototype.open=Yt.prototype.open,Yt.prototype.close=Yt.prototype.close,hn.NO_ERROR=0,hn.TIMEOUT=8,hn.HTTP_ERROR=6,ln.COMPLETE="complete",Et.EventType=fn,fn.OPEN="a",fn.CLOSE="b",fn.ERROR="c",fn.MESSAGE="d",J.prototype.listen=J.prototype.nb,se.prototype.getObject=se.prototype.Mb,se.prototype.releaseObject=se.prototype.og,jt.prototype.listenOnce=jt.prototype.Oc,jt.prototype.getLastError=jt.prototype.Hc,jt.prototype.getLastErrorCode=jt.prototype.Ud,jt.prototype.getStatus=jt.prototype.za,jt.prototype.getStatusText=jt.prototype.Yd,jt.prototype.getResponseJson=jt.prototype.yf,jt.prototype.getResponseText=jt.prototype.ya,jt.prototype.getResponseText=jt.prototype.ya,jt.prototype.send=jt.prototype.send;var kn={createWebChannelTransport:Nn,ErrorCode:hn,EventType:ln,WebChannel:Et,XhrIoPool:se},Rn=kn.createWebChannelTransport,On=kn.ErrorCode,Pn=kn.EventType,Mn=kn.WebChannel,Ln=kn.XhrIoPool;e.default=kn}.call(e,n(73))},419:function(t,e,n){"use strict";function r(t,e){var n={};for(var r in t)t.hasOwnProperty(r)&&(n[r]=e(t[r]));return n}function i(t,e,n){return new f(t,n)}function o(t){t.INTERNAL.registerService(d,i,{Functions:f},void 0,!0)}Object.defineProperty(e,"__esModule",{value:!0});var s=n(1),a=function(t){return t&&"object"==typeof t&&"default"in t?t.default:t}(n(132)),u={OK:"ok",CANCELLED:"cancelled",UNKNOWN:"unknown",INVALID_ARGUMENT:"invalid-argument",DEADLINE_EXCEEDED:"deadline-exceeded",NOT_FOUND:"not-found",ALREADY_EXISTS:"already-exists",PERMISSION_DENIED:"permission-denied",UNAUTHENTICATED:"unauthenticated",RESOURCE_EXHAUSTED:"resource-exhausted",FAILED_PRECONDITION:"failed-precondition",ABORTED:"aborted",OUT_OF_RANGE:"out-of-range",UNIMPLEMENTED:"unimplemented",INTERNAL:"internal",UNAVAILABLE:"unavailable",DATA_LOSS:"data-loss"},c=function(t){function e(n,r,i){var o=t.call(this,r)||this;return Object.setPrototypeOf(o,e.prototype),o.code=n,o.details=i,o}return s.__extends(e,t),e}(Error),h=function(){function t(t){this.app=t}return t.prototype.getAuthToken=function(){return s.__awaiter(this,void 0,void 0,function(){var t;return s.__generator(this,function(e){switch(e.label){case 0:return e.trys.push([0,2,,3]),[4,this.app.INTERNAL.getToken()];case 1:return(t=e.sent())?[2,t.accessToken]:[2,void 0];case 2:return e.sent(),[2,void 0];case 3:return[2]}})})},t.prototype.getInstanceIdToken=function(){return s.__awaiter(this,void 0,void 0,function(){var t,e;return s.__generator(this,function(n){switch(n.label){case 0:return n.trys.push([0,2,,3]),this.app.messaging?(t=this.app.messaging(),[4,t.getToken()]):[2,void 0];case 1:return(e=n.sent())?[2,e]:[2,void 0];case 2:return n.sent(),[2,void 0];case 3:return[2]}})})},t.prototype.getContext=function(){return s.__awaiter(this,void 0,void 0,function(){var t,e;return s.__generator(this,function(n){switch(n.label){case 0:return[4,this.getAuthToken()];case 1:return t=n.sent(),[4,this.getInstanceIdToken()];case 2:return e=n.sent(),[2,{authToken:t,instanceIdToken:e}]}})})},t}(),l=function(){function t(){}return t.prototype.encode=function(t){var e=this;if(null===t||void 0===t)return null;if(t instanceof Number&&(t=t.valueOf()),"number"==typeof t&&isFinite(t))return t;if(!0===t||!1===t)return t;if("[object String]"===Object.prototype.toString.call(t))return t;if(Array.isArray(t))return t.map(function(t){return e.encode(t)});if("function"==typeof t||"object"==typeof t)return r(t,function(t){return e.encode(t)});throw new Error("Data cannot be encoded in JSON: "+t)},t.prototype.decode=function(t){var e=this;if(null===t)return t;if(t["@type"])switch(t["@type"]){case"type.googleapis.com/google.protobuf.Int64Value":case"type.googleapis.com/google.protobuf.UInt64Value":var n=parseFloat(t.value);if(isNaN(n))throw new Error("Data cannot be decoded from JSON: "+t);return n;default:throw new Error("Data cannot be decoded from JSON: "+t)}return Array.isArray(t)?t.map(function(t){return e.decode(t)}):"function"==typeof t||"object"==typeof t?r(t,function(t){return e.decode(t)}):t},t}(),f=function(){function t(t,e){void 0===e&&(e="us-central1"),this.app_=t,this.region_=e,this.serializer=new l,this.emulatorOrigin=null,this.contextProvider=new h(t)}return Object.defineProperty(t.prototype,"app",{get:function(){return this.app_},enumerable:!0,configurable:!0}),t.prototype._url=function(t){var e=this.app_.options.projectId,n=this.region_;if(null!==this.emulatorOrigin){return this.emulatorOrigin+"/"+e+"/"+n+"/"+t}return"https://"+n+"-"+e+".cloudfunctions.net/"+t},t.prototype.useFunctionsEmulator=function(t){this.emulatorOrigin=t},t.prototype.httpsCallable=function(t){var e=this;return function(n){return e.call(t,n)}},t.prototype.postJSON=function(t,e,n){return s.__awaiter(this,void 0,void 0,function(){var r,i;return s.__generator(this,function(o){switch(o.label){case 0:n.append("Content-Type","application/json"),o.label=1;case 1:return o.trys.push([1,3,,4]),[4,fetch(t,{method:"POST",body:JSON.stringify(e),headers:n})];case 2:return r=o.sent(),[3,4];case 3:return o.sent(),[2,{status:0,json:null}];case 4:i=null,o.label=5;case 5:return o.trys.push([5,7,,8]),[4,r.json()];case 6:return i=o.sent(),[3,8];case 7:return o.sent(),[3,8];case 8:return[2,{status:r.status,json:i}]}})})},t.prototype.call=function(t,e){return s.__awaiter(this,void 0,void 0,function(){var n,r,i,o,a,h,l,f;return s.__generator(this,function(s){switch(s.label){case 0:return n=this._url(t),e=this.serializer.encode(e),r={data:e},i=new Headers,[4,this.contextProvider.getContext()];case 1:return(o=s.sent()).authToken&&i.append("Authorization","Bearer "+o.authToken),o.instanceIdToken&&i.append("Firebase-Instance-ID-Token",o.instanceIdToken),[4,this.postJSON(n,r,i)];case 2:if(a=s.sent(),h=function(t,e,n){var r=function(t){if(t>=200&&t<300)return"ok";switch(t){case 0:return"internal";case 400:return"invalid-argument";case 401:return"unauthenticated";case 403:return"permission-denied";case 404:return"not-found";case 409:return"aborted";case 429:return"resource-exhausted";case 499:return"cancelled";case 500:return"internal";case 501:return"unimplemented";case 503:return"unavailable";case 504:return"deadline-exceeded"}return"unknown"}(t),i=r,o=void 0;try{var s=e.error;if(s){var a=s.status;if("string"==typeof a){if(!u[a])return new c("internal","internal");r=u[a]}i=a;var h=s.message;"string"==typeof h&&(i=h),void 0!==(o=s.details)&&(o=n.decode(o))}}catch(t){}return"ok"===r?null:new c(r,i,o)}(a.status,a.json,this.serializer))throw h;if(!a.json)throw new c("internal","Response is not valid JSON object.");if(void 0===(l=a.json.data)&&(l=a.json.result),void 0===l)throw new c("internal","Response is missing data field.");return f=this.serializer.decode(l),[2,{data:f}]}})})},t}(),d="functions";o(a),e.registerFunctions=o},420:function(t,e,n){"use strict";function r(t,e){if(null==t||null==e)return!1;if(t===e)return!0;if(t.byteLength!==e.byteLength)return!1;for(var n=new DataView(t),r=new DataView(e),i=0;i<t.byteLength;i++)if(n.getUint8(i)!==r.getUint8(i))return!1;return!0}function i(t){return function(t){var e=new Uint8Array(t);return btoa(String.fromCharCode.apply(null,e))}(t).replace(/=/g,"").replace(/\+/g,"-").replace(/\//g,"_")}function o(t){for(var e=(t+"=".repeat((4-t.length%4)%4)).replace(/\-/g,"+").replace(/_/g,"/"),n=atob(e),r=new Uint8Array(n.length),i=0;i<n.length;++i)r[i]=n.charCodeAt(i);return r}function s(){var t=indexedDB.open(I);t.onerror=function(t){},t.onsuccess=function(e){!function(t){if(t.objectStoreNames.contains(C)){var e=t.transaction(C).objectStore(C),n=new S,r=e.openCursor();r.onerror=function(t){console.warn("Unable to cleanup old IDB.",t)},r.onsuccess=function(){var e=r.result;if(e){var i=e.value;n.deleteToken(i.fcmSenderId,i.fcmToken,i.fcmPushSet),e.continue()}else t.close(),indexedDB.deleteDatabase(I)}}}(t.result)}}function a(t){if(t.fcmToken&&("string"!=typeof t.fcmToken||0===t.fcmToken.length))throw _.create(v.BAD_TOKEN);if(t.swScope&&("string"!=typeof t.swScope||0===t.swScope.length))throw _.create(v.BAD_SCOPE);if(t.vapidKey&&(!(t.vapidKey instanceof Uint8Array)||65!==t.vapidKey.length))throw _.create(v.BAD_VAPID_KEY);if(t.endpoint&&("string"!=typeof t.endpoint||0===t.endpoint.length))throw _.create(v.BAD_SUBSCRIPTION);if(t.auth&&!(t.auth instanceof ArrayBuffer))throw _.create(v.BAD_SUBSCRIPTION);if(t.p256dh&&!(t.p256dh instanceof ArrayBuffer))throw _.create(v.BAD_SUBSCRIPTION);if(t.fcmSenderId&&("string"!=typeof t.fcmSenderId||0===t.fcmSenderId.length))throw _.create(v.BAD_SENDER_ID);if(t.fcmPushSet&&("string"!=typeof t.fcmPushSet||0===t.fcmPushSet.length))throw _.create(v.BAD_PUSH_SET)}function u(){return self.clients.matchAll({type:"window",includeUncontrolled:!0})}function c(t,e){return n={},n[d.TYPE_OF_MSG]=t,n[d.DATA]=e,n;var n}function h(t){t.INTERNAL.registerService("messaging",function(t){if(!l())throw _.create(v.UNSUPPORTED_BROWSER);return self&&"ServiceWorkerGlobalScope"in self?new O(t):new P(t)},{isSupported:l})}function l(){return self&&"ServiceWorkerGlobalScope"in self?"PushManager"in self&&"Notification"in self&&ServiceWorkerRegistration.prototype.hasOwnProperty("showNotification")&&PushSubscription.prototype.hasOwnProperty("getKey"):navigator.cookieEnabled&&"serviceWorker"in navigator&&"PushManager"in window&&"Notification"in window&&"fetch"in window&&ServiceWorkerRegistration.prototype.hasOwnProperty("showNotification")&&PushSubscription.prototype.hasOwnProperty("getKey")}Object.defineProperty(e,"__esModule",{value:!0}),n.d(e,"registerMessaging",function(){return h}),n.d(e,"isSupported",function(){return l});var f,d,p=n(205),m=(n.n(p),n(1)),y=n(132),g=n.n(y),v={AVAILABLE_IN_WINDOW:"only-available-in-window",AVAILABLE_IN_SW:"only-available-in-sw",SHOULD_BE_INHERITED:"should-be-overriden",BAD_SENDER_ID:"bad-sender-id",INCORRECT_GCM_SENDER_ID:"incorrect-gcm-sender-id",PERMISSION_DEFAULT:"permission-default",PERMISSION_BLOCKED:"permission-blocked",UNSUPPORTED_BROWSER:"unsupported-browser",NOTIFICATIONS_BLOCKED:"notifications-blocked",FAILED_DEFAULT_REGISTRATION:"failed-serviceworker-registration",SW_REGISTRATION_EXPECTED:"sw-registration-expected",GET_SUBSCRIPTION_FAILED:"get-subscription-failed",INVALID_SAVED_TOKEN:"invalid-saved-token",SW_REG_REDUNDANT:"sw-reg-redundant",TOKEN_SUBSCRIBE_FAILED:"token-subscribe-failed",TOKEN_SUBSCRIBE_NO_TOKEN:"token-subscribe-no-token",TOKEN_SUBSCRIBE_NO_PUSH_SET:"token-subscribe-no-push-set",TOKEN_UNSUBSCRIBE_FAILED:"token-unsubscribe-failed",TOKEN_UPDATE_FAILED:"token-update-failed",TOKEN_UPDATE_NO_TOKEN:"token-update-no-token",USE_SW_BEFORE_GET_TOKEN:"use-sw-before-get-token",INVALID_DELETE_TOKEN:"invalid-delete-token",DELETE_TOKEN_NOT_FOUND:"delete-token-not-found",DELETE_SCOPE_NOT_FOUND:"delete-scope-not-found",BG_HANDLER_FUNCTION_EXPECTED:"bg-handler-function-expected",NO_WINDOW_CLIENT_TO_MSG:"no-window-client-to-msg",UNABLE_TO_RESUBSCRIBE:"unable-to-resubscribe",NO_FCM_TOKEN_FOR_RESUBSCRIBE:"no-fcm-token-for-resubscribe",FAILED_TO_DELETE_TOKEN:"failed-to-delete-token",NO_SW_IN_REG:"no-sw-in-reg",BAD_SCOPE:"bad-scope",BAD_VAPID_KEY:"bad-vapid-key",BAD_SUBSCRIPTION:"bad-subscription",BAD_TOKEN:"bad-token",BAD_PUSH_SET:"bad-push-set",FAILED_DELETE_VAPID_KEY:"failed-delete-vapid-key",INVALID_PUBLIC_VAPID_KEY:"invalid-public-vapid-key",USE_PUBLIC_KEY_BEFORE_GET_TOKEN:"use-public-key-before-get-token",PUBLIC_KEY_DECRYPTION_FAILED:"public-vapid-key-decryption-failed"},b=(f={},f[v.AVAILABLE_IN_WINDOW]="This method is available in a Window context.",f[v.AVAILABLE_IN_SW]="This method is available in a service worker context.",f[v.SHOULD_BE_INHERITED]="This method should be overriden by extended classes.",f[v.BAD_SENDER_ID]="Please ensure that 'messagingSenderId' is set correctly in the options passed into firebase.initializeApp().",f[v.PERMISSION_DEFAULT]="The required permissions were not granted and dismissed instead.",f[v.PERMISSION_BLOCKED]="The required permissions were not granted and blocked instead.",f[v.UNSUPPORTED_BROWSER]="This browser doesn't support the API's required to use the firebase SDK.",f[v.NOTIFICATIONS_BLOCKED]="Notifications have been blocked.",f[v.FAILED_DEFAULT_REGISTRATION]="We are unable to register the default service worker. {$browserErrorMessage}",f[v.SW_REGISTRATION_EXPECTED]="A service worker registration was the expected input.",f[v.GET_SUBSCRIPTION_FAILED]="There was an error when trying to get any existing Push Subscriptions.",f[v.INVALID_SAVED_TOKEN]="Unable to access details of the saved token.",f[v.SW_REG_REDUNDANT]="The service worker being used for push was made redundant.",f[v.TOKEN_SUBSCRIBE_FAILED]="A problem occured while subscribing the user to FCM: {$message}",f[v.TOKEN_SUBSCRIBE_NO_TOKEN]="FCM returned no token when subscribing the user to push.",f[v.TOKEN_SUBSCRIBE_NO_PUSH_SET]="FCM returned an invalid response when getting an FCM token.",f[v.TOKEN_UNSUBSCRIBE_FAILED]="A problem occured while unsubscribing the user from FCM: {$message}",f[v.TOKEN_UPDATE_FAILED]="A problem occured while updating the user from FCM: {$message}",f[v.TOKEN_UPDATE_NO_TOKEN]="FCM returned no token when updating the user to push.",f[v.USE_SW_BEFORE_GET_TOKEN]="The useServiceWorker() method may only be called once and must be called before calling getToken() to ensure your service worker is used.",f[v.INVALID_DELETE_TOKEN]="You must pass a valid token into deleteToken(), i.e. the token from getToken().",f[v.DELETE_TOKEN_NOT_FOUND]="The deletion attempt for token could not be performed as the token was not found.",f[v.DELETE_SCOPE_NOT_FOUND]="The deletion attempt for service worker scope could not be performed as the scope was not found.",f[v.BG_HANDLER_FUNCTION_EXPECTED]="The input to setBackgroundMessageHandler() must be a function.",f[v.NO_WINDOW_CLIENT_TO_MSG]="An attempt was made to message a non-existant window client.",f[v.UNABLE_TO_RESUBSCRIBE]="There was an error while re-subscribing the FCM token for push messaging. Will have to resubscribe the user on next visit. {$message}",f[v.NO_FCM_TOKEN_FOR_RESUBSCRIBE]="Could not find an FCM token and as a result, unable to resubscribe. Will have to resubscribe the user on next visit.",f[v.FAILED_TO_DELETE_TOKEN]="Unable to delete the currently saved token.",f[v.NO_SW_IN_REG]="Even though the service worker registration was successful, there was a problem accessing the service worker itself.",f[v.INCORRECT_GCM_SENDER_ID]="Please change your web app manifest's 'gcm_sender_id' value to '103953800507' to use Firebase messaging.",f[v.BAD_SCOPE]="The service worker scope must be a string with at least one character.",f[v.BAD_VAPID_KEY]="The public VAPID key is not a Uint8Array with 65 bytes.",f[v.BAD_SUBSCRIPTION]="The subscription must be a valid PushSubscription.",f[v.BAD_TOKEN]="The FCM Token used for storage / lookup was not a valid token string.",f[v.BAD_PUSH_SET]="The FCM push set used for storage / lookup was not not a valid push set string.",f[v.FAILED_DELETE_VAPID_KEY]="The VAPID key could not be deleted.",f[v.INVALID_PUBLIC_VAPID_KEY]="The public VAPID key must be a string.",f[v.PUBLIC_KEY_DECRYPTION_FAILED]="The public VAPID key did not equal 65 bytes when decrypted.",f),_=new p.ErrorFactory("messaging","Messaging",b),w=new Uint8Array([4,51,148,247,223,161,235,177,220,3,162,94,21,113,219,72,211,46,237,237,178,52,219,183,71,58,12,143,196,204,225,111,60,140,132,223,171,182,102,62,242,12,212,139,254,227,249,118,47,20,28,99,8,106,111,45,177,26,149,176,206,55,192,156,110]),E="https://fcm.googleapis.com";!function(t){t.TYPE_OF_MSG="firebase-messaging-msg-type",t.DATA="firebase-messaging-msg-data"}(d||(d={}));var T;!function(t){t.PUSH_MSG_RECEIVED="push-msg-received",t.NOTIFICATION_CLICKED="notification-clicked"}(T||(T={}));var S=function(){function t(){}return t.prototype.getToken=function(t,e,n){return Object(m.__awaiter)(this,void 0,void 0,function(){var o,s,a,u,c,h,l,f,d;return Object(m.__generator)(this,function(p){switch(p.label){case 0:o=i(e.getKey("p256dh")),s=i(e.getKey("auth")),a="authorized_entity="+t+"&endpoint="+e.endpoint+"&encryption_key="+o+"&encryption_auth="+s,r(n.buffer,w.buffer)||(u=i(n),a+="&application_pub_key="+u),(c=new Headers).append("Content-Type","application/x-www-form-urlencoded"),h={method:"POST",headers:c,body:a},p.label=1;case 1:return p.trys.push([1,4,,5]),[4,fetch(E+"/fcm/connect/subscribe",h)];case 2:return f=p.sent(),[4,f.json()];case 3:return l=p.sent(),[3,5];case 4:throw p.sent(),_.create(v.TOKEN_SUBSCRIBE_FAILED);case 5:if(l.error)throw d=l.error.message,_.create(v.TOKEN_SUBSCRIBE_FAILED,{message:d});if(!l.token)throw _.create(v.TOKEN_SUBSCRIBE_NO_TOKEN);if(!l.pushSet)throw _.create(v.TOKEN_SUBSCRIBE_NO_PUSH_SET);return[2,{token:l.token,pushSet:l.pushSet}]}})})},t.prototype.updateToken=function(t,e,n,o,s){return Object(m.__awaiter)(this,void 0,void 0,function(){var a,u,c,h,l,f,d,p,y;return Object(m.__generator)(this,function(m){switch(m.label){case 0:a=i(o.getKey("p256dh")),u=i(o.getKey("auth")),c="push_set="+n+"&token="+e+"&authorized_entity="+t+"&endpoint="+o.endpoint+"&encryption_key="+a+"&encryption_auth="+u,r(s.buffer,w.buffer)||(h=i(s),c+="&application_pub_key="+h),(l=new Headers).append("Content-Type","application/x-www-form-urlencoded"),f={method:"POST",headers:l,body:c},m.label=1;case 1:return m.trys.push([1,4,,5]),[4,fetch(E+"/fcm/connect/subscribe",f)];case 2:return p=m.sent(),[4,p.json()];case 3:return d=m.sent(),[3,5];case 4:throw m.sent(),_.create(v.TOKEN_UPDATE_FAILED);case 5:if(d.error)throw y=d.error.message,_.create(v.TOKEN_UPDATE_FAILED,{message:y});if(!d.token)throw _.create(v.TOKEN_UPDATE_NO_TOKEN);return[2,d.token]}})})},t.prototype.deleteToken=function(t,e,n){return Object(m.__awaiter)(this,void 0,void 0,function(){var r,i,o,s,a,u;return Object(m.__generator)(this,function(c){switch(c.label){case 0:r="authorized_entity="+t+"&token="+e+"&pushSet="+n,(i=new Headers).append("Content-Type","application/x-www-form-urlencoded"),o={method:"POST",headers:i,body:r},c.label=1;case 1:return c.trys.push([1,4,,5]),[4,fetch(E+"/fcm/connect/unsubscribe",o)];case 2:return s=c.sent(),[4,s.json()];case 3:if((a=c.sent()).error)throw u=a.error.message,_.create(v.TOKEN_UNSUBSCRIBE_FAILED,{message:u});return[3,5];case 4:throw c.sent(),_.create(v.TOKEN_UNSUBSCRIBE_FAILED);case 5:return[2]}})})},t}(),I="undefined",C="fcm_token_object_Store",D=function(){function t(){this.dbPromise=null}return t.prototype.get=function(t){return this.createTransaction(function(e){return e.get(t)})},t.prototype.getIndex=function(t,e){return this.createTransaction(function(n){return n.index(t).get(e)})},t.prototype.put=function(t){return this.createTransaction(function(e){return e.put(t)},"readwrite")},t.prototype.delete=function(t){return this.createTransaction(function(e){return e.delete(t)},"readwrite")},t.prototype.closeDatabase=function(){return Object(m.__awaiter)(this,void 0,void 0,function(){return Object(m.__generator)(this,function(t){switch(t.label){case 0:return this.dbPromise?[4,this.dbPromise]:[3,2];case 1:t.sent().close(),this.dbPromise=null,t.label=2;case 2:return[2]}})})},t.prototype.createTransaction=function(t,e){return void 0===e&&(e="readonly"),Object(m.__awaiter)(this,void 0,void 0,function(){var n,r,i,o;return Object(m.__generator)(this,function(s){switch(s.label){case 0:return[4,this.getDb()];case 1:return n=s.sent(),r=n.transaction(this.objectStoreName,e),i=r.objectStore(this.objectStoreName),[4,function(t){return new Promise(function(e,n){t.onsuccess=function(){e(t.result)},t.onerror=function(){n(t.error)}})}(t(i))];case 2:return o=s.sent(),[2,new Promise(function(t,e){r.oncomplete=function(){t(o)},r.onerror=function(){e(r.error)}})]}})})},t.prototype.getDb=function(){var t=this;return this.dbPromise||(this.dbPromise=new Promise(function(e,n){var r=indexedDB.open(t.dbName,t.dbVersion);r.onsuccess=function(){e(r.result)},r.onerror=function(){t.dbPromise=null,n(r.error)},r.onupgradeneeded=function(e){return t.onDbUpgrade(r,e)}})),this.dbPromise},t}(),N=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.dbName="fcm_token_details_db",e.dbVersion=3,e.objectStoreName="fcm_token_object_Store",e}return Object(m.__extends)(e,t),e.prototype.onDbUpgrade=function(t,e){switch(e.oldVersion){case 0:(n=t.result.createObjectStore(this.objectStoreName,{keyPath:"swScope"})).createIndex("fcmSenderId","fcmSenderId",{unique:!1}),n.createIndex("fcmToken","fcmToken",{unique:!0});case 1:s();case 2:var n,r=(n=t.transaction.objectStore(this.objectStoreName)).openCursor();r.onsuccess=function(){var t=r.result;if(t){var e=t.value,n=Object(m.__assign)({},e);e.createTime||(n.createTime=Date.now()),"string"==typeof e.vapidKey&&(n.vapidKey=o(e.vapidKey)),"string"==typeof e.auth&&(n.auth=o(e.auth).buffer),"string"==typeof e.auth&&(n.p256dh=o(e.p256dh).buffer),t.update(n),t.continue()}}}},e.prototype.getTokenDetailsFromToken=function(t){return Object(m.__awaiter)(this,void 0,void 0,function(){return Object(m.__generator)(this,function(e){if(!t)throw _.create(v.BAD_TOKEN);return a({fcmToken:t}),[2,this.getIndex("fcmToken",t)]})})},e.prototype.getTokenDetailsFromSWScope=function(t){return Object(m.__awaiter)(this,void 0,void 0,function(){return Object(m.__generator)(this,function(e){if(!t)throw _.create(v.BAD_SCOPE);return a({swScope:t}),[2,this.get(t)]})})},e.prototype.saveTokenDetails=function(t){return Object(m.__awaiter)(this,void 0,void 0,function(){return Object(m.__generator)(this,function(e){if(!t.swScope)throw _.create(v.BAD_SCOPE);if(!t.vapidKey)throw _.create(v.BAD_VAPID_KEY);if(!t.endpoint||!t.auth||!t.p256dh)throw _.create(v.BAD_SUBSCRIPTION);if(!t.fcmSenderId)throw _.create(v.BAD_SENDER_ID);if(!t.fcmToken)throw _.create(v.BAD_TOKEN);if(!t.fcmPushSet)throw _.create(v.BAD_PUSH_SET);return a(t),[2,this.put(t)]})})},e.prototype.deleteToken=function(t){return Object(m.__awaiter)(this,void 0,void 0,function(){var e;return Object(m.__generator)(this,function(n){switch(n.label){case 0:return"string"!=typeof t||0===t.length?[2,Promise.reject(_.create(v.INVALID_DELETE_TOKEN))]:[4,this.getTokenDetailsFromToken(t)];case 1:if(!(e=n.sent()))throw _.create(v.DELETE_TOKEN_NOT_FOUND);return[4,this.delete(e.swScope)];case 2:return n.sent(),[2,e]}})})},e}(D),A=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.dbName="fcm_vapid_details_db",e.dbVersion=1,e.objectStoreName="fcm_vapid_object_Store",e}return Object(m.__extends)(e,t),e.prototype.onDbUpgrade=function(t){t.result.createObjectStore(this.objectStoreName,{keyPath:"swScope"})},e.prototype.getVapidFromSWScope=function(t){return Object(m.__awaiter)(this,void 0,void 0,function(){var e;return Object(m.__generator)(this,function(n){switch(n.label){case 0:if("string"!=typeof t||0===t.length)throw _.create(v.BAD_SCOPE);return[4,this.get(t)];case 1:return e=n.sent(),[2,e?e.vapidKey:void 0]}})})},e.prototype.saveVapidDetails=function(t,e){return Object(m.__awaiter)(this,void 0,void 0,function(){var n;return Object(m.__generator)(this,function(r){if("string"!=typeof t||0===t.length)throw _.create(v.BAD_SCOPE);if(null===e||65!==e.length)throw _.create(v.BAD_VAPID_KEY);return n={swScope:t,vapidKey:e},[2,this.put(n)]})})},e.prototype.deleteVapidDetails=function(t){return Object(m.__awaiter)(this,void 0,void 0,function(){var e;return Object(m.__generator)(this,function(n){switch(n.label){case 0:return[4,this.getVapidFromSWScope(t)];case 1:if(!(e=n.sent()))throw _.create(v.DELETE_SCOPE_NOT_FOUND);return[4,this.delete(t)];case 2:return n.sent(),[2,e]}})})},e}(D),k="messagingSenderId",R=function(){function t(t){var e=this;if(!t.options[k]||"string"!=typeof t.options[k])throw _.create(v.BAD_SENDER_ID);this.messagingSenderId=t.options[k],this.tokenDetailsModel=new N,this.vapidDetailsModel=new A,this.iidModel=new S,this.app=t,this.INTERNAL={delete:function(){return e.delete()}}}return t.prototype.getToken=function(){return Object(m.__awaiter)(this,void 0,void 0,function(){var t,e,n,r,i;return Object(m.__generator)(this,function(o){switch(o.label){case 0:if("denied"===(t=this.getNotificationPermission_()))throw _.create(v.NOTIFICATIONS_BLOCKED);return"granted"!==t?[2,null]:[4,this.getSWRegistration_()];case 1:return e=o.sent(),[4,this.getPublicVapidKey_()];case 2:return n=o.sent(),[4,this.getPushSubscription(e,n)];case 3:return r=o.sent(),[4,this.tokenDetailsModel.getTokenDetailsFromSWScope(e.scope)];case 4:return(i=o.sent())?[2,this.manageExistingToken(e,r,n,i)]:[2,this.getNewToken(e,r,n)]}})})},t.prototype.manageExistingToken=function(t,e,n,i){return Object(m.__awaiter)(this,void 0,void 0,function(){return Object(m.__generator)(this,function(o){switch(o.label){case 0:return function(t,e,n){if(!n.vapidKey||!r(e.buffer,n.vapidKey.buffer))return!1;var i=t.endpoint===n.endpoint,o=r(t.getKey("auth"),n.auth),s=r(t.getKey("p256dh"),n.p256dh);return i&&o&&s}(e,n,i)?Date.now()<i.createTime+6048e5?[2,i.fcmToken]:[2,this.updateToken(t,e,n,i)]:[4,this.deleteTokenFromDB(i.fcmToken)];case 1:return o.sent(),[2,this.getNewToken(t,e,n)]}})})},t.prototype.updateToken=function(t,e,n,r){return Object(m.__awaiter)(this,void 0,void 0,function(){var i,o,s;return Object(m.__generator)(this,function(a){switch(a.label){case 0:return a.trys.push([0,4,,6]),[4,this.iidModel.updateToken(this.messagingSenderId,r.fcmToken,r.fcmPushSet,e,n)];case 1:return i=a.sent(),o={swScope:t.scope,vapidKey:n,fcmSenderId:this.messagingSenderId,fcmToken:i,fcmPushSet:r.fcmPushSet,createTime:Date.now(),endpoint:e.endpoint,auth:e.getKey("auth"),p256dh:e.getKey("p256dh")},[4,this.tokenDetailsModel.saveTokenDetails(o)];case 2:return a.sent(),[4,this.vapidDetailsModel.saveVapidDetails(t.scope,n)];case 3:return a.sent(),[2,i];case 4:return s=a.sent(),[4,this.deleteToken(r.fcmToken)];case 5:throw a.sent(),s;case 6:return[2]}})})},t.prototype.getNewToken=function(t,e,n){return Object(m.__awaiter)(this,void 0,void 0,function(){var r,i;return Object(m.__generator)(this,function(o){switch(o.label){case 0:return[4,this.iidModel.getToken(this.messagingSenderId,e,n)];case 1:return r=o.sent(),i={swScope:t.scope,vapidKey:n,fcmSenderId:this.messagingSenderId,fcmToken:r.token,fcmPushSet:r.pushSet,createTime:Date.now(),endpoint:e.endpoint,auth:e.getKey("auth"),p256dh:e.getKey("p256dh")},[4,this.tokenDetailsModel.saveTokenDetails(i)];case 2:return o.sent(),[4,this.vapidDetailsModel.saveVapidDetails(t.scope,n)];case 3:return o.sent(),[2,r.token]}})})},t.prototype.deleteToken=function(t){return Object(m.__awaiter)(this,void 0,void 0,function(){var e,n;return Object(m.__generator)(this,function(r){switch(r.label){case 0:return[4,this.deleteTokenFromDB(t)];case 1:return r.sent(),[4,this.getSWRegistration_()];case 2:return(e=r.sent())?[4,e.pushManager.getSubscription()]:[3,4];case 3:if(n=r.sent())return[2,n.unsubscribe()];r.label=4;case 4:return[2,!0]}})})},t.prototype.deleteTokenFromDB=function(t){return Object(m.__awaiter)(this,void 0,void 0,function(){var e;return Object(m.__generator)(this,function(n){switch(n.label){case 0:return[4,this.tokenDetailsModel.deleteToken(t)];case 1:return e=n.sent(),[4,this.iidModel.deleteToken(e.fcmSenderId,e.fcmToken,e.fcmPushSet)];case 2:return n.sent(),[2]}})})},t.prototype.getPushSubscription=function(t,e){return t.pushManager.getSubscription().then(function(n){return n||t.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:e})})},t.prototype.requestPermission=function(){throw _.create(v.AVAILABLE_IN_WINDOW)},t.prototype.useServiceWorker=function(t){throw _.create(v.AVAILABLE_IN_WINDOW)},t.prototype.usePublicVapidKey=function(t){throw _.create(v.AVAILABLE_IN_WINDOW)},t.prototype.onMessage=function(t,e,n){throw _.create(v.AVAILABLE_IN_WINDOW)},t.prototype.onTokenRefresh=function(t,e,n){throw _.create(v.AVAILABLE_IN_WINDOW)},t.prototype.setBackgroundMessageHandler=function(t){throw _.create(v.AVAILABLE_IN_SW)},t.prototype.delete=function(){return Object(m.__awaiter)(this,void 0,void 0,function(){return Object(m.__generator)(this,function(t){switch(t.label){case 0:return[4,Promise.all([this.tokenDetailsModel.closeDatabase(),this.vapidDetailsModel.closeDatabase()])];case 1:return t.sent(),[2]}})})},t.prototype.getNotificationPermission_=function(){return Notification.permission},t.prototype.getTokenDetailsModel=function(){return this.tokenDetailsModel},t.prototype.getVapidDetailsModel=function(){return this.vapidDetailsModel},t.prototype.getIidModel=function(){return this.iidModel},t}(),O=function(t){function e(e){var n=t.call(this,e)||this;return n.bgMessageHandler=null,self.addEventListener("push",function(t){n.onPush(t)}),self.addEventListener("pushsubscriptionchange",function(t){n.onSubChange(t)}),self.addEventListener("notificationclick",function(t){n.onNotificationClick(t)}),n}return Object(m.__extends)(e,t),e.prototype.onPush=function(t){t.waitUntil(this.onPush_(t))},e.prototype.onSubChange=function(t){t.waitUntil(this.onSubChange_(t))},e.prototype.onNotificationClick=function(t){t.waitUntil(this.onNotificationClick_(t))},e.prototype.onPush_=function(t){return Object(m.__awaiter)(this,void 0,void 0,function(){var e,n,r,i,o,s;return Object(m.__generator)(this,function(a){switch(a.label){case 0:if(!t.data)return[2];try{e=t.data.json()}catch(t){return[2]}return[4,this.hasVisibleClients_()];case 1:return a.sent()?[2,this.sendMessageToWindowClients_(e)]:(n=this.getNotificationData_(e))?(r=n.title||"",[4,this.getSWRegistration_()]):[3,3];case 2:return i=a.sent(),o=n.actions,s=Notification.maxActions,o&&s&&o.length>s&&console.warn("This browser only supports "+s+" actions.The remaining actions will not be displayed."),[2,i.showNotification(r,n)];case 3:return this.bgMessageHandler?[4,this.bgMessageHandler(e)]:[3,5];case 4:return a.sent(),[2];case 5:return[2]}})})},e.prototype.onSubChange_=function(t){return Object(m.__awaiter)(this,void 0,void 0,function(){var t,e,n,r,i;return Object(m.__generator)(this,function(o){switch(o.label){case 0:return o.trys.push([0,2,,3]),[4,this.getSWRegistration_()];case 1:return t=o.sent(),[3,3];case 2:throw e=o.sent(),_.create(v.UNABLE_TO_RESUBSCRIBE,{message:e});case 3:return o.trys.push([3,5,,8]),[4,t.pushManager.getSubscription()];case 4:return o.sent(),[3,8];case 5:return n=o.sent(),r=this.getTokenDetailsModel(),[4,r.getTokenDetailsFromSWScope(t.scope)];case 6:if(!(i=o.sent()))throw n;return[4,this.deleteToken(i.fcmToken)];case 7:throw o.sent(),n;case 8:return[2]}})})},e.prototype.onNotificationClick_=function(t){return Object(m.__awaiter)(this,void 0,void 0,function(){var e,n,r,i;return Object(m.__generator)(this,function(o){switch(o.label){case 0:return t.notification&&t.notification.data&&t.notification.data.FCM_MSG?t.action?[2]:(t.stopImmediatePropagation(),t.notification.close(),(e=t.notification.data.FCM_MSG).notification&&(n=e.fcmOptions&&e.fcmOptions.link||e.notification.click_action)?[4,this.getWindowClient_(n)]:[2]):[2];case 1:return(r=o.sent())?[3,3]:[4,self.clients.openWindow(n)];case 2:return r=o.sent(),[3,5];case 3:return[4,r.focus()];case 4:r=o.sent(),o.label=5;case 5:return r?(delete e.notification,delete e.fcmOptions,i=c(T.NOTIFICATION_CLICKED,e),[2,this.attemptToMessageClient_(r,i)]):[2]}})})},e.prototype.getNotificationData_=function(t){if(t&&"object"==typeof t.notification){var e=Object(m.__assign)({},t.notification);return e.data=Object(m.__assign)({},t.notification.data,(n={},n.FCM_MSG=t,n)),e;var n}},e.prototype.setBackgroundMessageHandler=function(t){if(!t||"function"!=typeof t)throw _.create(v.BG_HANDLER_FUNCTION_EXPECTED);this.bgMessageHandler=t},e.prototype.getWindowClient_=function(t){return Object(m.__awaiter)(this,void 0,void 0,function(){var e,n,r,i;return Object(m.__generator)(this,function(o){switch(o.label){case 0:return e=new URL(t,self.location.href).href,[4,u()];case 1:for(n=o.sent(),r=null,i=0;i<n.length;i++)if(new URL(n[i].url,self.location.href).href===e){r=n[i];break}return[2,r]}})})},e.prototype.attemptToMessageClient_=function(t,e){return Object(m.__awaiter)(this,void 0,void 0,function(){return Object(m.__generator)(this,function(n){if(!t)throw _.create(v.NO_WINDOW_CLIENT_TO_MSG);return t.postMessage(e),[2]})})},e.prototype.hasVisibleClients_=function(){return Object(m.__awaiter)(this,void 0,void 0,function(){var t;return Object(m.__generator)(this,function(e){switch(e.label){case 0:return[4,u()];case 1:return t=e.sent(),[2,t.some(function(t){return"visible"===t.visibilityState})]}})})},e.prototype.sendMessageToWindowClients_=function(t){return Object(m.__awaiter)(this,void 0,void 0,function(){var e,n,r=this;return Object(m.__generator)(this,function(i){switch(i.label){case 0:return[4,u()];case 1:return e=i.sent(),n=c(T.PUSH_MSG_RECEIVED,t),[4,Promise.all(e.map(function(t){return r.attemptToMessageClient_(t,n)}))];case 2:return i.sent(),[2]}})})},e.prototype.getSWRegistration_=function(){return Object(m.__awaiter)(this,void 0,void 0,function(){return Object(m.__generator)(this,function(t){return[2,self.registration]})})},e.prototype.getPublicVapidKey_=function(){return Object(m.__awaiter)(this,void 0,void 0,function(){var t,e;return Object(m.__generator)(this,function(n){switch(n.label){case 0:return[4,this.getSWRegistration_()];case 1:if(!(t=n.sent()))throw _.create(v.SW_REGISTRATION_EXPECTED);return[4,this.getVapidDetailsModel().getVapidFromSWScope(t.scope)];case 2:return null==(e=n.sent())?[2,w]:[2,e]}})})},e}(R),P=function(t){function e(e){var n=t.call(this,e)||this;return n.registrationToUse=null,n.publicVapidKeyToUse=null,n.manifestCheckPromise=null,n.messageObserver=null,n.tokenRefreshObserver=null,n.onMessageInternal=Object(p.createSubscribe)(function(t){n.messageObserver=t}),n.onTokenRefreshInternal=Object(p.createSubscribe)(function(t){n.tokenRefreshObserver=t}),n.setupSWMessageListener_(),n}return Object(m.__extends)(e,t),e.prototype.getToken=function(){return Object(m.__awaiter)(this,void 0,void 0,function(){return Object(m.__generator)(this,function(e){switch(e.label){case 0:return this.manifestCheckPromise||(this.manifestCheckPromise=function(){return Object(m.__awaiter)(this,void 0,void 0,function(){var t,e,n;return Object(m.__generator)(this,function(r){switch(r.label){case 0:if(!(t=document.querySelector('link[rel="manifest"]')))return[2];r.label=1;case 1:return r.trys.push([1,4,,5]),[4,fetch(t.href)];case 2:return n=r.sent(),[4,n.json()];case 3:return e=r.sent(),[3,5];case 4:return r.sent(),[2];case 5:if(!e||!e.gcm_sender_id)return[2];if("103953800507"!==e.gcm_sender_id)throw _.create(v.INCORRECT_GCM_SENDER_ID);return[2]}})})}()),[4,this.manifestCheckPromise];case 1:return e.sent(),[2,t.prototype.getToken.call(this)]}})})},e.prototype.requestPermission=function(){return Object(m.__awaiter)(this,void 0,void 0,function(){var t;return Object(m.__generator)(this,function(e){switch(e.label){case 0:return"granted"===this.getNotificationPermission_()?[2]:[4,Notification.requestPermission()];case 1:if("granted"===(t=e.sent()))return[2];throw _.create("denied"===t?v.PERMISSION_BLOCKED:v.PERMISSION_DEFAULT)}})})},e.prototype.useServiceWorker=function(t){if(!(t instanceof ServiceWorkerRegistration))throw _.create(v.SW_REGISTRATION_EXPECTED);if(null!=this.registrationToUse)throw _.create(v.USE_SW_BEFORE_GET_TOKEN);this.registrationToUse=t},e.prototype.usePublicVapidKey=function(t){if("string"!=typeof t)throw _.create(v.INVALID_PUBLIC_VAPID_KEY);if(null!=this.publicVapidKeyToUse)throw _.create(v.USE_PUBLIC_KEY_BEFORE_GET_TOKEN);var e=o(t);if(65!==e.length)throw _.create(v.PUBLIC_KEY_DECRYPTION_FAILED);this.publicVapidKeyToUse=e},e.prototype.onMessage=function(t,e,n){return"function"==typeof t?this.onMessageInternal(t,e,n):this.onMessageInternal(t)},e.prototype.onTokenRefresh=function(t,e,n){return"function"==typeof t?this.onTokenRefreshInternal(t,e,n):this.onTokenRefreshInternal(t)},e.prototype.waitForRegistrationToActivate_=function(t){var e=t.installing||t.waiting||t.active;return new Promise(function(n,r){if(e)if("activated"!==e.state)if("redundant"!==e.state){var i=function(){if("activated"===e.state)n(t);else{if("redundant"!==e.state)return;r(_.create(v.SW_REG_REDUNDANT))}e.removeEventListener("statechange",i)};e.addEventListener("statechange",i)}else r(_.create(v.SW_REG_REDUNDANT));else n(t);else r(_.create(v.NO_SW_IN_REG))})},e.prototype.getSWRegistration_=function(){var t=this;return this.registrationToUse?this.waitForRegistrationToActivate_(this.registrationToUse):(this.registrationToUse=null,navigator.serviceWorker.register("/firebase-messaging-sw.js",{scope:"/firebase-cloud-messaging-push-scope"}).catch(function(t){throw _.create(v.FAILED_DEFAULT_REGISTRATION,{browserErrorMessage:t.message})}).then(function(e){return t.waitForRegistrationToActivate_(e).then(function(){return t.registrationToUse=e,e.update(),e})}))},e.prototype.getPublicVapidKey_=function(){return Object(m.__awaiter)(this,void 0,void 0,function(){return Object(m.__generator)(this,function(t){return this.publicVapidKeyToUse?[2,this.publicVapidKeyToUse]:[2,w]})})},e.prototype.setupSWMessageListener_=function(){var t=this;navigator.serviceWorker.addEventListener("message",function(e){if(e.data&&e.data[d.TYPE_OF_MSG]){var n=e.data;switch(n[d.TYPE_OF_MSG]){case T.PUSH_MSG_RECEIVED:case T.NOTIFICATION_CLICKED:t.messageObserver&&t.messageObserver.next(n[d.DATA])}}},!1)},e}(R);h(g.a)},421:function(t,e,n){"use strict";function r(t){return"storage/"+t}function i(){return new gt(vt.UNKNOWN,"An unknown error occurred, please check the error payload for server response.")}function o(){return new gt(vt.CANCELED,"User canceled the upload/download.")}function s(){return new gt(vt.CANNOT_SLICE_BLOB,"Cannot slice blob for upload. Please retry the upload.")}function a(t,e,n){return new gt(vt.INVALID_ARGUMENT,"Invalid argument in `"+e+"` at index "+t+": "+n)}function u(){return new gt(vt.APP_DELETED,"The Firebase app was deleted.")}function c(t,e){return new gt(vt.INVALID_FORMAT,"String does not match format '"+t+"': "+e)}function h(t){throw new gt(vt.INTERNAL_ERROR,"Internal error: "+t)}function l(t){switch(t){case bt.RAW:case bt.BASE64:case bt.BASE64URL:case bt.DATA_URL:return;default:throw"Expected one of the event types: ["+bt.RAW+", "+bt.BASE64+", "+bt.BASE64URL+", "+bt.DATA_URL+"]."}}function f(t,e){switch(t){case bt.RAW:return new _t(d(e));case bt.BASE64:case bt.BASE64URL:return new _t(p(t,e));case bt.DATA_URL:return new _t(function(t){var e=new wt(t);return e.base64?p(bt.BASE64,e.rest):function(t){var e;try{e=decodeURIComponent(t)}catch(t){throw c(bt.DATA_URL,"Malformed data URL.")}return d(e)}(e.rest)}(e),function(t){return new wt(t).contentType}(e))}throw i()}function d(t){for(var e=[],n=0;n<t.length;n++){var r=t.charCodeAt(n);if(r<=127)e.push(r);else if(r<=2047)e.push(192|r>>6,128|63&r);else if(55296==(64512&r)){if(n<t.length-1&&56320==(64512&t.charCodeAt(n+1))){var i=r,o=t.charCodeAt(++n);e.push(240|(r=65536|(1023&i)<<10|1023&o)>>18,128|r>>12&63,128|r>>6&63,128|63&r)}else e.push(239,191,189)}else 56320==(64512&r)?e.push(239,191,189):e.push(224|r>>12,128|r>>6&63,128|63&r)}return new Uint8Array(e)}function p(t,e){switch(t){case bt.BASE64:var n=-1!==e.indexOf("-"),r=-1!==e.indexOf("_");if(n||r){throw c(t,"Invalid character '"+(n?"-":"_")+"' found: is it base64url encoded?")}break;case bt.BASE64URL:var i=-1!==e.indexOf("+"),o=-1!==e.indexOf("/");if(i||o){throw c(t,"Invalid character '"+(i?"+":"/")+"' found: is it base64 encoded?")}e=e.replace(/-/g,"+").replace(/_/g,"/")}var s;try{s=atob(e)}catch(e){throw c(t,"Invalid character found")}for(var a=new Uint8Array(s.length),u=0;u<s.length;u++)a[u]=s.charCodeAt(u);return a}function m(t){switch(t){case Tt.RUNNING:case Tt.PAUSING:case Tt.CANCELING:return St.RUNNING;case Tt.PAUSED:return St.PAUSED;case Tt.SUCCESS:return St.SUCCESS;case Tt.CANCELED:return St.CANCELED;case Tt.ERROR:default:return St.ERROR}}function y(t,e){return Object.prototype.hasOwnProperty.call(t,e)}function g(t,e){for(var n in t)y(t,n)&&e(n,t[n])}function v(t){if(null==t)return{};var e={};return g(t,function(t,n){e[t]=n}),e}function b(t){return new Promise(t)}function _(t){return Promise.resolve(t)}function w(t){return null!=t}function E(t){return void 0!==t}function T(t){return"function"==typeof t}function S(t){return"object"==typeof t}function I(t){return S(t)&&null!==t}function C(t){return"string"==typeof t||t instanceof String}function D(t){return N()&&t instanceof Blob}function N(){return"undefined"!=typeof Blob}function A(t){var e;try{e=JSON.parse(t)}catch(t){return null}return function(t){return S(t)&&!Array.isArray(t)}(e)?e:null}function k(t){var e=t.lastIndexOf("/",t.length-2);return-1===e?t:t.slice(e+1)}function R(t){return ht+ft+t}function O(t){return ht+dt+t}function P(t){var e=encodeURIComponent,n="?";return g(t,function(t,r){var i=e(t)+"="+e(r);n=n+i+"&"}),n=n.slice(0,-1)}function M(){if(At)return At;var t=[];t.push(new Nt("bucket")),t.push(new Nt("generation")),t.push(new Nt("metageneration")),t.push(new Nt("name","fullPath",!0));var e=new Nt("name");e.xform=function(t,e){return function(t){return!C(t)||t.length<2?t:(t=t,k(t))}(e)},t.push(e);var n=new Nt("size");return n.xform=function(t,e){return w(e)?+e:e},t.push(n),t.push(new Nt("timeCreated")),t.push(new Nt("updated")),t.push(new Nt("md5Hash",null,!0)),t.push(new Nt("cacheControl",null,!0)),t.push(new Nt("contentDisposition",null,!0)),t.push(new Nt("contentEncoding",null,!0)),t.push(new Nt("contentLanguage",null,!0)),t.push(new Nt("contentType",null,!0)),t.push(new Nt("metadata","customMetadata",!0)),At=t}function L(t,e,n){var r={};r.type="file";for(var i=n.length,o=0;o<i;o++){var s=n[o];r[s.local]=s.xform(r,e[s.server])}return function(t,e){Object.defineProperty(t,"ref",{get:function(){var n=new Dt(t.bucket,t.fullPath);return e.makeStorageReference(n)}})}(r,t),r}function x(t,e,n){var r=A(e);if(null===r)return null;return L(t,r,n)}function U(t,e){var n=A(e);if(null===n)return null;if(!C(n.downloadTokens))return null;var r=n.downloadTokens;if(0===r.length)return null;var i=encodeURIComponent;return r.split(",").map(function(e){var n=t.fullPath;return function(t){return lt+ft+t}("/b/"+i(t.bucket)+"/o/"+i(n))+P({alt:"media",token:e})})[0]}function B(t,e){for(var n={},r=e.length,i=0;i<r;i++){var o=e[i];o.writable&&(n[o.server]=t[o.local])}return JSON.stringify(n)}function F(t){if(!(t&&S(t)))throw"Expected Metadata object.";for(var e in t){var n=t[e];if("customMetadata"===e){if(!S(n))throw"Expected object for 'customMetadata' mapping."}else if(I(n))throw"Mapping for '"+e+"' cannot be an object."}}function q(t,e,n){for(var r=e.length,i=e.length,o=0;o<e.length;o++)if(e[o].optional){r=o;break}if(!(r<=n.length&&n.length<=i))throw function(t,e,n,r){var i,o;return t===e?(i=t,o=1===t?"argument":"arguments"):(i="between "+t+" and "+e,o="arguments"),new gt(vt.INVALID_ARGUMENT_COUNT,"Invalid argument count in `"+n+"`: Expected "+i+" "+o+", received "+r+".")}(r,i,t,n.length);for(o=0;o<n.length;o++)try{e[o].validator(n[o])}catch(e){throw e instanceof Error?a(o,t,e.message):a(o,t,e)}}function V(t,e){function n(t){if(!C(t))throw"Expected string."}var r;return r=t?function(t,e){return function(n){t(n),e(n)}}(n,t):n,new kt(r,e)}function K(t){return new kt(F,t)}function j(){return new kt(function(t){if(!(function(t){return"number"==typeof t||t instanceof Number}(t)&&t>=0))throw"Expected a number 0 or greater."})}function W(t,e){return new kt(function(e){if(!(null===e||w(e)&&e instanceof Object))throw"Expected an Object.";void 0!==t&&null!==t&&t(e)},e)}function Q(t){return new kt(function(t){if(null!==t&&!T(t))throw"Expected a Function."},t)}function G(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];var n="undefined"!=typeof BlobBuilder?BlobBuilder:"undefined"!=typeof WebKitBlobBuilder?WebKitBlobBuilder:void 0;if(void 0!==n){for(var r=new n,i=0;i<t.length;i++)r.append(t[i]);return r.getBlob()}if(N())return new Blob(t);throw Error("This browser doesn't seem to support creating Blobs")}function z(t,e){return-1!==t.indexOf(e)}function H(t){if(!t)throw i()}function X(t,e){return function(n,r){var i=x(t,r,e);return H(null!==i),i}}function Y(t){return function(e,n){var r;return(r=401===e.getStatus()?new gt(vt.UNAUTHENTICATED,"User is not authenticated, please authenticate using Firebase Authentication and try again."):402===e.getStatus()?function(t){return new gt(vt.QUOTA_EXCEEDED,"Quota for bucket '"+t+"' exceeded, please view quota on https://firebase.google.com/pricing/.")}(t.bucket):403===e.getStatus()?function(t){return new gt(vt.UNAUTHORIZED,"User does not have permission to access '"+t+"'.")}(t.path):n).setServerResponseProp(n.serverResponseProp()),r}}function J(t){var e=Y(t);return function(n,r){var i=e(n,r);return 404===n.getStatus()&&(i=function(t){return new gt(vt.OBJECT_NOT_FOUND,"Object '"+t+"' does not exist.")}(t.path)),i.setServerResponseProp(r.serverResponseProp()),i}}function Z(t,e,n){var r=R(e.fullServerUrl()),i=t.maxOperationRetryTime(),o=new Ot(r,"GET",X(t,n),i);return o.errorHandler=J(e),o}function $(t,e,n){var r=R(e.fullServerUrl()),i=t.maxOperationRetryTime(),o=new Ot(r,"GET",function(t,e){return function(n,r){var i=x(t,r,e);return H(null!==i),U(i,r)}}(t,n),i);return o.errorHandler=J(e),o}function tt(t,e,n){var r=v(n);return r.fullPath=t.path,r.size=e.size(),r.contentType||(r.contentType=function(t,e){return t&&t.contentType||e&&e.type()||"application/octet-stream"}(null,e)),r}function et(t,e){var n;try{n=t.getResponseHeader("X-Goog-Upload-Status")}catch(t){H(!1)}return H(z(e||["active"],n)),n}function nt(t,e,n,r,i,o,a,u){var c=new Pt(0,0);if(a?(c.current=a.current,c.total=a.total):(c.current=0,c.total=r.size()),r.size()!==c.total)throw new gt(vt.SERVER_FILE_WRONG_SIZE,"Server recorded incorrect upload file size, please retry the upload.");var h=c.total-c.current,l=h;i>0&&(l=Math.min(l,i));var f=c.current,d={"X-Goog-Upload-Command":l===h?"upload, finalize":"upload","X-Goog-Upload-Offset":c.current},p=r.slice(f,f+l);if(null===p)throw s();var m=e.maxUploadRetryTime(),y=new Ot(n,"POST",function(t,n){var i,s=et(t,["active","final"]),a=c.current+l,u=r.size();return i="final"===s?X(e,o)(t,n):null,new Pt(a,u,"final"===s,i)},m);return y.headers=d,y.body=p.uploadData(),y.progressCallback=u||null,y.errorHandler=Y(t),y}function rt(t){return function(){for(var e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];_(!0).then(function(){t.apply(null,e)})}}function it(t,e,n){var r=P(t.urlParams),i=t.url+r,o=v(t.headers);return function(t,e){null!==e&&e.length>0&&(t.Authorization="Firebase "+e)}(o,e),function(t){t["X-Firebase-Storage-Version"]="webjs/"+(void 0!==ct.a?ct.a.SDK_VERSION:"AppManager")}(o),new Vt(i,t.method,o,t.body,t.successCodes,t.additionalRetryCodes,t.handler,t.errorHandler,t.timeout,t.progressCallback,n)}function ot(t,e,n){return new jt(t,new Ct,n)}function st(t){t.INTERNAL.registerService(Qt,ot,{TaskState:St,TaskEvent:Et,StringFormat:bt,Storage:jt,Reference:Ut},void 0,!0)}Object.defineProperty(e,"__esModule",{value:!0}),n.d(e,"registerStorage",function(){return st});var at,ut=n(132),ct=n.n(ut),ht="https://firebasestorage.googleapis.com",lt="https://firebasestorage.googleapis.com",ft="/v0",dt="/v0",pt=12e4,mt=6e4,yt=-9007199254740991,gt=function(){function t(t,e){this.code_=r(t),this.message_="Firebase Storage: "+e,this.serverResponse_=null,this.name_="FirebaseError"}return t.prototype.codeProp=function(){return this.code},t.prototype.codeEquals=function(t){return r(t)===this.codeProp()},t.prototype.serverResponseProp=function(){return this.serverResponse_},t.prototype.setServerResponseProp=function(t){this.serverResponse_=t},Object.defineProperty(t.prototype,"name",{get:function(){return this.name_},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"code",{get:function(){return this.code_},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"message",{get:function(){return this.message_},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"serverResponse",{get:function(){return this.serverResponse_},enumerable:!0,configurable:!0}),t}(),vt={UNKNOWN:"unknown",OBJECT_NOT_FOUND:"object-not-found",BUCKET_NOT_FOUND:"bucket-not-found",PROJECT_NOT_FOUND:"project-not-found",QUOTA_EXCEEDED:"quota-exceeded",UNAUTHENTICATED:"unauthenticated",UNAUTHORIZED:"unauthorized",RETRY_LIMIT_EXCEEDED:"retry-limit-exceeded",INVALID_CHECKSUM:"invalid-checksum",CANCELED:"canceled",INVALID_EVENT_NAME:"invalid-event-name",INVALID_URL:"invalid-url",INVALID_DEFAULT_BUCKET:"invalid-default-bucket",NO_DEFAULT_BUCKET:"no-default-bucket",CANNOT_SLICE_BLOB:"cannot-slice-blob",SERVER_FILE_WRONG_SIZE:"server-file-wrong-size",NO_DOWNLOAD_URL:"no-download-url",INVALID_ARGUMENT:"invalid-argument",INVALID_ARGUMENT_COUNT:"invalid-argument-count",APP_DELETED:"app-deleted",INVALID_ROOT_OPERATION:"invalid-root-operation",INVALID_FORMAT:"invalid-format",INTERNAL_ERROR:"internal-error"},bt={RAW:"raw",BASE64:"base64",BASE64URL:"base64url",DATA_URL:"data_url"},_t=function(){return function(t,e){this.data=t,this.contentType=e||null}}(),wt=function(){return function(t){this.base64=!1,this.contentType=null;var e=t.match(/^data:([^,]+)?,/);if(null===e)throw c(bt.DATA_URL,"Must be formatted 'data:[<mediatype>][;base64],<data>");var n=e[1]||null;null!=n&&(this.base64=function(t,e){return!!(t.length>=e.length)&&t.substring(t.length-e.length)===e}(n,";base64"),this.contentType=this.base64?n.substring(0,n.length-";base64".length):n),this.rest=t.substring(t.indexOf(",")+1)}}(),Et={STATE_CHANGED:"state_changed"},Tt={RUNNING:"running",PAUSING:"pausing",PAUSED:"paused",SUCCESS:"success",CANCELING:"canceling",CANCELED:"canceled",ERROR:"error"},St={RUNNING:"running",PAUSED:"paused",SUCCESS:"success",CANCELED:"canceled",ERROR:"error"};!function(t){t[t.NO_ERROR=0]="NO_ERROR",t[t.NETWORK_ERROR=1]="NETWORK_ERROR",t[t.ABORT=2]="ABORT"}(at||(at={}));var It=function(){function t(){var t=this;this.sent_=!1,this.xhr_=new XMLHttpRequest,this.errorCode_=at.NO_ERROR,this.sendPromise_=b(function(e,n){t.xhr_.addEventListener("abort",function(n){t.errorCode_=at.ABORT,e(t)}),t.xhr_.addEventListener("error",function(n){t.errorCode_=at.NETWORK_ERROR,e(t)}),t.xhr_.addEventListener("load",function(n){e(t)})})}return t.prototype.send=function(t,e,n,r){var i=this;if(this.sent_)throw h("cannot .send() more than once");if(this.sent_=!0,this.xhr_.open(e,t,!0),w(r)){g(r,function(t,e){i.xhr_.setRequestHeader(t,e.toString())})}return w(n)?this.xhr_.send(n):this.xhr_.send(),this.sendPromise_},t.prototype.getErrorCode=function(){if(!this.sent_)throw h("cannot .getErrorCode() before sending");return this.errorCode_},t.prototype.getStatus=function(){if(!this.sent_)throw h("cannot .getStatus() before sending");try{return this.xhr_.status}catch(t){return-1}},t.prototype.getResponseText=function(){if(!this.sent_)throw h("cannot .getResponseText() before sending");return this.xhr_.responseText},t.prototype.abort=function(){this.xhr_.abort()},t.prototype.getResponseHeader=function(t){return this.xhr_.getResponseHeader(t)},t.prototype.addUploadProgressListener=function(t){w(this.xhr_.upload)&&this.xhr_.upload.addEventListener("progress",t)},t.prototype.removeUploadProgressListener=function(t){w(this.xhr_.upload)&&this.xhr_.upload.removeEventListener("progress",t)},t}(),Ct=function(){function t(){}return t.prototype.createXhrIo=function(){return new It},t}(),Dt=function(){function t(t,e){this.bucket=t,this.path_=e}return Object.defineProperty(t.prototype,"path",{get:function(){return this.path_},enumerable:!0,configurable:!0}),t.prototype.fullServerUrl=function(){var t=encodeURIComponent;return"/b/"+t(this.bucket)+"/o/"+t(this.path)},t.prototype.bucketOnlyServerUrl=function(){return"/b/"+encodeURIComponent(this.bucket)+"/o"},t.makeFromBucketSpec=function(e){var n;try{n=t.makeFromUrl(e)}catch(n){return new t(e,"")}if(""===n.path)return n;throw function(t){return new gt(vt.INVALID_DEFAULT_BUCKET,"Invalid default bucket '"+t+"'.")}(e)},t.makeFromUrl=function(e){for(var n=null,r="([A-Za-z0-9.\\-_]+)",i=[{regex:new RegExp("^gs://"+r+"(/(.*))?$","i"),indices:{bucket:1,path:3},postModify:function(t){"/"===t.path.charAt(t.path.length-1)&&(t.path_=t.path_.slice(0,-1))}},{regex:new RegExp("^https?://firebasestorage\\.googleapis\\.com/v[A-Za-z0-9_]+/b/"+r+"/o(/([^?#]*).*)?$","i"),indices:{bucket:1,path:3},postModify:function(t){t.path_=decodeURIComponent(t.path)}}],o=0;o<i.length;o++){var s=i[o],a=s.regex.exec(e);if(a){var u=a[s.indices.path];u||(u=""),n=new t(a[s.indices.bucket],u),s.postModify(n);break}}if(null==n)throw function(t){return new gt(vt.INVALID_URL,"Invalid URL '"+t+"'.")}(e);return n},t}(),Nt=function(){return function(t,e,n,r){this.server=t,this.local=e||t,this.writable=!!n,this.xform=r||function(t,e){return e}}}(),At=null,kt=function(){return function(t,e){var n=this;this.validator=function(e){n.optional&&!E(e)||t(e)},this.optional=!!e}}(),Rt=function(){function t(t,e){var n=0,r="";D(t)?(this.data_=t,n=t.size,r=t.type):t instanceof ArrayBuffer?(e?this.data_=new Uint8Array(t):(this.data_=new Uint8Array(t.byteLength),this.data_.set(new Uint8Array(t))),n=this.data_.length):t instanceof Uint8Array&&(e?this.data_=t:(this.data_=new Uint8Array(t.length),this.data_.set(t)),n=t.length),this.size_=n,this.type_=r}return t.prototype.size=function(){return this.size_},t.prototype.type=function(){return this.type_},t.prototype.slice=function(e,n){if(D(this.data_)){var r=function(t,e,n){return t.webkitSlice?t.webkitSlice(e,n):t.mozSlice?t.mozSlice(e,n):t.slice?t.slice(e,n):null}(this.data_,e,n);return null===r?null:new t(r)}return new t(new Uint8Array(this.data_.buffer,e,n-e),!0)},t.getBlob=function(){for(var e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];if(N()){var r=e.map(function(e){return e instanceof t?e.data_:e});return new t(G.apply(null,r))}var i=e.map(function(t){return C(t)?f(bt.RAW,t).data:t.data_}),o=0;i.forEach(function(t){o+=t.byteLength});var s=new Uint8Array(o),a=0;return i.forEach(function(t){for(var e=0;e<t.length;e++)s[a++]=t[e]}),new t(s,!0)},t.prototype.uploadData=function(){return this.data_},t}(),Ot=function(){return function(t,e,n,r){this.url=t,this.method=e,this.handler=n,this.timeout=r,this.urlParams={},this.headers={},this.body=null,this.errorHandler=null,this.progressCallback=null,this.successCodes=[200],this.additionalRetryCodes=[]}}(),Pt=function(){return function(t,e,n,r){this.current=t,this.total=e,this.finalized=!!n,this.metadata=r||null}}(),Mt=function(){return function(t,e,n){if(T(t)||w(e)||w(n))this.next=t,this.error=e||null,this.complete=n||null;else{var r=t;this.next=r.next||null,this.error=r.error||null,this.complete=r.complete||null}}}(),Lt=function(){return function(t,e,n,r,i,o){this.bytesTransferred=t,this.totalBytes=e,this.state=n,this.metadata=r,this.task=i,this.ref=o}}(),xt=function(){function t(t,e,n,r,i,o){void 0===o&&(o=null);var s=this;this.transferred_=0,this.needToFetchStatus_=!1,this.needToFetchMetadata_=!1,this.observers_=[],this.error_=null,this.uploadUrl_=null,this.request_=null,this.chunkMultiplier_=1,this.resolve_=null,this.reject_=null,this.ref_=t,this.authWrapper_=e,this.location_=n,this.blob_=i,this.metadata_=o,this.mappings_=r,this.resumable_=this.shouldDoResumable_(this.blob_),this.state_=Tt.RUNNING,this.errorHandler_=function(t){s.request_=null,s.chunkMultiplier_=1,t.codeEquals(vt.CANCELED)?(s.needToFetchStatus_=!0,s.completeTransitions_()):(s.error_=t,s.transition_(Tt.ERROR))},this.metadataErrorHandler_=function(t){s.request_=null,t.codeEquals(vt.CANCELED)?s.completeTransitions_():(s.error_=t,s.transition_(Tt.ERROR))},this.promise_=b(function(t,e){s.resolve_=t,s.reject_=e,s.start_()}),this.promise_.then(null,function(){})}return t.prototype.makeProgressCallback_=function(){var t=this,e=this.transferred_;return function(n,r){t.updateProgress_(e+n)}},t.prototype.shouldDoResumable_=function(t){return t.size()>262144},t.prototype.start_=function(){this.state_===Tt.RUNNING&&null===this.request_&&(this.resumable_?null===this.uploadUrl_?this.createResumable_():this.needToFetchStatus_?this.fetchStatus_():this.needToFetchMetadata_?this.fetchMetadata_():this.continueUpload_():this.oneShotUpload_())},t.prototype.resolveToken_=function(t){var e=this;this.authWrapper_.getAuthToken().then(function(n){switch(e.state_){case Tt.RUNNING:t(n);break;case Tt.CANCELING:e.transition_(Tt.CANCELED);break;case Tt.PAUSING:e.transition_(Tt.PAUSED)}})},t.prototype.createResumable_=function(){var t=this;this.resolveToken_(function(e){var n=function(t,e,n,r,i){var o=e.bucketOnlyServerUrl(),s=tt(e,r,i),a={name:s.fullPath},u=O(o),c={"X-Goog-Upload-Protocol":"resumable","X-Goog-Upload-Command":"start","X-Goog-Upload-Header-Content-Length":r.size(),"X-Goog-Upload-Header-Content-Type":s.contentType,"Content-Type":"application/json; charset=utf-8"},h=B(s,n),l=t.maxUploadRetryTime(),f=new Ot(u,"POST",function(t,e){et(t);var n;try{n=t.getResponseHeader("X-Goog-Upload-URL")}catch(t){H(!1)}return H(C(n)),n},l);return f.urlParams=a,f.headers=c,f.body=h,f.errorHandler=Y(e),f}(t.authWrapper_,t.location_,t.mappings_,t.blob_,t.metadata_),r=t.authWrapper_.makeRequest(n,e);t.request_=r,r.getPromise().then(function(e){t.request_=null,t.uploadUrl_=e,t.needToFetchStatus_=!1,t.completeTransitions_()},t.errorHandler_)})},t.prototype.fetchStatus_=function(){var t=this,e=this.uploadUrl_;this.resolveToken_(function(n){var r=function(t,e,n,r){var i=t.maxUploadRetryTime(),o=new Ot(n,"POST",function(t,e){var n,i=et(t,["active","final"]);try{n=t.getResponseHeader("X-Goog-Upload-Size-Received")}catch(t){H(!1)}var o=parseInt(n,10);return H(!isNaN(o)),new Pt(o,r.size(),"final"===i)},i);return o.headers={"X-Goog-Upload-Command":"query"},o.errorHandler=Y(e),o}(t.authWrapper_,t.location_,e,t.blob_),i=t.authWrapper_.makeRequest(r,n);t.request_=i,i.getPromise().then(function(e){e=e,t.request_=null,t.updateProgress_(e.current),t.needToFetchStatus_=!1,e.finalized&&(t.needToFetchMetadata_=!0),t.completeTransitions_()},t.errorHandler_)})},t.prototype.continueUpload_=function(){var t=this,e=262144*this.chunkMultiplier_,n=new Pt(this.transferred_,this.blob_.size()),r=this.uploadUrl_;this.resolveToken_(function(i){var o;try{o=nt(t.location_,t.authWrapper_,r,t.blob_,e,t.mappings_,n,t.makeProgressCallback_())}catch(e){return t.error_=e,void t.transition_(Tt.ERROR)}var s=t.authWrapper_.makeRequest(o,i);t.request_=s,s.getPromise().then(function(e){t.increaseMultiplier_(),t.request_=null,t.updateProgress_(e.current),e.finalized?(t.metadata_=e.metadata,t.transition_(Tt.SUCCESS)):t.completeTransitions_()},t.errorHandler_)})},t.prototype.increaseMultiplier_=function(){262144*this.chunkMultiplier_<33554432&&(this.chunkMultiplier_*=2)},t.prototype.fetchMetadata_=function(){var t=this;this.resolveToken_(function(e){var n=Z(t.authWrapper_,t.location_,t.mappings_),r=t.authWrapper_.makeRequest(n,e);t.request_=r,r.getPromise().then(function(e){t.request_=null,t.metadata_=e,t.transition_(Tt.SUCCESS)},t.metadataErrorHandler_)})},t.prototype.oneShotUpload_=function(){var t=this;this.resolveToken_(function(e){var n=function(t,e,n,r,i){var o=e.bucketOnlyServerUrl(),a={"X-Goog-Upload-Protocol":"multipart"},u=function(){for(var t="",e=0;e<2;e++)t+=Math.random().toString().slice(2);return t}();a["Content-Type"]="multipart/related; boundary="+u;var c=tt(e,r,i),h=B(c,n),l=Rt.getBlob("--"+u+"\r\nContent-Type: application/json; charset=utf-8\r\n\r\n"+h+"\r\n--"+u+"\r\nContent-Type: "+c.contentType+"\r\n\r\n",r,"\r\n--"+u+"--");if(null===l)throw s();var f={name:c.fullPath},d=O(o),p=t.maxUploadRetryTime(),m=new Ot(d,"POST",X(t,n),p);return m.urlParams=f,m.headers=a,m.body=l.uploadData(),m.errorHandler=Y(e),m}(t.authWrapper_,t.location_,t.mappings_,t.blob_,t.metadata_),r=t.authWrapper_.makeRequest(n,e);t.request_=r,r.getPromise().then(function(e){t.request_=null,t.metadata_=e,t.updateProgress_(t.blob_.size()),t.transition_(Tt.SUCCESS)},t.errorHandler_)})},t.prototype.updateProgress_=function(t){var e=this.transferred_;this.transferred_=t,this.transferred_!==e&&this.notifyObservers_()},t.prototype.transition_=function(t){if(this.state_!==t)switch(t){case Tt.CANCELING:case Tt.PAUSING:this.state_=t,null!==this.request_&&this.request_.cancel();break;case Tt.RUNNING:var e=this.state_===Tt.PAUSED;this.state_=t,e&&(this.notifyObservers_(),this.start_());break;case Tt.PAUSED:this.state_=t,this.notifyObservers_();break;case Tt.CANCELED:this.error_=o(),this.state_=t,this.notifyObservers_();break;case Tt.ERROR:case Tt.SUCCESS:this.state_=t,this.notifyObservers_()}},t.prototype.completeTransitions_=function(){switch(this.state_){case Tt.PAUSING:this.transition_(Tt.PAUSED);break;case Tt.CANCELING:this.transition_(Tt.CANCELED);break;case Tt.RUNNING:this.start_()}},Object.defineProperty(t.prototype,"snapshot",{get:function(){var t=m(this.state_);return new Lt(this.transferred_,this.blob_.size(),t,this.metadata_,this,this.ref_)},enumerable:!0,configurable:!0}),t.prototype.on=function(t,e,n,r){function i(t){try{return void a(t)}catch(t){}try{u(t);if(!(E(t.next)||E(t.error)||E(t.complete)))throw"";return}catch(t){throw s}}function o(t){return function(e,n,i){null!==t&&q("on",t,arguments);var o=new Mt(e,n,r);return c.addObserver_(o),function(){c.removeObserver_(o)}}}void 0===e&&(e=void 0),void 0===n&&(n=void 0),void 0===r&&(r=void 0);var s="Expected a function or an Object with one of `next`, `error`, `complete` properties.",a=Q(!0).validator,u=W(null,!0).validator;q("on",[V(function(e){if(t!==Et.STATE_CHANGED)throw"Expected one of the event types: ["+Et.STATE_CHANGED+"]."}),W(i,!0),Q(!0),Q(!0)],arguments);var c=this,h=[W(function(t){if(null===t)throw s;i(t)}),Q(!0),Q(!0)];return!(E(e)||E(n)||E(r))?o(h):o(null)(e,n,r)},t.prototype.then=function(t,e){return this.promise_.then(t,e)},t.prototype.catch=function(t){return this.then(null,t)},t.prototype.addObserver_=function(t){this.observers_.push(t),this.notifyObserver_(t)},t.prototype.removeObserver_=function(t){!function(t,e){var n=t.indexOf(e);-1!==n&&t.splice(n,1)}(this.observers_,t)},t.prototype.notifyObservers_=function(){var t=this;this.finishPromise_();(function(t){return Array.prototype.slice.call(t)})(this.observers_).forEach(function(e){t.notifyObserver_(e)})},t.prototype.finishPromise_=function(){if(null!==this.resolve_){var t=!0;switch(m(this.state_)){case St.SUCCESS:rt(this.resolve_.bind(null,this.snapshot))();break;case St.CANCELED:case St.ERROR:rt(this.reject_.bind(null,this.error_))();break;default:t=!1}t&&(this.resolve_=null,this.reject_=null)}},t.prototype.notifyObserver_=function(t){switch(m(this.state_)){case St.RUNNING:case St.PAUSED:null!==t.next&&rt(t.next.bind(t,this.snapshot))();break;case St.SUCCESS:null!==t.complete&&rt(t.complete.bind(t))();break;case St.CANCELED:case St.ERROR:null!==t.error&&rt(t.error.bind(t,this.error_))();break;default:null!==t.error&&rt(t.error.bind(t,this.error_))()}},t.prototype.resume=function(){q("resume",[],arguments);var t=this.state_===Tt.PAUSED||this.state_===Tt.PAUSING;return t&&this.transition_(Tt.RUNNING),t},t.prototype.pause=function(){q("pause",[],arguments);var t=this.state_===Tt.RUNNING;return t&&this.transition_(Tt.PAUSING),t},t.prototype.cancel=function(){q("cancel",[],arguments);var t=this.state_===Tt.RUNNING||this.state_===Tt.PAUSING;return t&&this.transition_(Tt.CANCELING),t},t}(),Ut=function(){function t(t,e){this.authWrapper=t,this.location=e instanceof Dt?e:Dt.makeFromUrl(e)}return t.prototype.toString=function(){return q("toString",[],arguments),"gs://"+this.location.bucket+"/"+this.location.path},t.prototype.newRef=function(e,n){return new t(e,n)},t.prototype.mappings=function(){return M()},t.prototype.child=function(t){q("child",[V()],arguments);var e=function(t,e){var n=e.split("/").filter(function(t){return t.length>0}).join("/");return 0===t.length?n:t+"/"+n}(this.location.path,t),n=new Dt(this.location.bucket,e);return this.newRef(this.authWrapper,n)},Object.defineProperty(t.prototype,"parent",{get:function(){var t=function(t){if(0==t.length)return null;var e=t.lastIndexOf("/");return-1===e?"":t.slice(0,e)}(this.location.path);if(null===t)return null;var e=new Dt(this.location.bucket,t);return this.newRef(this.authWrapper,e)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"root",{get:function(){var t=new Dt(this.location.bucket,"");return this.newRef(this.authWrapper,t)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"bucket",{get:function(){return this.location.bucket},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"fullPath",{get:function(){return this.location.path},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"name",{get:function(){return k(this.location.path)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"storage",{get:function(){return this.authWrapper.service()},enumerable:!0,configurable:!0}),t.prototype.put=function(t,e){return void 0===e&&(e=null),q("put",[new kt(function(t){if(!(t instanceof Uint8Array||t instanceof ArrayBuffer||N()&&t instanceof Blob))throw"Expected Blob or File."}),K(!0)],arguments),this.throwIfRoot_("put"),new xt(this,this.authWrapper,this.location,this.mappings(),new Rt(t),e)},t.prototype.putString=function(t,e,n){void 0===e&&(e=bt.RAW),q("putString",[V(),V(l,!0),K(!0)],arguments),this.throwIfRoot_("putString");var r=f(e,t),i=v(n);return!w(i.contentType)&&w(r.contentType)&&(i.contentType=r.contentType),new xt(this,this.authWrapper,this.location,this.mappings(),new Rt(r.data,!0),i)},t.prototype.delete=function(){q("delete",[],arguments),this.throwIfRoot_("delete");var t=this;return this.authWrapper.getAuthToken().then(function(e){var n=function(t,e){var n=R(e.fullServerUrl()),r=t.maxOperationRetryTime(),i=new Ot(n,"DELETE",function(t,e){},r);return i.successCodes=[200,204],i.errorHandler=J(e),i}(t.authWrapper,t.location);return t.authWrapper.makeRequest(n,e).getPromise()})},t.prototype.getMetadata=function(){q("getMetadata",[],arguments),this.throwIfRoot_("getMetadata");var t=this;return this.authWrapper.getAuthToken().then(function(e){var n=Z(t.authWrapper,t.location,t.mappings());return t.authWrapper.makeRequest(n,e).getPromise()})},t.prototype.updateMetadata=function(t){q("updateMetadata",[K()],arguments),this.throwIfRoot_("updateMetadata");var e=this;return this.authWrapper.getAuthToken().then(function(n){var r=function(t,e,n,r){var i=R(e.fullServerUrl()),o=B(n,r),s=t.maxOperationRetryTime(),a=new Ot(i,"PATCH",X(t,r),s);return a.headers={"Content-Type":"application/json; charset=utf-8"},a.body=o,a.errorHandler=J(e),a}(e.authWrapper,e.location,t,e.mappings());return e.authWrapper.makeRequest(r,n).getPromise()})},t.prototype.getDownloadURL=function(){q("getDownloadURL",[],arguments),this.throwIfRoot_("getDownloadURL");var t=this;return this.authWrapper.getAuthToken().then(function(e){var n=$(t.authWrapper,t.location,t.mappings());return t.authWrapper.makeRequest(n,e).getPromise().then(function(t){if(null===t)throw new gt(vt.NO_DOWNLOAD_URL,"The given file does not have any download URLs.");return t})})},t.prototype.throwIfRoot_=function(t){if(""===this.location.path)throw function(t){return new gt(vt.INVALID_ROOT_OPERATION,"The operation '"+t+"' cannot be performed on a root reference, create a non-root reference using child, such as .child('file.png').")}(t)},t}(),Bt=function(){function t(t){this.promise_=function(t){return Promise.reject(t)}(t)}return t.prototype.getPromise=function(){return this.promise_},t.prototype.cancel=function(t){void 0===t&&(t=!1)},t}(),Ft=function(){function t(){this.map_={},this.id_=yt}return t.prototype.addRequest=function(t){function e(){delete r.map_[n]}var n=this.id_;this.id_++,this.map_[n]=t;var r=this;t.getPromise().then(e,e)},t.prototype.clear=function(){g(this.map_,function(t,e){e&&e.cancel(!0)}),this.map_={}},t}(),qt=function(){function t(e,n,r,i,o){if(this.bucket_=null,this.deleted_=!1,this.app_=e,null!==this.app_){var s=this.app_.options;w(s)&&(this.bucket_=t.extractBucket_(s))}this.storageRefMaker_=n,this.requestMaker_=r,this.pool_=o,this.service_=i,this.maxOperationRetryTime_=pt,this.maxUploadRetryTime_=mt,this.requestMap_=new Ft}return t.extractBucket_=function(t){var e=t.storageBucket||null;if(null==e)return null;return Dt.makeFromBucketSpec(e).bucket},t.prototype.getAuthToken=function(){return null!==this.app_&&w(this.app_.INTERNAL)&&w(this.app_.INTERNAL.getToken)?this.app_.INTERNAL.getToken().then(function(t){return null!==t?t.accessToken:null},function(t){return null}):_(null)},t.prototype.bucket=function(){if(this.deleted_)throw u();return this.bucket_},t.prototype.service=function(){return this.service_},t.prototype.makeStorageReference=function(t){return this.storageRefMaker_(this,t)},t.prototype.makeRequest=function(t,e){if(this.deleted_)return new Bt(u());var n=this.requestMaker_(t,e,this.pool_);return this.requestMap_.addRequest(n),n},t.prototype.deleteApp=function(){this.deleted_=!0,this.app_=null,this.requestMap_.clear()},t.prototype.maxUploadRetryTime=function(){return this.maxUploadRetryTime_},t.prototype.setMaxUploadRetryTime=function(t){this.maxUploadRetryTime_=t},t.prototype.maxOperationRetryTime=function(){return this.maxOperationRetryTime_},t.prototype.setMaxOperationRetryTime=function(t){this.maxOperationRetryTime_=t},t}(),Vt=function(){function t(t,e,n,r,i,o,s,a,u,c,h){this.pendingXhr_=null,this.backoffId_=null,this.resolve_=null,this.reject_=null,this.canceled_=!1,this.appDelete_=!1,this.url_=t,this.method_=e,this.headers_=n,this.body_=r,this.successCodes_=i.slice(),this.additionalRetryCodes_=o.slice(),this.callback_=s,this.errorCallback_=a,this.progressCallback_=c,this.timeout_=u,this.pool_=h;var l=this;this.promise_=b(function(t,e){l.resolve_=t,l.reject_=e,l.start_()})}return t.prototype.start_=function(){function t(t,e){function r(t){null!==n.progressCallback_&&n.progressCallback_(t.loaded,t.lengthComputable?t.total:-1)}if(e)t(!1,new Kt(!1,null,!0));else{var i=n.pool_.createXhrIo();n.pendingXhr_=i,null!==n.progressCallback_&&i.addUploadProgressListener(r),i.send(n.url_,n.method_,n.body_,n.headers_).then(function(e){null!==n.progressCallback_&&e.removeUploadProgressListener(r),n.pendingXhr_=null;var i=(e=e).getErrorCode()===at.NO_ERROR,o=e.getStatus();if(i&&!n.isRetryStatusCode_(o)){var s=z(n.successCodes_,o);t(!0,new Kt(s,e))}else{var a=e.getErrorCode()===at.ABORT;t(!1,new Kt(!1,null,a))}})}}function e(t,e){var r=n.resolve_,s=n.reject_,a=e.xhr;if(e.wasSuccessCode)try{var c=n.callback_(a,a.getResponseText());E(c)?r(c):r()}catch(t){s(t)}else if(null!==a){(h=i()).setServerResponseProp(a.getResponseText()),s(n.errorCallback_?n.errorCallback_(a,h):h)}else if(e.canceled){s(h=n.appDelete_?u():o())}else{var h;s(h=new gt(vt.RETRY_LIMIT_EXCEEDED,"Max retry time for operation exceeded, please try again."))}}var n=this;this.canceled_?e(0,new Kt(!1,null,!0)):this.backoffId_=function(t,e,n){function r(){return 2===l}function i(){f||(f=!0,e.apply(null,arguments))}function o(e){c=setTimeout(function(){c=null,t(s,r())},e)}function s(t){for(var e=[],n=1;n<arguments.length;n++)e[n-1]=arguments[n];if(!f)if(t)i.apply(null,arguments);else if(r()||h)i.apply(null,arguments);else{u<64&&(u*=2);var s;1===l?(l=2,s=0):s=1e3*(u+Math.random()),o(s)}}function a(t){d||(d=!0,f||(null!==c?(t||(l=2),clearTimeout(c),o(0)):t||(l=1)))}var u=1,c=null,h=!1,l=0,f=!1,d=!1;return o(0),setTimeout(function(){h=!0,a(!0)},n),a}(t,e,this.timeout_)},t.prototype.getPromise=function(){return this.promise_},t.prototype.cancel=function(t){this.canceled_=!0,this.appDelete_=t||!1,null!==this.backoffId_&&function(t){t(!1)}(this.backoffId_),null!==this.pendingXhr_&&this.pendingXhr_.abort()},t.prototype.isRetryStatusCode_=function(t){var e=t>=500&&t<600,n=z([408,429],t),r=z(this.additionalRetryCodes_,t);return e||n||r},t}(),Kt=function(){return function(t,e,n){this.wasSuccessCode=t,this.xhr=e,this.canceled=!!n}}(),jt=function(){function t(t,e,n){if(this.bucket_=null,this.authWrapper_=new qt(t,function(t,e){return new Ut(t,e)},it,this,e),this.app_=t,null!=n)this.bucket_=Dt.makeFromBucketSpec(n);else{var r=this.authWrapper_.bucket();null!=r&&(this.bucket_=new Dt(r,""))}this.internals_=new Wt(this)}return t.prototype.ref=function(t){if(q("ref",[V(function(t){if(/^[A-Za-z]+:\/\//.test(t))throw"Expected child path but got a URL, use refFromURL instead."},!0)],arguments),null==this.bucket_)throw new Error("No Storage Bucket defined in Firebase Options.");var e=new Ut(this.authWrapper_,this.bucket_);return null!=t?e.child(t):e},t.prototype.refFromURL=function(t){return q("refFromURL",[V(function(t){if(!/^[A-Za-z]+:\/\//.test(t))throw"Expected full URL but got a child path, use ref instead.";try{Dt.makeFromUrl(t)}catch(t){throw"Expected valid full URL but got an invalid one."}},!1)],arguments),new Ut(this.authWrapper_,t)},Object.defineProperty(t.prototype,"maxUploadRetryTime",{get:function(){return this.authWrapper_.maxUploadRetryTime()},enumerable:!0,configurable:!0}),t.prototype.setMaxUploadRetryTime=function(t){q("setMaxUploadRetryTime",[j()],arguments),this.authWrapper_.setMaxUploadRetryTime(t)},Object.defineProperty(t.prototype,"maxOperationRetryTime",{get:function(){return this.authWrapper_.maxOperationRetryTime()},enumerable:!0,configurable:!0}),t.prototype.setMaxOperationRetryTime=function(t){q("setMaxOperationRetryTime",[j()],arguments),this.authWrapper_.setMaxOperationRetryTime(t)},Object.defineProperty(t.prototype,"app",{get:function(){return this.app_},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"INTERNAL",{get:function(){return this.internals_},enumerable:!0,configurable:!0}),t}(),Wt=function(){function t(t){this.service_=t}return t.prototype.delete=function(){return this.service_.authWrapper_.deleteApp(),_(void 0)},t}(),Qt="storage";st(ct.a)},422:function(t,e,n){"use strict";function r(t){return i._40(2,[(t()(),i._17(0,0,null,null,1,"div",[["class","toolbar-background"]],null,null,null,null,null)),i._16(1,278528,null,0,o.i,[i.A,i.B,i.p,i.O],{klass:[0,"klass"],ngClass:[1,"ngClass"]},null),i._28(null,0),i._28(null,1),i._28(null,2),(t()(),i._17(5,0,null,null,2,"div",[["class","toolbar-content"]],null,null,null,null,null)),i._16(6,278528,null,0,o.i,[i.A,i.B,i.p,i.O],{klass:[0,"klass"],ngClass:[1,"ngClass"]},null),i._28(null,3)],function(t,e){var n=e.component;t(e,1,0,"toolbar-background","toolbar-background-"+n._mode);t(e,6,0,"toolbar-content","toolbar-content-"+n._mode)},null)}n.d(e,"a",function(){return u}),e.b=r;var i=n(0),o=n(17),s=n(97),a=n(2),u=i._15({encapsulation:2,styles:[],data:{}});i._13("ion-toolbar",s.a,function(t){return i._40(0,[(t()(),i._17(0,0,null,null,1,"ion-toolbar",[["class","toolbar"]],[[2,"statusbar-padding",null]],null,null,r,u)),i._16(1,49152,null,0,s.a,[a.a,i.p,i.N],null,null)],null,function(t,e){t(e,0,0,i._29(e,1)._sbPadding)})},{color:"color",mode:"mode"},{},["[menuToggle],ion-buttons[left]","ion-buttons[start]","ion-buttons[end],ion-buttons[right]","*"])}});